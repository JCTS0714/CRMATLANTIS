import{r as f,o as L,f as O,H as R,g as p,i as u,j as s,k as W,w as q,x as H,t as c,n as F,z as j,F as Z,m as G}from"./vendor-vue-Db-AqoDh.js";import{a as g}from"./vendor-utils-Czy7fllw.js";import{f as J,a as x,t as h,g as K,c as Q}from"./App-Bt9-hbAg.js";import"./app-DjmpOHxG.js";import"./vendor-ui-DEm6YKEA.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const X={class:"p-4"},Y={class:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between"},ee={class:"w-full sm:max-w-md"},te={class:"flex items-center gap-2"},ae={class:"text-sm text-slate-600 dark:text-slate-300"},se={key:0},re={key:1},oe={key:0,class:"mt-2 text-sm text-slate-600 dark:text-slate-300"},ie={class:"mt-4 overflow-x-auto rounded-lg border border-slate-200 bg-white dark:border-slate-800 dark:bg-slate-900"},ne={class:"min-w-full text-left text-sm text-slate-700 dark:text-slate-200"},le={class:"px-4 py-3 font-medium text-slate-900 dark:text-slate-100"},de={class:"px-4 py-3"},ce={class:"px-4 py-3"},pe={class:"px-4 py-3"},ue={class:"px-4 py-3"},me={class:"px-4 py-3"},fe=["href"],ge=["src"],be={key:1,class:"inline-flex items-center rounded-md border border-slate-300 px-2 py-1 text-xs text-slate-700 dark:border-slate-700 dark:text-slate-200"},xe={key:1},he={class:"px-4 py-3"},ve={class:"flex items-center gap-2"},ye=["disabled","onClick"],_e=["disabled","onClick"],ke={class:"mt-4 flex items-center justify-between"},we=["disabled"],Ce={class:"text-sm text-slate-600 dark:text-slate-300"},Ie=["disabled"],je={__name:"CertificadosTable",setup(Te){const D=e=>{if(!e)return"";const t=String(e);return t.startsWith("http://")||t.startsWith("https://")?t:`/storage/${t.replace(/^\/+/,"")}`},z=e=>String(e||"").toLowerCase().endsWith(".pdf"),P=e=>{if(!e)return"";const t=String(e).trim();if(t==="")return"";const a=t.match(/^(\d{4})-(\d{2})-(\d{2})/);if(a)return`${a[3]}/${a[2]}/${a[1]}`;const i=new Date(t);return Number.isNaN(i.getTime())?t:new Intl.DateTimeFormat("es-PE",{day:"2-digit",month:"2-digit",year:"numeric"}).format(i)},v=f([]),y=f(!1),w=f(new Set),C=f(new Set),_=f("");let I=null;const T=f(!1),E=f(!1),m=f(""),l=f({current_page:1,last_page:1,per_page:15,total:0,from:0,to:0}),b=async(e=1)=>{y.value=!0;try{const{data:t}=await g.get("/postventa/certificados/data",{params:{q:_.value||"",per_page:l.value.per_page,page:e}});v.value=t.certificados||[],l.value={...l.value,...t.pagination||{}}}finally{y.value=!1}},$=e=>{const t=Math.max(1,Math.min(l.value.last_page||1,e));b(t)},V=async e=>{var a,i,n,r;const t=(i=(a=e==null?void 0:e.target)==null?void 0:a.files)==null?void 0:i[0];if(e!=null&&e.target&&(e.target.value=""),!!t){T.value=!0,m.value="Importando datos...";try{const o=new FormData;o.append("csv",t);const{data:d}=await g.post("/postventa/certificados/import-data",o,{headers:{"Content-Type":"multipart/form-data"}}),k=((d==null?void 0:d.output)??"").trim();m.value=k!==""?k:"Importación de datos finalizada.",x("Datos importados"),b(1)}catch(o){const d=((r=(n=o==null?void 0:o.response)==null?void 0:n.data)==null?void 0:r.message)??"No se pudo importar el CSV.";m.value=d,h(d)}finally{T.value=!1}}},M=async e=>{var a,i,n;const t=Array.from(((a=e==null?void 0:e.target)==null?void 0:a.files)??[]);if(e!=null&&e.target&&(e.target.value=""),!!t.length){E.value=!0,m.value="Importando imágenes...";try{const r=new FormData;t.forEach(d=>r.append("images[]",d));const{data:o}=await g.post("/postventa/certificados/import-images",r,{headers:{"Content-Type":"multipart/form-data"}});if(typeof(o==null?void 0:o.updated)=="number")m.value=`Importación de imágenes finalizada. Actualizados: ${o.updated} · Saltados: ${o.skipped??0} · Sin match: ${o.unmatched??0}`;else{const d=((o==null?void 0:o.output)??"").trim();m.value=d!==""?d:"Importación de imágenes finalizada."}x("Imágenes importadas"),b(1)}catch(r){const o=((n=(i=r==null?void 0:r.response)==null?void 0:i.data)==null?void 0:n.message)??"No se pudo importar el ZIP.";m.value=o,h(o)}finally{E.value=!1}}},U=async()=>{var t,a;const e=await J();if(e)try{if((e==null?void 0:e.imagen)instanceof File){const i=new FormData;Object.entries(e).forEach(([n,r])=>{r!=null&&i.append(n,r)}),await g.post("/postventa/certificados",i,{headers:{"Content-Type":"multipart/form-data"}})}else await g.post("/postventa/certificados",e);x("Certificado creado"),b(1)}catch(i){const n=((a=(t=i==null?void 0:i.response)==null?void 0:t.data)==null?void 0:a.message)??"No se pudo crear el certificado.";h(n)}},B=async e=>{var a,i,n;if(!(e!=null&&e.id))return;const t=await K(e);if(t){w.value.add(e.id);try{let r;if((t==null?void 0:t.imagen)instanceof File){const d=new FormData;d.append("_method","PUT"),Object.entries(t).forEach(([k,S])=>{S!=null&&d.append(k,S)}),r=await g.post(`/postventa/certificados/${e.id}`,d,{headers:{"Content-Type":"multipart/form-data"}})}else r=await g.put(`/postventa/certificados/${e.id}`,t);const o=(a=r==null?void 0:r.data)==null?void 0:a.data;Object.assign(e,o&&typeof o=="object"?o:t),x("Certificado actualizado")}catch(r){const o=((n=(i=r==null?void 0:r.response)==null?void 0:i.data)==null?void 0:n.message)??"No se pudo actualizar el certificado.";h(o)}finally{w.value.delete(e.id)}}},A=async e=>{var a,i;if(!(!(e!=null&&e.id)||!await Q({title:"Eliminar certificado",text:"Se eliminará el certificado.",confirmText:"Eliminar",cancelText:"Cancelar",icon:"warning"}))){C.value.add(e.id);try{await g.delete(`/postventa/certificados/${e.id}`),v.value=v.value.filter(n=>n.id!==e.id),x("Certificado eliminado"),b(Math.min(l.value.current_page,l.value.last_page||1))}catch(n){const r=((i=(a=n==null?void 0:n.response)==null?void 0:a.data)==null?void 0:i.message)??"No se pudo eliminar el certificado.";h(r)}finally{C.value.delete(e.id)}}},N=()=>U();return L(()=>{window.addEventListener("certificados:create",N)}),O(()=>{window.removeEventListener("certificados:create",N)}),R(_,()=>{I&&clearTimeout(I),I=setTimeout(()=>{b(1)},300)},{flush:"post"}),b(1),(e,t)=>(u(),p("div",X,[s("div",Y,[s("div",ee,[q(s("input",{"onUpdate:modelValue":t[0]||(t[0]=a=>_.value=a),type:"text",class:"w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 focus:border-sky-500 focus:ring-sky-500 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100",placeholder:"Buscar certificado (nombre, RUC, usuario…)"},null,512),[[H,_.value]])]),s("div",te,[s("div",ae,[l.value.total?(u(),p("span",se,"Mostrando "+c(l.value.from)+"–"+c(l.value.to)+" de "+c(l.value.total),1)):(u(),p("span",re,"Sin resultados"))]),s("label",{class:F(["inline-flex cursor-pointer items-center rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",T.value?"pointer-events-none opacity-50":""])},[s("input",{type:"file",class:"hidden",accept:".csv,.txt,text/csv",onChange:V},null,32),t[3]||(t[3]=j(" Importar datos (CSV) ",-1))],2),s("label",{class:F(["inline-flex cursor-pointer items-center rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",E.value?"pointer-events-none opacity-50":""])},[s("input",{type:"file",class:"hidden",multiple:"",accept:"image/*,.pdf,application/pdf",onChange:M},null,32),t[4]||(t[4]=j(" Importar imágenes ",-1))],2)])]),m.value?(u(),p("div",oe,c(m.value),1)):W("",!0),s("div",ie,[s("table",ne,[t[5]||(t[5]=s("thead",{class:"bg-slate-50 text-xs uppercase text-slate-600 dark:bg-slate-800 dark:text-slate-200"},[s("tr",null,[s("th",{class:"px-4 py-3"},"Nombre"),s("th",{class:"px-4 py-3"},"RUC"),s("th",{class:"px-4 py-3"},"Tipo"),s("th",{class:"px-4 py-3"},"Estado"),s("th",{class:"px-4 py-3"},"Vencimiento"),s("th",{class:"px-4 py-3"},"Imagen"),s("th",{class:"px-4 py-3"},"Acciones")])],-1)),s("tbody",null,[(u(!0),p(Z,null,G(v.value,a=>(u(),p("tr",{key:a.id,class:"border-t border-slate-200 hover:bg-slate-50 dark:border-slate-800 dark:hover:bg-slate-800"},[s("td",le,c(a.nombre),1),s("td",de,c(a.ruc||"—"),1),s("td",ce,c(a.tipo||"—"),1),s("td",pe,c(a.estado||"—"),1),s("td",ue,c(P(a.fecha_vencimiento)||"—"),1),s("td",me,[a.imagen?(u(),p("a",{key:0,href:D(a.imagen),target:"_blank",rel:"noreferrer"},[z(a.imagen)?(u(),p("span",be," PDF ")):(u(),p("img",{key:0,src:D(a.imagen),alt:"",class:"h-10 w-10 rounded object-cover"},null,8,ge))],8,fe)):(u(),p("span",xe,"—"))]),s("td",he,[s("div",ve,[s("button",{type:"button",class:"inline-flex items-center rounded-lg border border-slate-300 bg-white px-3 py-1.5 text-xs font-medium text-slate-700 hover:bg-slate-50 disabled:opacity-60 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:w.value.has(a.id),onClick:i=>B(a)}," Editar ",8,ye),s("button",{type:"button",class:"inline-flex items-center rounded-lg border border-red-200 bg-white px-3 py-1.5 text-xs font-medium text-red-700 hover:bg-red-50 disabled:opacity-60 dark:border-red-900/40 dark:bg-slate-900 dark:text-red-300 dark:hover:bg-red-950/30",disabled:C.value.has(a.id),onClick:i=>A(a)}," Eliminar ",8,_e)])])]))),128))])])]),s("div",ke,[s("button",{class:"rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 disabled:cursor-not-allowed disabled:opacity-50 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:l.value.current_page<=1||y.value,onClick:t[1]||(t[1]=a=>$(l.value.current_page-1))}," Anterior ",8,we),s("div",Ce," Página "+c(l.value.current_page)+" / "+c(l.value.last_page),1),s("button",{class:"rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 disabled:cursor-not-allowed disabled:opacity-50 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:l.value.current_page>=l.value.last_page||y.value,onClick:t[2]||(t[2]=a=>$(l.value.current_page+1))}," Siguiente ",8,Ie)])]))}};export{je as default};
