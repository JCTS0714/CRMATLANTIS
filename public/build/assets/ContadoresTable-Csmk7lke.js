import{r as u,o as G,f as J,x as Q,g as p,i as m,j as e,k as Y,w as $,z as Z,A as ee,t as i,n as te,C as ae,u as g,F as A,m as M,s as B,v as se}from"./vendor-vue-Diyp6CFE.js";import{a as x}from"./vendor-utils-Czy7fllw.js";import{u as oe,a as re,_ as le,e as ne,b as _,t as w,f as de,c as ie}from"./App-DAC6HJ3v.js";import"./app-BDRZbfW-.js";import"./vendor-ui-BsDgRXDF.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const ce={class:"p-4"},ue={class:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between"},pe={class:"w-full sm:max-w-md"},me={class:"flex items-center gap-2"},be={class:"text-sm text-slate-600 dark:text-slate-300"},ge={key:0},ve={key:1},xe={key:0,class:"mt-2 text-sm text-slate-600 dark:text-slate-300"},ye={class:"px-4 py-3 font-medium text-slate-900 dark:text-slate-100"},fe={class:"px-4 py-3"},ke={class:"px-4 py-3"},he={class:"px-4 py-3"},_e={class:"px-4 py-3"},we={class:"px-4 py-3"},Ce={class:"px-4 py-3"},Se={class:"flex items-center gap-2"},Ne=["disabled","onClick"],Te=["disabled","onClick"],Ee={class:"mt-4 flex items-center justify-between"},ze=["disabled"],Re={class:"text-sm text-slate-600 dark:text-slate-300"},Ve=["disabled"],Fe={__name:"ContadoresTable",setup(Ie){const y=u([]),f=u(!1),C=u(new Set),S=u(new Set),k=u("");let N=null;const T=u(!1),v=u(""),o=u({current_page:1,last_page:1,per_page:15,total:0,from:0,to:0}),E=[{key:"nro",label:"Nro"},{key:"comercio",label:"Comercio"},{key:"nom_contador",label:"Nombre"},{key:"customer",label:"Cliente"},{key:"usuario",label:"Usuario"},{key:"servidor",label:"Servidor"},{key:"actions",label:"Acciones"}],{tableRef:z,visibleKeys:j,isColumnVisible:D,toggleColumn:F,resetColumns:U}=oe({tableId:"contadores-table",columns:E}),{tableScrollRef:L,stickyScrollRef:P,stickyScrollWidth:q,showStickyXScroll:H}=re({tableRef:z}),b=async(t=1)=>{f.value=!0;try{const{data:s}=await x.get("/postventa/contadores/data",{params:{q:k.value||"",per_page:o.value.per_page,page:t}});y.value=s.contadores||[],o.value={...o.value,...s.pagination||{}}}finally{f.value=!1}},R=t=>{const s=Math.max(1,Math.min(o.value.last_page||1,t));b(s)},K=async t=>{var a,r,l,d;const s=(r=(a=t==null?void 0:t.target)==null?void 0:a.files)==null?void 0:r[0];if(t!=null&&t.target&&(t.target.value=""),!!s){T.value=!0,v.value="Importando...";try{const n=new FormData;n.append("csv",s);const{data:c}=await x.post("/postventa/contadores/import",n,{headers:{"Content-Type":"multipart/form-data"}}),h=((c==null?void 0:c.output)??"").trim();v.value=h!==""?h:"Importación finalizada.",_("Importación finalizada"),b(1)}catch(n){const c=((d=(l=n==null?void 0:n.response)==null?void 0:l.data)==null?void 0:d.message)??"No se pudo importar el CSV.";v.value=c,w(c)}finally{T.value=!1}}},O=async()=>{var s,a;const t=await ne();if(t)try{await x.post("/postventa/contadores",t),_("Contador creado"),b(1)}catch(r){const l=((a=(s=r==null?void 0:r.response)==null?void 0:s.data)==null?void 0:a.message)??"No se pudo crear el contador.";w(l)}},W=async t=>{var a,r,l;if(!(t!=null&&t.id))return;const s=await de(t);if(s){C.value.add(t.id);try{const d=await x.put(`/postventa/contadores/${t.id}`,s),n=(a=d==null?void 0:d.data)==null?void 0:a.data,c=Array.isArray(n==null?void 0:n.customers)?n.customers.map(I=>({id:I.id,name:I.name})):[],h=c[0]??null;Object.assign(t,{...s,customer:h,customers:c}),_("Contador actualizado")}catch(d){const n=((l=(r=d==null?void 0:d.response)==null?void 0:r.data)==null?void 0:l.message)??"No se pudo actualizar el contador.";w(n)}finally{C.value.delete(t.id)}}},X=async t=>{var a,r;if(!(!(t!=null&&t.id)||!await ie({title:"Eliminar contador",text:"Se eliminará el contador y su asignación a cliente (si existe).",confirmText:"Eliminar",cancelText:"Cancelar",icon:"warning"}))){S.value.add(t.id);try{await x.delete(`/postventa/contadores/${t.id}`),y.value=y.value.filter(l=>l.id!==t.id),_("Contador eliminado"),b(Math.min(o.value.current_page,o.value.last_page||1))}catch(l){const d=((r=(a=l==null?void 0:l.response)==null?void 0:a.data)==null?void 0:r.message)??"No se pudo eliminar el contador.";w(d)}finally{S.value.delete(t.id)}}},V=()=>O();return G(()=>{window.addEventListener("contadores:create",V)}),J(()=>{window.removeEventListener("contadores:create",V)}),Q(k,()=>{N&&clearTimeout(N),N=setTimeout(()=>{b(1)},300)},{flush:"post"}),b(1),(t,s)=>(m(),p("div",ce,[e("div",ue,[e("div",pe,[$(e("input",{"onUpdate:modelValue":s[0]||(s[0]=a=>k.value=a),type:"text",class:"w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 focus:border-sky-500 focus:ring-sky-500 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100",placeholder:"Buscar contador (nro, comercio, nombre, usuario, servidor…)"},null,512),[[Z,k.value]])]),e("div",me,[e("div",be,[o.value.total?(m(),p("span",ge,"Mostrando "+i(o.value.from)+"–"+i(o.value.to)+" de "+i(o.value.total),1)):(m(),p("span",ve,"Sin resultados"))]),e("label",{class:te(["inline-flex cursor-pointer items-center rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 disabled:cursor-not-allowed disabled:opacity-50 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",T.value?"pointer-events-none opacity-50":""])},[e("input",{type:"file",class:"hidden",accept:".csv,.txt,text/csv",onChange:K},null,32),s[3]||(s[3]=ae(" Importar CSV ",-1))],2),ee(le,{columns:E,"visible-keys":g(j),onToggle:g(F),onReset:g(U)},null,8,["visible-keys","onToggle","onReset"])])]),v.value?(m(),p("div",xe,i(v.value),1)):Y("",!0),e("div",{ref_key:"tableScrollRef",ref:L,class:"mt-4 overflow-x-auto rounded-lg border border-slate-200 bg-white dark:border-slate-800 dark:bg-slate-900"},[e("table",{ref_key:"tableRef",ref:z,class:"min-w-full text-left text-sm text-slate-700 dark:text-slate-200"},[e("colgroup",null,[(m(),p(A,null,M(E,a=>e("col",{key:a.key,style:B({display:g(D)(a.key)?"":"none"})},null,4)),64))]),s[4]||(s[4]=e("thead",{class:"bg-slate-50 text-xs uppercase text-slate-600 dark:bg-slate-800 dark:text-slate-200"},[e("tr",null,[e("th",{class:"px-4 py-3"},"Nro"),e("th",{class:"px-4 py-3"},"Comercio"),e("th",{class:"px-4 py-3"},"Nombre"),e("th",{class:"px-4 py-3"},"Cliente"),e("th",{class:"px-4 py-3"},"Usuario"),e("th",{class:"px-4 py-3"},"Servidor"),e("th",{class:"px-4 py-3"},"Acciones")])],-1)),e("tbody",null,[(m(!0),p(A,null,M(y.value,a=>{var r;return m(),p("tr",{key:a.id,class:"border-t border-slate-200 hover:bg-slate-50 dark:border-slate-800 dark:hover:bg-slate-800"},[e("td",ye,i(a.nro||"—"),1),e("td",fe,i(a.comercio||"—"),1),e("td",ke,i(a.nom_contador||"—"),1),e("td",he,i(((r=a.customer)==null?void 0:r.name)||"—"),1),e("td",_e,i(a.usuario||"—"),1),e("td",we,i(a.servidor||"—"),1),e("td",Ce,[e("div",Se,[e("button",{type:"button",class:"inline-flex items-center rounded-lg border border-slate-300 bg-white px-3 py-1.5 text-xs font-medium text-slate-700 hover:bg-slate-50 disabled:opacity-60 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:C.value.has(a.id),onClick:l=>W(a)}," Editar ",8,Ne),e("button",{type:"button",class:"inline-flex items-center rounded-lg border border-red-200 bg-white px-3 py-1.5 text-xs font-medium text-red-700 hover:bg-red-50 disabled:opacity-60 dark:border-red-900/40 dark:bg-slate-900 dark:text-red-300 dark:hover:bg-red-950/30",disabled:S.value.has(a.id),onClick:l=>X(a)}," Eliminar ",8,Te)])])])}),128))])],512)],512),$(e("div",{ref_key:"stickyScrollRef",ref:P,class:"sticky bottom-0 z-20 mt-2 overflow-x-auto rounded-lg border border-slate-200 bg-white/95 dark:border-slate-700 dark:bg-slate-900/95"},[e("div",{style:B({width:`${g(q)}px`,height:"1px"})},null,4)],512),[[se,g(H)]]),e("div",Ee,[e("button",{class:"rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 disabled:cursor-not-allowed disabled:opacity-50 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:o.value.current_page<=1||f.value,onClick:s[1]||(s[1]=a=>R(o.value.current_page-1))}," Anterior ",8,ze),e("div",Re," Página "+i(o.value.current_page)+" / "+i(o.value.last_page),1),e("button",{class:"rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 disabled:cursor-not-allowed disabled:opacity-50 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:o.value.current_page>=o.value.last_page||f.value,onClick:s[2]||(s[2]=a=>R(o.value.current_page+1))}," Siguiente ",8,Ve)])]))}};export{Fe as default};
