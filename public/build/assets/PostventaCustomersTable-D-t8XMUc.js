import{r as m,H as z,o as A,f as V,g as p,i as b,j as s,w as q,x as L,t as d,F as O,m as U}from"./vendor-vue-Db-AqoDh.js";import{a as _}from"./vendor-utils-Czy7fllw.js";import{a as x,t as f,d as H,p as G,b as J,c as K}from"./App-D_XY1sJF.js";import"./app-CglYj3fU.js";import"./vendor-ui-DEm6YKEA.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const Q={class:"p-4"},R={class:"mb-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between"},W={class:"w-full sm:max-w-md"},X={class:"flex items-center gap-2"},Y=["disabled"],Z=["disabled"],ee={class:"text-sm text-slate-600 dark:text-slate-300"},te={key:0},ae={key:1},se={class:"overflow-x-auto rounded-lg border border-slate-200 bg-white dark:border-slate-800 dark:bg-slate-900"},oe={class:"min-w-full text-left text-sm text-slate-700 dark:text-slate-200"},ne={class:"px-4 py-3 font-medium text-slate-900 dark:text-slate-100"},le={class:"px-4 py-3"},re={class:"px-4 py-3"},de={class:"px-4 py-3"},ie={key:0},ue={key:1},me={class:"px-4 py-3"},ce={class:"px-4 py-3"},pe={class:"px-4 py-3"},be={class:"flex items-center gap-2"},ge=["onClick"],_e=["onClick"],ye=["disabled","onClick"],xe=["disabled","onClick"],fe={class:"mt-4 flex items-center justify-between"},ve=["disabled"],he={class:"text-sm text-slate-600 dark:text-slate-300"},ke=["disabled"],De={__name:"PostventaCustomersTable",setup(we){const v=m([]),h=m(!1),k=m(!1),w=m(null),C=m(!1),I=m(new Set),T=m(new Set),$=m("");let y=null;const l=m({current_page:1,last_page:1,per_page:15,total:0,from:0,to:0}),g=async(e=1)=>{h.value=!0;try{const{data:a}=await _.get("/customers/data",{params:{q:$.value||"",per_page:l.value.per_page,page:e}});v.value=a.customers||[],l.value={...l.value,...a.pagination||{}}}finally{h.value=!1}},S=()=>{var e,a;(a=(e=w.value)==null?void 0:e.click)==null||a.call(e)},D=async e=>{var t,o,n,r,i;const a=(o=(t=e==null?void 0:e.target)==null?void 0:t.files)==null?void 0:o[0];if(a){C.value=!0;try{const u=new FormData;u.append("csv",a);const{data:c}=await _.post("/customers/import",u,{headers:{"Content-Type":"multipart/form-data"}});x(((n=c==null?void 0:c.output)!=null&&n.trim(),"Importación finalizada")),await g(1)}catch(u){const c=((i=(r=u==null?void 0:u.response)==null?void 0:r.data)==null?void 0:i.message)??"No se pudo importar el CSV.";f(c)}finally{C.value=!1,w.value&&(w.value.value="")}}},N=e=>{const a=(e==null?void 0:e.company_name)||(e==null?void 0:e.name)||"",t=e!=null&&e.company_name?e==null?void 0:e.name:"";let o=a;t&&t!==a&&(o+=` — ${t}`);const n=e!=null&&e.document_number?`${e!=null&&e.document_type?e.document_type+" ":""}${e.document_number}`:"";return n&&(o+=` (${n})`),o},j=e=>{e!=null&&e.id&&window.dispatchEvent(new CustomEvent("incidencias:create",{detail:{customer_id:e.id,customer_label:N(e)}}))},B=async()=>{var a,t;const e=await H();if(e){k.value=!0;try{await _.post("/customers",e),x("Cliente creado"),await g(1)}catch(o){const n=((t=(a=o==null?void 0:o.response)==null?void 0:a.data)==null?void 0:t.message)??"No se pudo crear el cliente.";f(n)}finally{k.value=!1}}},F=async e=>{var t,o,n;if(!(e!=null&&e.id))return;const a=await J(e);if(a){I.value.add(e.id);try{const r=await _.put(`/customers/${e.id}`,a),i=(t=r==null?void 0:r.data)==null?void 0:t.data;i&&typeof i=="object"?Object.assign(e,i):Object.assign(e,a),x("Cliente actualizado")}catch(r){const i=((n=(o=r==null?void 0:r.response)==null?void 0:o.data)==null?void 0:n.message)??"No se pudo actualizar el cliente.";f(i)}finally{I.value.delete(e.id)}}},M=async e=>{var r,i;if(!(e!=null&&e.id))return;const a=await G(e);if(!a)return;const o=`Pago cliente: ${e.company_name||e.name||`Cliente #${e.id}`}`,n=[e.name&&e.company_name&&e.name!==e.company_name?`Contacto: ${e.name}`:null,e.document_number?`Documento: ${e.document_type?`${e.document_type} `:""}${e.document_number}`:null,e.contact_phone?`Teléfono: ${e.contact_phone}`:null,a.note?`Detalle: ${a.note}`:null].filter(Boolean);try{await _.post("/calendar/events",{event_type:"customer_payment",title:o,description:n.join(" | ")||null,all_day:!0,start_at:a.date,end_at:null,reminder_minutes:1440,related_type:"customer",related_id:e.id,meta:{customer_name:e.name||null,company_name:e.company_name||null,payment_date:a.date}}),x("Fecha de pago agregada al calendario")}catch(u){const c=((i=(r=u==null?void 0:u.response)==null?void 0:r.data)==null?void 0:i.message)??"No se pudo agregar la fecha de pago al calendario.";f(c)}},P=async e=>{var t,o;if(!(!(e!=null&&e.id)||!await K({title:"Eliminar cliente",text:"Se eliminará el cliente. Las incidencias asociadas quedarán sin cliente (se desvinculan).",confirmText:"Eliminar",cancelText:"Cancelar",icon:"warning"}))){T.value.add(e.id);try{await _.delete(`/customers/${e.id}`),v.value=v.value.filter(n=>n.id!==e.id),x("Cliente eliminado"),g(Math.min(l.value.current_page,l.value.last_page||1))}catch(n){const r=((o=(t=n==null?void 0:n.response)==null?void 0:t.data)==null?void 0:o.message)??"No se pudo eliminar el cliente.";f(r)}finally{T.value.delete(e.id)}}},E=e=>{const a=Math.max(1,Math.min(l.value.last_page||1,e));g(a)};return z($,()=>{y&&clearTimeout(y),y=setTimeout(()=>{g(1)},300)},{flush:"post"}),A(()=>{g(1)}),V(()=>{y&&clearTimeout(y)}),(e,a)=>(b(),p("div",Q,[s("div",R,[s("div",W,[q(s("input",{"onUpdate:modelValue":a[0]||(a[0]=t=>$.value=t),type:"text",class:"w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 focus:border-sky-500 focus:ring-sky-500 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100",placeholder:"Buscar cliente (nombre, contacto, empresa, documento…)"},null,512),[[L,$.value]])]),s("div",X,[s("input",{ref_key:"importInput",ref:w,type:"file",accept:".csv,text/csv",class:"hidden",onChange:D},null,544),s("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:C.value,onClick:S},d(C.value?"Importando…":"Importar CSV"),9,Y),s("button",{type:"button",class:"inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 disabled:opacity-60",disabled:k.value,onClick:B},d(k.value?"Creando…":"Crear cliente"),9,Z),s("div",ee,[l.value.total?(b(),p("span",te,"Mostrando "+d(l.value.from)+"–"+d(l.value.to)+" de "+d(l.value.total),1)):(b(),p("span",ae,"Sin resultados"))])])]),s("div",se,[s("table",oe,[a[3]||(a[3]=s("thead",{class:"bg-slate-50 text-xs uppercase text-slate-600 dark:bg-slate-800 dark:text-slate-200"},[s("tr",null,[s("th",{class:"px-4 py-3"},"Cliente"),s("th",{class:"px-4 py-3"},"Contacto"),s("th",{class:"px-4 py-3"},"Empresa"),s("th",{class:"px-4 py-3"},"Documento"),s("th",{class:"px-4 py-3"},"Teléfono"),s("th",{class:"px-4 py-3"},"Email"),s("th",{class:"px-4 py-3"},"Acciones")])],-1)),s("tbody",null,[(b(!0),p(O,null,U(v.value,t=>(b(),p("tr",{key:t.id,class:"border-t border-slate-200 hover:bg-slate-50 dark:border-slate-800 dark:hover:bg-slate-800"},[s("td",ne,d(t.name),1),s("td",le,d(t.contact_name||"—"),1),s("td",re,d(t.company_name||"—"),1),s("td",de,[t.document_type||t.document_number?(b(),p("span",ie,d(t.document_type||"")+" "+d(t.document_number||""),1)):(b(),p("span",ue,"—"))]),s("td",me,d(t.contact_phone||"—"),1),s("td",ce,d(t.contact_email||"—"),1),s("td",pe,[s("div",be,[s("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",onClick:o=>j(t)}," Abrir incidencia ",8,ge),s("button",{type:"button",class:"inline-flex items-center rounded-lg border border-emerald-200 bg-emerald-50 px-3 py-1.5 text-xs font-medium text-emerald-700 hover:bg-emerald-100 disabled:opacity-60 dark:border-emerald-900/40 dark:bg-emerald-950/30 dark:text-emerald-300 dark:hover:bg-emerald-900/40",onClick:o=>M(t)}," Agregar fecha de pago ",8,_e),s("button",{type:"button",class:"inline-flex items-center rounded-lg border border-slate-300 bg-white px-3 py-1.5 text-xs font-medium text-slate-700 hover:bg-slate-50 disabled:opacity-60 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:I.value.has(t.id),onClick:o=>F(t)}," Editar ",8,ye),s("button",{type:"button",class:"inline-flex items-center rounded-lg border border-red-200 bg-white px-3 py-1.5 text-xs font-medium text-red-700 hover:bg-red-50 disabled:opacity-60 dark:border-red-900/40 dark:bg-slate-900 dark:text-red-300 dark:hover:bg-red-950/30",disabled:T.value.has(t.id),onClick:o=>P(t)}," Eliminar ",8,xe)])])]))),128))])])]),s("div",fe,[s("button",{class:"rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 disabled:cursor-not-allowed disabled:opacity-50 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:l.value.current_page<=1||h.value,onClick:a[1]||(a[1]=t=>E(l.value.current_page-1))}," Anterior ",8,ve),s("div",he," Página "+d(l.value.current_page)+" / "+d(l.value.last_page),1),s("button",{class:"rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 disabled:cursor-not-allowed disabled:opacity-50 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:l.value.current_page>=l.value.last_page||h.value,onClick:a[2]||(a[2]=t=>E(l.value.current_page+1))}," Siguiente ",8,ke)])]))}};export{De as default};
