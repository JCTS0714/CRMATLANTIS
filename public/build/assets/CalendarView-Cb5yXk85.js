const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/vendor-ui-DEm6YKEA.js","assets/vendor-vue-Db-AqoDh.js"])))=>i.map(i=>d[i]);
import{_ as me}from"./app-CglYj3fU.js";import{a as k}from"./vendor-utils-Czy7fllw.js";import{i as pe,a as ve,b as fe,F as ge}from"./vendor-ui-DEm6YKEA.js";import{a as P,t as B,c as ye}from"./App-D_XY1sJF.js";import"./notifications-Dl6xZJx9.js";import"./calendar-notifications-CrOVVuzr.js";import{e as ie,r as J,o as be,I as we,f as _e,g as xe,i as he,j as L,B as Ee,t as ke,u as $e}from"./vendor-vue-Db-AqoDh.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const Se={class:"p-4"},Ne={class:"mb-4 flex items-center justify-between"},Te=["disabled"],Ce={class:"rounded-lg border border-gray-200 bg-white p-2 shadow-sm dark:border-slate-800 dark:bg-slate-900"},Be={class:"px-3 py-2 text-center text-base font-semibold text-gray-800 dark:text-slate-100"},He={__name:"CalendarView",setup(De){const W=window.__AUTH_USER__??null,le=ie(()=>{const e=(W==null?void 0:W.permissions)??[];return Array.isArray(e)&&e.includes("calendar.delete")}),p=J(!1),V=J(null),K=J(""),j=()=>{var e,t;try{(t=(e=V.value)==null?void 0:e.getApi)==null||t.call(e).refetchEvents()}catch{}},X=e=>{var r,n,l;const t=(n=(r=V.value)==null?void 0:r.getApi)==null?void 0:n.call(r);if(!t)return;const a=(l=t.view)==null?void 0:l.type;if(a==="dayGridMonth"){t.incrementDate({months:e});return}if(a==="timeGridWeek"){t.incrementDate({weeks:e});return}t.incrementDate({days:e})},Z=(e=null)=>{var l,d;const t=(d=(l=V.value)==null?void 0:l.getApi)==null?void 0:d.call(l),a=e??(t==null?void 0:t.view),r=a==null?void 0:a.currentStart;if(!r)return;const n=new Date(r);n.setDate(n.getDate()+15),K.value=new Intl.DateTimeFormat("es-PE",{year:"numeric",month:"long"}).format(n)},N=e=>{if(!e)return"";const t=new Date(e);if(Number.isNaN(t.getTime()))return"";const a=r=>String(r).padStart(2,"0");return`${t.getFullYear()}-${a(t.getMonth()+1)}-${a(t.getDate())}T${a(t.getHours())}:${a(t.getMinutes())}`},H=async({event_type:e="general",is_existing:t=!1,title:a="",start_at:r="",end_at:n="",all_day:l=!1,reminder_minutes:d="",related_type:i="",related_id:m="",description:f="",location:y="",allowDelete:G=!1}={})=>{const E=h=>String(h??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),b="mt-1 w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-950 dark:text-slate-100",T=`
    <div class="grid gap-3 text-left">
      <div>
        <label class="block text-xs font-medium text-gray-600 dark:text-slate-300">Tipo de evento</label>
        <select id="sw-ev-event_type" class="${b}">
          <option value="general" ${e==="general"?"selected":""}>General</option>
          <option value="meeting" ${e==="meeting"?"selected":""}>Reunión</option>
          <option value="lead_followup" ${e==="lead_followup"?"selected":""}>Seguimiento de lead</option>
          <option value="customer_payment" ${e==="customer_payment"?"selected":""}>Fecha de pago</option>
          <option value="certificate_expiry" ${e==="certificate_expiry"?"selected":""}>Vencimiento de certificado</option>
        </select>
      </div>

      <div>
        <label class="block text-xs font-medium text-gray-600 dark:text-slate-300">Título</label>
        <input id="sw-ev-title" class="${b}" value="${E(a)}" />
      </div>

      <div class="grid grid-cols-1 gap-3 sm:grid-cols-2">
        <div>
          <label class="block text-xs font-medium text-gray-600 dark:text-slate-300">Inicio</label>
          <input id="sw-ev-start" type="datetime-local" class="${b}" value="${E(r)}" />
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-600 dark:text-slate-300">Fin</label>
          <input id="sw-ev-end" type="datetime-local" class="${b}" value="${E(n)}" />
        </div>
      </div>

      <div class="grid grid-cols-1 gap-3 sm:grid-cols-2">
        <div>
          <label class="block text-xs font-medium text-gray-600 dark:text-slate-300">Recordatorio (minutos antes)</label>
          <input id="sw-ev-reminder" type="number" min="1" max="10080" class="${b}" value="${E(d)}" placeholder="(opcional)" />
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-600 dark:text-slate-300">Ubicación</label>
          <input id="sw-ev-location" class="${b}" value="${E(y)}" placeholder="(opcional)" />
        </div>
      </div>

      <div>
        <label class="block text-xs font-medium text-gray-600 dark:text-slate-300">Descripción</label>
        <textarea id="sw-ev-description" rows="3" class="${b}" placeholder="(opcional)">${E(f)}</textarea>
      </div>

      <div class="grid grid-cols-1 gap-3 sm:grid-cols-2">
        <div>
          <label class="block text-xs font-medium text-gray-600 dark:text-slate-300">Relacionado a</label>
          <select id="sw-ev-related_type" class="${b}">
            <option value="" ${i?"":"selected"}>(ninguno)</option>
            <option value="lead" ${i==="lead"?"selected":""}>Lead</option>
            <option value="customer" ${i==="customer"?"selected":""}>Cliente</option>
            <option value="certificate" ${i==="certificate"?"selected":""}>Certificado</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-600 dark:text-slate-300">Relacionado</label>
          <input id="sw-ev-related_search" class="${b}" placeholder="Escribe para buscar…" autocomplete="off" />
          <input id="sw-ev-related_id" type="hidden" value="${E(m)}" />
          <div id="sw-ev-related_results" class="mt-2 max-h-44 overflow-auto rounded-lg border border-gray-200 bg-white p-1 text-left shadow-sm dark:border-slate-800 dark:bg-slate-950" style="display:none;"></div>
          <div id="sw-ev-related_hint" class="mt-1 text-xs text-gray-500 dark:text-slate-400">Selecciona un resultado para llenar el vínculo (opcional).</div>
        </div>
      </div>
    </div>
  `,{default:x}=await me(async()=>{const{default:h}=await import("./vendor-ui-DEm6YKEA.js").then(o=>o.s);return{default:h}},__vite__mapDeps([0,1])),Y=await x.fire({title:"Evento",html:T,focusConfirm:!1,showCancelButton:!0,showDenyButton:!!G,confirmButtonText:"Guardar",cancelButtonText:"Cancelar",denyButtonText:"Eliminar",buttonsStyling:!1,didOpen:async()=>{const h=document.getElementById("sw-ev-event_type"),o=document.getElementById("sw-ev-start"),$=document.getElementById("sw-ev-end"),C=document.getElementById("sw-ev-reminder"),w=document.getElementById("sw-ev-related_type"),v=document.getElementById("sw-ev-related_search"),R=document.getElementById("sw-ev-related_id"),g=document.getElementById("sw-ev-related_results");if(!w||!v||!R||!g||!h||!o||!$||!C)return;let D=null;const _=()=>{g.innerHTML="",g.style.display="none"},M=s=>{R.value=s!=null&&s.id?String(s.id):"",v.value=s!=null&&s.label?String(s.label):"",_()},z=()=>{const s=w.value||"",u=!!s;v.disabled=!u;const c=s==="lead"?"lead":s==="customer"?"cliente":"certificado";v.placeholder=u?`Buscar ${c}…`:"Selecciona tipo primero",u||M(null)},A=()=>{const s=h.value||"general",u=s==="customer_payment"||s==="certificate_expiry",c=t&&u;s==="customer_payment"&&(w.value="customer"),s==="certificate_expiry"&&(w.value="certificate"),u?(o.type!=="date"&&(o.type="date"),o.value&&o.value.length>10&&(o.value=o.value.slice(0,10)),$.value="",$.disabled=!0,String(C.value||"").trim()||(C.value="1440")):(o.type!=="datetime-local"&&(o.type="datetime-local",o.value&&o.value.length===10&&(o.value=`${o.value}T09:00`)),$.disabled=!1),h.disabled=c,w.disabled=c,v.disabled=c?!0:v.disabled,z(),c&&(v.disabled=!0)},q=s=>{if(g.innerHTML="",!(s!=null&&s.length)){_();return}g.style.display="block";for(const u of s){const c=document.createElement("button");c.type="button",c.className="flex w-full items-center justify-between rounded-md px-2 py-1.5 text-left text-sm text-gray-800 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-200 dark:text-slate-100 dark:hover:bg-slate-900 dark:focus:ring-blue-500/30",c.textContent=u.label,c.addEventListener("click",()=>M(u)),g.appendChild(c)}},U=async()=>{var c,S;const s=w.value||"",u=Number(R.value);if(!(!s||!Number.isFinite(u)||u<1))try{const I=await k.get("/related-lookup",{params:{type:s,id:u}});(S=(c=I==null?void 0:I.data)==null?void 0:c.data)!=null&&S.label?v.value=I.data.data.label:v.value=`#${u}`}catch{}},F=async()=>{var c;const s=w.value||"",u=(v.value||"").trim();if(!s||u.length<2){_();return}try{const S=await k.get("/related-lookup",{params:{type:s,q:u,limit:8}});q(((c=S==null?void 0:S.data)==null?void 0:c.data)??[])}catch{_()}};w.addEventListener("change",()=>{z(),_()}),h.addEventListener("change",()=>{A(),_()}),v.addEventListener("input",()=>{R.value="",D&&window.clearTimeout(D),D=window.setTimeout(()=>{F()},250)}),v.addEventListener("blur",()=>{window.setTimeout(()=>_(),150)}),v.addEventListener("focus",()=>{F()}),A(),await U()},customClass:{popup:"rounded-xl border border-gray-200 bg-white text-gray-900 shadow-xl dark:!border-slate-800 dark:!bg-slate-900 dark:!text-slate-100",backdrop:"bg-black/60",title:"text-base font-semibold text-gray-900 dark:text-slate-100",htmlContainer:"text-sm text-gray-600 dark:text-slate-300",actions:"gap-2",confirmButton:"inline-flex items-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 disabled:opacity-60",cancelButton:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-4 focus:ring-blue-100 disabled:opacity-60 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",denyButton:"inline-flex items-center rounded-lg bg-rose-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-rose-700 focus:outline-none focus:ring-4 focus:ring-rose-300 disabled:opacity-60"},preConfirm:()=>{var A,q,U,F,s,u,c,S,I,ne,re,se;const h=((q=(A=document.getElementById("sw-ev-title"))==null?void 0:A.value)==null?void 0:q.trim())??"",o=((U=document.getElementById("sw-ev-event_type"))==null?void 0:U.value)??"general",$=((F=document.getElementById("sw-ev-start"))==null?void 0:F.value)??"",C=((s=document.getElementById("sw-ev-end"))==null?void 0:s.value)??"",w=((u=document.getElementById("sw-ev-reminder"))==null?void 0:u.value)??"",v=((S=(c=document.getElementById("sw-ev-location"))==null?void 0:c.value)==null?void 0:S.trim())??"",R=((ne=(I=document.getElementById("sw-ev-description"))==null?void 0:I.value)==null?void 0:ne.trim())??"";let g=((re=document.getElementById("sw-ev-related_type"))==null?void 0:re.value)??"";const D=((se=document.getElementById("sw-ev-related_id"))==null?void 0:se.value)??"",_=o==="customer_payment"||o==="certificate_expiry";if(o==="customer_payment"&&!g&&(g="customer"),o==="certificate_expiry"&&!g&&(g="certificate"),!h)return x.showValidationMessage("El título es requerido."),!1;if(!$)return x.showValidationMessage("La fecha/hora de inicio es requerida."),!1;if(C&&C<$)return x.showValidationMessage("La fecha/hora fin no puede ser menor que inicio."),!1;if(g&&!D)return x.showValidationMessage("Selecciona un registro relacionado de la lista."),!1;if(o==="customer_payment"&&g!=="customer")return x.showValidationMessage("Los pagos deben vincularse a un cliente."),!1;const M=w?Number(w):_?1440:null;if(w&&(!Number.isFinite(M)||M<1))return x.showValidationMessage("El recordatorio debe ser un número válido."),!1;const z=_?`${$}T00:00`:$;return{event_type:o,title:h,all_day:_,start_at:new Date(z).toISOString(),end_at:_?null:C?new Date(C).toISOString():null,reminder_minutes:M,location:v||null,description:R||null,related_type:g||null,related_id:D?Number(D):null}}});return Y.isDenied?{action:"delete"}:Y.isConfirmed?{action:"save",payload:Y.value}:null},Q=e=>{const t=String(e||"").toLowerCase();return t?t.endsWith("lead")||t==="lead"?"lead":t.endsWith("customer")||t==="customer"?"customer":t.endsWith("certificado")||t==="certificate"?"certificate":null:null},oe=e=>e==="customer_payment"?["bg-emerald-600","border-emerald-700/30","dark:bg-emerald-500/70","dark:border-emerald-300/20"]:e==="certificate_expiry"?["bg-amber-600","border-amber-700/30","dark:bg-amber-500/70","dark:border-amber-300/20"]:e==="lead_followup"?["bg-indigo-600","border-indigo-700/30","dark:bg-indigo-500/70","dark:border-indigo-300/20"]:e==="meeting"?["bg-violet-600","border-violet-700/30","dark:bg-violet-500/70","dark:border-violet-300/20"]:["bg-blue-600","border-blue-700/30","dark:bg-blue-500/70","dark:border-blue-300/20"],de=ie(()=>({plugins:[pe,ve,fe],initialView:"dayGridMonth",customButtons:{prevCustom:{text:"‹",click:()=>X(-1)},nextCustom:{text:"›",click:()=>X(1)}},headerToolbar:{left:"prevCustom,nextCustom today",center:"",right:"dayGridMonth,timeGridWeek,timeGridDay"},eventDisplay:"block",eventClassNames:e=>{var t,a;return["rounded-md","px-2","py-1","text-xs","font-semibold","text-white","shadow-sm","border",...oe(((a=(t=e==null?void 0:e.event)==null?void 0:t.extendedProps)==null?void 0:a.event_type)||"general")]},selectable:!0,editable:!0,eventTimeFormat:{hour:"2-digit",minute:"2-digit",meridiem:!1},datesSet:e=>Z(e.view),events:async(e,t,a)=>{var r;try{const n=await k.get("/calendar/events",{params:{start:e.startStr,end:e.endStr}});t(((r=n==null?void 0:n.data)==null?void 0:r.data)??[])}catch(n){B("No se pudo cargar el calendario"),a(n)}},dateClick:async e=>{var l,d,i;const t=new Date(e.date),a=new Date(e.date);a.setHours(a.getHours()+1);const r=await H({start_at:N(t),end_at:N(a)});if(!r||r.action!=="save")return;const n=r.payload;p.value=!0;try{const m=await k.post("/calendar/events",n),f=((l=m.data)==null?void 0:l.data)||m.data;P("Evento creado"),e.view.calendar.refetchEvents(),f&&f.id&&O({id:f.id,title:n.title,description:n.description,start_at:n.start_at,end_at:n.end_at,reminder_minutes:n.reminder_minutes})}catch(m){B(((i=(d=m==null?void 0:m.response)==null?void 0:d.data)==null?void 0:i.message)??"No se pudo crear el evento")}finally{p.value=!1}},eventClick:async e=>{var l,d,i,m;const t=e.event,a=t.extendedProps||{},r=await H({event_type:a.event_type??"general",is_existing:!0,title:t.title,start_at:N(t.start),end_at:N(t.end),reminder_minutes:a.reminder_minutes??"",location:a.location??"",description:a.description??"",related_type:Q(a.related_type)||"",related_id:a.related_id??"",allowDelete:le.value});if(!r)return;if(r.action==="delete"){if(!await ye({title:"Eliminar evento",text:"Esta acción no se puede deshacer.",confirmText:"Eliminar"}))return;p.value=!0;try{await k.delete(`/calendar/events/${t.id}`),P("Evento eliminado"),e.view.calendar.refetchEvents(),ae(t.id)}catch(y){B(((d=(l=y==null?void 0:y.response)==null?void 0:l.data)==null?void 0:d.message)??"No se pudo eliminar el evento")}finally{p.value=!1}return}if(r.action!=="save")return;const n=r.payload;p.value=!0;try{await k.put(`/calendar/events/${t.id}`,n),P("Evento actualizado"),e.view.calendar.refetchEvents(),ae(t.id),O({id:t.id,title:n.title,description:n.description,start_at:n.start_at,end_at:n.end_at,reminder_minutes:n.reminder_minutes})}catch(f){B(((m=(i=f==null?void 0:f.response)==null?void 0:i.data)==null?void 0:m.message)??"No se pudo actualizar el evento")}finally{p.value=!1}},eventDrop:async e=>{var r,n,l,d;const t=e.event,a=t.extendedProps||{};p.value=!0;try{await k.put(`/calendar/events/${t.id}`,{title:t.title,start_at:(r=t.start)==null?void 0:r.toISOString(),end_at:((n=t.end)==null?void 0:n.toISOString())??null,reminder_minutes:a.reminder_minutes??null,location:a.location??null,description:a.description??null,event_type:a.event_type??"general",related_type:Q(a.related_type),related_id:a.related_id??null}),P("Evento movido")}catch(i){e.revert(),B(((d=(l=i==null?void 0:i.response)==null?void 0:l.data)==null?void 0:d.message)??"No se pudo mover el evento")}finally{p.value=!1}},eventResize:async e=>{var r,n,l,d;const t=e.event,a=t.extendedProps||{};p.value=!0;try{await k.put(`/calendar/events/${t.id}`,{title:t.title,start_at:(r=t.start)==null?void 0:r.toISOString(),end_at:((n=t.end)==null?void 0:n.toISOString())??null,reminder_minutes:a.reminder_minutes??null,location:a.location??null,description:a.description??null,event_type:a.event_type??"general",related_type:Q(a.related_type),related_id:a.related_id??null}),P("Evento actualizado")}catch(i){e.revert(),B(((d=(l=i==null?void 0:i.response)==null?void 0:l.data)==null?void 0:d.message)??"No se pudo actualizar el evento")}finally{p.value=!1}}})),ce=async()=>{var n,l,d;const e=new Date,t=new Date(e);t.setHours(t.getHours()+1);const a=await H({start_at:N(e),end_at:N(t)});if(!a||a.action!=="save")return;const r=a.payload;p.value=!0;try{const i=await k.post("/calendar/events",r),m=((n=i.data)==null?void 0:n.data)||i.data;P("Evento creado"),j(),m&&m.id&&O({id:m.id,title:r.title,description:r.description,start_at:r.start_at,end_at:r.end_at,reminder_minutes:r.reminder_minutes})}catch(i){B(((d=(l=i==null?void 0:i.response)==null?void 0:l.data)==null?void 0:d.message)??"No se pudo crear el evento")}finally{p.value=!1}},ee=e=>{if(!e)return null;const t=new Date(e);if(!Number.isNaN(t.getTime()))return t;const a=new Date(String(e).replace(" ","T"));return Number.isNaN(a.getTime())?null:a},ue=async()=>{var G,E,b;const e=new URL(window.location.href),t=e.searchParams.get("related_type")||"",a=e.searchParams.get("related_id")||"",r=e.searchParams.get("title")||"",n=e.searchParams.get("description")||"";if(!t&&!a&&!r&&!n)return;const l=ee(e.searchParams.get("start")),d=ee(e.searchParams.get("end")),i=l??new Date,m=d??new Date(i.getTime()+3600*1e3),f=await H({event_type:t==="lead"?"lead_followup":"general",title:r||"",start_at:N(i),end_at:N(m),related_type:t,related_id:a,description:n});if(e.searchParams.delete("related_type"),e.searchParams.delete("related_id"),e.searchParams.delete("title"),e.searchParams.delete("description"),e.searchParams.delete("start"),e.searchParams.delete("end"),window.history.replaceState({},"",e.pathname+e.search),!f||f.action!=="save")return;const y=f.payload;p.value=!0;try{const T=await k.post("/calendar/events",y),x=((G=T.data)==null?void 0:G.data)||T.data;P("Evento creado"),j(),x&&x.id&&O({id:x.id,title:y.title,description:y.description,start_at:y.start_at,end_at:y.end_at,reminder_minutes:y.reminder_minutes})}catch(T){B(((b=(E=T==null?void 0:T.response)==null?void 0:E.data)==null?void 0:b.message)??"No se pudo crear el evento")}finally{p.value=!1}},te=()=>j(),O=e=>{if(!window.CalendarNotifications||!e)return;const t={id:e.id,title:e.title,description:e.description||"",start_datetime:e.start_at,end_datetime:e.end_at,start_time:new Date(e.start_at).toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"}),reminder_minutes:e.reminder_minutes};t.reminder_minutes&&t.reminder_minutes>0?window.CalendarNotifications.setReminderTimes([t.reminder_minutes]):window.CalendarNotifications.setReminderTimes([15,5]),window.CalendarNotifications.scheduleReminders(t)},ae=e=>{window.CalendarNotifications&&e&&window.CalendarNotifications.cancelReminders(e)};return be(()=>{window.addEventListener("calendar:refetch",te),we(()=>{var t,a;const e=(a=(t=V.value)==null?void 0:t.getApi)==null?void 0:a.call(t);e&&e.gotoDate(new Date),Z(),Promise.resolve().then(()=>{window.CalendarNotifications&&window.CalendarNotifications.init()}),ue()})}),_e(()=>{window.removeEventListener("calendar:refetch",te)}),(e,t)=>(he(),xe("div",Se,[L("div",Ne,[t[0]||(t[0]=L("div",null,[L("div",{class:"text-sm font-semibold text-gray-900 dark:text-slate-100"},"Calendario"),L("div",{class:"mt-1 text-xs text-gray-600 dark:text-slate-300"},"Tu agenda personal (solo tú la ves).")],-1)),L("button",{type:"button",class:"inline-flex items-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700 disabled:opacity-60",disabled:p.value,onClick:ce}," Nuevo evento ",8,Te)]),L("div",Ce,[L("div",Be,ke(K.value),1),Ee($e(ge),{ref_key:"calendarRef",ref:V,options:de.value},null,8,["options"])])]))}};export{He as default};
