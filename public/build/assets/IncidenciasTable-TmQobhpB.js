import{r as i,e as Z,o as ee,f as te,I as ae,g as c,i as u,j as a,k,w as q,s as se,t as o,D as re,n as O,y as Q,F as j,l as F}from"./vendor-vue-CzwclP9t.js";import{a as E}from"./vendor-utils-Czy7fllw.js";import{a as B,t as V,c as oe}from"./App-QtNM8dfD.js";import"./app-DH9r4SNu.js";import"./vendor-ui-E6c-3yld.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const ne={class:"mb-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between"},de={class:"flex-1"},le={class:"flex items-center gap-2"},ie=["disabled"],ce={class:"mb-4 overflow-x-auto"},ue={class:"inline-flex rounded-lg border border-gray-200 bg-white p-1 shadow-sm dark:border-slate-800 dark:bg-slate-900"},pe={class:"ml-2 rounded bg-black/5 px-2 py-0.5 text-xs font-semibold text-gray-700 dark:bg-white/10 dark:text-slate-200"},ge=["onClick"],ve={class:"ml-2 rounded bg-black/5 px-2 py-0.5 text-xs font-semibold text-gray-700 dark:bg-white/10 dark:text-slate-200"},be={key:0,class:"mb-4 rounded-lg border border-red-200 bg-red-50 p-3 text-sm text-red-700 dark:border-red-900/40 dark:bg-red-950/30 dark:text-red-200"},me={class:"bg-white border border-gray-200 rounded-lg shadow-sm dark:bg-slate-900 dark:border-slate-800"},xe={class:"p-4 border-b border-gray-200 dark:border-slate-800 flex items-center justify-between"},ye={class:"mt-1 text-xs text-gray-600 dark:text-slate-300"},he={key:0},fe={key:0,class:"text-xs text-gray-600 dark:text-slate-300"},_e={class:"overflow-x-auto"},ke={class:"min-w-[1300px] w-full text-sm text-left text-gray-700 dark:text-slate-200"},we={class:"px-4 py-3 font-medium text-gray-900 dark:text-slate-100"},Ce={class:"px-4 py-3"},Se={class:"px-4 py-3"},Ie=["value","disabled","onChange"],Ne=["value"],Te={class:"px-4 py-3"},Ee={class:"flex items-center gap-2"},De=["disabled","onClick"],Le=["disabled","onClick"],Ae={class:"px-4 py-3"},$e={class:"px-4 py-3"},je={key:0},Fe={key:1,class:"text-gray-500 dark:text-slate-400"},Be={class:"px-4 py-3"},Ve={class:"px-4 py-3"},ze={class:"px-4 py-3"},Me={class:"px-4 py-3"},Ue={key:0},Pe={class:"p-4 flex items-center justify-between gap-3"},qe=["disabled"],Oe={class:"text-xs text-gray-600 dark:text-slate-300"},Qe=["disabled"],Ye={__name:"IncidenciasTable",setup(Re){const w=i([]),m=i([]),z=i(0),x=i(!1),b=i(""),D=i(new Set),C=i(new Set),S=i(null),I=i(!1),N=i(""),L=i("");let h=null;const A=i(15),y=i(null),n=i({current_page:1,last_page:1,per_page:15,total:0,from:0,to:0}),R=()=>{const t=new URL(window.location.href).searchParams.get("q");t&&(N.value=t,L.value=t)},f=({stageId:e=y.value,page:t=n.value.current_page}={})=>{y.value=e===void 0?y.value:e,n.value.current_page=t,_()},_=async()=>{var e,t,s;x.value=!0,b.value="";try{const r=await E.get("/incidencias/data",{params:{stage_id:y.value,q:L.value||"",page:n.value.current_page,per_page:A.value}}),d=((e=r==null?void 0:r.data)==null?void 0:e.data)??{};w.value=d.stages??[],z.value=d.total_count??0,m.value=d.incidences??[],n.value={...n.value,...d.pagination||{}}}catch(r){const d=((s=(t=r==null?void 0:r.response)==null?void 0:t.data)==null?void 0:s.message)??"No se pudo cargar incidencias.";b.value=d}finally{x.value=!1}},G=()=>{var e,t;(t=(e=S.value)==null?void 0:e.click)==null||t.call(e)},H=async e=>{var s,r,d,p,v;const t=(r=(s=e==null?void 0:e.target)==null?void 0:s.files)==null?void 0:r[0];if(t){I.value=!0,b.value="";try{const l=new FormData;l.append("csv",t);const{data:g}=await E.post("/incidencias/import",l,{headers:{"Content-Type":"multipart/form-data"}});B(((d=g==null?void 0:g.output)!=null&&d.trim(),"Importación finalizada")),n.value.current_page=1,await _()}catch(l){const g=((v=(p=l==null?void 0:l.response)==null?void 0:p.data)==null?void 0:v.message)??"No se pudo importar el CSV.";b.value=g,V(g)}finally{I.value=!1,S.value&&(S.value.value="")}}},J=Z(()=>{const e=new Map;for(const t of w.value)e.set(t.id,t);return e}),$=e=>!!(e!=null&&e.archived_at),K=e=>{e!=null&&e.id&&window.dispatchEvent(new CustomEvent("incidencias:edit",{detail:{incidence:e}}))},M=e=>{if(!e||$(e))return!1;const t=J.value.get(e.stage_id);return!!(t!=null&&t.is_done)},W=async(e,t)=>{var r,d,p,v;const s=Number((r=t==null?void 0:t.target)==null?void 0:r.value);if(!(!(e!=null&&e.id)||!Number.isFinite(s))){D.value.add(e.id),b.value="";try{const l=await E.patch(`/incidencias/${e.id}/move-stage`,{stage_id:s}),g=(d=l==null?void 0:l.data)==null?void 0:d.data;g&&typeof g=="object"?Object.assign(e,g):e.stage_id=s,B("Incidencia actualizada")}catch(l){const g=((v=(p=l==null?void 0:l.response)==null?void 0:p.data)==null?void 0:v.message)??"No se pudo mover la incidencia.";b.value=g,V(g)}finally{D.value.delete(e.id)}}},X=async e=>{var s,r,d;if(!(!(e!=null&&e.id)||!M(e)||!await oe({title:"Archivar incidencia",text:"Se ocultará del backlog, pero seguirá visible en la tabla (historial).",confirmText:"Archivar",cancelText:"Cancelar",icon:"warning"}))){C.value.add(e.id),b.value="";try{const p=await E.patch(`/incidencias/${e.id}/archive`),v=(s=p==null?void 0:p.data)==null?void 0:s.data;v&&typeof v=="object"?Object.assign(e,v):e.archived_at=new Date().toISOString(),B("Incidencia archivada"),window.dispatchEvent(new CustomEvent("incidencias:archived"))}catch(p){const v=((d=(r=p==null?void 0:p.response)==null?void 0:r.data)==null?void 0:d.message)??"No se pudo archivar la incidencia.";b.value=v,V(v)}finally{C.value.delete(e.id)}}},Y=e=>{if(!e)return"";try{const t=new Date(String(e));return Number.isNaN(t.getTime())?String(e):t.toLocaleDateString()}catch{return String(e)}},U=e=>{if(!e)return"";try{const t=new Date(String(e));return Number.isNaN(t.getTime())?String(e):t.toLocaleString()}catch{return String(e)}},T=()=>{n.value.current_page=1,_()},P=e=>{var r;const t=(r=e==null?void 0:e.detail)==null?void 0:r.incidence;if(!(t!=null&&t.id))return;const s=m.value.findIndex(d=>d.id===t.id);s!==-1&&m.value.splice(s,1,{...m.value[s],...t})};return ee(async()=>{R(),window.addEventListener("incidencias:created",T),window.addEventListener("incidencias:archived",T),window.addEventListener("incidencias:updated",P),await _()}),te(()=>{window.removeEventListener("incidencias:created",T),window.removeEventListener("incidencias:archived",T),window.removeEventListener("incidencias:updated",P),h&&window.clearTimeout(h)}),ae(N,e=>{h&&window.clearTimeout(h),h=window.setTimeout(()=>{L.value=e,n.value.current_page=1,_()},350)},{flush:"post"}),(e,t)=>(u(),c("section",null,[a("div",ne,[a("div",de,[t[6]||(t[6]=a("label",{class:"sr-only",for:"inc-search"},"Buscar",-1)),q(a("input",{id:"inc-search","onUpdate:modelValue":t[0]||(t[0]=s=>N.value=s),type:"search",placeholder:"Buscar por título, correlativo, cliente…",class:"w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900 placeholder:text-gray-400 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:placeholder:text-slate-500"},null,512),[[se,N.value]])]),a("div",le,[a("input",{ref_key:"importInput",ref:S,type:"file",accept:".csv,text/csv",class:"hidden",onChange:H},null,544),a("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:I.value,onClick:G},o(I.value?"Importando…":"Importar CSV"),9,ie),q(a("select",{"onUpdate:modelValue":t[1]||(t[1]=s=>A.value=s),class:"rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100",onChange:t[2]||(t[2]=s=>f({page:1}))},[...t[7]||(t[7]=[a("option",{value:10},"10",-1),a("option",{value:15},"15",-1),a("option",{value:25},"25",-1),a("option",{value:50},"50",-1)])],544),[[re,A.value,void 0,{number:!0}]])])]),a("div",ce,[a("div",ue,[a("button",{type:"button",class:O(["px-3 py-2 text-sm font-medium rounded-md transition",y.value===null?"bg-blue-600 text-white":"text-gray-700 hover:bg-gray-50 dark:text-slate-200 dark:hover:bg-slate-800"]),onClick:t[3]||(t[3]=s=>f({stageId:null,page:1}))},[t[8]||(t[8]=Q(" Todos ",-1)),a("span",pe,o(z.value),1)],2),(u(!0),c(j,null,F(w.value,s=>(u(),c("button",{key:s.id,type:"button",class:O(["px-3 py-2 text-sm font-medium rounded-md transition",y.value===s.id?"bg-blue-600 text-white":"text-gray-700 hover:bg-gray-50 dark:text-slate-200 dark:hover:bg-slate-800"]),onClick:r=>f({stageId:s.id,page:1})},[Q(o(s.name)+" ",1),a("span",ve,o(s.count??0),1)],10,ge))),128))])]),b.value?(u(),c("div",be,o(b.value),1)):k("",!0),a("div",me,[a("div",xe,[a("div",null,[t[9]||(t[9]=a("div",{class:"text-sm font-semibold text-gray-900 dark:text-slate-100"},"Incidencias",-1)),a("div",ye,[n.value.total!==null?(u(),c("span",he," Mostrando "+o(n.value.from??0)+"–"+o(n.value.to??0)+" de "+o(n.value.total??0),1)):k("",!0)])]),x.value?(u(),c("div",fe,"Cargando…")):k("",!0)]),a("div",_e,[a("table",ke,[t[11]||(t[11]=a("thead",{class:"text-xs uppercase bg-gray-50 text-gray-700 dark:bg-slate-800 dark:text-slate-200"},[a("tr",null,[a("th",{class:"px-4 py-3"},"ID"),a("th",{class:"px-4 py-3"},"Correlativo"),a("th",{class:"px-4 py-3"},"Columna"),a("th",{class:"px-4 py-3"},"Acciones"),a("th",{class:"px-4 py-3"},"Título"),a("th",{class:"px-4 py-3"},"Cliente"),a("th",{class:"px-4 py-3"},"Prioridad"),a("th",{class:"px-4 py-3"},"Fecha"),a("th",{class:"px-4 py-3"},"Archivado"),a("th",{class:"px-4 py-3"},"Actualizado")])],-1)),a("tbody",null,[(u(!0),c(j,null,F(m.value,s=>(u(),c("tr",{key:s.id,class:"border-b border-gray-100 bg-white hover:bg-blue-50/40 transition-colors dark:border-slate-800 dark:bg-slate-900 dark:hover:bg-slate-800/60"},[a("td",we,o(s.id),1),a("td",Ce,o(s.correlative||"—"),1),a("td",Se,[a("select",{value:s.stage_id,class:"w-full rounded-lg border border-gray-200 bg-white px-2 py-1.5 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 disabled:opacity-60 dark:border-slate-800 dark:bg-slate-950 dark:text-slate-100",disabled:D.value.has(s.id)||$(s),onChange:r=>W(s,r)},[(u(!0),c(j,null,F(w.value,r=>(u(),c("option",{key:r.id,value:r.id},o(r.name),9,Ne))),128))],40,Ie)]),a("td",Te,[a("div",Ee,[a("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:$(s),onClick:r=>K(s)}," Editar ",8,De),M(s)?(u(),c("button",{key:0,type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:C.value.has(s.id),onClick:r=>X(s)},o(C.value.has(s.id)?"Archivando…":"Archivar"),9,Le)):k("",!0)])]),a("td",Ae,o(s.title??""),1),a("td",$e,[s.customer?(u(),c("span",je,o(s.customer.company_name||s.customer.name),1)):(u(),c("span",Fe,"—"))]),a("td",Be,o(s.priority??""),1),a("td",Ve,o(Y(s.date)),1),a("td",ze,o(U(s.archived_at)),1),a("td",Me,o(U(s.updated_at)),1)]))),128)),!x.value&&m.value.length===0?(u(),c("tr",Ue,[...t[10]||(t[10]=[a("td",{colspan:"10",class:"px-4 py-10 text-center text-sm text-gray-600 dark:text-slate-300"}," Sin incidencias. ",-1)])])):k("",!0)])])]),a("div",Pe,[a("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:x.value||n.value.current_page<=1,onClick:t[4]||(t[4]=s=>f({page:n.value.current_page-1}))}," Anterior ",8,qe),a("div",Oe," Página "+o(n.value.current_page)+" / "+o(n.value.last_page),1),a("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:x.value||n.value.current_page>=n.value.last_page,onClick:t[5]||(t[5]=s=>f({page:n.value.current_page+1}))}," Siguiente ",8,Qe)])])]))}};export{Ye as default};
