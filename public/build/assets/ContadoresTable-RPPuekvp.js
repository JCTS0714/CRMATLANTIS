import{r as p,o as B,f as j,H as A,g as m,i as g,j as t,k as D,w as F,x as L,t as i,n as U,z as P,F as q,m as H}from"./vendor-vue-Db-AqoDh.js";import{a as x}from"./vendor-utils-Czy7fllw.js";import{e as O,a as y,t as k,f as R,c as G}from"./App-D_XY1sJF.js";import"./app-CglYj3fU.js";import"./vendor-ui-DEm6YKEA.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const J={class:"p-4"},K={class:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between"},Q={class:"w-full sm:max-w-md"},W={class:"flex items-center gap-2"},X={class:"text-sm text-slate-600 dark:text-slate-300"},Y={key:0},Z={key:1},tt={key:0,class:"mt-2 text-sm text-slate-600 dark:text-slate-300"},et={class:"mt-4 overflow-x-auto rounded-lg border border-slate-200 bg-white dark:border-slate-800 dark:bg-slate-900"},at={class:"min-w-full text-left text-sm text-slate-700 dark:text-slate-200"},st={class:"px-4 py-3 font-medium text-slate-900 dark:text-slate-100"},ot={class:"px-4 py-3"},rt={class:"px-4 py-3"},lt={class:"px-4 py-3"},dt={class:"px-4 py-3"},nt={class:"px-4 py-3"},it={class:"px-4 py-3"},ct={class:"flex items-center gap-2"},pt=["disabled","onClick"],ut=["disabled","onClick"],mt={class:"mt-4 flex items-center justify-between"},gt=["disabled"],bt={class:"text-sm text-slate-600 dark:text-slate-300"},xt=["disabled"],Ct={__name:"ContadoresTable",setup(vt){const v=p([]),h=p(!1),w=p(new Set),C=p(new Set),_=p("");let S=null;const E=p(!1),b=p(""),o=p({current_page:1,last_page:1,per_page:15,total:0,from:0,to:0}),u=async(e=1)=>{h.value=!0;try{const{data:s}=await x.get("/postventa/contadores/data",{params:{q:_.value||"",per_page:o.value.per_page,page:e}});v.value=s.contadores||[],o.value={...o.value,...s.pagination||{}}}finally{h.value=!1}},T=e=>{const s=Math.max(1,Math.min(o.value.last_page||1,e));u(s)},z=async e=>{var a,r,l,n;const s=(r=(a=e==null?void 0:e.target)==null?void 0:a.files)==null?void 0:r[0];if(e!=null&&e.target&&(e.target.value=""),!!s){E.value=!0,b.value="Importando...";try{const d=new FormData;d.append("csv",s);const{data:c}=await x.post("/postventa/contadores/import",d,{headers:{"Content-Type":"multipart/form-data"}}),f=((c==null?void 0:c.output)??"").trim();b.value=f!==""?f:"Importación finalizada.",y("Importación finalizada"),u(1)}catch(d){const c=((n=(l=d==null?void 0:d.response)==null?void 0:l.data)==null?void 0:n.message)??"No se pudo importar el CSV.";b.value=c,k(c)}finally{E.value=!1}}},M=async()=>{var s,a;const e=await O();if(e)try{await x.post("/postventa/contadores",e),y("Contador creado"),u(1)}catch(r){const l=((a=(s=r==null?void 0:r.response)==null?void 0:s.data)==null?void 0:a.message)??"No se pudo crear el contador.";k(l)}},V=async e=>{var a,r,l;if(!(e!=null&&e.id))return;const s=await R(e);if(s){w.value.add(e.id);try{const n=await x.put(`/postventa/contadores/${e.id}`,s),d=(a=n==null?void 0:n.data)==null?void 0:a.data,c=Array.isArray(d==null?void 0:d.customers)?d.customers.map(I=>({id:I.id,name:I.name})):[],f=c[0]??null;Object.assign(e,{...s,customer:f,customers:c}),y("Contador actualizado")}catch(n){const d=((l=(r=n==null?void 0:n.response)==null?void 0:r.data)==null?void 0:l.message)??"No se pudo actualizar el contador.";k(d)}finally{w.value.delete(e.id)}}},$=async e=>{var a,r;if(!(!(e!=null&&e.id)||!await G({title:"Eliminar contador",text:"Se eliminará el contador y su asignación a cliente (si existe).",confirmText:"Eliminar",cancelText:"Cancelar",icon:"warning"}))){C.value.add(e.id);try{await x.delete(`/postventa/contadores/${e.id}`),v.value=v.value.filter(l=>l.id!==e.id),y("Contador eliminado"),u(Math.min(o.value.current_page,o.value.last_page||1))}catch(l){const n=((r=(a=l==null?void 0:l.response)==null?void 0:a.data)==null?void 0:r.message)??"No se pudo eliminar el contador.";k(n)}finally{C.value.delete(e.id)}}},N=()=>M();return B(()=>{window.addEventListener("contadores:create",N)}),j(()=>{window.removeEventListener("contadores:create",N)}),A(_,()=>{S&&clearTimeout(S),S=setTimeout(()=>{u(1)},300)},{flush:"post"}),u(1),(e,s)=>(g(),m("div",J,[t("div",K,[t("div",Q,[F(t("input",{"onUpdate:modelValue":s[0]||(s[0]=a=>_.value=a),type:"text",class:"w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 focus:border-sky-500 focus:ring-sky-500 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100",placeholder:"Buscar contador (nro, comercio, nombre, usuario, servidor…)"},null,512),[[L,_.value]])]),t("div",W,[t("div",X,[o.value.total?(g(),m("span",Y,"Mostrando "+i(o.value.from)+"–"+i(o.value.to)+" de "+i(o.value.total),1)):(g(),m("span",Z,"Sin resultados"))]),t("label",{class:U(["inline-flex cursor-pointer items-center rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 disabled:cursor-not-allowed disabled:opacity-50 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",E.value?"pointer-events-none opacity-50":""])},[t("input",{type:"file",class:"hidden",accept:".csv,.txt,text/csv",onChange:z},null,32),s[3]||(s[3]=P(" Importar CSV ",-1))],2)])]),b.value?(g(),m("div",tt,i(b.value),1)):D("",!0),t("div",et,[t("table",at,[s[4]||(s[4]=t("thead",{class:"bg-slate-50 text-xs uppercase text-slate-600 dark:bg-slate-800 dark:text-slate-200"},[t("tr",null,[t("th",{class:"px-4 py-3"},"Nro"),t("th",{class:"px-4 py-3"},"Comercio"),t("th",{class:"px-4 py-3"},"Nombre"),t("th",{class:"px-4 py-3"},"Cliente"),t("th",{class:"px-4 py-3"},"Usuario"),t("th",{class:"px-4 py-3"},"Servidor"),t("th",{class:"px-4 py-3"},"Acciones")])],-1)),t("tbody",null,[(g(!0),m(q,null,H(v.value,a=>{var r;return g(),m("tr",{key:a.id,class:"border-t border-slate-200 hover:bg-slate-50 dark:border-slate-800 dark:hover:bg-slate-800"},[t("td",st,i(a.nro||"—"),1),t("td",ot,i(a.comercio||"—"),1),t("td",rt,i(a.nom_contador||"—"),1),t("td",lt,i(((r=a.customer)==null?void 0:r.name)||"—"),1),t("td",dt,i(a.usuario||"—"),1),t("td",nt,i(a.servidor||"—"),1),t("td",it,[t("div",ct,[t("button",{type:"button",class:"inline-flex items-center rounded-lg border border-slate-300 bg-white px-3 py-1.5 text-xs font-medium text-slate-700 hover:bg-slate-50 disabled:opacity-60 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:w.value.has(a.id),onClick:l=>V(a)}," Editar ",8,pt),t("button",{type:"button",class:"inline-flex items-center rounded-lg border border-red-200 bg-white px-3 py-1.5 text-xs font-medium text-red-700 hover:bg-red-50 disabled:opacity-60 dark:border-red-900/40 dark:bg-slate-900 dark:text-red-300 dark:hover:bg-red-950/30",disabled:C.value.has(a.id),onClick:l=>$(a)}," Eliminar ",8,ut)])])])}),128))])])]),t("div",mt,[t("button",{class:"rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 disabled:cursor-not-allowed disabled:opacity-50 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:o.value.current_page<=1||h.value,onClick:s[1]||(s[1]=a=>T(o.value.current_page-1))}," Anterior ",8,gt),t("div",bt," Página "+i(o.value.current_page)+" / "+i(o.value.last_page),1),t("button",{class:"rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 disabled:cursor-not-allowed disabled:opacity-50 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:o.value.current_page>=o.value.last_page||h.value,onClick:s[2]||(s[2]=a=>T(o.value.current_page+1))}," Siguiente ",8,xt)])]))}};export{Ct as default};
