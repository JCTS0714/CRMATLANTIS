import{r as c,e as se,o as re,f as ne,H as oe,g as l,i,j as s,k as w,w as O,x as de,t as d,D as le,n as Q,z,F,m as U}from"./vendor-vue-Db-AqoDh.js";import{a as C}from"./vendor-utils-Czy7fllw.js";import{a as L,t as A,c as R}from"./App-qLal-Xme.js";import"./app-Wix60hZj.js";import"./vendor-ui-DEm6YKEA.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const ie={class:"mb-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between"},ce={class:"flex-1"},ue={class:"flex items-center gap-2"},pe=["disabled"],ge={class:"mb-4 overflow-x-auto"},ve={class:"inline-flex rounded-lg border border-gray-200 bg-white p-1 shadow-sm dark:border-slate-800 dark:bg-slate-900"},me={class:"ml-2 rounded bg-black/5 px-2 py-0.5 text-xs font-semibold text-gray-700 dark:bg-white/10 dark:text-slate-200"},be=["onClick"],xe={class:"ml-2 rounded bg-black/5 px-2 py-0.5 text-xs font-semibold text-gray-700 dark:bg-white/10 dark:text-slate-200"},ye={key:0,class:"mb-4 rounded-lg border border-red-200 bg-red-50 p-3 text-sm text-red-700 dark:border-red-900/40 dark:bg-red-950/30 dark:text-red-200"},he={class:"bg-white border border-gray-200 rounded-lg shadow-sm dark:bg-slate-900 dark:border-slate-800"},fe={class:"p-4 border-b border-gray-200 dark:border-slate-800 flex items-center justify-between"},ke={class:"mt-1 text-xs text-gray-600 dark:text-slate-300"},_e={key:0},we={key:0,class:"text-xs text-gray-600 dark:text-slate-300"},Ce={class:"overflow-x-auto"},Se={class:"min-w-[1300px] w-full text-sm text-left text-gray-700 dark:text-slate-200"},Ie={class:"px-4 py-3 font-medium text-gray-900 dark:text-slate-100"},Ee={class:"px-4 py-3"},Te={class:"px-4 py-3"},Ne=["value","disabled","onChange"],De=["value"],$e={class:"px-4 py-3"},Le={class:"flex items-center gap-2"},Ae=["disabled","onClick"],je=["disabled","onClick"],Be=["disabled","onClick"],Me={key:0,class:"w-3 h-3 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},Ve={key:1,class:"w-3 h-3 mr-1 animate-spin",fill:"none",viewBox:"0 0 24 24"},ze={class:"px-4 py-3"},Fe={class:"px-4 py-3"},Ue={key:0},Pe={key:1,class:"text-gray-500 dark:text-slate-400"},qe={class:"px-4 py-3"},He={class:"px-4 py-3"},Oe={class:"px-4 py-3"},Qe={class:"px-4 py-3"},Re={key:0},Ge={class:"p-4 flex items-center justify-between gap-3"},Je=["disabled"],Ke={class:"text-xs text-gray-600 dark:text-slate-300"},We=["disabled"],rt={__name:"IncidenciasTable",setup(Xe){const S=c([]),b=c([]),I=c(0),x=c(!1),v=c(""),j=c(new Set),E=c(new Set),f=c(new Set),T=c(null),N=c(!1),D=c(""),B=c("");let k=null;const M=c(15),y=c(null),o=c({current_page:1,last_page:1,per_page:15,total:0,from:0,to:0}),G=()=>{const t=new URL(window.location.href).searchParams.get("q");t&&(D.value=t,B.value=t)},_=({stageId:e=y.value,page:t=o.value.current_page}={})=>{y.value=e===void 0?y.value:e,o.value.current_page=t,h()},h=async()=>{var e,t,a;x.value=!0,v.value="";try{const r=await C.get("/incidencias/data",{params:{stage_id:y.value,q:B.value||"",page:o.value.current_page,per_page:M.value}}),n=((e=r==null?void 0:r.data)==null?void 0:e.data)??{};S.value=n.stages??[],I.value=n.total_count??0,b.value=n.incidences??[],o.value={...o.value,...n.pagination||{}}}catch(r){const n=((a=(t=r==null?void 0:r.response)==null?void 0:t.data)==null?void 0:a.message)??"No se pudo cargar incidencias.";v.value=n}finally{x.value=!1}},J=()=>{var e,t;(t=(e=T.value)==null?void 0:e.click)==null||t.call(e)},K=async e=>{var a,r,n,p,m;const t=(r=(a=e==null?void 0:e.target)==null?void 0:a.files)==null?void 0:r[0];if(t){N.value=!0,v.value="";try{const u=new FormData;u.append("csv",t);const{data:g}=await C.post("/incidencias/import",u,{headers:{"Content-Type":"multipart/form-data"}});L(((n=g==null?void 0:g.output)!=null&&n.trim(),"Importación finalizada")),o.value.current_page=1,await h()}catch(u){const g=((m=(p=u==null?void 0:u.response)==null?void 0:p.data)==null?void 0:m.message)??"No se pudo importar el CSV.";v.value=g,A(g)}finally{N.value=!1,T.value&&(T.value.value="")}}},W=se(()=>{const e=new Map;for(const t of S.value)e.set(t.id,t);return e}),V=e=>!!(e!=null&&e.archived_at),X=e=>{e!=null&&e.id&&window.dispatchEvent(new CustomEvent("incidencias:edit",{detail:{incidence:e}}))},P=e=>{if(!e||V(e))return!1;const t=W.value.get(e.stage_id);return!!(t!=null&&t.is_done)},Y=async(e,t)=>{var r,n,p,m;const a=Number((r=t==null?void 0:t.target)==null?void 0:r.value);if(!(!(e!=null&&e.id)||!Number.isFinite(a))){j.value.add(e.id),v.value="";try{const u=await C.patch(`/incidencias/${e.id}/move-stage`,{stage_id:a}),g=(n=u==null?void 0:u.data)==null?void 0:n.data;g&&typeof g=="object"?Object.assign(e,g):e.stage_id=a,L("Incidencia actualizada")}catch(u){const g=((m=(p=u==null?void 0:u.response)==null?void 0:p.data)==null?void 0:m.message)??"No se pudo mover la incidencia.";v.value=g,A(g)}finally{j.value.delete(e.id)}}},Z=async e=>{var a,r,n;if(!(!(e!=null&&e.id)||!P(e)||!await R({title:"Archivar incidencia",text:"Se ocultará del backlog, pero seguirá visible en la tabla (historial).",confirmText:"Archivar",cancelText:"Cancelar",icon:"warning"}))){E.value.add(e.id),v.value="";try{const p=await C.patch(`/incidencias/${e.id}/archive`),m=(a=p==null?void 0:p.data)==null?void 0:a.data;m&&typeof m=="object"?Object.assign(e,m):e.archived_at=new Date().toISOString(),L("Incidencia archivada"),window.dispatchEvent(new CustomEvent("incidencias:archived"))}catch(p){const m=((n=(r=p==null?void 0:p.response)==null?void 0:r.data)==null?void 0:n.message)??"No se pudo archivar la incidencia.";v.value=m,A(m)}finally{E.value.delete(e.id)}}},ee=async e=>{await R({title:"¿Eliminar incidencia?",text:`Se eliminará permanentemente "${e.title||`#${e.correlative}`}"`,confirmText:"Sí, eliminar",cancelText:"Cancelar",icon:"warning"})&&await te(e)},te=async e=>{var t,a;f.value.add(e.id),v.value="";try{await C.delete(`/incidencias/${e.id}`);const r=b.value.findIndex(n=>n.id===e.id);if(r!==-1&&(b.value.splice(r,1),I.value=Math.max(0,I.value-1),b.value.length===0&&o.value.current_page>1)){o.value.current_page--,h();return}L("Incidencia eliminada exitosamente"),window.dispatchEvent(new CustomEvent("incidencias:deleted"))}catch(r){const n=((a=(t=r==null?void 0:r.response)==null?void 0:t.data)==null?void 0:a.message)??"No se pudo eliminar la incidencia.";v.value=n,A(n)}finally{f.value.delete(e.id)}},ae=e=>{if(!e)return"";try{const t=new Date(String(e));return Number.isNaN(t.getTime())?String(e):t.toLocaleDateString()}catch{return String(e)}},q=e=>{if(!e)return"";try{const t=new Date(String(e));return Number.isNaN(t.getTime())?String(e):t.toLocaleString()}catch{return String(e)}},$=()=>{o.value.current_page=1,h()},H=e=>{var r;const t=(r=e==null?void 0:e.detail)==null?void 0:r.incidence;if(!(t!=null&&t.id))return;const a=b.value.findIndex(n=>n.id===t.id);a!==-1&&b.value.splice(a,1,{...b.value[a],...t})};return re(async()=>{G(),window.addEventListener("incidencias:created",$),window.addEventListener("incidencias:archived",$),window.addEventListener("incidencias:updated",H),await h()}),ne(()=>{window.removeEventListener("incidencias:created",$),window.removeEventListener("incidencias:archived",$),window.removeEventListener("incidencias:updated",H),k&&window.clearTimeout(k)}),oe(D,e=>{k&&window.clearTimeout(k),k=window.setTimeout(()=>{B.value=e,o.value.current_page=1,h()},350)},{flush:"post"}),(e,t)=>(i(),l("section",null,[s("div",ie,[s("div",ce,[t[6]||(t[6]=s("label",{class:"sr-only",for:"inc-search"},"Buscar",-1)),O(s("input",{id:"inc-search","onUpdate:modelValue":t[0]||(t[0]=a=>D.value=a),type:"search",placeholder:"Buscar por título, correlativo, cliente…",class:"w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900 placeholder:text-gray-400 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:placeholder:text-slate-500"},null,512),[[de,D.value]])]),s("div",ue,[s("input",{ref_key:"importInput",ref:T,type:"file",accept:".csv,text/csv",class:"hidden",onChange:K},null,544),s("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:N.value,onClick:J},d(N.value?"Importando…":"Importar CSV"),9,pe),O(s("select",{"onUpdate:modelValue":t[1]||(t[1]=a=>M.value=a),class:"rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100",onChange:t[2]||(t[2]=a=>_({page:1}))},[...t[7]||(t[7]=[s("option",{value:10},"10",-1),s("option",{value:15},"15",-1),s("option",{value:25},"25",-1),s("option",{value:50},"50",-1)])],544),[[le,M.value,void 0,{number:!0}]])])]),s("div",ge,[s("div",ve,[s("button",{type:"button",class:Q(["px-3 py-2 text-sm font-medium rounded-md transition",y.value===null?"bg-blue-600 text-white":"text-gray-700 hover:bg-gray-50 dark:text-slate-200 dark:hover:bg-slate-800"]),onClick:t[3]||(t[3]=a=>_({stageId:null,page:1}))},[t[8]||(t[8]=z(" Todos ",-1)),s("span",me,d(I.value),1)],2),(i(!0),l(F,null,U(S.value,a=>(i(),l("button",{key:a.id,type:"button",class:Q(["px-3 py-2 text-sm font-medium rounded-md transition",y.value===a.id?"bg-blue-600 text-white":"text-gray-700 hover:bg-gray-50 dark:text-slate-200 dark:hover:bg-slate-800"]),onClick:r=>_({stageId:a.id,page:1})},[z(d(a.name)+" ",1),s("span",xe,d(a.count??0),1)],10,be))),128))])]),v.value?(i(),l("div",ye,d(v.value),1)):w("",!0),s("div",he,[s("div",fe,[s("div",null,[t[9]||(t[9]=s("div",{class:"text-sm font-semibold text-gray-900 dark:text-slate-100"},"Incidencias",-1)),s("div",ke,[o.value.total!==null?(i(),l("span",_e," Mostrando "+d(o.value.from??0)+"–"+d(o.value.to??0)+" de "+d(o.value.total??0),1)):w("",!0)])]),x.value?(i(),l("div",we,"Cargando…")):w("",!0)]),s("div",Ce,[s("table",Se,[t[13]||(t[13]=s("thead",{class:"text-xs uppercase bg-gray-50 text-gray-700 dark:bg-slate-800 dark:text-slate-200"},[s("tr",null,[s("th",{class:"px-4 py-3"},"ID"),s("th",{class:"px-4 py-3"},"Correlativo"),s("th",{class:"px-4 py-3"},"Columna"),s("th",{class:"px-4 py-3"},"Acciones"),s("th",{class:"px-4 py-3"},"Título"),s("th",{class:"px-4 py-3"},"Cliente"),s("th",{class:"px-4 py-3"},"Prioridad"),s("th",{class:"px-4 py-3"},"Fecha"),s("th",{class:"px-4 py-3"},"Archivado"),s("th",{class:"px-4 py-3"},"Actualizado")])],-1)),s("tbody",null,[(i(!0),l(F,null,U(b.value,a=>(i(),l("tr",{key:a.id,class:"border-b border-gray-100 bg-white hover:bg-blue-50/40 transition-colors dark:border-slate-800 dark:bg-slate-900 dark:hover:bg-slate-800/60"},[s("td",Ie,d(a.id),1),s("td",Ee,d(a.correlative||"—"),1),s("td",Te,[s("select",{value:a.stage_id,class:"w-full rounded-lg border border-gray-200 bg-white px-2 py-1.5 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 disabled:opacity-60 dark:border-slate-800 dark:bg-slate-950 dark:text-slate-100",disabled:j.value.has(a.id)||V(a),onChange:r=>Y(a,r)},[(i(!0),l(F,null,U(S.value,r=>(i(),l("option",{key:r.id,value:r.id},d(r.name),9,De))),128))],40,Ne)]),s("td",$e,[s("div",Le,[s("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:V(a),onClick:r=>X(a)}," Editar ",8,Ae),P(a)?(i(),l("button",{key:0,type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:E.value.has(a.id),onClick:r=>Z(a)},d(E.value.has(a.id)?"Archivando…":"Archivar"),9,je)):w("",!0),s("button",{type:"button",class:"inline-flex items-center rounded-lg border border-red-200 bg-red-50 px-3 py-1.5 text-xs font-medium text-red-700 shadow-sm hover:bg-red-100 disabled:opacity-60 dark:border-red-800 dark:bg-red-950 dark:text-red-300 dark:hover:bg-red-900",disabled:f.value.has(a.id),onClick:r=>ee(a)},[f.value.has(a.id)?(i(),l("svg",Ve,[...t[11]||(t[11]=[s("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),s("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)])])):(i(),l("svg",Me,[...t[10]||(t[10]=[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"},null,-1)])])),z(" "+d(f.value.has(a.id)?"Eliminando…":"Eliminar"),1)],8,Be)])]),s("td",ze,d(a.title??""),1),s("td",Fe,[a.customer?(i(),l("span",Ue,d(a.customer.company_name||a.customer.name),1)):(i(),l("span",Pe,"—"))]),s("td",qe,d(a.priority??""),1),s("td",He,d(ae(a.date)),1),s("td",Oe,d(q(a.archived_at)),1),s("td",Qe,d(q(a.updated_at)),1)]))),128)),!x.value&&b.value.length===0?(i(),l("tr",Re,[...t[12]||(t[12]=[s("td",{colspan:"10",class:"px-4 py-10 text-center text-sm text-gray-600 dark:text-slate-300"}," Sin incidencias. ",-1)])])):w("",!0)])])]),s("div",Ge,[s("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:x.value||o.value.current_page<=1,onClick:t[4]||(t[4]=a=>_({page:o.value.current_page-1}))}," Anterior ",8,Je),s("div",Ke," Página "+d(o.value.current_page)+" / "+d(o.value.last_page),1),s("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:x.value||o.value.current_page>=o.value.last_page,onClick:t[5]||(t[5]=a=>_({page:o.value.current_page+1}))}," Siguiente ",8,We)])])]))}};export{rt as default};
