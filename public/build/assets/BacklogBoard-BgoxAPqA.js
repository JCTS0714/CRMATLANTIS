import{r as x,e as H,o as J,f as K,g as d,i as r,j as o,t as l,n as N,F as B,l as M,C as m,k as S}from"./vendor-vue-CzwclP9t.js";import{a as L}from"./vendor-utils-Czy7fllw.js";import{a as F,t as T,c as P}from"./App-QtNM8dfD.js";import"./app-DH9r4SNu.js";import"./vendor-ui-E6c-3yld.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const Q={key:0,class:"text-sm text-gray-600 dark:text-slate-300"},R={key:1,class:"mb-3 text-sm text-red-600"},W=["onDrop"],X={class:"p-4 border-b border-gray-200 dark:border-slate-800"},Y={class:"flex items-center justify-between gap-3"},Z={class:"text-sm font-semibold text-gray-900 dark:text-slate-100"},ee={class:"text-xs text-gray-600 dark:text-slate-300"},te={class:"p-3 space-y-3 min-h-[140px]"},ne={key:0,class:"text-sm text-gray-500 dark:text-slate-400 px-1"},ae=["draggable","onDragstart","onClick"],se={class:"flex items-start justify-between gap-3"},ie={class:"text-sm font-semibold text-gray-900 dark:text-slate-100"},de={key:0,class:"text-xs text-gray-600 dark:text-slate-300 mt-1"},re={key:1,class:"text-xs text-gray-500 dark:text-slate-400 mt-1"},oe={class:"text-xs text-gray-700 dark:text-slate-200"},ce={key:0,class:"mt-2 text-xs text-gray-600 dark:text-slate-300"},le={key:1,class:"mt-3 flex justify-end gap-2"},ue=["disabled","onClick"],ve=["disabled","onClick"],me={key:2,class:"mt-3 flex justify-end"},be=["disabled","onClick"],_e={__name:"BacklogBoard",setup(ge){const k=x(!0),u=x([]),b=x(""),_=x(null),w=x(null),p=x(new Set),z=H(()=>{const e=u.value.length||1;return e<=1?"grid-cols-1":e===2?"grid-cols-1 md:grid-cols-2":e===3?"grid-cols-1 md:grid-cols-3":"grid-cols-1 md:grid-cols-2 xl:grid-cols-4"}),U=e=>{if(!e)return"";try{const n=new Date(String(e));return Number.isNaN(n.getTime())?String(e):n.toLocaleDateString()}catch{return String(e)}},C=async({showLoading:e=!0}={})=>{var n,t;e&&(k.value=!0);try{const s=await L.get("/backlog/board-data");u.value=((t=(n=s==null?void 0:s.data)==null?void 0:n.data)==null?void 0:t.stages)??[]}finally{e&&(k.value=!1)}},$=(e,n)=>{const t=u.value.find(i=>i.id===e);if(!(t!=null&&t.incidences))return null;const s=t.incidences.findIndex(i=>i.id===n);if(s===-1)return null;const[a]=t.incidences.splice(s,1);return t.count=t.count??t.incidences.length,typeof t.count=="number"&&(t.count=Math.max(0,t.count-1)),a},V=(e,n)=>{const t=u.value.find(s=>s.id===e);t&&(Array.isArray(t.incidences)||(t.incidences=[]),t.incidences.unshift(n),t.count=t.count??t.incidences.length,typeof t.count=="number"&&(t.count+=1))},f=e=>!!(e!=null&&e.archived_at),E=e=>{e!=null&&e.id&&window.dispatchEvent(new CustomEvent("incidencias:edit",{detail:{incidence:e}}))},j=e=>{var t,s,a;const n=(t=e==null?void 0:e.detail)==null?void 0:t.incidence;if(n!=null&&n.id)for(const i of u.value){const c=((a=(s=i==null?void 0:i.incidences)==null?void 0:s.findIndex)==null?void 0:a.call(s,h=>h.id===n.id))??-1;if(c!==-1){i.incidences.splice(c,1,{...i.incidences[c],...n});break}}},O=(e,n)=>{f(e)||(_.value=e,w.value=(n==null?void 0:n.id)??null)},q=async e=>{var a,i,c,h,A;const n=_.value,t=w.value;if(_.value=null,w.value=null,!(n!=null&&n.id)||!t||!(e!=null&&e.id)||t===e.id)return;b.value="";const s=$(t,n.id);s&&(s.stage_id=e.id,V(e.id,s));try{const v=await L.patch(`/incidencias/${n.id}/move-stage`,{stage_id:e.id}),g=(a=v==null?void 0:v.data)==null?void 0:a.data;if(g&&typeof g=="object"){const I=(c=(i=u.value.find(D=>D.id===e.id))==null?void 0:i.incidences)==null?void 0:c.find(D=>D.id===n.id);I&&Object.assign(I,g)}F("Incidencia actualizada")}catch(v){const g=((A=(h=v==null?void 0:v.response)==null?void 0:h.data)==null?void 0:A.message)??"No se pudo mover la incidencia.";b.value=g,T(g),await C({showLoading:!1})}},G=async(e,n)=>{var s,a;if(!(!(e!=null&&e.id)||!(n!=null&&n.is_done)||!await P({title:"Archivar incidencia",text:"Se ocultará del backlog, pero seguirá visible en la tabla (historial).",confirmText:"Archivar",cancelText:"Cancelar",icon:"warning"}))){p.value.add(e.id),b.value="";try{await L.patch(`/incidencias/${e.id}/archive`),$(n.id,e.id),F("Incidencia archivada"),window.dispatchEvent(new CustomEvent("incidencias:archived"))}catch(i){const c=((a=(s=i==null?void 0:i.response)==null?void 0:s.data)==null?void 0:a.message)??"No se pudo archivar la incidencia.";b.value=c,T(c)}finally{p.value.delete(e.id)}}},y=()=>C({showLoading:!1});return J(async()=>{window.addEventListener("incidencias:created",y),window.addEventListener("incidencias:archived",y),window.addEventListener("incidencias:updated",j),await C()}),K(()=>{window.removeEventListener("incidencias:created",y),window.removeEventListener("incidencias:archived",y),window.removeEventListener("incidencias:updated",j)}),(e,n)=>(r(),d("div",null,[n[3]||(n[3]=o("div",{class:"mb-4 text-sm text-gray-600 dark:text-slate-300"}," Arrastra una incidencia entre columnas para cambiar su estado. ",-1)),k.value?(r(),d("div",Q,"Cargando...")):b.value?(r(),d("div",R,l(b.value),1)):(r(),d("div",{key:2,class:N(["grid gap-4",z.value])},[(r(!0),d(B,null,M(u.value,t=>{var s;return r(),d("section",{key:t.id,class:"bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden dark:bg-slate-900 dark:border-slate-800",onDragover:n[2]||(n[2]=m(()=>{},["prevent"])),onDrop:m(a=>q(t),["prevent"])},[o("div",X,[o("div",Y,[o("div",Z,l(t.name),1),o("div",ee,l(t.count),1)])]),o("div",te,[(((s=t.incidences)==null?void 0:s.length)??0)===0?(r(),d("div",ne," Sin incidencias. ")):S("",!0),(r(!0),d(B,null,M(t.incidences,a=>(r(),d("article",{key:a.id,class:N(["select-none bg-gray-50 border border-gray-200 rounded-lg p-3 transition-colors dark:bg-slate-800 dark:border-slate-700",f(a)?"cursor-not-allowed opacity-80":"cursor-grab active:cursor-grabbing hover:bg-blue-50/50 dark:hover:bg-slate-800/80"]),draggable:!f(a),onDragstart:i=>O(a,t),onClick:i=>E(a)},[o("div",se,[o("div",null,[o("div",ie,l(a.title),1),a.customer?(r(),d("div",de,l(a.customer.company_name||a.customer.name),1)):(r(),d("div",re,"Sin cliente"))]),o("div",oe,l(a.priority),1)]),a.date?(r(),d("div",ce,l(U(a.date)),1)):S("",!0),t.is_done?(r(),d("div",le,[o("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:f(a),onMousedown:n[0]||(n[0]=m(()=>{},["stop"])),onClick:m(i=>E(a),["stop","prevent"])}," Editar ",40,ue),o("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:p.value.has(a.id),onClick:m(i=>G(a,t),["stop","prevent"])},l(p.value.has(a.id)?"Archivando…":"Archivar"),9,ve)])):(r(),d("div",me,[o("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:f(a),onMousedown:n[1]||(n[1]=m(()=>{},["stop"])),onClick:m(i=>E(a),["stop","prevent"])}," Editar ",40,be)]))],42,ae))),128))])],40,W)}),128))],2))]))}};export{_e as default};
