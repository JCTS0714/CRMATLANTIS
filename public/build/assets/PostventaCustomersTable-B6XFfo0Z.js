import{r as d,x as P,y as A,o as ne,f as ie,g as c,i as u,j as a,w as V,z as de,k as ce,A as ue,t as l,u as y,F as B,m as j,s as D,v as pe}from"./vendor-vue-Diyp6CFE.js";import{a as g}from"./vendor-utils-Czy7fllw.js";import{u as me,a as be,_ as ye,t as h,b as v,p as ge,c as U,d as he}from"./App-BLINciIY.js";import"./app-D0PWajC2.js";import"./vendor-ui-BsDgRXDF.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const _e={class:"p-4"},fe={class:"mb-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between"},xe={class:"w-full sm:max-w-md"},ve={class:"flex items-center gap-2"},ke=["disabled"],we=["disabled"],Ce=["disabled"],Se={class:"text-sm text-slate-600 dark:text-slate-300"},Ne={key:0},Te={key:1},Ee={class:"px-4 py-3"},Ie={class:"px-4 py-3 font-medium text-slate-900 dark:text-slate-100"},$e={class:"px-4 py-3"},Re={class:"px-4 py-3"},Pe={class:"px-4 py-3"},Ae={class:"px-4 py-3"},Fe={key:0},ze={key:1},Le={class:"px-4 py-3"},Me={class:"px-4 py-3"},Ve={class:"px-4 py-3"},Be={class:"px-4 py-3"},je={class:"px-4 py-3"},De={class:"px-4 py-3"},Ue={class:"px-4 py-3"},Oe={class:"px-4 py-3"},qe={class:"px-4 py-3"},He={class:"px-4 py-3"},Ke={class:"flex items-center gap-2"},Qe=["onClick"],We=["disabled","onClick"],Xe=["disabled","onClick"],Ge={class:"mt-4 flex items-center justify-between"},Je=["disabled"],Ye={class:"text-sm text-slate-600 dark:text-slate-300"},Ze=["disabled"],nt={__name:"PostventaCustomersTable",setup(et){const m=d([]),k=d(!1),w=d(!1),C=d(null),S=d(!1),N=d(!1),O=(()=>{if(typeof window>"u")return!1;const e=window.location.hostname;return e==="localhost"||e==="127.0.0.1"||e==="::1"})(),E=d(new Set),I=d(new Set),T=d("");let f=null;const n=d({current_page:1,last_page:1,per_page:15,total:0,from:0,to:0}),$=[{key:"csv_numero",label:"N°"},{key:"customer",label:"Cliente"},{key:"company",label:"Empresa"},{key:"precio",label:"Precio"},{key:"rubro",label:"Rubro"},{key:"document",label:"Documento"},{key:"phone",label:"Teléfono"},{key:"email",label:"Email"},{key:"link",label:"Link"},{key:"usuario",label:"Usuario"},{key:"contrasena",label:"Contraseña"},{key:"servidor",label:"Servidor"},{key:"fecha_contacto_mes",label:"Mes contacto"},{key:"fecha_contacto_anio",label:"Año contacto"},{key:"fecha_creacion",label:"F. creación"},{key:"actions",label:"Acciones"}],{tableRef:F,visibleKeys:z,isColumnVisible:q,toggleColumn:H,resetColumns:K}=me({tableId:"postventa-customers-table",columns:$}),{tableScrollRef:Q,stickyScrollRef:W,stickyScrollWidth:X,showStickyXScroll:G,refreshStickyScroll:R}=be({tableRef:F}),b=async(e=1)=>{k.value=!0;try{const{data:s}=await g.get("/customers/data",{params:{q:T.value||"",per_page:n.value.per_page,page:e}});m.value=s.customers||[],n.value={...n.value,...s.pagination||{}}}finally{k.value=!1}},J=e=>{const s=Number(n.value.from);if(Number.isFinite(s)&&s>0)return s+e;const t=Number(n.value.current_page)||1,o=Number(n.value.per_page)||15;return(t-1)*o+e+1},Y=()=>{var e,s;(s=(e=C.value)==null?void 0:e.click)==null||s.call(e)},Z=async e=>{var t,o,r,i,p;const s=(o=(t=e==null?void 0:e.target)==null?void 0:t.files)==null?void 0:o[0];if(s){S.value=!0;try{const _=new FormData;_.append("csv",s);const{data:x}=await g.post("/customers/import",_,{headers:{"Content-Type":"multipart/form-data"}});v(((r=x==null?void 0:x.output)!=null&&r.trim(),"Importación finalizada")),await b(1)}catch(_){const x=((p=(i=_==null?void 0:_.response)==null?void 0:i.data)==null?void 0:p.message)??"No se pudo importar el CSV.";h(x)}finally{S.value=!1,C.value&&(C.value.value="")}}},ee=async()=>{var s,t;if(await U({title:"Borrar tabla de clientes (solo local)",text:"Se eliminarán todos los clientes de la tabla en tu entorno local. Esta acción no se puede deshacer.",confirmText:"Sí, borrar todo",cancelText:"Cancelar",icon:"warning"})){N.value=!0;try{const{data:o}=await g.post("/customers/clear-local");v((o==null?void 0:o.message)||"Tabla de clientes limpiada."),await b(1)}catch(o){const r=((t=(s=o==null?void 0:o.response)==null?void 0:s.data)==null?void 0:t.message)??"No se pudo limpiar la tabla de clientes.";h(r)}finally{N.value=!1}}},te=e=>{const s=(e==null?void 0:e.company_name)||(e==null?void 0:e.name)||"",t=e!=null&&e.company_name?e==null?void 0:e.name:"";let o=s;t&&t!==s&&(o+=` — ${t}`);const r=e!=null&&e.document_number?`${e!=null&&e.document_type?e.document_type+" ":""}${e.document_number}`:"";return r&&(o+=` (${r})`),o},ae=e=>{e!=null&&e.id&&window.dispatchEvent(new CustomEvent("incidencias:create",{detail:{customer_id:e.id,customer_label:te(e)}}))},se=async()=>{var s,t;const e=await ge();if(e){w.value=!0;try{await g.post("/customers",e),v("Cliente creado"),await b(1)}catch(o){const r=((t=(s=o==null?void 0:o.response)==null?void 0:s.data)==null?void 0:t.message)??"No se pudo crear el cliente.";h(r)}finally{w.value=!1}}},L=async e=>{var t,o,r;if(!(e!=null&&e.id))return;const s=await he(e);if(s){E.value.add(e.id);try{const i=await g.put(`/customers/${e.id}`,s),p=(t=i==null?void 0:i.data)==null?void 0:t.data;p&&typeof p=="object"?Object.assign(e,p):Object.assign(e,s),v("Cliente actualizado")}catch(i){const p=((r=(o=i==null?void 0:i.response)==null?void 0:o.data)==null?void 0:r.message)??"No se pudo actualizar el cliente.";h(p)}finally{E.value.delete(e.id)}}},oe=async e=>{var t,o;if(!(!(e!=null&&e.id)||!await U({title:"Eliminar cliente",text:"Se eliminará el cliente. Las incidencias asociadas quedarán sin cliente (se desvinculan).",confirmText:"Eliminar",cancelText:"Cancelar",icon:"warning"}))){I.value.add(e.id);try{await g.delete(`/customers/${e.id}`),m.value=m.value.filter(r=>r.id!==e.id),v("Cliente eliminado"),b(Math.min(n.value.current_page,n.value.last_page||1))}catch(r){const i=((o=(t=r==null?void 0:r.response)==null?void 0:t.data)==null?void 0:o.message)??"No se pudo eliminar el cliente.";h(i)}finally{I.value.delete(e.id)}}},M=e=>{const s=Math.max(1,Math.min(n.value.last_page||1,e));b(s)},le=()=>{const e=new URL(window.location.href),s=e.searchParams.get("edit_customer_id");if(!s)return null;const t=Number(s);e.searchParams.delete("edit_customer_id"),e.searchParams.delete("source");const o=`${e.pathname}${e.search?e.search:""}${e.hash||""}`;return window.history.replaceState({},"",o||"/postventa/clientes"),Number.isInteger(t)&&t>0?t:null},re=async()=>{var t;const e=le();if(!e)return;let s=m.value.find(o=>Number(o.id)===e)||null;if(!s)try{const o=await g.get(`/customers/${e}`);s=((t=o==null?void 0:o.data)==null?void 0:t.data)??null,s&&m.value.unshift(s)}catch{h("No se pudo abrir el cliente convertido para edición.");return}if(!s){h("No se encontró el cliente convertido.");return}await L(s)};return P(T,()=>{f&&clearTimeout(f),f=setTimeout(()=>{b(1)},300)},{flush:"post"}),P(z,async()=>{await A(),R()},{deep:!0}),P(m,async()=>{await A(),R()}),ne(async()=>{await b(1),await re(),await A(),R()}),ie(()=>{f&&clearTimeout(f)}),(e,s)=>(u(),c("div",_e,[a("div",fe,[a("div",xe,[V(a("input",{"onUpdate:modelValue":s[0]||(s[0]=t=>T.value=t),type:"text",class:"w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 focus:border-sky-500 focus:ring-sky-500 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100",placeholder:"Buscar cliente (nombre, contacto, empresa, documento…)"},null,512),[[de,T.value]])]),a("div",ve,[a("input",{ref_key:"importInput",ref:C,type:"file",accept:".csv,text/csv",class:"hidden",onChange:Z},null,544),a("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:S.value,onClick:Y},l(S.value?"Importando…":"Importar CSV"),9,ke),a("button",{type:"button",class:"inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 disabled:opacity-60",disabled:w.value,onClick:se},l(w.value?"Creando…":"Crear cliente"),9,we),y(O)?(u(),c("button",{key:0,type:"button",class:"inline-flex items-center rounded-lg border border-red-300 bg-red-50 px-3 py-2 text-sm font-medium text-red-700 hover:bg-red-100 disabled:opacity-60 dark:border-red-900/60 dark:bg-red-950/30 dark:text-red-300 dark:hover:bg-red-900/40",disabled:N.value,onClick:ee},l(N.value?"Limpiando…":"Borrar tabla (local)"),9,Ce)):ce("",!0),a("div",Se,[n.value.total?(u(),c("span",Ne,"Mostrando "+l(n.value.from)+"–"+l(n.value.to)+" de "+l(n.value.total),1)):(u(),c("span",Te,"Sin resultados"))]),ue(ye,{columns:$,"visible-keys":y(z),onToggle:y(H),onReset:y(K)},null,8,["visible-keys","onToggle","onReset"])])]),a("div",{ref_key:"tableScrollRef",ref:Q,class:"overflow-x-auto rounded-lg border border-slate-200 bg-white dark:border-slate-800 dark:bg-slate-900"},[a("table",{ref_key:"tableRef",ref:F,class:"min-w-full text-left text-sm text-slate-700 dark:text-slate-200"},[a("colgroup",null,[(u(),c(B,null,j($,t=>a("col",{key:t.key,style:D({display:y(q)(t.key)?"":"none"})},null,4)),64))]),s[3]||(s[3]=a("thead",{class:"bg-slate-50 text-xs uppercase text-slate-600 dark:bg-slate-800 dark:text-slate-200"},[a("tr",null,[a("th",{class:"px-4 py-3"},"N°"),a("th",{class:"px-4 py-3"},"Cliente"),a("th",{class:"px-4 py-3"},"Empresa"),a("th",{class:"px-4 py-3"},"Precio"),a("th",{class:"px-4 py-3"},"Rubro"),a("th",{class:"px-4 py-3"},"Documento"),a("th",{class:"px-4 py-3"},"Teléfono"),a("th",{class:"px-4 py-3"},"Email"),a("th",{class:"px-4 py-3"},"Link"),a("th",{class:"px-4 py-3"},"Usuario"),a("th",{class:"px-4 py-3"},"Contraseña"),a("th",{class:"px-4 py-3"},"Servidor"),a("th",{class:"px-4 py-3"},"Mes contacto"),a("th",{class:"px-4 py-3"},"Año contacto"),a("th",{class:"px-4 py-3"},"F. creación"),a("th",{class:"px-4 py-3"},"Acciones")])],-1)),a("tbody",null,[(u(!0),c(B,null,j(m.value,(t,o)=>(u(),c("tr",{key:t.id,class:"border-t border-slate-200 hover:bg-slate-50 dark:border-slate-800 dark:hover:bg-slate-800"},[a("td",Ee,l(J(o)),1),a("td",Ie,l(t.contact_name||t.name||"—"),1),a("td",$e,l(t.company_name||"—"),1),a("td",Re,l(t.precio??"—"),1),a("td",Pe,l(t.rubro||"—"),1),a("td",Ae,[t.document_type||t.document_number?(u(),c("span",Fe,l(t.document_type||"")+" "+l(t.document_number||""),1)):(u(),c("span",ze,"—"))]),a("td",Le,l(t.contact_phone||"—"),1),a("td",Me,l(t.contact_email||"—"),1),a("td",Ve,l(t.link||"—"),1),a("td",Be,l(t.usuario||"—"),1),a("td",je,l(t.contrasena||"—"),1),a("td",De,l(t.servidor||"—"),1),a("td",Ue,l(t.fecha_contacto_mes||"—"),1),a("td",Oe,l(t.fecha_contacto_anio||"—"),1),a("td",qe,l(t.fecha_creacion||"—"),1),a("td",He,[a("div",Ke,[a("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",onClick:r=>ae(t)}," Abrir incidencia ",8,Qe),a("button",{type:"button",class:"inline-flex items-center rounded-lg border border-slate-300 bg-white px-3 py-1.5 text-xs font-medium text-slate-700 hover:bg-slate-50 disabled:opacity-60 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:E.value.has(t.id),onClick:r=>L(t)}," Editar ",8,We),a("button",{type:"button",class:"inline-flex items-center rounded-lg border border-red-200 bg-white px-3 py-1.5 text-xs font-medium text-red-700 hover:bg-red-50 disabled:opacity-60 dark:border-red-900/40 dark:bg-slate-900 dark:text-red-300 dark:hover:bg-red-950/30",disabled:I.value.has(t.id),onClick:r=>oe(t)}," Eliminar ",8,Xe)])])]))),128))])],512)],512),V(a("div",{ref_key:"stickyScrollRef",ref:W,class:"sticky bottom-0 z-20 mt-2 overflow-x-auto rounded-lg border border-slate-200 bg-white/95 dark:border-slate-700 dark:bg-slate-900/95"},[a("div",{style:D({width:`${y(X)}px`,height:"1px"})},null,4)],512),[[pe,y(G)]]),a("div",Ge,[a("button",{class:"rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 disabled:cursor-not-allowed disabled:opacity-50 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:n.value.current_page<=1||k.value,onClick:s[1]||(s[1]=t=>M(n.value.current_page-1))}," Anterior ",8,Je),a("div",Ye," Página "+l(n.value.current_page)+" / "+l(n.value.last_page),1),a("button",{class:"rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 disabled:cursor-not-allowed disabled:opacity-50 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:n.value.current_page>=n.value.last_page||k.value,onClick:s[2]||(s[2]=t=>M(n.value.current_page+1))}," Siguiente ",8,Ze)])]))}};export{nt as default};
