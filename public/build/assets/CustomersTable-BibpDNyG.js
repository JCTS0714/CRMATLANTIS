import{r as c,H as B,g as m,i as b,j as t,w as F,x as M,t as d,F as P,m as z}from"./vendor-vue-Db-AqoDh.js";import{a as _}from"./vendor-utils-Czy7fllw.js";import{a as k,t as w,p as V,b as A,c as q}from"./App-D_XY1sJF.js";import"./app-CglYj3fU.js";import"./vendor-ui-DEm6YKEA.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const L={class:"p-4"},O={class:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between"},H={class:"w-full sm:max-w-md"},U={class:"flex items-center gap-3"},G=["disabled"],J={class:"text-sm text-slate-600 dark:text-slate-300"},K={key:0},Q={key:1},R={class:"mt-4 overflow-x-auto rounded-lg border border-slate-200 bg-white dark:border-slate-800 dark:bg-slate-900"},W={class:"min-w-full text-left text-sm text-slate-700 dark:text-slate-200"},X={class:"px-4 py-3 font-medium text-slate-900 dark:text-slate-100"},Y={class:"px-4 py-3"},Z={class:"px-4 py-3"},ee={class:"px-4 py-3"},te={key:0},ae={key:1},se={class:"px-4 py-3"},oe={class:"px-4 py-3"},le={class:"px-4 py-3"},ne={class:"flex items-center gap-2"},re=["onClick"],de=["disabled","onClick"],ie=["disabled","onClick"],ue={class:"mt-4 flex items-center justify-between"},ce=["disabled"],pe={class:"text-sm text-slate-600 dark:text-slate-300"},me=["disabled"],fe={__name:"CustomersTable",setup(be){const x=c([]),y=c(!1),C=c(new Set),$=c(new Set),v=c(null),h=c(!1),f=c("");let I=null;const o=c({current_page:1,last_page:1,per_page:15,total:0,from:0,to:0}),g=async(e=1)=>{y.value=!0;try{const{data:a}=await _.get("/customers/data",{params:{q:f.value||"",per_page:o.value.per_page,page:e}});x.value=a.customers||[],o.value={...o.value,...a.pagination||{}}}finally{y.value=!1}},S=()=>{var e,a;(a=(e=v.value)==null?void 0:e.click)==null||a.call(e)},D=async e=>{var s,n,r,l,i;const a=(n=(s=e==null?void 0:e.target)==null?void 0:s.files)==null?void 0:n[0];if(a){h.value=!0;try{const u=new FormData;u.append("csv",a);const{data:p}=await _.post("/customers/import",u,{headers:{"Content-Type":"multipart/form-data"}});k(((r=p==null?void 0:p.output)!=null&&r.trim(),"Importación finalizada")),await g(1)}catch(u){const p=((i=(l=u==null?void 0:u.response)==null?void 0:l.data)==null?void 0:i.message)??"No se pudo importar el CSV.";w(p)}finally{h.value=!1,v.value&&(v.value.value="")}}},E=async e=>{var s,n,r;if(!(e!=null&&e.id))return;const a=await A(e);if(a){C.value.add(e.id);try{const l=await _.put(`/customers/${e.id}`,a),i=(s=l==null?void 0:l.data)==null?void 0:s.data;i&&typeof i=="object"?Object.assign(e,i):Object.assign(e,a),k("Cliente actualizado")}catch(l){const i=((r=(n=l==null?void 0:l.response)==null?void 0:n.data)==null?void 0:r.message)??"No se pudo actualizar el cliente.";w(i)}finally{C.value.delete(e.id)}}},j=async e=>{var l,i;if(!(e!=null&&e.id))return;const a=await V(e);if(!a)return;const n=`Pago cliente: ${e.company_name||e.name||`Cliente #${e.id}`}`,r=[e.name&&e.company_name&&e.name!==e.company_name?`Contacto: ${e.name}`:null,e.document_number?`Documento: ${e.document_type?`${e.document_type} `:""}${e.document_number}`:null,e.contact_phone?`Teléfono: ${e.contact_phone}`:null,a.note?`Detalle: ${a.note}`:null].filter(Boolean);try{await _.post("/calendar/events",{event_type:"customer_payment",title:n,description:r.join(" | ")||null,all_day:!0,start_at:a.date,end_at:null,reminder_minutes:1440,related_type:"customer",related_id:e.id,meta:{customer_name:e.name||null,company_name:e.company_name||null,payment_date:a.date}}),k("Fecha de pago agregada al calendario")}catch(u){const p=((i=(l=u==null?void 0:u.response)==null?void 0:l.data)==null?void 0:i.message)??"No se pudo agregar la fecha de pago al calendario.";w(p)}},N=async e=>{var s,n;if(!(!(e!=null&&e.id)||!await q({title:"Eliminar cliente",text:"Se eliminará el cliente. Los leads asociados quedarán sin cliente (se desvinculan).",confirmText:"Eliminar",cancelText:"Cancelar",icon:"warning"}))){$.value.add(e.id);try{await _.delete(`/customers/${e.id}`),x.value=x.value.filter(r=>r.id!==e.id),k("Cliente eliminado"),g(Math.min(o.value.current_page,o.value.last_page||1))}catch(r){const l=((n=(s=r==null?void 0:r.response)==null?void 0:s.data)==null?void 0:n.message)??"No se pudo eliminar el cliente.";w(l)}finally{$.value.delete(e.id)}}},T=e=>{const a=Math.max(1,Math.min(o.value.last_page||1,e));g(a)};return B(f,()=>{I&&clearTimeout(I),I=setTimeout(()=>{g(1)},300)},{flush:"post"}),g(1),(e,a)=>(b(),m("div",L,[t("div",O,[t("div",H,[F(t("input",{"onUpdate:modelValue":a[0]||(a[0]=s=>f.value=s),type:"text",class:"w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 focus:border-sky-500 focus:ring-sky-500 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100",placeholder:"Buscar cliente (nombre, contacto, empresa, documento…)"},null,512),[[M,f.value]])]),t("div",U,[t("input",{ref_key:"importInput",ref:v,type:"file",accept:".csv,text/csv",class:"hidden",onChange:D},null,544),t("button",{type:"button",class:"inline-flex items-center rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50 disabled:opacity-60 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:h.value,onClick:S},d(h.value?"Importando…":"Importar CSV"),9,G),t("div",J,[o.value.total?(b(),m("span",K,"Mostrando "+d(o.value.from)+"–"+d(o.value.to)+" de "+d(o.value.total),1)):(b(),m("span",Q,"Sin resultados"))])])]),t("div",R,[t("table",W,[a[3]||(a[3]=t("thead",{class:"bg-slate-50 text-xs uppercase text-slate-600 dark:bg-slate-800 dark:text-slate-200"},[t("tr",null,[t("th",{class:"px-4 py-3"},"Cliente"),t("th",{class:"px-4 py-3"},"Contacto"),t("th",{class:"px-4 py-3"},"Empresa"),t("th",{class:"px-4 py-3"},"Documento"),t("th",{class:"px-4 py-3"},"Teléfono"),t("th",{class:"px-4 py-3"},"Email"),t("th",{class:"px-4 py-3"},"Acciones")])],-1)),t("tbody",null,[(b(!0),m(P,null,z(x.value,s=>(b(),m("tr",{key:s.id,class:"border-t border-slate-200 hover:bg-slate-50 dark:border-slate-800 dark:hover:bg-slate-800"},[t("td",X,d(s.name),1),t("td",Y,d(s.contact_name||"—"),1),t("td",Z,d(s.company_name||"—"),1),t("td",ee,[s.document_type||s.document_number?(b(),m("span",te,d(s.document_type||"")+" "+d(s.document_number||""),1)):(b(),m("span",ae,"—"))]),t("td",se,d(s.contact_phone||"—"),1),t("td",oe,d(s.contact_email||"—"),1),t("td",le,[t("div",ne,[t("button",{type:"button",class:"inline-flex items-center rounded-lg border border-emerald-200 bg-emerald-50 px-3 py-1.5 text-xs font-medium text-emerald-700 hover:bg-emerald-100 disabled:opacity-60 dark:border-emerald-900/40 dark:bg-emerald-950/30 dark:text-emerald-300 dark:hover:bg-emerald-900/40",onClick:n=>j(s)}," Agregar fecha de pago ",8,re),t("button",{type:"button",class:"inline-flex items-center rounded-lg border border-slate-300 bg-white px-3 py-1.5 text-xs font-medium text-slate-700 hover:bg-slate-50 disabled:opacity-60 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:C.value.has(s.id),onClick:n=>E(s)}," Editar ",8,de),t("button",{type:"button",class:"inline-flex items-center rounded-lg border border-red-200 bg-white px-3 py-1.5 text-xs font-medium text-red-700 hover:bg-red-50 disabled:opacity-60 dark:border-red-900/40 dark:bg-slate-900 dark:text-red-300 dark:hover:bg-red-950/30",disabled:$.value.has(s.id),onClick:n=>N(s)}," Eliminar ",8,ie)])])]))),128))])])]),t("div",ue,[t("button",{class:"rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 disabled:cursor-not-allowed disabled:opacity-50 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:o.value.current_page<=1||y.value,onClick:a[1]||(a[1]=s=>T(o.value.current_page-1))}," Anterior ",8,ce),t("div",pe," Página "+d(o.value.current_page)+" / "+d(o.value.last_page),1),t("button",{class:"rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 disabled:cursor-not-allowed disabled:opacity-50 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:o.value.current_page>=o.value.last_page||y.value,onClick:a[2]||(a[2]=s=>T(o.value.current_page+1))}," Siguiente ",8,me)])]))}};export{fe as default};
