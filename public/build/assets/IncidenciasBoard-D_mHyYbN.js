import{r as s,e as ce,o as ue,g as c,i as u,j as l,A as G,w as O,G as ge,z as R,t as y,n as L,F as Y,m as J,l as w,k as K,D as z,C as ve}from"./vendor-vue-Diyp6CFE.js";import{a as S}from"./vendor-utils-Czy7fllw.js";import{S as F}from"./vendor-ui-BsDgRXDF.js";import{_ as fe,a as me}from"./BaseModal-Coysbt3i.js";const xe={class:"mb-4 flex items-center gap-3"},pe={class:"flex items-center gap-2"},be={class:"flex items-center gap-2"},ye={class:"flex items-center gap-2"},ke={key:0,class:"text-sm text-gray-600 dark:text-slate-300"},he={key:1,class:"mb-3 text-sm text-red-600"},we=["data-stage-id","onDrop"],_e={class:"p-4 border-b border-gray-200 dark:border-slate-800"},Ie={class:"flex items-center justify-between gap-3"},Ce={class:"text-sm font-semibold text-gray-900 dark:text-slate-100"},Ae={class:"text-xs text-gray-600 dark:text-slate-300"},De={class:"p-3 space-y-3 min-h-[140px]"},Ee={key:0,class:"text-sm text-gray-500 dark:text-slate-400 px-1"},Me=["data-incidence-id"],Se=["data-incidence-id","draggable","onDragstart","onDragover","onDrop","onClick"],Be={class:"flex items-start justify-between gap-3"},$e={class:"flex-1 min-w-0"},Te={class:"text-sm font-semibold text-gray-900 dark:text-slate-100 truncate"},je={key:0,class:"text-xs text-gray-600 dark:text-slate-300 mt-1 truncate"},Ve={class:"flex items-center gap-2 mt-2"},Ne=["disabled","onClick"],Oe={key:0,class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},Le={key:1,class:"w-4 h-4 animate-spin",fill:"none",viewBox:"0 0 24 24"},ze={class:"flex justify-end gap-3"},Ge={__name:"IncidenciasBoard",setup(Fe){const B=s(!1),v=s([]),_=s(""),I=s(50),C=s(""),A=s(""),p=s(null),d=s(null),$=s(null),m=s(!1),k=s(!1),h=s({incidenceId:null,position:"after",stageId:null}),x=s(null),D=s(new Set),T=s(null),P=s(null),Q=ce(()=>{const t=v.value.length;return t===1?"grid-cols-1":t===2?"grid-cols-1 lg:grid-cols-2":t===3?"grid-cols-1 lg:grid-cols-3":t===4?"grid-cols-1 lg:grid-cols-2 xl:grid-cols-4":t===5?"grid-cols-1 lg:grid-cols-3 xl:grid-cols-5":"grid-cols-1 lg:grid-cols-3 2xl:grid-cols-6"}),E=async({showLoading:t=!0}={})=>{var e;t&&(B.value=!0);try{const r=await S.get("/incidencias/board-data",{params:{limit:I.value,date_from:C.value||null,date_to:A.value||null}});v.value=((e=r.data)==null?void 0:e.stages)??[]}catch(r){console.error("Error loading incidences:",r)}finally{t&&(B.value=!1)}},W=()=>{E()},X=()=>{C.value="",A.value="",I.value=50,E()},M=(t,e)=>!!(e!=null&&e.is_resolved),Z=t=>{switch(t==null?void 0:t.toLowerCase()){case"alta":return"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200";case"media":return"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200";case"baja":return"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200";default:return"bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200"}},ee=(t,e)=>{if(M(t,e))return;d.value=t,$.value=(t==null?void 0:t.stage_id)??null,p.value=t.id,k.value=!1;const r=v.value.find(i=>i.id===((t==null?void 0:t.stage_id)??null));if(r&&Array.isArray(r.incidences)){const i=r.incidences.findIndex(a=>a.id===t.id);x.value={stageId:r.id,index:i}}else x.value=null;m.value=!1},te=(t=!1)=>{var r;if(!m.value)return;const e=((r=d.value)==null?void 0:r.id)??null;if(e!=null){for(const i of v.value){if(!Array.isArray(i.incidences))continue;const a=i.incidences.findIndex(n=>n.id===e);a!==-1&&i.incidences.splice(a,1)}if(t&&x.value){const i=v.value.find(a=>a.id===x.value.stageId);if(i){Array.isArray(i.incidences)||(i.incidences=[]);const a=Math.max(0,Math.min(x.value.index??i.incidences.length,i.incidences.length));i.incidences.splice(a,0,d.value)}}m.value=!1,h.value={incidenceId:null,position:"after",stageId:null}}},re=()=>{!k.value&&m.value&&te(!0),d.value=null,$.value=null,p.value=null,m.value=!1,k.value=!1,h.value={incidenceId:null,position:"after",stageId:null},x.value=null};let j=null;const ae=(t,e,r)=>{d.value&&(j&&clearTimeout(j),j=setTimeout(()=>{le(t,e,r)},16))},le=(t,e,r)=>{var q;if(!d.value)return;const i=r.currentTarget.closest("section[data-stage-id]");if(!i)return;const a=i.querySelector(".p-3");if(!a)return;const n=a.querySelectorAll("article[data-incidence-id]"),g=Array.from(n).filter(b=>Number(b.getAttribute("data-incidence-id"))!==d.value.id);if(g.length===0){H(e.id,0),h.value={incidenceId:null,position:"top",stageId:e.id};return}const o=r.clientY;let f=g.length;for(let b=0;b<g.length;b++){const N=g[b].getBoundingClientRect(),de=N.top+N.height/2;if(o<de){f=b;break}}H(e.id,f);const V=f>0?Number((q=g[f-1])==null?void 0:q.getAttribute("data-incidence-id")):null;h.value={incidenceId:V,position:f===0?"before":"after",stageId:e.id}},H=(t,e)=>{var g;if(!d.value||m.value)return;const r=d.value,i=v.value.find(o=>o.id===t);if(!i||(((g=i.incidences)==null?void 0:g.findIndex(o=>o.id===r.id))??-1)===e)return;v.value.forEach(o=>{if(!Array.isArray(o.incidences))return;const f=o.incidences.findIndex(V=>V.id===r.id);f!==-1&&o.incidences.splice(f,1)}),Array.isArray(i.incidences)||(i.incidences=[]);const n=Math.max(0,Math.min(e,i.incidences.length));i.incidences.splice(n,0,r),m.value=!0},U=async(t,e=null)=>{var r,i;if((r=d.value)!=null&&r.id&&t!=null&&t.id&&m.value){k.value=!0;const a=d.value.id,n=((i=x.value)==null?void 0:i.stageId)??null,g=v.value.find(o=>o.id===t.id);if(!g)return;try{n&&n!==t.id&&await S.patch(`/incidencias/${a}/move-stage`,{stage_id:t.id});const o=g.incidences.map(f=>f.id);await S.patch("/incidencias/reorder",{stage_id:t.id,ordered_ids:o}),m.value=!1,h.value={incidenceId:null,position:"after",stageId:null},d.value=null,$.value=null,p.value=null,x.value=null,k.value=!1,_.value=""}catch{_.value="Error al mover la incidencia",await E({showLoading:!1})}return}},ie=t=>{var e;P.value=t,(e=T.value)==null||e.open()},se=()=>{var t;P.value=null,(t=T.value)==null||t.close()},ne=async t=>{(await F.fire({title:"¿Eliminar incidencia?",text:`Se eliminará permanentemente "${t.title||`#${t.correlative}`}"`,icon:"warning",showCancelButton:!0,confirmButtonColor:"#ef4444",cancelButtonColor:"#6b7280",confirmButtonText:"Sí, eliminar",cancelButtonText:"Cancelar"})).isConfirmed&&await oe(t)},oe=async t=>{D.value.add(t.id);try{await S.delete(`/incidencias/${t.id}`),v.value.forEach(e=>{if(Array.isArray(e.incidences)){const r=e.incidences.findIndex(i=>i.id===t.id);r!==-1&&(e.incidences.splice(r,1),e.count=(e.count||0)-1)}}),await F.fire({title:"Eliminada",text:"La incidencia ha sido eliminada exitosamente",icon:"success",timer:2e3,showConfirmButton:!1})}catch(e){console.error("Error deleting incidence:",e),await F.fire({title:"Error",text:"No se pudo eliminar la incidencia",icon:"error"})}finally{D.value.delete(t.id)}};return ue(()=>{E()}),(t,e)=>(u(),c("div",null,[e[12]||(e[12]=l("div",{class:"mb-4 text-sm text-gray-600 dark:text-slate-300"}," Arrastra una incidencia entre columnas para cambiar su etapa. ",-1)),l("div",xe,[l("div",pe,[e[5]||(e[5]=l("label",{class:"text-xs text-gray-600 dark:text-slate-300"},"Limite:",-1)),O(l("select",{"onUpdate:modelValue":e[0]||(e[0]=r=>I.value=r),class:"rounded-lg border border-gray-200 bg-white px-2 py-1 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:focus:ring-blue-900/30"},[...e[4]||(e[4]=[l("option",{value:20},"20",-1),l("option",{value:50},"50",-1),l("option",{value:100},"100",-1),l("option",{value:250},"250",-1)])],512),[[ge,I.value,void 0,{number:!0}]])]),l("div",be,[e[6]||(e[6]=l("label",{class:"text-xs text-gray-600 dark:text-slate-300"},"Desde:",-1)),O(l("input",{"onUpdate:modelValue":e[1]||(e[1]=r=>C.value=r),type:"date",class:"rounded-lg border border-gray-200 bg-white px-2 py-1 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 placeholder:text-gray-400 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:placeholder:text-slate-500 dark:focus:ring-blue-900/30 dark:[color-scheme:dark]"},null,512),[[R,C.value]])]),l("div",ye,[e[7]||(e[7]=l("label",{class:"text-xs text-gray-600 dark:text-slate-300"},"Hasta:",-1)),O(l("input",{"onUpdate:modelValue":e[2]||(e[2]=r=>A.value=r),type:"date",class:"rounded-lg border border-gray-200 bg-white px-2 py-1 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 placeholder:text-gray-400 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:placeholder:text-slate-500 dark:focus:ring-blue-900/30 dark:[color-scheme:dark]"},null,512),[[R,A.value]])]),l("div",{class:"flex items-center gap-2 ms-auto"},[l("button",{onClick:W,class:"inline-flex items-center rounded-lg bg-blue-600 px-3 py-1 text-sm text-white"},"Aplicar"),l("button",{onClick:X,class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1 text-sm text-gray-700 shadow-sm hover:bg-gray-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800"}," Limpiar ")])]),B.value?(u(),c("div",ke,"Cargando...")):_.value?(u(),c("div",he,y(_.value),1)):(u(),c("div",{key:2,class:L(["grid gap-4",Q.value])},[(u(!0),c(Y,null,J(v.value,r=>{var i;return u(),c("section",{key:r.id,"data-stage-id":r.id,class:"bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden dark:bg-slate-900 dark:border-slate-800",onDragover:e[3]||(e[3]=w(()=>{},["prevent"])),onDrop:w(a=>U(r),["prevent"])},[l("div",_e,[l("div",Ie,[l("div",Ce,y(r.name),1),l("div",Ae,y(r.count),1)])]),l("div",De,[(((i=r.incidences)==null?void 0:i.length)??0)===0?(u(),c("div",Ee," Sin incidencias. ")):K("",!0),(u(!0),c(Y,null,J(r.incidences,a=>(u(),c("div",{key:a.id,"data-incidence-id":a.id},[l("article",{"data-incidence-id":a.id,class:L(["select-none bg-gray-50 border border-gray-200 rounded-lg p-3 dark:bg-slate-800 dark:border-slate-700",{"scale-105 shadow-lg opacity-90 z-50 transform":p.value===a.id,"opacity-50":p.value&&p.value!==a.id,"cursor-not-allowed opacity-80":M(a,r),"cursor-grab active:cursor-grabbing hover:bg-blue-50/30 dark:hover:bg-slate-800/50":!M(a,r)}]),draggable:!M(a,r),onDragstart:n=>ee(a,r),onDragend:re,onDragover:w(n=>ae(a,r,n),["prevent"]),onDrop:w(n=>U(r,a),["prevent"]),onClick:n=>ie(a)},[l("div",Be,[l("div",$e,[l("div",Te,y(a.title||`#${a.correlative}`),1),a.customer?(u(),c("div",je,y(a.customer.company_name||a.customer.name),1)):K("",!0),l("div",Ve,[l("span",{class:L(["inline-flex items-center px-2 py-0.5 rounded text-xs font-medium",Z(a.priority)])},y(a.priority||"Normal"),3)])]),l("button",{type:"button",class:"opacity-0 group-hover:opacity-100 hover:opacity-100 ml-2 p-1 text-red-600 hover:text-red-800 hover:bg-red-50 rounded transition-all dark:text-red-400 dark:hover:text-red-300 dark:hover:bg-red-950",disabled:D.value.has(a.id),onClick:w(n=>ne(a),["stop"]),title:"Eliminar incidencia"},[D.value.has(a.id)?(u(),c("svg",Le,[...e[9]||(e[9]=[l("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),l("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)])])):(u(),c("svg",Oe,[...e[8]||(e[8]=[l("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"},null,-1)])]))],8,Ne)])],42,Se)],8,Me))),128))])],40,we)}),128))],2)),G(me,{ref_key:"incidenceModal",ref:T,title:"Editar Incidencia","max-width":"lg","close-on-backdrop":""},{footer:z(()=>[l("div",ze,[G(fe,{variant:"secondary",onClick:se},{default:z(()=>[...e[10]||(e[10]=[ve(" Cancelar ",-1)])]),_:1})])]),default:z(()=>[e[11]||(e[11]=l("div",{class:"py-4"},[l("p",{class:"text-gray-600 dark:text-slate-400"}," Modal de edición de incidencias (por implementar) ")],-1))]),_:1},512)]))}};export{Ge as default};
