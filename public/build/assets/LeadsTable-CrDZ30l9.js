import{a as B}from"./vendor-utils-Czy7fllw.js";import{S as $}from"./vendor-ui-E6c-3yld.js";import{g,i as c,j as e,t as r,n as H,y as W,F as O,l as U,e as h,k as D,r as x,H as G,I as K,o as Q,A as J,u as b,p as X}from"./vendor-vue-CzwclP9t.js";const Y={class:"mb-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between"},Z={class:"flex-1"},ee=["value"],te={class:"flex items-center gap-2"},ae=["disabled"],se=["value"],re={class:"mb-4 overflow-x-auto"},oe={class:"inline-flex rounded-lg border border-gray-200 bg-white p-1 shadow-sm dark:border-slate-800 dark:bg-slate-900"},ne={class:"ml-2 rounded bg-black/5 px-2 py-0.5 text-xs font-semibold text-gray-700 dark:bg-white/10 dark:text-slate-200"},le=["onClick"],de={class:"ml-2 rounded bg-black/5 px-2 py-0.5 text-xs font-semibold text-gray-700 dark:bg-white/10 dark:text-slate-200"},ie={__name:"LeadsTableFilters",props:{modelValue:{type:String,required:!0},stages:{type:Array,required:!0},activeStageId:{type:[Number,null],default:null},totalCount:{type:Number,default:0},perPage:{type:Number,default:25},importing:{type:Boolean,default:!1}},emits:["update:modelValue","update:per-page","stage-filter","import-file"],setup(t){return(l,s)=>(c(),g("section",null,[e("div",Y,[e("div",Z,[s[5]||(s[5]=e("label",{class:"sr-only",for:"leads-search"},"Buscar",-1)),e("input",{id:"leads-search",value:t.modelValue,type:"search",placeholder:"Buscar por nombre, empresa, contacto, email, teléfono, documento…",class:"w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900 placeholder:text-gray-400 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:placeholder:text-slate-500",onInput:s[0]||(s[0]=d=>l.$emit("update:modelValue",d.target.value))},null,40,ee)]),e("div",te,[e("input",{ref:"importInput",type:"file",accept:".csv,text/csv",class:"hidden",onChange:s[1]||(s[1]=d=>l.$emit("import-file",d))},null,544),e("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:t.importing,onClick:s[2]||(s[2]=d=>l.$refs.importInput.click())},r(t.importing?"Importando…":"Importar CSV"),9,ae),e("select",{value:t.perPage,class:"rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100",onChange:s[3]||(s[3]=d=>l.$emit("update:per-page",Number(d.target.value)))},[...s[6]||(s[6]=[e("option",{value:10},"10",-1),e("option",{value:15},"15",-1),e("option",{value:25},"25",-1),e("option",{value:50},"50",-1)])],40,se)])]),e("div",re,[e("div",oe,[e("button",{type:"button",class:H(["px-3 py-2 text-sm font-medium rounded-md transition",t.activeStageId===null?"bg-blue-600 text-white":"text-gray-700 hover:bg-gray-50 dark:text-slate-200 dark:hover:bg-slate-800"]),onClick:s[4]||(s[4]=d=>l.$emit("stage-filter",null))},[s[7]||(s[7]=W(" Todos ",-1)),e("span",ne,r(t.totalCount),1)],2),(c(!0),g(O,null,U(t.stages,d=>(c(),g("button",{key:d.id,type:"button",class:H(["px-3 py-2 text-sm font-medium rounded-md transition",t.activeStageId===d.id?"bg-blue-600 text-white":"text-gray-700 hover:bg-gray-50 dark:text-slate-200 dark:hover:bg-slate-800"]),onClick:v=>l.$emit("stage-filter",d.id)},[W(r(d.name)+" ",1),e("span",de,r(d.count??0),1)],10,le))),128))])])]))}},ce={class:"border-b border-gray-100 bg-white hover:bg-blue-50/40 transition-colors dark:border-slate-800 dark:bg-slate-900 dark:hover:bg-slate-800/60"},ue={class:"px-4 py-3 font-medium text-gray-900 dark:text-slate-100"},ge={class:"px-4 py-3"},pe=["value","disabled"],me={key:0,selected:"",disabled:"",class:"text-sm text-gray-600"},ye=["value"],be={class:"px-4 py-3"},he=["disabled"],xe={key:1,class:"text-xs text-gray-500 dark:text-slate-400"},ve={class:"px-4 py-3"},fe={class:"px-4 py-3 text-right"},ke={class:"px-4 py-3"},we={class:"px-4 py-3"},$e={class:"px-4 py-3"},_e={class:"px-4 py-3"},Ce={class:"px-4 py-3"},Se={class:"px-4 py-3"},Ie={class:"px-4 py-3"},Pe={class:"px-4 py-3"},Ee={class:"px-4 py-3"},Be={class:"px-4 py-3"},De={class:"px-4 py-3"},Te={class:"px-4 py-3"},Ne={class:"px-4 py-3"},Ae={class:"px-4 py-3"},Fe={__name:"LeadsTableRow",props:{lead:{type:Object,required:!0},stages:{type:Array,required:!0},stageNameById:{type:Map,required:!0},savingStage:{type:Boolean,default:!1},archiving:{type:Boolean,default:!1}},emits:["stage-change","archive"],setup(t){const l=t,s=h(()=>l.stageNameById.get(l.lead.stage_id)),d=h(()=>l.lead.archived_at||l.lead.won_at),v=h(()=>!l.lead.archived_at&&!l.lead.won_at),f=(i,u="EUR")=>i?new Intl.NumberFormat("es-ES",{style:"currency",currency:u||"EUR"}).format(i):"",y=i=>i?new Date(i).toLocaleString("es-ES"):"";return(i,u)=>(c(),g("tr",ce,[e("td",ue,r(t.lead.id),1),e("td",ge,[e("select",{value:t.lead.stage_id,class:"inline-block w-auto min-w-[120px] rounded-lg border border-gray-200 bg-white px-2 py-1.5 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 disabled:opacity-60 dark:border-slate-800 dark:bg-slate-950 dark:text-slate-100",disabled:t.savingStage||d.value,onChange:u[0]||(u[0]=m=>i.$emit("stage-change",t.lead,m))},[s.value?D("",!0):(c(),g("option",me," Etapa: "+r(t.lead.stage_name??"Cargando…"),1)),(c(!0),g(O,null,U(t.stages,m=>(c(),g("option",{key:m.id,value:m.id},r(m.name),9,ye))),128))],40,pe)]),e("td",be,[v.value?(c(),g("button",{key:0,type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:t.archiving,onClick:u[1]||(u[1]=m=>i.$emit("archive",t.lead))},r(t.archiving?"Archivando…":"Archivar"),9,he)):(c(),g("span",xe,"—"))]),e("td",ve,r(t.lead.name??""),1),e("td",fe,r(f(t.lead.amount,t.lead.currency)),1),e("td",ke,r(t.lead.currency??""),1),e("td",we,r(t.lead.contact_name??""),1),e("td",$e,r(t.lead.contact_phone??""),1),e("td",_e,r(t.lead.contact_email??""),1),e("td",Ce,r(t.lead.company_name??""),1),e("td",Se,r(t.lead.company_address??""),1),e("td",Ie,r(t.lead.document_type??""),1),e("td",Pe,r(t.lead.document_number??""),1),e("td",Ee,r(t.lead.customer_id??""),1),e("td",Be,r(t.lead.created_by??""),1),e("td",De,r(y(t.lead.won_at)),1),e("td",Te,r(y(t.lead.archived_at)),1),e("td",Ne,r(y(t.lead.created_at)),1),e("td",Ae,r(y(t.lead.updated_at)),1)]))}},Ve={class:"p-4 flex items-center justify-between gap-3"},qe=["disabled"],Le={class:"text-xs text-gray-600 dark:text-slate-300"},je=["disabled"],Me={__name:"LeadsTablePagination",props:{pagination:{type:Object,required:!0,default:()=>({current_page:1,last_page:1})},loading:{type:Boolean,default:!1}},emits:["page-change"],setup(t){return(l,s)=>(c(),g("div",Ve,[e("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:t.loading||t.pagination.current_page<=1,onClick:s[0]||(s[0]=d=>l.$emit("page-change",t.pagination.current_page-1))}," Anterior ",8,qe),e("div",Le," Página "+r(t.pagination.current_page)+" / "+r(t.pagination.last_page),1),e("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:t.loading||t.pagination.current_page>=t.pagination.last_page,onClick:s[1]||(s[1]=d=>l.$emit("page-change",t.pagination.current_page+1))}," Siguiente ",8,je)]))}};function ze(t={}){const{endpoint:l,defaultPerPage:s=25,defaultFilters:d={},searchDebounce:v=300}=t,f=x(!1),y=x(null),i=x([]),u=G({current_page:1,last_page:1,per_page:s,total:0,from:null,to:null}),m=G({q:"",page:1,per_page:s,...d}),L=h(()=>i.value.length>0),j=h(()=>!f.value&&i.value.length===0),_=h(()=>u.total||0),I=h(()=>{if(!u.total)return"";const p=u.from||0,C=u.to||0,S=u.total||0;return`${p}-${C} de ${S}`}),k=async(p={})=>{var C,S,V;if(!l){console.error("useTableData: endpoint is required");return}f.value=!0,y.value=null;try{const a={...m,...p},o=await B.get(l,{params:a}),n=((C=o.data)==null?void 0:C.data)||o.data;i.value=(n==null?void 0:n.items)||[],n!=null&&n.pagination&&Object.assign(u,n.pagination)}catch(a){y.value=((V=(S=a.response)==null?void 0:S.data)==null?void 0:V.message)||"Error al cargar los datos",console.error("useTableData fetch error:",a)}finally{f.value=!1}},w=async(p={})=>{Object.assign(m,p),await k()},P=async p=>{await w({page:p})},T=async p=>{await w({per_page:p,page:1})},N=async p=>{await w({q:p,page:1})},M=async()=>{await k()},A=async()=>{Object.assign(m,{q:"",page:1,per_page:s,...d}),await k()};let F;return{loading:f,error:y,items:i,pagination:u,filters:m,hasData:L,isEmpty:j,totalCount:_,paginationInfo:I,fetchData:k,applyFilters:w,changePage:P,changePerPage:T,search:N,debouncedSearch:p=>{clearTimeout(F),F=setTimeout(()=>{N(p)},v)},refresh:M,reset:A}}const Oe={key:0,class:"mb-4 rounded-lg border border-red-200 bg-red-50 p-3 text-sm text-red-700 dark:border-red-900/40 dark:bg-red-950/30 dark:text-red-200"},Ue={class:"bg-white border border-gray-200 rounded-lg shadow-sm dark:bg-slate-900 dark:border-slate-800"},Re={class:"p-4 border-b border-gray-200 dark:border-slate-800 flex items-center justify-between"},He={class:"mt-1 text-xs text-gray-600 dark:text-slate-300"},We={key:0},Ge={key:0,class:"text-xs text-gray-600 dark:text-slate-300"},Je={class:"overflow-x-auto"},Ke={class:"min-w-[1400px] w-full text-sm text-left text-gray-700 dark:text-slate-200"},Qe={key:0},tt={__name:"LeadsTable",setup(t){const{loading:l,error:s,items:d,pagination:v,isEmpty:f,paginationInfo:y,fetchData:i,applyFilters:u,changePage:m,changePerPage:L,debouncedSearch:j}=ze({endpoint:"/leads/data",defaultPerPage:25}),_=x([]),I=x(!1),k=x(new Set),w=x(new Set),P=x(""),T=x(null),N=h(()=>v.per_page),M=h(()=>v.total||0),A=h(()=>{const a=new Map;return _.value.forEach(o=>{a.set(o.id,o.name)}),a});K(P,a=>{j(a)});const F=a=>{L(a)},R=a=>{T.value=a,u({stageId:a,page:1})},p=async(a,o)=>{const n=parseInt(o.target.value);if(n!==a.stage_id){k.value.add(a.id);try{await B.patch(`/leads/${a.id}`,{stage_id:n}),a.stage_id=n,a.stage_name=A.value.get(n),$.fire({title:"¡Actualizado!",text:"Etapa del lead actualizada correctamente",icon:"success",timer:2e3,showConfirmButton:!1})}catch(q){console.error(q),$.fire({title:"Error",text:"No se pudo actualizar la etapa del lead",icon:"error"})}finally{k.value.delete(a.id)}}},C=async a=>{if((await $.fire({title:"¿Archivar lead?",text:`Se archivará el lead "${a.name}"`,icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, archivar",cancelButtonText:"Cancelar",reverseButtons:!0})).isConfirmed){w.value.add(a.id);try{await B.patch(`/leads/${a.id}/archive`),$.fire({title:"¡Archivado!",text:"Lead archivado correctamente",icon:"success",timer:2e3,showConfirmButton:!1}),await i()}catch(n){console.error(n),$.fire({title:"Error",text:"No se pudo archivar el lead",icon:"error"})}finally{w.value.delete(a.id)}}},S=async a=>{var n,q;const o=a.target.files[0];if(o){I.value=!0;try{const E=new FormData;E.append("file",o);const z=(await B.post("/leads/import",E,{headers:{"Content-Type":"multipart/form-data"}})).data;$.fire({title:"¡Importación completada!",html:`
        <div class="text-left">
          <p><strong>Procesados:</strong> ${z.processed||0}</p>
          <p><strong>Importados:</strong> ${z.imported||0}</p>
          <p><strong>Errores:</strong> ${z.errors||0}</p>
        </div>
      `,icon:"success"}),await i()}catch(E){console.error(E),$.fire({title:"Error en la importación",text:((q=(n=E.response)==null?void 0:n.data)==null?void 0:q.message)||"Error desconocido",icon:"error"})}finally{I.value=!1,a.target.value=""}}},V=async()=>{var a;try{const o=await B.get("/leads/stages");_.value=((a=o.data)==null?void 0:a.data)||[]}catch(o){console.error("Error loading stages:",o)}};return Q(async()=>{await Promise.all([V(),i()])}),(a,o)=>(c(),g("section",null,[J(ie,{modelValue:P.value,"onUpdate:modelValue":o[0]||(o[0]=n=>P.value=n),stages:_.value,"active-stage-id":T.value,"total-count":M.value,"per-page":N.value,importing:I.value,"onUpdate:perPage":F,onStageFilter:R,onImportFile:S},null,8,["modelValue","stages","active-stage-id","total-count","per-page","importing"]),b(s)?(c(),g("div",Oe,r(b(s)),1)):D("",!0),e("div",Ue,[e("div",Re,[e("div",null,[o[1]||(o[1]=e("div",{class:"text-sm font-semibold text-gray-900 dark:text-slate-100"},"Leads",-1)),e("div",He,[b(y)?(c(),g("span",We,r(b(y)),1)):D("",!0)])]),b(l)?(c(),g("div",Ge,"Cargando…")):D("",!0)]),e("div",Je,[e("table",Ke,[o[3]||(o[3]=e("thead",{class:"text-xs uppercase bg-gray-50 text-gray-700 dark:bg-slate-800 dark:text-slate-200"},[e("tr",null,[e("th",{class:"px-4 py-3"},"ID"),e("th",{class:"px-4 py-3"},"Etapa"),e("th",{class:"px-4 py-3"},"Acciones"),e("th",{class:"px-4 py-3"},"Nombre"),e("th",{class:"px-4 py-3 text-right"},"Monto"),e("th",{class:"px-4 py-3"},"Moneda"),e("th",{class:"px-4 py-3"},"Contacto"),e("th",{class:"px-4 py-3"},"Teléfono"),e("th",{class:"px-4 py-3"},"Email"),e("th",{class:"px-4 py-3"},"Empresa"),e("th",{class:"px-4 py-3"},"Dirección"),e("th",{class:"px-4 py-3"},"Doc. tipo"),e("th",{class:"px-4 py-3"},"Doc. nro"),e("th",{class:"px-4 py-3"},"Customer ID"),e("th",{class:"px-4 py-3"},"Creado por"),e("th",{class:"px-4 py-3"},"Won at"),e("th",{class:"px-4 py-3"},"Archivado"),e("th",{class:"px-4 py-3"},"Creado"),e("th",{class:"px-4 py-3"},"Actualizado")])],-1)),e("tbody",null,[(c(!0),g(O,null,U(b(d),n=>(c(),X(Fe,{key:n.id,lead:n,stages:_.value,"stage-name-by-id":A.value,"saving-stage":k.value.has(n.id),archiving:w.value.has(n.id),onStageChange:p,onArchive:C},null,8,["lead","stages","stage-name-by-id","saving-stage","archiving"]))),128)),b(f)?(c(),g("tr",Qe,[...o[2]||(o[2]=[e("td",{colspan:"19",class:"px-4 py-10 text-center text-sm text-gray-600 dark:text-slate-300"}," Sin leads. ",-1)])])):D("",!0)])])]),J(Me,{pagination:b(v),loading:b(l),onPageChange:b(m)},null,8,["pagination","loading","onPageChange"])])]))}};export{tt as default};
