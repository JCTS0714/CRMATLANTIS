import{r as c,e as we,x as U,y as z,o as Ce,f as Se,g as i,i as u,j as t,k as G,w as p,z as j,A as Te,t as o,u as x,G as L,F as h,m as w,v as H,s as K,n as Q}from"./vendor-vue-Diyp6CFE.js";import{a as g}from"./vendor-utils-Czy7fllw.js";import{u as Ae,a as Ne,_ as Ie,t as f,b as T,p as Ee,c as W,d as $e}from"./App-DAC6HJ3v.js";import{_ as Fe}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./app-BDRZbfW-.js";import"./vendor-ui-BsDgRXDF.js";const Le={class:"p-4"},Oe={class:"mb-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between"},Ve={class:"w-full sm:max-w-md"},Me={class:"flex items-center gap-2"},Pe=["disabled"],Re=["disabled"],Ue=["disabled"],ze={class:"text-sm text-slate-600 dark:text-slate-300"},je={key:0},Be={key:1},De={key:0,class:"mb-4 rounded-lg border border-slate-200 bg-slate-50 p-3 dark:border-slate-700 dark:bg-slate-800/50"},Je={class:"grid grid-cols-1 gap-3 md:grid-cols-2 xl:grid-cols-3"},qe=["value"],Ge=["value"],He=["value"],Ke=["value"],Qe={class:"mt-3 flex items-center gap-2"},We=["disabled"],Xe={class:"search-loading-track"},Ye={class:"px-4 py-3"},Ze={class:"px-4 py-3 font-medium text-slate-900 dark:text-slate-100"},et={class:"px-4 py-3"},tt={class:"px-4 py-3"},at={class:"px-4 py-3"},st={class:"px-4 py-3"},lt={key:0},ot={key:1},rt={class:"px-4 py-3"},nt={class:"px-4 py-3"},dt={class:"px-4 py-3"},it={class:"px-4 py-3"},ut={class:"px-4 py-3"},ct={class:"px-4 py-3"},bt={class:"px-4 py-3"},mt={class:"px-4 py-3"},pt={class:"px-4 py-3"},vt={class:"px-4 py-3"},yt={class:"flex items-center gap-2"},xt=["onClick"],gt=["disabled","onClick"],ft=["disabled","onClick"],kt={class:"mt-4 flex items-center justify-between"},_t=["disabled"],ht={class:"text-sm text-slate-600 dark:text-slate-300"},wt=["disabled"],Ct={__name:"PostventaCustomersTable",setup(St){const y=c([]),k=c(!1),A=c(!1),O=c(!1),N=c(null),I=c(!1),E=c(!1),X=(()=>{if(typeof window>"u")return!1;const e=window.location.hostname;return e==="localhost"||e==="127.0.0.1"||e==="::1"})(),V=c(new Set),M=c(new Set),$=c("");let C=null;const F=c(!1),r=c({servidor:"",menbresia:"",rubro:"",document_type:"",fecha_contacto_mes:"",fecha_contacto_anio:""}),Y=["ATLANTIS ONLINE","ATLANTIS VIP","ATLANTIS POS","ATLANTIS FAST","LORITO"],Z=["Mensual","Trimestral","Semestral","Anual"],ee=["dni","ruc","otro"],te=[{value:1,label:"Enero"},{value:2,label:"Febrero"},{value:3,label:"Marzo"},{value:4,label:"Abril"},{value:5,label:"Mayo"},{value:6,label:"Junio"},{value:7,label:"Julio"},{value:8,label:"Agosto"},{value:9,label:"Septiembre"},{value:10,label:"Octubre"},{value:11,label:"Noviembre"},{value:12,label:"Diciembre"}],ae=we(()=>Object.values(r.value).some(e=>String(e).trim()!=="")),d=c({current_page:1,last_page:1,per_page:15,total:0,from:0,to:0}),P=[{key:"csv_numero",label:"N°"},{key:"customer",label:"Cliente"},{key:"company",label:"Empresa"},{key:"precio",label:"Precio"},{key:"rubro",label:"Rubro"},{key:"document",label:"Documento"},{key:"phone",label:"Teléfono"},{key:"email",label:"Email"},{key:"link",label:"Link"},{key:"usuario",label:"Usuario"},{key:"contrasena",label:"Contraseña"},{key:"servidor",label:"Servidor"},{key:"fecha_contacto_mes",label:"Mes contacto"},{key:"fecha_contacto_anio",label:"Año contacto"},{key:"fecha_creacion",label:"F. creación"},{key:"actions",label:"Acciones"}],{tableRef:B,visibleKeys:D,isColumnVisible:se,toggleColumn:le,resetColumns:oe}=Ae({tableId:"postventa-customers-table",columns:P}),{tableScrollRef:re,stickyScrollRef:ne,stickyScrollWidth:de,showStickyXScroll:ie,refreshStickyScroll:R}=Ne({tableRef:B}),ue=()=>{const e={};return r.value.servidor&&(e.servidor=r.value.servidor),r.value.menbresia&&(e.menbresia=r.value.menbresia),r.value.rubro&&(e.rubro=r.value.rubro),r.value.document_type&&(e.document_type=r.value.document_type),r.value.fecha_contacto_mes&&(e.fecha_contacto_mes=r.value.fecha_contacto_mes),r.value.fecha_contacto_anio&&(e.fecha_contacto_anio=r.value.fecha_contacto_anio),e},m=async(e=1)=>{k.value=!0;try{const{data:s}=await g.get("/customers/data",{params:{q:$.value||"",per_page:d.value.per_page,page:e,...ue()}});y.value=s.customers||[],d.value={...d.value,...s.pagination||{}},O.value=!0,setTimeout(()=>{O.value=!1},220)}finally{k.value=!1}},ce=async()=>{await m(1)},be=async()=>{r.value={servidor:"",menbresia:"",rubro:"",document_type:"",fecha_contacto_mes:"",fecha_contacto_anio:""},await m(1)},me=e=>{const s=Number(d.value.from);if(Number.isFinite(s)&&s>0)return s+e;const a=Number(d.value.current_page)||1,l=Number(d.value.per_page)||15;return(a-1)*l+e+1},pe=()=>{var e,s;(s=(e=N.value)==null?void 0:e.click)==null||s.call(e)},ve=async e=>{var a,l,n,b,v;const s=(l=(a=e==null?void 0:e.target)==null?void 0:a.files)==null?void 0:l[0];if(s){I.value=!0;try{const _=new FormData;_.append("csv",s);const{data:S}=await g.post("/customers/import",_,{headers:{"Content-Type":"multipart/form-data"}});T(((n=S==null?void 0:S.output)!=null&&n.trim(),"Importación finalizada")),await m(1)}catch(_){const S=((v=(b=_==null?void 0:_.response)==null?void 0:b.data)==null?void 0:v.message)??"No se pudo importar el CSV.";f(S)}finally{I.value=!1,N.value&&(N.value.value="")}}},ye=async()=>{var s,a;if(await W({title:"Borrar tabla de clientes (solo local)",text:"Se eliminarán todos los clientes de la tabla en tu entorno local. Esta acción no se puede deshacer.",confirmText:"Sí, borrar todo",cancelText:"Cancelar",icon:"warning"})){E.value=!0;try{const{data:l}=await g.post("/customers/clear-local");T((l==null?void 0:l.message)||"Tabla de clientes limpiada."),await m(1)}catch(l){const n=((a=(s=l==null?void 0:l.response)==null?void 0:s.data)==null?void 0:a.message)??"No se pudo limpiar la tabla de clientes.";f(n)}finally{E.value=!1}}},xe=e=>{const s=(e==null?void 0:e.company_name)||(e==null?void 0:e.name)||"",a=e!=null&&e.company_name?e==null?void 0:e.name:"";let l=s;a&&a!==s&&(l+=` — ${a}`);const n=e!=null&&e.document_number?`${e!=null&&e.document_type?e.document_type+" ":""}${e.document_number}`:"";return n&&(l+=` (${n})`),l},ge=e=>{e!=null&&e.id&&window.dispatchEvent(new CustomEvent("incidencias:create",{detail:{customer_id:e.id,customer_label:xe(e)}}))},fe=async()=>{var s,a;const e=await Ee();if(e){A.value=!0;try{await g.post("/customers",e),T("Cliente creado"),await m(1)}catch(l){const n=((a=(s=l==null?void 0:l.response)==null?void 0:s.data)==null?void 0:a.message)??"No se pudo crear el cliente.";f(n)}finally{A.value=!1}}},J=async e=>{var a,l,n;if(!(e!=null&&e.id))return;const s=await $e(e);if(s){V.value.add(e.id);try{const b=await g.put(`/customers/${e.id}`,s),v=(a=b==null?void 0:b.data)==null?void 0:a.data;v&&typeof v=="object"?Object.assign(e,v):Object.assign(e,s),T("Cliente actualizado")}catch(b){const v=((n=(l=b==null?void 0:b.response)==null?void 0:l.data)==null?void 0:n.message)??"No se pudo actualizar el cliente.";f(v)}finally{V.value.delete(e.id)}}},ke=async e=>{var a,l;if(!(!(e!=null&&e.id)||!await W({title:"Eliminar cliente",text:"Se eliminará el cliente. Las incidencias asociadas quedarán sin cliente (se desvinculan).",confirmText:"Eliminar",cancelText:"Cancelar",icon:"warning"}))){M.value.add(e.id);try{await g.delete(`/customers/${e.id}`),y.value=y.value.filter(n=>n.id!==e.id),T("Cliente eliminado"),m(Math.min(d.value.current_page,d.value.last_page||1))}catch(n){const b=((l=(a=n==null?void 0:n.response)==null?void 0:a.data)==null?void 0:l.message)??"No se pudo eliminar el cliente.";f(b)}finally{M.value.delete(e.id)}}},q=e=>{const s=Math.max(1,Math.min(d.value.last_page||1,e));m(s)},_e=()=>{const e=new URL(window.location.href),s=e.searchParams.get("edit_customer_id");if(!s)return null;const a=Number(s);e.searchParams.delete("edit_customer_id"),e.searchParams.delete("source");const l=`${e.pathname}${e.search?e.search:""}${e.hash||""}`;return window.history.replaceState({},"",l||"/postventa/clientes"),Number.isInteger(a)&&a>0?a:null},he=async()=>{var a;const e=_e();if(!e)return;let s=y.value.find(l=>Number(l.id)===e)||null;if(!s)try{const l=await g.get(`/customers/${e}`);s=((a=l==null?void 0:l.data)==null?void 0:a.data)??null,s&&y.value.unshift(s)}catch{f("No se pudo abrir el cliente convertido para edición.");return}if(!s){f("No se encontró el cliente convertido.");return}await J(s)};return U($,()=>{C&&clearTimeout(C),C=setTimeout(()=>{m(1)},300)},{flush:"post"}),U(D,async()=>{await z(),R()},{deep:!0}),U(y,async()=>{await z(),R()}),Ce(async()=>{await m(1),await he(),await z(),R()}),Se(()=>{C&&clearTimeout(C)}),(e,s)=>(u(),i("div",Le,[t("div",Oe,[t("div",Ve,[p(t("input",{"onUpdate:modelValue":s[0]||(s[0]=a=>$.value=a),type:"text",class:"w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 focus:border-sky-500 focus:ring-sky-500 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100",placeholder:"Buscar cliente (nombre, contacto, empresa, documento…)"},null,512),[[j,$.value]])]),t("div",Me,[t("input",{ref_key:"importInput",ref:N,type:"file",accept:".csv,text/csv",class:"hidden",onChange:ve},null,544),t("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:I.value,onClick:pe},o(I.value?"Importando…":"Importar CSV"),9,Pe),t("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",onClick:s[1]||(s[1]=a=>F.value=!F.value)},o(F.value?"Ocultar filtros":"Filtros avanzados"),1),t("button",{type:"button",class:"inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 disabled:opacity-60",disabled:A.value,onClick:fe},o(A.value?"Creando…":"Crear cliente"),9,Re),x(X)?(u(),i("button",{key:0,type:"button",class:"inline-flex items-center rounded-lg border border-red-300 bg-red-50 px-3 py-2 text-sm font-medium text-red-700 hover:bg-red-100 disabled:opacity-60 dark:border-red-900/60 dark:bg-red-950/30 dark:text-red-300 dark:hover:bg-red-900/40",disabled:E.value,onClick:ye},o(E.value?"Limpiando…":"Borrar tabla (local)"),9,Ue)):G("",!0),t("div",ze,[d.value.total?(u(),i("span",je,"Mostrando "+o(d.value.from)+"–"+o(d.value.to)+" de "+o(d.value.total),1)):(u(),i("span",Be,"Sin resultados"))]),Te(Ie,{columns:P,"visible-keys":x(D),onToggle:x(le),onReset:x(oe)},null,8,["visible-keys","onToggle","onReset"])])]),F.value?(u(),i("div",De,[t("div",Je,[t("div",null,[s[11]||(s[11]=t("label",{class:"mb-1 block text-xs font-medium text-slate-600 dark:text-slate-300"},"Servidor",-1)),p(t("select",{"onUpdate:modelValue":s[2]||(s[2]=a=>r.value.servidor=a),class:"w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100"},[s[10]||(s[10]=t("option",{value:""},"Todos",-1)),(u(),i(h,null,w(Y,a=>t("option",{key:a,value:a},o(a),9,qe)),64))],512),[[L,r.value.servidor]])]),t("div",null,[s[13]||(s[13]=t("label",{class:"mb-1 block text-xs font-medium text-slate-600 dark:text-slate-300"},"Menbresia",-1)),p(t("select",{"onUpdate:modelValue":s[3]||(s[3]=a=>r.value.menbresia=a),class:"w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100"},[s[12]||(s[12]=t("option",{value:""},"Todas",-1)),(u(),i(h,null,w(Z,a=>t("option",{key:a,value:a},o(a),9,Ge)),64))],512),[[L,r.value.menbresia]])]),t("div",null,[s[15]||(s[15]=t("label",{class:"mb-1 block text-xs font-medium text-slate-600 dark:text-slate-300"},"Tipo documento",-1)),p(t("select",{"onUpdate:modelValue":s[4]||(s[4]=a=>r.value.document_type=a),class:"w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100"},[s[14]||(s[14]=t("option",{value:""},"Todos",-1)),(u(),i(h,null,w(ee,a=>t("option",{key:a,value:a},o(a.toUpperCase()),9,He)),64))],512),[[L,r.value.document_type]])]),t("div",null,[s[16]||(s[16]=t("label",{class:"mb-1 block text-xs font-medium text-slate-600 dark:text-slate-300"},"Rubro",-1)),p(t("input",{"onUpdate:modelValue":s[5]||(s[5]=a=>r.value.rubro=a),type:"text",class:"w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100",placeholder:"Ej. restaurante"},null,512),[[j,r.value.rubro]])]),t("div",null,[s[18]||(s[18]=t("label",{class:"mb-1 block text-xs font-medium text-slate-600 dark:text-slate-300"},"Mes contacto",-1)),p(t("select",{"onUpdate:modelValue":s[6]||(s[6]=a=>r.value.fecha_contacto_mes=a),class:"w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100"},[s[17]||(s[17]=t("option",{value:""},"Todos",-1)),(u(),i(h,null,w(te,a=>t("option",{key:a.value,value:a.value},o(a.label),9,Ke)),64))],512),[[L,r.value.fecha_contacto_mes]])]),t("div",null,[s[19]||(s[19]=t("label",{class:"mb-1 block text-xs font-medium text-slate-600 dark:text-slate-300"},"Año contacto",-1)),p(t("input",{"onUpdate:modelValue":s[7]||(s[7]=a=>r.value.fecha_contacto_anio=a),type:"number",min:"2000",max:"2100",class:"w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100",placeholder:"2026"},null,512),[[j,r.value.fecha_contacto_anio]])])]),t("div",Qe,[t("button",{type:"button",class:"inline-flex items-center rounded-lg bg-blue-600 px-3 py-2 text-sm font-medium text-white hover:bg-blue-700",onClick:ce}," Aplicar filtros "),t("button",{type:"button",class:"inline-flex items-center rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:!ae.value,onClick:be}," Limpiar ",8,We)])])):G("",!0),t("div",{ref_key:"tableScrollRef",ref:re,class:Q(["relative overflow-x-auto rounded-lg border border-slate-200 bg-white dark:border-slate-800 dark:bg-slate-900",{"table-updated-flash":O.value}])},[p(t("div",Xe,[...s[20]||(s[20]=[t("div",{class:"search-loading-bar"},null,-1)])],512),[[H,k.value]]),t("table",{ref_key:"tableRef",ref:B,class:"min-w-full text-left text-sm text-slate-700 dark:text-slate-200"},[t("colgroup",null,[(u(),i(h,null,w(P,a=>t("col",{key:a.key,style:K({display:x(se)(a.key)?"":"none"})},null,4)),64))]),s[21]||(s[21]=t("thead",{class:"bg-slate-50 text-xs uppercase text-slate-600 dark:bg-slate-800 dark:text-slate-200"},[t("tr",null,[t("th",{class:"px-4 py-3"},"N°"),t("th",{class:"px-4 py-3"},"Cliente"),t("th",{class:"px-4 py-3"},"Empresa"),t("th",{class:"px-4 py-3"},"Precio"),t("th",{class:"px-4 py-3"},"Rubro"),t("th",{class:"px-4 py-3"},"Documento"),t("th",{class:"px-4 py-3"},"Teléfono"),t("th",{class:"px-4 py-3"},"Email"),t("th",{class:"px-4 py-3"},"Link"),t("th",{class:"px-4 py-3"},"Usuario"),t("th",{class:"px-4 py-3"},"Contraseña"),t("th",{class:"px-4 py-3"},"Servidor"),t("th",{class:"px-4 py-3"},"Mes contacto"),t("th",{class:"px-4 py-3"},"Año contacto"),t("th",{class:"px-4 py-3"},"F. creación"),t("th",{class:"px-4 py-3"},"Acciones")])],-1)),t("tbody",{class:Q(["transition-opacity duration-200",{"opacity-55":k.value}])},[(u(!0),i(h,null,w(y.value,(a,l)=>(u(),i("tr",{key:a.id,class:"border-t border-slate-200 hover:bg-slate-50 dark:border-slate-800 dark:hover:bg-slate-800"},[t("td",Ye,o(me(l)),1),t("td",Ze,o(a.contact_name||a.name||"—"),1),t("td",et,o(a.company_name||"—"),1),t("td",tt,o(a.precio??"—"),1),t("td",at,o(a.rubro||"—"),1),t("td",st,[a.document_type||a.document_number?(u(),i("span",lt,o(a.document_type||"")+" "+o(a.document_number||""),1)):(u(),i("span",ot,"—"))]),t("td",rt,o(a.contact_phone||"—"),1),t("td",nt,o(a.contact_email||"—"),1),t("td",dt,o(a.link||"—"),1),t("td",it,o(a.usuario||"—"),1),t("td",ut,o(a.contrasena||"—"),1),t("td",ct,o(a.servidor||"—"),1),t("td",bt,o(a.fecha_contacto_mes||"—"),1),t("td",mt,o(a.fecha_contacto_anio||"—"),1),t("td",pt,o(a.fecha_creacion||"—"),1),t("td",vt,[t("div",yt,[t("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",onClick:n=>ge(a)}," Abrir incidencia ",8,xt),t("button",{type:"button",class:"inline-flex items-center rounded-lg border border-slate-300 bg-white px-3 py-1.5 text-xs font-medium text-slate-700 hover:bg-slate-50 disabled:opacity-60 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:V.value.has(a.id),onClick:n=>J(a)}," Editar ",8,gt),t("button",{type:"button",class:"inline-flex items-center rounded-lg border border-red-200 bg-white px-3 py-1.5 text-xs font-medium text-red-700 hover:bg-red-50 disabled:opacity-60 dark:border-red-900/40 dark:bg-slate-900 dark:text-red-300 dark:hover:bg-red-950/30",disabled:M.value.has(a.id),onClick:n=>ke(a)}," Eliminar ",8,ft)])])]))),128))],2)],512)],2),p(t("div",{ref_key:"stickyScrollRef",ref:ne,class:"sticky bottom-0 z-20 mt-2 overflow-x-auto rounded-lg border border-slate-200 bg-white/95 dark:border-slate-700 dark:bg-slate-900/95"},[t("div",{style:K({width:`${x(de)}px`,height:"1px"})},null,4)],512),[[H,x(ie)]]),t("div",kt,[t("button",{class:"rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 disabled:cursor-not-allowed disabled:opacity-50 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:d.value.current_page<=1||k.value,onClick:s[8]||(s[8]=a=>q(d.value.current_page-1))}," Anterior ",8,_t),t("div",ht," Página "+o(d.value.current_page)+" / "+o(d.value.last_page),1),t("button",{class:"rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 disabled:cursor-not-allowed disabled:opacity-50 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:d.value.current_page>=d.value.last_page||k.value,onClick:s[9]||(s[9]=a=>q(d.value.current_page+1))}," Siguiente ",8,wt)])]))}},Ft=Fe(Ct,[["__scopeId","data-v-e4dfcb37"]]);export{Ft as default};
