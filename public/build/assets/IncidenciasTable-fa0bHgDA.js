import{r as l,e as te,o as ae,f as se,H as re,g as i,i as c,j as a,k as _,w as P,x as ne,t as o,D as oe,n as q,z as B,F as H,m as O}from"./vendor-vue-Db-AqoDh.js";import{a as N}from"./vendor-utils-Czy7fllw.js";import{a as M,t as V,c as Q}from"./App-BQAus7JI.js";import"./app-DcWcYQGw.js";import"./vendor-ui-DEm6YKEA.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const de={class:"mb-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between"},le={class:"flex-1"},ie={class:"flex items-center gap-2"},ce=["disabled"],ue={class:"mb-4 overflow-x-auto"},pe={class:"inline-flex rounded-lg border border-gray-200 bg-white p-1 shadow-sm dark:border-slate-800 dark:bg-slate-900"},ge={class:"ml-2 rounded bg-black/5 px-2 py-0.5 text-xs font-semibold text-gray-700 dark:bg-white/10 dark:text-slate-200"},ve=["onClick"],me={class:"ml-2 rounded bg-black/5 px-2 py-0.5 text-xs font-semibold text-gray-700 dark:bg-white/10 dark:text-slate-200"},be={key:0,class:"mb-4 rounded-lg border border-red-200 bg-red-50 p-3 text-sm text-red-700 dark:border-red-900/40 dark:bg-red-950/30 dark:text-red-200"},xe={class:"bg-white border border-gray-200 rounded-lg shadow-sm dark:bg-slate-900 dark:border-slate-800"},ye={class:"p-4 border-b border-gray-200 dark:border-slate-800 flex items-center justify-between"},he={class:"mt-1 text-xs text-gray-600 dark:text-slate-300"},fe={key:0},ke={key:0,class:"text-xs text-gray-600 dark:text-slate-300"},we={class:"overflow-x-auto"},_e={class:"min-w-[1300px] w-full text-sm text-left text-gray-700 dark:text-slate-200"},Ce={class:"px-4 py-3 font-medium text-gray-900 dark:text-slate-100"},Ie={class:"px-4 py-3"},Se={class:"px-4 py-3"},Ee={class:"flex items-center gap-2"},Te=["disabled","onClick"],De=["disabled","onClick"],Ne=["disabled","onClick"],Le={key:0,class:"w-3 h-3 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},$e={key:1,class:"w-3 h-3 mr-1 animate-spin",fill:"none",viewBox:"0 0 24 24"},Ae={class:"px-4 py-3"},Be={class:"px-4 py-3"},Me={key:0},Ve={key:1,class:"text-gray-500 dark:text-slate-400"},je={class:"px-4 py-3"},ze={class:"px-4 py-3"},Fe={class:"px-4 py-3"},Ue={class:"px-4 py-3"},Pe={key:0},qe={class:"p-4 flex items-center justify-between gap-3"},He=["disabled"],Oe={class:"text-xs text-gray-600 dark:text-slate-300"},Qe=["disabled"],Ze={__name:"IncidenciasTable",setup(Re){const L=l([]),g=l([]),C=l(0),m=l(!1),u=l(""),I=l(new Set),f=l(new Set),S=l(null),E=l(!1),T=l(""),$=l("");let k=null;const A=l(15),b=l(null),n=l({current_page:1,last_page:1,per_page:15,total:0,from:0,to:0}),R=()=>{const t=new URL(window.location.href).searchParams.get("q");t&&(T.value=t,$.value=t)},w=({stageId:e=b.value,page:t=n.value.current_page}={})=>{b.value=e===void 0?b.value:e,n.value.current_page=t,x()},x=async()=>{var e,t,s;m.value=!0,u.value="";try{const r=await N.get("/incidencias/data",{params:{stage_id:b.value,q:$.value||"",page:n.value.current_page,per_page:A.value}}),d=((e=r==null?void 0:r.data)==null?void 0:e.data)??{};L.value=d.stages??[],C.value=d.total_count??0,g.value=d.incidences??[],n.value={...n.value,...d.pagination||{}}}catch(r){const d=((s=(t=r==null?void 0:r.response)==null?void 0:t.data)==null?void 0:s.message)??"No se pudo cargar incidencias.";u.value=d}finally{m.value=!1}},G=()=>{var e,t;(t=(e=S.value)==null?void 0:e.click)==null||t.call(e)},J=async e=>{var s,r,d,p,v;const t=(r=(s=e==null?void 0:e.target)==null?void 0:s.files)==null?void 0:r[0];if(t){E.value=!0,u.value="";try{const y=new FormData;y.append("csv",t);const{data:h}=await N.post("/incidencias/import",y,{headers:{"Content-Type":"multipart/form-data"}});M(((d=h==null?void 0:h.output)!=null&&d.trim(),"Importación finalizada")),n.value.current_page=1,await x()}catch(y){const h=((v=(p=y==null?void 0:y.response)==null?void 0:p.data)==null?void 0:v.message)??"No se pudo importar el CSV.";u.value=h,V(h)}finally{E.value=!1,S.value&&(S.value.value="")}}},K=te(()=>{const e=new Map;for(const t of L.value)e.set(t.id,t);return e}),j=e=>!!(e!=null&&e.archived_at),W=e=>{e!=null&&e.id&&window.dispatchEvent(new CustomEvent("incidencias:edit",{detail:{incidence:e}}))},z=e=>{if(!e||j(e))return!1;const t=K.value.get(e.stage_id);return!!(t!=null&&t.is_done)},X=async e=>{var s,r,d;if(!(!(e!=null&&e.id)||!z(e)||!await Q({title:"Archivar incidencia",text:"Se ocultará del backlog, pero seguirá visible en la tabla (historial).",confirmText:"Archivar",cancelText:"Cancelar",icon:"warning"}))){I.value.add(e.id),u.value="";try{const p=await N.patch(`/incidencias/${e.id}/archive`),v=(s=p==null?void 0:p.data)==null?void 0:s.data;v&&typeof v=="object"?Object.assign(e,v):e.archived_at=new Date().toISOString(),M("Incidencia archivada"),window.dispatchEvent(new CustomEvent("incidencias:archived"))}catch(p){const v=((d=(r=p==null?void 0:p.response)==null?void 0:r.data)==null?void 0:d.message)??"No se pudo archivar la incidencia.";u.value=v,V(v)}finally{I.value.delete(e.id)}}},Y=async e=>{await Q({title:"¿Eliminar incidencia?",text:`Se eliminará permanentemente "${e.title||`#${e.correlative}`}"`,confirmText:"Sí, eliminar",cancelText:"Cancelar",icon:"warning"})&&await Z(e)},Z=async e=>{var t,s;f.value.add(e.id),u.value="";try{await N.delete(`/incidencias/${e.id}`);const r=g.value.findIndex(d=>d.id===e.id);if(r!==-1&&(g.value.splice(r,1),C.value=Math.max(0,C.value-1),g.value.length===0&&n.value.current_page>1)){n.value.current_page--,x();return}M("Incidencia eliminada exitosamente"),window.dispatchEvent(new CustomEvent("incidencias:deleted"))}catch(r){const d=((s=(t=r==null?void 0:r.response)==null?void 0:t.data)==null?void 0:s.message)??"No se pudo eliminar la incidencia.";u.value=d,V(d)}finally{f.value.delete(e.id)}},ee=e=>{if(!e)return"";try{const t=new Date(String(e));return Number.isNaN(t.getTime())?String(e):t.toLocaleDateString()}catch{return String(e)}},F=e=>{if(!e)return"";try{const t=new Date(String(e));return Number.isNaN(t.getTime())?String(e):t.toLocaleString()}catch{return String(e)}},D=()=>{n.value.current_page=1,x()},U=e=>{var r;const t=(r=e==null?void 0:e.detail)==null?void 0:r.incidence;if(!(t!=null&&t.id))return;const s=g.value.findIndex(d=>d.id===t.id);s!==-1&&g.value.splice(s,1,{...g.value[s],...t})};return ae(async()=>{R(),window.addEventListener("incidencias:created",D),window.addEventListener("incidencias:archived",D),window.addEventListener("incidencias:updated",U),await x()}),se(()=>{window.removeEventListener("incidencias:created",D),window.removeEventListener("incidencias:archived",D),window.removeEventListener("incidencias:updated",U),k&&window.clearTimeout(k)}),re(T,e=>{k&&window.clearTimeout(k),k=window.setTimeout(()=>{$.value=e,n.value.current_page=1,x()},350)},{flush:"post"}),(e,t)=>(c(),i("section",null,[a("div",de,[a("div",le,[t[6]||(t[6]=a("label",{class:"sr-only",for:"inc-search"},"Buscar",-1)),P(a("input",{id:"inc-search","onUpdate:modelValue":t[0]||(t[0]=s=>T.value=s),type:"search",placeholder:"Buscar por título, correlativo, cliente…",class:"w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900 placeholder:text-gray-400 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:placeholder:text-slate-500"},null,512),[[ne,T.value]])]),a("div",ie,[a("input",{ref_key:"importInput",ref:S,type:"file",accept:".csv,text/csv",class:"hidden",onChange:J},null,544),a("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:E.value,onClick:G},o(E.value?"Importando…":"Importar CSV"),9,ce),P(a("select",{"onUpdate:modelValue":t[1]||(t[1]=s=>A.value=s),class:"rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100",onChange:t[2]||(t[2]=s=>w({page:1}))},[...t[7]||(t[7]=[a("option",{value:10},"10",-1),a("option",{value:15},"15",-1),a("option",{value:25},"25",-1),a("option",{value:50},"50",-1)])],544),[[oe,A.value,void 0,{number:!0}]])])]),a("div",ue,[a("div",pe,[a("button",{type:"button",class:q(["px-3 py-2 text-sm font-medium rounded-md transition",b.value===null?"bg-blue-600 text-white":"text-gray-700 hover:bg-gray-50 dark:text-slate-200 dark:hover:bg-slate-800"]),onClick:t[3]||(t[3]=s=>w({stageId:null,page:1}))},[t[8]||(t[8]=B(" Todos ",-1)),a("span",ge,o(C.value),1)],2),(c(!0),i(H,null,O(L.value,s=>(c(),i("button",{key:s.id,type:"button",class:q(["px-3 py-2 text-sm font-medium rounded-md transition",b.value===s.id?"bg-blue-600 text-white":"text-gray-700 hover:bg-gray-50 dark:text-slate-200 dark:hover:bg-slate-800"]),onClick:r=>w({stageId:s.id,page:1})},[B(o(s.name)+" ",1),a("span",me,o(s.count??0),1)],10,ve))),128))])]),u.value?(c(),i("div",be,o(u.value),1)):_("",!0),a("div",xe,[a("div",ye,[a("div",null,[t[9]||(t[9]=a("div",{class:"text-sm font-semibold text-gray-900 dark:text-slate-100"},"Incidencias",-1)),a("div",he,[n.value.total!==null?(c(),i("span",fe," Mostrando "+o(n.value.from??0)+"–"+o(n.value.to??0)+" de "+o(n.value.total??0),1)):_("",!0)])]),m.value?(c(),i("div",ke,"Cargando…")):_("",!0)]),a("div",we,[a("table",_e,[t[13]||(t[13]=a("thead",{class:"text-xs uppercase bg-gray-50 text-gray-700 dark:bg-slate-800 dark:text-slate-200"},[a("tr",null,[a("th",{class:"px-4 py-3"},"ID"),a("th",{class:"px-4 py-3"},"Correlativo"),a("th",{class:"px-4 py-3"},"Acciones"),a("th",{class:"px-4 py-3"},"Título"),a("th",{class:"px-4 py-3"},"Cliente"),a("th",{class:"px-4 py-3"},"Prioridad"),a("th",{class:"px-4 py-3"},"Fecha"),a("th",{class:"px-4 py-3"},"Archivado"),a("th",{class:"px-4 py-3"},"Actualizado")])],-1)),a("tbody",null,[(c(!0),i(H,null,O(g.value,s=>(c(),i("tr",{key:s.id,class:"border-b border-gray-100 bg-white hover:bg-blue-50/40 transition-colors dark:border-slate-800 dark:bg-slate-900 dark:hover:bg-slate-800/60"},[a("td",Ce,o(s.id),1),a("td",Ie,o(s.correlative||"—"),1),a("td",Se,[a("div",Ee,[a("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:j(s),onClick:r=>W(s)}," Editar ",8,Te),z(s)?(c(),i("button",{key:0,type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:I.value.has(s.id),onClick:r=>X(s)},o(I.value.has(s.id)?"Archivando…":"Archivar"),9,De)):_("",!0),a("button",{type:"button",class:"inline-flex items-center rounded-lg border border-red-200 bg-red-50 px-3 py-1.5 text-xs font-medium text-red-700 shadow-sm hover:bg-red-100 disabled:opacity-60 dark:border-red-800 dark:bg-red-950 dark:text-red-300 dark:hover:bg-red-900",disabled:f.value.has(s.id),onClick:r=>Y(s)},[f.value.has(s.id)?(c(),i("svg",$e,[...t[11]||(t[11]=[a("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),a("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)])])):(c(),i("svg",Le,[...t[10]||(t[10]=[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"},null,-1)])])),B(" "+o(f.value.has(s.id)?"Eliminando…":"Eliminar"),1)],8,Ne)])]),a("td",Ae,o(s.title??""),1),a("td",Be,[s.customer?(c(),i("span",Me,o(s.customer.company_name||s.customer.name),1)):(c(),i("span",Ve,"—"))]),a("td",je,o(s.priority??""),1),a("td",ze,o(ee(s.date)),1),a("td",Fe,o(F(s.archived_at)),1),a("td",Ue,o(F(s.updated_at)),1)]))),128)),!m.value&&g.value.length===0?(c(),i("tr",Pe,[...t[12]||(t[12]=[a("td",{colspan:"9",class:"px-4 py-10 text-center text-sm text-gray-600 dark:text-slate-300"}," Sin incidencias. ",-1)])])):_("",!0)])])]),a("div",qe,[a("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:m.value||n.value.current_page<=1,onClick:t[4]||(t[4]=s=>w({page:n.value.current_page-1}))}," Anterior ",8,He),a("div",Oe," Página "+o(n.value.current_page)+" / "+o(n.value.last_page),1),a("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:m.value||n.value.current_page>=n.value.last_page,onClick:t[5]||(t[5]=s=>w({page:n.value.current_page+1}))}," Siguiente ",8,Qe)])])]))}};export{Ze as default};
