import{r as l,e as be,o as xe,f as fe,g as v,i as g,j as s,w as V,D as W,x as X,t as _,n as H,F as Z,m as ee,l as x,k as te}from"./vendor-vue-Db-AqoDh.js";import{a as D}from"./vendor-utils-Czy7fllw.js";import{a as z,t as R,c as ae}from"./App-3tNeg2y1.js";import"./app-CLTdK2m3.js";import"./vendor-ui-DEm6YKEA.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const pe={class:"mb-4 flex items-center gap-3"},ye={class:"flex items-center gap-2"},ke={class:"flex items-center gap-2"},he={class:"flex items-center gap-2"},we={class:"flex items-center gap-2"},_e={key:0,class:"text-sm text-gray-600 dark:text-slate-300"},Ie={key:1,class:"mb-3 text-sm text-red-600"},Ce=["data-stage-id","onDrop"],Ee={class:"p-4 border-b border-gray-200 dark:border-slate-800"},Ae={class:"flex items-center justify-between gap-3"},De={class:"text-sm font-semibold text-gray-900 dark:text-slate-100"},Me={class:"text-xs text-gray-600 dark:text-slate-300"},Te={class:"p-3 space-y-3 min-h-[140px]"},Le={key:0,class:"text-sm text-gray-500 dark:text-slate-400 px-1"},je=["data-incidence-id"],$e=["data-incidence-id","draggable","onDragstart","onDragover","onDrop"],Be=["onClick"],Ne={class:"text-sm font-semibold text-gray-900 dark:text-slate-100"},Oe={key:0,class:"text-xs text-gray-600 dark:text-slate-300 mt-1"},Fe={key:1,class:"text-xs text-gray-500 dark:text-slate-400 mt-1"},Se=["onClick"],Pe={key:1,class:"mt-3 flex justify-end gap-2"},Ue=["disabled","onClick"],Ve=["disabled","onClick"],ze=["disabled","onClick"],qe={key:2,class:"mt-3 flex justify-end gap-2"},He=["disabled","onClick"],Re=["disabled","onClick"],Ze={__name:"BacklogBoard",setup(Ye){const q=l(!0),c=l([]),y=l(""),B=l(50),N=l(""),O=l(""),F=l(""),k=l(null),m=l(null),C=l(null),h=l(!1),M=l(!1),T=l({incidenceId:null,position:"after",stageId:null}),I=l(null),S=l(new Set),re=be(()=>{const e=c.value.length||1;return e<=1?"grid-cols-1":e===2?"grid-cols-1 md:grid-cols-2":e===3?"grid-cols-1 md:grid-cols-3":"grid-cols-1 md:grid-cols-2 xl:grid-cols-4"}),ne=e=>{if(!e)return"";try{const t=new Date(String(e));return Number.isNaN(t.getTime())?String(e):t.toLocaleDateString()}catch{return String(e)}},de=e=>{switch(e==null?void 0:e.toLowerCase()){case"alta":return"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200 px-2 py-0.5 rounded font-medium";case"media":return"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200 px-2 py-0.5 rounded font-medium";case"baja":return"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 px-2 py-0.5 rounded font-medium";default:return"text-gray-700 dark:text-slate-200"}},E=async({showLoading:e=!0}={})=>{var t,n;e&&(q.value=!0);try{const r=await D.get("/backlog/board-data",{params:{limit:B.value,date_from:N.value||null,date_to:O.value||null,priority:F.value||null}});c.value=((n=(t=r==null?void 0:r.data)==null?void 0:t.data)==null?void 0:n.stages)??[]}finally{e&&(q.value=!1)}},se=()=>{E()},ie=()=>{N.value="",O.value="",F.value="",B.value=50,E()},Y=(e,t)=>{const n=c.value.find(d=>d.id===e);if(!(n!=null&&n.incidences))return null;const r=n.incidences.findIndex(d=>d.id===t);if(r===-1)return null;const[a]=n.incidences.splice(r,1);return n.count=Math.max(0,(n.count??n.incidences.length)-1),a},oe=(e,t,n=0)=>{const r=c.value.find(d=>d.id===e);if(!r)return;Array.isArray(r.incidences)||(r.incidences=[]);const a=Math.max(0,Math.min(n,r.incidences.length));r.incidences.splice(a,0,t),r.count=(r.count??0)+1},w=e=>!!(e!=null&&e.archived_at),P=e=>{e!=null&&e.id&&window.dispatchEvent(new CustomEvent("incidencias:edit",{detail:{incidence:e}}))},G=e=>{var n,r,a;const t=(n=e==null?void 0:e.detail)==null?void 0:n.incidence;if(t!=null&&t.id)for(const d of c.value){const i=((a=(r=d==null?void 0:d.incidences)==null?void 0:r.findIndex)==null?void 0:a.call(r,u=>u.id===t.id))??-1;if(i!==-1){d.incidences.splice(i,1,{...d.incidences[i],...t});break}}},le=(e,t)=>{if(w(e))return;m.value=e,C.value=(e==null?void 0:e.stage_id)??null,k.value=e.id,M.value=!1;const n=c.value.find(r=>r.id===((e==null?void 0:e.stage_id)??null));if(n&&Array.isArray(n.incidences)){const r=n.incidences.findIndex(a=>a.id===e.id);I.value={stageId:n.id,index:r}}else I.value=null;h.value=!1},ce=(e=!1)=>{var n;if(!h.value)return;const t=((n=m.value)==null?void 0:n.id)??null;if(t!=null){for(const r of c.value){if(!Array.isArray(r.incidences))continue;const a=r.incidences.findIndex(d=>d.id===t);a!==-1&&r.incidences.splice(a,1)}if(e&&I.value){const r=c.value.find(a=>a.id===I.value.stageId);if(r){Array.isArray(r.incidences)||(r.incidences=[]);const a=Math.max(0,Math.min(I.value.index??r.incidences.length,r.incidences.length));r.incidences.splice(a,0,m.value)}}h.value=!1,T.value={incidenceId:null,position:"after",stageId:null}}},ue=()=>{!M.value&&h.value&&ce(!0),m.value=null,C.value=null,k.value=null,h.value=!1,M.value=!1,T.value={incidenceId:null,position:"after",stageId:null},I.value=null};let L=null;const ve=(e,t,n)=>{m.value&&(L&&clearTimeout(L),L=setTimeout(()=>{ge(e,t,n)},16))},ge=(e,t,n)=>{var j;if(!m.value)return;const r=n.currentTarget.closest("section[data-stage-id]");if(!r)return;const a=r.querySelector(".p-3");if(!a)return;const d=a.querySelectorAll("article[data-incidence-id]"),i=Array.from(d).filter(o=>Number(o.getAttribute("data-incidence-id"))!==m.value.id);if(i.length===0){J(t.id,0),T.value={incidenceId:null,position:"top",stageId:t.id};return}const u=n.clientY;let f=i.length;for(let o=0;o<i.length;o++){const b=i[o].getBoundingClientRect(),p=b.top+b.height/2;if(u<p){f=o;break}}J(t.id,f);const A=f>0?Number((j=i[f-1])==null?void 0:j.getAttribute("data-incidence-id")):null;T.value={incidenceId:A,position:f===0?"before":"after",stageId:t.id}},J=(e,t)=>{var i;if(!m.value)return;const n=m.value,r=c.value.find(u=>u.id===e);if(!r||(((i=r.incidences)==null?void 0:i.findIndex(u=>u.id===n.id))??-1)===t)return;c.value.forEach(u=>{if(!Array.isArray(u.incidences))return;const f=u.incidences.findIndex(A=>A.id===n.id);f!==-1&&u.incidences.splice(f,1)}),Array.isArray(r.incidences)||(r.incidences=[]);const d=Math.max(0,Math.min(t,r.incidences.length));r.incidences.splice(d,0,n),h.value=!0},K=async(e,t=null,n=null)=>{var i,u,f,A,j;const r=m.value,a=C.value;if(!(r!=null&&r.id)||!a||!(e!=null&&e.id)){m.value=null,C.value=null,k.value=null;return}if(h.value){M.value=!0;const o=r.id,b=c.value.find(p=>p.id===e.id);if(!b)return;try{a!==e.id&&await D.patch(`/incidencias/${o}/move-stage`,{stage_id:e.id});const p=b.incidences.map($=>$.id);await D.patch("/incidencias/reorder",{stage_id:e.id,ordered_ids:p}),h.value=!1,T.value={incidenceId:null,position:"after",stageId:null},m.value=null,C.value=null,k.value=null,I.value=null,M.value=!1,y.value="",z("Incidencia actualizada")}catch{y.value="Error al mover la incidencia",await E({showLoading:!1})}return}if(a===e.id)return;y.value="";const d=Y(a,r.id);d&&(d.stage_id=e.id,oe(e.id,d,0));try{const o=await D.patch(`/incidencias/${r.id}/move-stage`,{stage_id:e.id}),b=(i=o==null?void 0:o.data)==null?void 0:i.data;if(b&&typeof b=="object"){const p=(f=(u=c.value.find($=>$.id===e.id))==null?void 0:u.incidences)==null?void 0:f.find($=>$.id===r.id);p&&Object.assign(p,b)}z("Incidencia actualizada")}catch(o){const b=((j=(A=o==null?void 0:o.response)==null?void 0:A.data)==null?void 0:j.message)??"No se pudo mover la incidencia.";y.value=b,R(b),await E({showLoading:!1})}finally{m.value=null,C.value=null,k.value=null}},Q=async e=>{var t,n;if(e!=null&&e.id)try{if(!(await ae({title:"¿Seguro que quieres eliminar la incidencia?",text:"Esta acción no se puede deshacer.",icon:"warning",confirmButtonText:"Eliminar",cancelButtonText:"Cancelar"})).isConfirmed)return;await D.delete(`/incidencias/${e.id}`);for(const a of c.value){const d=((n=(t=a==null?void 0:a.incidences)==null?void 0:t.findIndex)==null?void 0:n.call(t,i=>i.id===e.id))??-1;if(d!==-1){a.incidences.splice(d,1),a.count=Math.max(0,(a.count??0)-1);break}}z("Incidencia eliminada correctamente")}catch{R("Error al eliminar la incidencia")}},me=async(e,t)=>{var r,a;if(!(!(e!=null&&e.id)||!(t!=null&&t.is_done)||!await ae({title:"Archivar incidencia",text:"Se ocultará del backlog, pero seguirá visible en la tabla (historial).",confirmText:"Archivar",cancelText:"Cancelar",icon:"warning"}))){S.value.add(e.id),y.value="";try{await D.patch(`/incidencias/${e.id}/archive`),Y(t.id,e.id),z("Incidencia archivada"),window.dispatchEvent(new CustomEvent("incidencias:archived"))}catch(d){const i=((a=(r=d==null?void 0:d.response)==null?void 0:r.data)==null?void 0:a.message)??"No se pudo archivar la incidencia.";y.value=i,R(i)}finally{S.value.delete(e.id)}}},U=()=>E({showLoading:!1});return xe(async()=>{window.addEventListener("incidencias:created",U),window.addEventListener("incidencias:archived",U),window.addEventListener("incidencias:updated",G),await E()}),fe(()=>{window.removeEventListener("incidencias:created",U),window.removeEventListener("incidencias:archived",U),window.removeEventListener("incidencias:updated",G),L&&clearTimeout(L)}),(e,t)=>(g(),v("div",null,[t[15]||(t[15]=s("div",{class:"mb-4 text-sm text-gray-600 dark:text-slate-300"}," Arrastra una incidencia entre columnas para cambiar su estado, o dentro de una columna para reordenar. ",-1)),s("div",pe,[s("div",ye,[t[10]||(t[10]=s("label",{class:"text-xs text-gray-600 dark:text-slate-300"},"Limite:",-1)),V(s("select",{"onUpdate:modelValue":t[0]||(t[0]=n=>B.value=n),class:"rounded-lg border border-gray-200 bg-white px-2 py-1 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:focus:ring-blue-900/30"},[...t[9]||(t[9]=[s("option",{value:20},"20",-1),s("option",{value:50},"50",-1),s("option",{value:100},"100",-1),s("option",{value:250},"250",-1)])],512),[[W,B.value,void 0,{number:!0}]])]),s("div",ke,[t[11]||(t[11]=s("label",{class:"text-xs text-gray-600 dark:text-slate-300"},"Desde:",-1)),V(s("input",{"onUpdate:modelValue":t[1]||(t[1]=n=>N.value=n),type:"date",class:"rounded-lg border border-gray-200 bg-white px-2 py-1 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 placeholder:text-gray-400 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:placeholder:text-slate-500 dark:focus:ring-blue-900/30 dark:[color-scheme:dark]"},null,512),[[X,N.value]])]),s("div",he,[t[12]||(t[12]=s("label",{class:"text-xs text-gray-600 dark:text-slate-300"},"Hasta:",-1)),V(s("input",{"onUpdate:modelValue":t[2]||(t[2]=n=>O.value=n),type:"date",class:"rounded-lg border border-gray-200 bg-white px-2 py-1 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 placeholder:text-gray-400 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:placeholder:text-slate-500 dark:focus:ring-blue-900/30 dark:[color-scheme:dark]"},null,512),[[X,O.value]])]),s("div",we,[t[14]||(t[14]=s("label",{class:"text-xs text-gray-600 dark:text-slate-300"},"Prioridad:",-1)),V(s("select",{"onUpdate:modelValue":t[3]||(t[3]=n=>F.value=n),class:"rounded-lg border border-gray-200 bg-white px-2 py-1 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:focus:ring-blue-900/30"},[...t[13]||(t[13]=[s("option",{value:""},"Todas",-1),s("option",{value:"alta"},"Alta",-1),s("option",{value:"media"},"Media",-1),s("option",{value:"baja"},"Baja",-1)])],512),[[W,F.value]])]),s("div",{class:"flex items-center gap-2 ms-auto"},[s("button",{onClick:se,class:"inline-flex items-center rounded-lg bg-blue-600 px-3 py-1 text-sm text-white hover:bg-blue-700"}," Aplicar "),s("button",{onClick:ie,class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1 text-sm text-gray-700 shadow-sm hover:bg-gray-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800"}," Limpiar ")])]),q.value?(g(),v("div",_e,"Cargando...")):y.value?(g(),v("div",Ie,_(y.value),1)):(g(),v("div",{key:2,class:H(["grid gap-4",re.value])},[(g(!0),v(Z,null,ee(c.value,n=>{var r;return g(),v("section",{key:n.id,"data-stage-id":n.id,class:"bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden dark:bg-slate-900 dark:border-slate-800",onDragover:t[8]||(t[8]=x(()=>{},["prevent"])),onDrop:x(a=>K(n),["prevent"])},[s("div",Ee,[s("div",Ae,[s("div",De,_(n.name),1),s("div",Me,_(n.count),1)])]),s("div",Te,[(((r=n.incidences)==null?void 0:r.length)??0)===0?(g(),v("div",Le," Sin incidencias. ")):te("",!0),(g(!0),v(Z,null,ee(n.incidences,a=>(g(),v("div",{key:a.id,"data-incidence-id":a.id},[s("article",{"data-incidence-id":a.id,class:H(["select-none bg-gray-50 border border-gray-200 rounded-lg p-3 dark:bg-slate-800 dark:border-slate-700 transition-all duration-150",{"scale-105 shadow-lg opacity-90 z-50 transform":k.value===a.id,"opacity-50":k.value&&k.value!==a.id,"cursor-not-allowed opacity-80":w(a),"cursor-grab active:cursor-grabbing hover:bg-blue-50/30 dark:hover:bg-slate-800/50":!w(a)}]),draggable:!w(a),onDragstart:d=>le(a),onDragend:ue,onDragover:x(d=>ve(a,n,d),["prevent"]),onDrop:x(d=>K(n,a,d),["prevent"])},[s("div",{class:"flex items-start justify-between gap-3 cursor-pointer",onClick:d=>P(a)},[s("div",null,[s("div",Ne,_(a.title),1),a.customer?(g(),v("div",Oe,_(a.customer.company_name||a.customer.name),1)):(g(),v("div",Fe,"Sin cliente"))]),s("div",{class:H(["text-xs",de(a.priority)])},_(a.priority||"Normal"),3)],8,Be),a.date?(g(),v("div",{key:0,class:"mt-2 text-xs text-gray-600 dark:text-slate-300 cursor-pointer",onClick:d=>P(a)},_(ne(a.date)),9,Se)):te("",!0),n.is_done?(g(),v("div",Pe,[s("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:w(a),onMousedown:t[4]||(t[4]=x(()=>{},["stop"])),onClick:x(d=>P(a),["stop","prevent"])}," Editar ",40,Ue),s("button",{type:"button",class:"inline-flex items-center rounded-lg border border-red-200 bg-red-50 px-3 py-1.5 text-xs font-medium text-red-700 shadow-sm hover:bg-red-100 disabled:opacity-60 dark:border-red-700 dark:bg-red-900/20 dark:text-red-400 dark:hover:bg-red-900/30",disabled:w(a),onMousedown:t[5]||(t[5]=x(()=>{},["stop"])),onClick:x(d=>Q(a),["stop","prevent"])}," Eliminar ",40,Ve),s("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:S.value.has(a.id),onClick:x(d=>me(a,n),["stop","prevent"])},_(S.value.has(a.id)?"Archivando…":"Archivar"),9,ze)])):(g(),v("div",qe,[s("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:w(a),onMousedown:t[6]||(t[6]=x(()=>{},["stop"])),onClick:x(d=>P(a),["stop","prevent"])}," Editar ",40,He),s("button",{type:"button",class:"inline-flex items-center rounded-lg border border-red-200 bg-red-50 px-3 py-1.5 text-xs font-medium text-red-700 shadow-sm hover:bg-red-100 disabled:opacity-60 dark:border-red-700 dark:bg-red-900/20 dark:text-red-400 dark:hover:bg-red-900/30",disabled:w(a),onMousedown:t[7]||(t[7]=x(()=>{},["stop"])),onClick:x(d=>Q(a),["stop","prevent"])}," Eliminar ",40,Re)]))],42,$e)],8,je))),128))])],40,Ce)}),128))],2))]))}};export{Ze as default};
