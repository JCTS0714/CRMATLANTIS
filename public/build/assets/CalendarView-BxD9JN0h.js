const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/vendor-ui-E6c-3yld.js","assets/vendor-vue-CzwclP9t.js"])))=>i.map(i=>d[i]);
import{_ as ae}from"./app-C7qh-bKB.js";import{a as y}from"./vendor-utils-Czy7fllw.js";import{i as ne,a as se,b as le,F as re}from"./vendor-ui-E6c-3yld.js";import{a as D,t as E,c as oe}from"./App-BD-yU49k.js";import{e as K,r as V,o as de,f as ie,g as ce,i as ue,j as $,A as me,t as ve,u as pe}from"./vendor-vue-CzwclP9t.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const ge={class:"p-4"},fe={class:"mb-4 flex items-center justify-between"},ye=["disabled"],be={class:"rounded-lg border border-gray-200 bg-white p-2 shadow-sm dark:border-slate-800 dark:bg-slate-900"},xe={class:"px-3 py-2 text-center text-base font-semibold text-gray-800 dark:text-slate-100"},$e={__name:"CalendarView",setup(we){const F=window.__AUTH_USER__??null,X=K(()=>{const t=(F==null?void 0:F.permissions)??[];return Array.isArray(t)&&t.includes("calendar.delete")}),u=V(!1),C=V(null),W=V(""),H=()=>{var t,e;try{(e=(t=C.value)==null?void 0:t.getApi)==null||e.call(t).refetchEvents()}catch{}},G=t=>{var n,s,l;const e=(s=(n=C.value)==null?void 0:n.getApi)==null?void 0:s.call(n);if(!e)return;const a=(l=e.view)==null?void 0:l.type;if(a==="dayGridMonth"){e.incrementDate({months:t});return}if(a==="timeGridWeek"){e.incrementDate({weeks:t});return}e.incrementDate({days:t})},q=(t=null)=>{var l,o;const e=(o=(l=C.value)==null?void 0:l.getApi)==null?void 0:o.call(l),a=t??(e==null?void 0:e.view),n=a==null?void 0:a.currentStart;if(!n)return;const s=new Date(n);s.setDate(s.getDate()+15),W.value=new Intl.DateTimeFormat("es-PE",{year:"numeric",month:"long"}).format(s)},w=t=>{if(!t)return"";const e=new Date(t);if(Number.isNaN(e.getTime()))return"";const a=n=>String(n).padStart(2,"0");return`${e.getFullYear()}-${a(e.getMonth()+1)}-${a(e.getDate())}T${a(e.getHours())}:${a(e.getMinutes())}`},R=async({title:t="",start_at:e="",end_at:a="",all_day:n=!1,reminder_minutes:s="",related_type:l="",related_id:o="",description:d="",location:h="",allowDelete:_=!1}={})=>{const m=p=>String(p??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),g="mt-1 w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-950 dark:text-slate-100",N=`
    <div class="grid gap-3 text-left">
      <div>
        <label class="block text-xs font-medium text-gray-600 dark:text-slate-300">Título</label>
        <input id="sw-ev-title" class="${g}" value="${m(t)}" />
      </div>

      <div class="grid grid-cols-1 gap-3 sm:grid-cols-2">
        <div>
          <label class="block text-xs font-medium text-gray-600 dark:text-slate-300">Inicio</label>
          <input id="sw-ev-start" type="datetime-local" class="${g}" value="${m(e)}" />
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-600 dark:text-slate-300">Fin</label>
          <input id="sw-ev-end" type="datetime-local" class="${g}" value="${m(a)}" />
        </div>
      </div>

      <div class="grid grid-cols-1 gap-3 sm:grid-cols-2">
        <div>
          <label class="block text-xs font-medium text-gray-600 dark:text-slate-300">Recordatorio (minutos antes)</label>
          <input id="sw-ev-reminder" type="number" min="1" max="10080" class="${g}" value="${m(s)}" placeholder="(opcional)" />
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-600 dark:text-slate-300">Ubicación</label>
          <input id="sw-ev-location" class="${g}" value="${m(h)}" placeholder="(opcional)" />
        </div>
      </div>

      <div>
        <label class="block text-xs font-medium text-gray-600 dark:text-slate-300">Descripción</label>
        <textarea id="sw-ev-description" rows="3" class="${g}" placeholder="(opcional)">${m(d)}</textarea>
      </div>

      <div class="grid grid-cols-1 gap-3 sm:grid-cols-2">
        <div>
          <label class="block text-xs font-medium text-gray-600 dark:text-slate-300">Relacionado a</label>
          <select id="sw-ev-related_type" class="${g}">
            <option value="" ${l?"":"selected"}>(ninguno)</option>
            <option value="lead" ${l==="lead"?"selected":""}>Lead</option>
            <option value="customer" ${l==="customer"?"selected":""}>Cliente</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-600 dark:text-slate-300">Relacionado</label>
          <input id="sw-ev-related_search" class="${g}" placeholder="Escribe para buscar…" autocomplete="off" />
          <input id="sw-ev-related_id" type="hidden" value="${m(o)}" />
          <div id="sw-ev-related_results" class="mt-2 max-h-44 overflow-auto rounded-lg border border-gray-200 bg-white p-1 text-left shadow-sm dark:border-slate-800 dark:bg-slate-950" style="display:none;"></div>
          <div id="sw-ev-related_hint" class="mt-1 text-xs text-gray-500 dark:text-slate-400">Selecciona un resultado para llenar el vínculo (opcional).</div>
        </div>
      </div>
    </div>
  `,{default:T}=await ae(async()=>{const{default:p}=await import("./vendor-ui-E6c-3yld.js").then(c=>c.s);return{default:p}},__vite__mapDeps([0,1])),O=await T.fire({title:"Evento",html:N,focusConfirm:!1,showCancelButton:!0,showDenyButton:!!_,confirmButtonText:"Guardar",cancelButtonText:"Cancelar",denyButtonText:"Eliminar",buttonsStyling:!1,didOpen:async()=>{const p=document.getElementById("sw-ev-related_type"),c=document.getElementById("sw-ev-related_search"),b=document.getElementById("sw-ev-related_id"),f=document.getElementById("sw-ev-related_results");if(!p||!c||!b||!f)return;let I=null;const k=()=>{f.innerHTML="",f.style.display="none"},P=r=>{b.value=r!=null&&r.id?String(r.id):"",c.value=r!=null&&r.label?String(r.label):"",k()},B=()=>{const r=p.value||"",i=!!r;c.disabled=!i,c.placeholder=i?`Buscar ${r==="lead"?"lead":"cliente"}…`:"Selecciona tipo primero",i||P(null)},L=r=>{if(f.innerHTML="",!(r!=null&&r.length)){k();return}f.style.display="block";for(const i of r){const v=document.createElement("button");v.type="button",v.className="flex w-full items-center justify-between rounded-md px-2 py-1.5 text-left text-sm text-gray-800 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-200 dark:text-slate-100 dark:hover:bg-slate-900 dark:focus:ring-blue-500/30",v.textContent=i.label,v.addEventListener("click",()=>P(i)),f.appendChild(v)}},A=async()=>{var v,x;const r=p.value||"",i=Number(b.value);if(!(!r||!Number.isFinite(i)||i<1))try{const S=await y.get("/related-lookup",{params:{type:r,id:i}});(x=(v=S==null?void 0:S.data)==null?void 0:v.data)!=null&&x.label?c.value=S.data.data.label:c.value=`#${i}`}catch{}},M=async()=>{var v;const r=p.value||"",i=(c.value||"").trim();if(!r||i.length<2){k();return}try{const x=await y.get("/related-lookup",{params:{type:r,q:i,limit:8}});L(((v=x==null?void 0:x.data)==null?void 0:v.data)??[])}catch{k()}};p.addEventListener("change",()=>{B(),k()}),c.addEventListener("input",()=>{b.value="",I&&window.clearTimeout(I),I=window.setTimeout(()=>{M()},250)}),c.addEventListener("blur",()=>{window.setTimeout(()=>k(),150)}),c.addEventListener("focus",()=>{M()}),B(),await A()},customClass:{popup:"rounded-xl border border-gray-200 bg-white text-gray-900 shadow-xl dark:!border-slate-800 dark:!bg-slate-900 dark:!text-slate-100",backdrop:"bg-black/60",title:"text-base font-semibold text-gray-900 dark:text-slate-100",htmlContainer:"text-sm text-gray-600 dark:text-slate-300",actions:"gap-2",confirmButton:"inline-flex items-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 disabled:opacity-60",cancelButton:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-4 focus:ring-blue-100 disabled:opacity-60 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",denyButton:"inline-flex items-center rounded-lg bg-rose-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-rose-700 focus:outline-none focus:ring-4 focus:ring-rose-300 disabled:opacity-60"},preConfirm:()=>{var A,M,r,i,v,x,S,j,Q,Y,J;const p=((M=(A=document.getElementById("sw-ev-title"))==null?void 0:A.value)==null?void 0:M.trim())??"",c=((r=document.getElementById("sw-ev-start"))==null?void 0:r.value)??"",b=((i=document.getElementById("sw-ev-end"))==null?void 0:i.value)??"",f=((v=document.getElementById("sw-ev-reminder"))==null?void 0:v.value)??"",I=((S=(x=document.getElementById("sw-ev-location"))==null?void 0:x.value)==null?void 0:S.trim())??"",k=((Q=(j=document.getElementById("sw-ev-description"))==null?void 0:j.value)==null?void 0:Q.trim())??"",P=((Y=document.getElementById("sw-ev-related_type"))==null?void 0:Y.value)??"",B=((J=document.getElementById("sw-ev-related_id"))==null?void 0:J.value)??"";if(!p)return T.showValidationMessage("El título es requerido."),!1;if(!c)return T.showValidationMessage("La fecha/hora de inicio es requerida."),!1;if(b&&b<c)return T.showValidationMessage("La fecha/hora fin no puede ser menor que inicio."),!1;if(P&&!B)return T.showValidationMessage("Selecciona un registro relacionado (lead/cliente) de la lista."),!1;const L=f?Number(f):null;return f&&(!Number.isFinite(L)||L<1)?(T.showValidationMessage("El recordatorio debe ser un número válido."),!1):{title:p,start_at:new Date(c).toISOString(),end_at:b?new Date(b).toISOString():null,reminder_minutes:L,location:I||null,description:k||null,related_type:P||null,related_id:B?Number(B):null}}});return O.isDenied?{action:"delete"}:O.isConfirmed?{action:"save",payload:O.value}:null},Z=K(()=>({plugins:[ne,se,le],initialView:"dayGridMonth",customButtons:{prevCustom:{text:"‹",click:()=>G(-1)},nextCustom:{text:"›",click:()=>G(1)}},headerToolbar:{left:"prevCustom,nextCustom today",center:"",right:"dayGridMonth,timeGridWeek,timeGridDay"},eventDisplay:"block",eventClassNames:()=>["rounded-md","px-2","py-1","text-xs","font-semibold","bg-blue-600","text-white","shadow-sm","border","border-blue-700/30","dark:bg-blue-500/70","dark:border-blue-300/20"],selectable:!0,editable:!0,eventTimeFormat:{hour:"2-digit",minute:"2-digit",meridiem:!1},datesSet:t=>q(t.view),events:async(t,e,a)=>{var n;try{const s=await y.get("/calendar/events",{params:{start:t.startStr,end:t.endStr}});e(((n=s==null?void 0:s.data)==null?void 0:n.data)??[])}catch(s){E("No se pudo cargar el calendario"),a(s)}},dateClick:async t=>{var l,o;const e=new Date(t.date),a=new Date(t.date);a.setHours(a.getHours()+1);const n=await R({start_at:w(e),end_at:w(a)});if(!n||n.action!=="save")return;const s=n.payload;u.value=!0;try{await y.post("/calendar/events",s),D("Evento creado"),t.view.calendar.refetchEvents()}catch(d){E(((o=(l=d==null?void 0:d.response)==null?void 0:l.data)==null?void 0:o.message)??"No se pudo crear el evento")}finally{u.value=!1}},eventClick:async t=>{var l,o,d,h;const e=t.event,a=e.extendedProps||{},n=await R({title:e.title,start_at:w(e.start),end_at:w(e.end),reminder_minutes:a.reminder_minutes??"",location:a.location??"",description:a.description??"",related_type:a.related_type?a.related_type.endsWith("Lead")?"lead":a.related_type.endsWith("Customer")?"customer":"":"",related_id:a.related_id??"",allowDelete:X.value});if(!n)return;if(n.action==="delete"){if(!await oe({title:"Eliminar evento",text:"Esta acción no se puede deshacer.",confirmText:"Eliminar"}))return;u.value=!0;try{await y.delete(`/calendar/events/${e.id}`),D("Evento eliminado"),t.view.calendar.refetchEvents()}catch(m){E(((o=(l=m==null?void 0:m.response)==null?void 0:l.data)==null?void 0:o.message)??"No se pudo eliminar el evento")}finally{u.value=!1}return}if(n.action!=="save")return;const s=n.payload;u.value=!0;try{await y.put(`/calendar/events/${e.id}`,s),D("Evento actualizado"),t.view.calendar.refetchEvents()}catch(_){E(((h=(d=_==null?void 0:_.response)==null?void 0:d.data)==null?void 0:h.message)??"No se pudo actualizar el evento")}finally{u.value=!1}},eventDrop:async t=>{var n,s,l,o;const e=t.event,a=e.extendedProps||{};u.value=!0;try{await y.put(`/calendar/events/${e.id}`,{title:e.title,start_at:(n=e.start)==null?void 0:n.toISOString(),end_at:((s=e.end)==null?void 0:s.toISOString())??null,reminder_minutes:a.reminder_minutes??null,location:a.location??null,description:a.description??null,related_type:a.related_type?a.related_type.endsWith("Lead")?"lead":a.related_type.endsWith("Customer")?"customer":null:null,related_id:a.related_id??null}),D("Evento movido")}catch(d){t.revert(),E(((o=(l=d==null?void 0:d.response)==null?void 0:l.data)==null?void 0:o.message)??"No se pudo mover el evento")}finally{u.value=!1}},eventResize:async t=>{var n,s,l,o;const e=t.event,a=e.extendedProps||{};u.value=!0;try{await y.put(`/calendar/events/${e.id}`,{title:e.title,start_at:(n=e.start)==null?void 0:n.toISOString(),end_at:((s=e.end)==null?void 0:s.toISOString())??null,reminder_minutes:a.reminder_minutes??null,location:a.location??null,description:a.description??null,related_type:a.related_type?a.related_type.endsWith("Lead")?"lead":a.related_type.endsWith("Customer")?"customer":null:null,related_id:a.related_id??null}),D("Evento actualizado")}catch(d){t.revert(),E(((o=(l=d==null?void 0:d.response)==null?void 0:l.data)==null?void 0:o.message)??"No se pudo actualizar el evento")}finally{u.value=!1}}})),ee=async()=>{var s,l;const t=new Date,e=new Date(t);e.setHours(e.getHours()+1);const a=await R({start_at:w(t),end_at:w(e)});if(!a||a.action!=="save")return;const n=a.payload;u.value=!0;try{await y.post("/calendar/events",n),D("Evento creado"),H()}catch(o){E(((l=(s=o==null?void 0:o.response)==null?void 0:s.data)==null?void 0:l.message)??"No se pudo crear el evento")}finally{u.value=!1}},z=t=>{if(!t)return null;const e=new Date(t);if(!Number.isNaN(e.getTime()))return e;const a=new Date(String(t).replace(" ","T"));return Number.isNaN(a.getTime())?null:a},te=async()=>{var m,g;const t=new URL(window.location.href),e=t.searchParams.get("related_type")||"",a=t.searchParams.get("related_id")||"",n=t.searchParams.get("title")||"";if(!e&&!a&&!n)return;const s=z(t.searchParams.get("start")),l=z(t.searchParams.get("end")),o=s??new Date,d=l??new Date(o.getTime()+3600*1e3),h=await R({title:n||"",start_at:w(o),end_at:w(d),related_type:e,related_id:a});if(t.searchParams.delete("related_type"),t.searchParams.delete("related_id"),t.searchParams.delete("title"),t.searchParams.delete("start"),t.searchParams.delete("end"),window.history.replaceState({},"",t.pathname+t.search),!h||h.action!=="save")return;const _=h.payload;u.value=!0;try{await y.post("/calendar/events",_),D("Evento creado"),H()}catch(N){E(((g=(m=N==null?void 0:N.response)==null?void 0:m.data)==null?void 0:g.message)??"No se pudo crear el evento")}finally{u.value=!1}},U=()=>H();return de(()=>{window.addEventListener("calendar:refetch",U),setTimeout(()=>{var e,a;const t=(a=(e=C.value)==null?void 0:e.getApi)==null?void 0:a.call(e);t&&t.gotoDate(new Date),te(),q()},0)}),ie(()=>{window.removeEventListener("calendar:refetch",U)}),(t,e)=>(ue(),ce("div",ge,[$("div",fe,[e[0]||(e[0]=$("div",null,[$("div",{class:"text-sm font-semibold text-gray-900 dark:text-slate-100"},"Calendario"),$("div",{class:"mt-1 text-xs text-gray-600 dark:text-slate-300"},"Tu agenda personal (solo tú la ves).")],-1)),$("button",{type:"button",class:"inline-flex items-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700 disabled:opacity-60",disabled:u.value,onClick:ee}," Nuevo evento ",8,ye)]),$("div",be,[$("div",xe,ve(W.value),1),me(pe(re),{ref_key:"calendarRef",ref:C,options:Z.value},null,8,["options"])])]))}};export{$e as default};
