import{r as i,H as z,o as V,f as A,g as c,i as p,j as a,w as P,x as q,t as n,F as L,m as O}from"./vendor-vue-Db-AqoDh.js";import{a as _}from"./vendor-utils-Czy7fllw.js";import{a as C,t as I,b as U,p as H,c as G}from"./App-Bt9-hbAg.js";import"./app-DjmpOHxG.js";import"./vendor-ui-DEm6YKEA.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const J={class:"p-4"},K={class:"mb-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between"},Q={class:"w-full sm:max-w-md"},R={class:"flex items-center gap-2"},W=["disabled"],X=["disabled"],Y={class:"text-sm text-slate-600 dark:text-slate-300"},Z={key:0},ee={key:1},te={class:"overflow-x-auto rounded-lg border border-slate-200 bg-white dark:border-slate-800 dark:bg-slate-900"},ae={class:"min-w-full text-left text-sm text-slate-700 dark:text-slate-200"},se={class:"px-4 py-3 font-medium text-slate-900 dark:text-slate-100"},oe={class:"px-4 py-3"},le={class:"px-4 py-3"},re={class:"px-4 py-3"},ne={key:0},de={key:1},ie={class:"px-4 py-3"},ue={class:"px-4 py-3"},ce={class:"px-4 py-3"},pe={class:"flex items-center gap-2"},me=["onClick"],be=["disabled","onClick"],ge=["disabled","onClick"],xe={class:"mt-4 flex items-center justify-between"},_e=["disabled"],ve={class:"text-sm text-slate-600 dark:text-slate-300"},ye=["disabled"],Te={__name:"PostventaCustomersTable",setup(fe){const v=i([]),y=i(!1),f=i(!1),h=i(null),k=i(!1),E=i(new Set),T=i(new Set),w=i("");let g=null;const l=i({current_page:1,last_page:1,per_page:15,total:0,from:0,to:0}),m=async(e=1)=>{y.value=!0;try{const{data:s}=await _.get("/customers/data",{params:{q:w.value||"",per_page:l.value.per_page,page:e}});v.value=s.customers||[],l.value={...l.value,...s.pagination||{}}}finally{y.value=!1}},S=()=>{var e,s;(s=(e=h.value)==null?void 0:e.click)==null||s.call(e)},j=async e=>{var t,o,r,d,u;const s=(o=(t=e==null?void 0:e.target)==null?void 0:t.files)==null?void 0:o[0];if(s){k.value=!0;try{const b=new FormData;b.append("csv",s);const{data:x}=await _.post("/customers/import",b,{headers:{"Content-Type":"multipart/form-data"}});C(((r=x==null?void 0:x.output)!=null&&r.trim(),"Importación finalizada")),await m(1)}catch(b){const x=((u=(d=b==null?void 0:b.response)==null?void 0:d.data)==null?void 0:u.message)??"No se pudo importar el CSV.";I(x)}finally{k.value=!1,h.value&&(h.value.value="")}}},M=e=>{const s=(e==null?void 0:e.company_name)||(e==null?void 0:e.name)||"",t=e!=null&&e.company_name?e==null?void 0:e.name:"";let o=s;t&&t!==s&&(o+=` — ${t}`);const r=e!=null&&e.document_number?`${e!=null&&e.document_type?e.document_type+" ":""}${e.document_number}`:"";return r&&(o+=` (${r})`),o},B=e=>{e!=null&&e.id&&window.dispatchEvent(new CustomEvent("incidencias:create",{detail:{customer_id:e.id,customer_label:M(e)}}))},D=async()=>{var s,t;const e=await U();if(e){f.value=!0;try{await _.post("/customers",e),C("Cliente creado"),await m(1)}catch(o){const r=((t=(s=o==null?void 0:o.response)==null?void 0:s.data)==null?void 0:t.message)??"No se pudo crear el cliente.";I(r)}finally{f.value=!1}}},F=async e=>{var t,o,r;if(!(e!=null&&e.id))return;const s=await H(e);if(s){E.value.add(e.id);try{const d=await _.put(`/customers/${e.id}`,s),u=(t=d==null?void 0:d.data)==null?void 0:t.data;u&&typeof u=="object"?Object.assign(e,u):Object.assign(e,s),C("Cliente actualizado")}catch(d){const u=((r=(o=d==null?void 0:d.response)==null?void 0:o.data)==null?void 0:r.message)??"No se pudo actualizar el cliente.";I(u)}finally{E.value.delete(e.id)}}},N=async e=>{var t,o;if(!(!(e!=null&&e.id)||!await G({title:"Eliminar cliente",text:"Se eliminará el cliente. Las incidencias asociadas quedarán sin cliente (se desvinculan).",confirmText:"Eliminar",cancelText:"Cancelar",icon:"warning"}))){T.value.add(e.id);try{await _.delete(`/customers/${e.id}`),v.value=v.value.filter(r=>r.id!==e.id),C("Cliente eliminado"),m(Math.min(l.value.current_page,l.value.last_page||1))}catch(r){const d=((o=(t=r==null?void 0:r.response)==null?void 0:t.data)==null?void 0:o.message)??"No se pudo eliminar el cliente.";I(d)}finally{T.value.delete(e.id)}}},$=e=>{const s=Math.max(1,Math.min(l.value.last_page||1,e));m(s)};return z(w,()=>{g&&clearTimeout(g),g=setTimeout(()=>{m(1)},300)},{flush:"post"}),V(()=>{m(1)}),A(()=>{g&&clearTimeout(g)}),(e,s)=>(p(),c("div",J,[a("div",K,[a("div",Q,[P(a("input",{"onUpdate:modelValue":s[0]||(s[0]=t=>w.value=t),type:"text",class:"w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 focus:border-sky-500 focus:ring-sky-500 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100",placeholder:"Buscar cliente (nombre, contacto, empresa, documento…)"},null,512),[[q,w.value]])]),a("div",R,[a("input",{ref_key:"importInput",ref:h,type:"file",accept:".csv,text/csv",class:"hidden",onChange:j},null,544),a("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:k.value,onClick:S},n(k.value?"Importando…":"Importar CSV"),9,W),a("button",{type:"button",class:"inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 disabled:opacity-60",disabled:f.value,onClick:D},n(f.value?"Creando…":"Crear cliente"),9,X),a("div",Y,[l.value.total?(p(),c("span",Z,"Mostrando "+n(l.value.from)+"–"+n(l.value.to)+" de "+n(l.value.total),1)):(p(),c("span",ee,"Sin resultados"))])])]),a("div",te,[a("table",ae,[s[3]||(s[3]=a("thead",{class:"bg-slate-50 text-xs uppercase text-slate-600 dark:bg-slate-800 dark:text-slate-200"},[a("tr",null,[a("th",{class:"px-4 py-3"},"Cliente"),a("th",{class:"px-4 py-3"},"Contacto"),a("th",{class:"px-4 py-3"},"Empresa"),a("th",{class:"px-4 py-3"},"Documento"),a("th",{class:"px-4 py-3"},"Teléfono"),a("th",{class:"px-4 py-3"},"Email"),a("th",{class:"px-4 py-3"},"Acciones")])],-1)),a("tbody",null,[(p(!0),c(L,null,O(v.value,t=>(p(),c("tr",{key:t.id,class:"border-t border-slate-200 hover:bg-slate-50 dark:border-slate-800 dark:hover:bg-slate-800"},[a("td",se,n(t.name),1),a("td",oe,n(t.contact_name||"—"),1),a("td",le,n(t.company_name||"—"),1),a("td",re,[t.document_type||t.document_number?(p(),c("span",ne,n(t.document_type||"")+" "+n(t.document_number||""),1)):(p(),c("span",de,"—"))]),a("td",ie,n(t.contact_phone||"—"),1),a("td",ue,n(t.contact_email||"—"),1),a("td",ce,[a("div",pe,[a("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",onClick:o=>B(t)}," Abrir incidencia ",8,me),a("button",{type:"button",class:"inline-flex items-center rounded-lg border border-slate-300 bg-white px-3 py-1.5 text-xs font-medium text-slate-700 hover:bg-slate-50 disabled:opacity-60 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:E.value.has(t.id),onClick:o=>F(t)}," Editar ",8,be),a("button",{type:"button",class:"inline-flex items-center rounded-lg border border-red-200 bg-white px-3 py-1.5 text-xs font-medium text-red-700 hover:bg-red-50 disabled:opacity-60 dark:border-red-900/40 dark:bg-slate-900 dark:text-red-300 dark:hover:bg-red-950/30",disabled:T.value.has(t.id),onClick:o=>N(t)}," Eliminar ",8,ge)])])]))),128))])])]),a("div",xe,[a("button",{class:"rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 disabled:cursor-not-allowed disabled:opacity-50 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:l.value.current_page<=1||y.value,onClick:s[1]||(s[1]=t=>$(l.value.current_page-1))}," Anterior ",8,_e),a("div",ve," Página "+n(l.value.current_page)+" / "+n(l.value.last_page),1),a("button",{class:"rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 disabled:cursor-not-allowed disabled:opacity-50 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:l.value.current_page>=l.value.last_page||y.value,onClick:s[2]||(s[2]=t=>$(l.value.current_page+1))}," Siguiente ",8,ye)])]))}};export{Te as default};
