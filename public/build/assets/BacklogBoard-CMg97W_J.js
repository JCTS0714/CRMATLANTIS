import{r as u,e as fe,o as be,f as xe,g,i as m,j as s,w as V,D as W,x as X,t as I,n as H,F as Z,m as ee,l as b,k as te}from"./vendor-vue-Db-AqoDh.js";import{a as T}from"./vendor-utils-Czy7fllw.js";import{a as z,t as R,c as ae}from"./App-CX0ghhiI.js";import"./app-BbxmDrTg.js";import"./vendor-ui-DEm6YKEA.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const pe={class:"mb-4 flex items-center gap-3"},ye={class:"flex items-center gap-2"},ke={class:"flex items-center gap-2"},he={class:"flex items-center gap-2"},we={class:"flex items-center gap-2"},_e={key:0,class:"text-sm text-gray-600 dark:text-slate-300"},Ie={key:1,class:"mb-3 text-sm text-red-600"},Ce=["data-stage-id","onDrop"],Ee={class:"p-4 border-b border-gray-200 dark:border-slate-800"},Ae={class:"flex items-center justify-between gap-3"},De={class:"text-sm font-semibold text-gray-900 dark:text-slate-100"},Te={class:"text-xs text-gray-600 dark:text-slate-300"},Me={class:"p-3 space-y-3 min-h-[140px]"},Le={key:0,class:"text-sm text-gray-500 dark:text-slate-400 px-1"},je=["data-incidence-id"],$e=["data-incidence-id","draggable","onDragstart","onDragover","onDrop"],Be=["onClick"],Ne={class:"text-sm font-semibold text-gray-900 dark:text-slate-100"},Oe={key:0,class:"text-xs text-gray-600 dark:text-slate-300 mt-1"},Fe={key:1,class:"text-xs text-gray-500 dark:text-slate-400 mt-1"},Se=["onClick"],Pe={key:1,class:"mt-3 flex justify-end gap-2"},Ue=["disabled","onClick"],Ve=["disabled","onClick"],ze=["disabled","onClick"],qe={key:2,class:"mt-3 flex justify-end gap-2"},He=["disabled","onClick"],Re=["disabled","onClick"],Ze={__name:"BacklogBoard",setup(Ye){const q=u(!0),c=u([]),w=u(""),B=u(50),N=u(""),O=u(""),F=u(""),y=u(null),o=u(null),C=u(null),p=u(!1),M=u(!1),L=u({incidenceId:null,position:"after",stageId:null}),E=u(null),S=u(new Set),re=fe(()=>{const e=c.value.length||1;return e<=1?"grid-cols-1":e===2?"grid-cols-1 md:grid-cols-2":e===3?"grid-cols-1 md:grid-cols-3":"grid-cols-1 md:grid-cols-2 xl:grid-cols-4"}),ne=e=>{if(!e)return"";try{const t=new Date(String(e));return Number.isNaN(t.getTime())?String(e):t.toLocaleDateString()}catch{return String(e)}},de=e=>{switch(e==null?void 0:e.toLowerCase()){case"alta":return"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200 px-2 py-0.5 rounded font-medium";case"media":return"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200 px-2 py-0.5 rounded font-medium";case"baja":return"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 px-2 py-0.5 rounded font-medium";default:return"text-gray-700 dark:text-slate-200"}},A=async({showLoading:e=!0}={})=>{var t,r;e&&(q.value=!0);try{const n=await T.get("/backlog/board-data",{params:{limit:B.value,date_from:N.value||null,date_to:O.value||null,priority:F.value||null}});c.value=((r=(t=n==null?void 0:n.data)==null?void 0:t.data)==null?void 0:r.stages)??[]}finally{e&&(q.value=!1)}},se=()=>{A()},ie=()=>{N.value="",O.value="",F.value="",B.value=50,A()},Y=(e,t)=>{const r=c.value.find(d=>d.id===e);if(!(r!=null&&r.incidences))return null;const n=r.incidences.findIndex(d=>d.id===t);if(n===-1)return null;const[a]=r.incidences.splice(n,1);return r.count=Math.max(0,(r.count??r.incidences.length)-1),a},le=(e,t,r=0)=>{const n=c.value.find(d=>d.id===e);if(!n)return;Array.isArray(n.incidences)||(n.incidences=[]);const a=Math.max(0,Math.min(r,n.incidences.length));n.incidences.splice(a,0,t),n.count=(n.count??0)+1},_=e=>!!(e!=null&&e.archived_at),P=e=>{e!=null&&e.id&&window.dispatchEvent(new CustomEvent("incidencias:edit",{detail:{incidence:e}}))},G=e=>{var r,n,a;const t=(r=e==null?void 0:e.detail)==null?void 0:r.incidence;if(t!=null&&t.id)for(const d of c.value){const i=((a=(n=d==null?void 0:d.incidences)==null?void 0:n.findIndex)==null?void 0:a.call(n,v=>v.id===t.id))??-1;if(i!==-1){d.incidences.splice(i,1,{...d.incidences[i],...t});break}}},oe=(e,t)=>{if(_(e))return;o.value=e,C.value=(e==null?void 0:e.stage_id)??null,y.value=e.id,M.value=!1;const r=c.value.find(n=>n.id===((e==null?void 0:e.stage_id)??null));if(r&&Array.isArray(r.incidences)){const n=r.incidences.findIndex(a=>a.id===e.id);E.value={stageId:r.id,index:n}}else E.value=null;p.value=!1},ue=(e=!1)=>{var r;if(!p.value)return;const t=((r=o.value)==null?void 0:r.id)??null;if(t!=null){for(const n of c.value){if(!Array.isArray(n.incidences))continue;const a=n.incidences.findIndex(d=>d.id===t);a!==-1&&n.incidences.splice(a,1)}if(e&&E.value){const n=c.value.find(a=>a.id===E.value.stageId);if(n){Array.isArray(n.incidences)||(n.incidences=[]);const a=Math.max(0,Math.min(E.value.index??n.incidences.length,n.incidences.length));n.incidences.splice(a,0,o.value)}}p.value=!1,L.value={incidenceId:null,position:"after",stageId:null}}},ce=()=>{k&&(clearTimeout(k),k=null),!M.value&&p.value&&ue(!0),o.value=null,C.value=null,y.value=null,p.value=!1,M.value=!1,L.value={incidenceId:null,position:"after",stageId:null},E.value=null};let k=null;const ve=(e,t,r)=>{!o.value||!r||!r.currentTarget||(k&&clearTimeout(k),k=setTimeout(()=>{o.value&&r.currentTarget&&ge(e,t,r)},16))},ge=(e,t,r)=>{var j;if(!o.value||!r||!r.currentTarget)return;const n=r.currentTarget.closest("section[data-stage-id]");if(!n)return;const a=n.querySelector(".p-3");if(!a)return;const d=a.querySelectorAll("article[data-incidence-id]"),i=Array.from(d).filter(l=>Number(l.getAttribute("data-incidence-id"))!==o.value.id);if(i.length===0){J(t.id,0),L.value={incidenceId:null,position:"top",stageId:t.id};return}const v=r.clientY;let x=i.length;for(let l=0;l<i.length;l++){const f=i[l].getBoundingClientRect(),h=f.top+f.height/2;if(v<h){x=l;break}}J(t.id,x);const D=x>0?Number((j=i[x-1])==null?void 0:j.getAttribute("data-incidence-id")):null;L.value={incidenceId:D,position:x===0?"before":"after",stageId:t.id}},J=(e,t)=>{var i;if(!o.value||p.value)return;const r=o.value,n=c.value.find(v=>v.id===e);if(!n||(((i=n.incidences)==null?void 0:i.findIndex(v=>v.id===r.id))??-1)===t)return;c.value.forEach(v=>{if(!Array.isArray(v.incidences))return;const x=v.incidences.findIndex(D=>D.id===r.id);x!==-1&&v.incidences.splice(x,1)}),Array.isArray(n.incidences)||(n.incidences=[]);const d=Math.max(0,Math.min(t,n.incidences.length));n.incidences.splice(d,0,r),p.value=!0},K=async(e,t=null,r=null)=>{var i,v,x,D,j;const n=o.value,a=C.value;if(!(n!=null&&n.id)||!a||!(e!=null&&e.id)){o.value=null,C.value=null,y.value=null;return}if(p.value){M.value=!0;const l=n.id,f=c.value.find(h=>h.id===e.id);if(!f)return;try{a!==e.id&&await T.patch(`/incidencias/${l}/move-stage`,{stage_id:e.id});const h=f.incidences.map($=>$.id);await T.patch("/incidencias/reorder",{stage_id:e.id,ordered_ids:h}),p.value=!1,L.value={incidenceId:null,position:"after",stageId:null},o.value=null,C.value=null,y.value=null,E.value=null,M.value=!1,w.value="",z("Incidencia actualizada")}catch{w.value="Error al mover la incidencia",await A({showLoading:!1})}return}if(a===e.id)return;w.value="";const d=Y(a,n.id);d&&(d.stage_id=e.id,le(e.id,d,0));try{const l=await T.patch(`/incidencias/${n.id}/move-stage`,{stage_id:e.id}),f=(i=l==null?void 0:l.data)==null?void 0:i.data;if(f&&typeof f=="object"){const h=(x=(v=c.value.find($=>$.id===e.id))==null?void 0:v.incidences)==null?void 0:x.find($=>$.id===n.id);h&&Object.assign(h,f)}z("Incidencia actualizada")}catch(l){const f=((j=(D=l==null?void 0:l.response)==null?void 0:D.data)==null?void 0:j.message)??"No se pudo mover la incidencia.";w.value=f,R(f),await A({showLoading:!1})}finally{o.value=null,C.value=null,y.value=null}},Q=async e=>{var t,r;if(e!=null&&e.id)try{if(!(await ae({title:"¿Seguro que quieres eliminar la incidencia?",text:"Esta acción no se puede deshacer.",icon:"warning",confirmButtonText:"Eliminar",cancelButtonText:"Cancelar"})).isConfirmed)return;await T.delete(`/incidencias/${e.id}`);for(const a of c.value){const d=((r=(t=a==null?void 0:a.incidences)==null?void 0:t.findIndex)==null?void 0:r.call(t,i=>i.id===e.id))??-1;if(d!==-1){a.incidences.splice(d,1),a.count=Math.max(0,(a.count??0)-1);break}}z("Incidencia eliminada correctamente")}catch{R("Error al eliminar la incidencia")}},me=async(e,t)=>{var n,a;if(!(!(e!=null&&e.id)||!(t!=null&&t.is_done)||!await ae({title:"Archivar incidencia",text:"Se ocultará del backlog, pero seguirá visible en la tabla (historial).",confirmText:"Archivar",cancelText:"Cancelar",icon:"warning"}))){S.value.add(e.id),w.value="";try{await T.patch(`/incidencias/${e.id}/archive`),Y(t.id,e.id),z("Incidencia archivada"),window.dispatchEvent(new CustomEvent("incidencias:archived"))}catch(d){const i=((a=(n=d==null?void 0:d.response)==null?void 0:n.data)==null?void 0:a.message)??"No se pudo archivar la incidencia.";w.value=i,R(i)}finally{S.value.delete(e.id)}}},U=()=>A({showLoading:!1});return be(async()=>{window.addEventListener("incidencias:created",U),window.addEventListener("incidencias:archived",U),window.addEventListener("incidencias:updated",G),await A()}),xe(()=>{window.removeEventListener("incidencias:created",U),window.removeEventListener("incidencias:archived",U),window.removeEventListener("incidencias:updated",G),k&&(clearTimeout(k),k=null),o.value=null,C.value=null,y.value=null,p.value=!1}),(e,t)=>(m(),g("div",null,[t[15]||(t[15]=s("div",{class:"mb-4 text-sm text-gray-600 dark:text-slate-300"}," Arrastra una incidencia entre columnas para cambiar su estado, o dentro de una columna para reordenar. ",-1)),s("div",pe,[s("div",ye,[t[10]||(t[10]=s("label",{class:"text-xs text-gray-600 dark:text-slate-300"},"Limite:",-1)),V(s("select",{"onUpdate:modelValue":t[0]||(t[0]=r=>B.value=r),class:"rounded-lg border border-gray-200 bg-white px-2 py-1 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:focus:ring-blue-900/30"},[...t[9]||(t[9]=[s("option",{value:20},"20",-1),s("option",{value:50},"50",-1),s("option",{value:100},"100",-1),s("option",{value:250},"250",-1)])],512),[[W,B.value,void 0,{number:!0}]])]),s("div",ke,[t[11]||(t[11]=s("label",{class:"text-xs text-gray-600 dark:text-slate-300"},"Desde:",-1)),V(s("input",{"onUpdate:modelValue":t[1]||(t[1]=r=>N.value=r),type:"date",class:"rounded-lg border border-gray-200 bg-white px-2 py-1 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 placeholder:text-gray-400 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:placeholder:text-slate-500 dark:focus:ring-blue-900/30 dark:[color-scheme:dark]"},null,512),[[X,N.value]])]),s("div",he,[t[12]||(t[12]=s("label",{class:"text-xs text-gray-600 dark:text-slate-300"},"Hasta:",-1)),V(s("input",{"onUpdate:modelValue":t[2]||(t[2]=r=>O.value=r),type:"date",class:"rounded-lg border border-gray-200 bg-white px-2 py-1 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 placeholder:text-gray-400 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:placeholder:text-slate-500 dark:focus:ring-blue-900/30 dark:[color-scheme:dark]"},null,512),[[X,O.value]])]),s("div",we,[t[14]||(t[14]=s("label",{class:"text-xs text-gray-600 dark:text-slate-300"},"Prioridad:",-1)),V(s("select",{"onUpdate:modelValue":t[3]||(t[3]=r=>F.value=r),class:"rounded-lg border border-gray-200 bg-white px-2 py-1 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:focus:ring-blue-900/30"},[...t[13]||(t[13]=[s("option",{value:""},"Todas",-1),s("option",{value:"alta"},"Alta",-1),s("option",{value:"media"},"Media",-1),s("option",{value:"baja"},"Baja",-1)])],512),[[W,F.value]])]),s("div",{class:"flex items-center gap-2 ms-auto"},[s("button",{onClick:se,class:"inline-flex items-center rounded-lg bg-blue-600 px-3 py-1 text-sm text-white hover:bg-blue-700"}," Aplicar "),s("button",{onClick:ie,class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1 text-sm text-gray-700 shadow-sm hover:bg-gray-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800"}," Limpiar ")])]),q.value?(m(),g("div",_e,"Cargando...")):w.value?(m(),g("div",Ie,I(w.value),1)):(m(),g("div",{key:2,class:H(["grid gap-4",re.value])},[(m(!0),g(Z,null,ee(c.value,r=>{var n;return m(),g("section",{key:r.id,"data-stage-id":r.id,class:"bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden dark:bg-slate-900 dark:border-slate-800",onDragover:t[8]||(t[8]=b(()=>{},["prevent"])),onDrop:b(a=>K(r),["prevent"])},[s("div",Ee,[s("div",Ae,[s("div",De,I(r.name),1),s("div",Te,I(r.count),1)])]),s("div",Me,[(((n=r.incidences)==null?void 0:n.length)??0)===0?(m(),g("div",Le," Sin incidencias. ")):te("",!0),(m(!0),g(Z,null,ee(r.incidences,a=>(m(),g("div",{key:a.id,"data-incidence-id":a.id},[s("article",{"data-incidence-id":a.id,class:H(["select-none bg-gray-50 border border-gray-200 rounded-lg p-3 dark:bg-slate-800 dark:border-slate-700 transition-all duration-150",{"scale-105 shadow-lg opacity-90 z-50 transform":y.value===a.id,"opacity-50":y.value&&y.value!==a.id,"cursor-not-allowed opacity-80":_(a),"cursor-grab active:cursor-grabbing hover:bg-blue-50/30 dark:hover:bg-slate-800/50":!_(a)}]),draggable:!_(a),onDragstart:d=>oe(a),onDragend:ce,onDragover:b(d=>ve(a,r,d),["prevent"]),onDrop:b(d=>K(r,a,d),["prevent"])},[s("div",{class:"flex items-start justify-between gap-3 cursor-pointer",onClick:d=>P(a)},[s("div",null,[s("div",Ne,I(a.title),1),a.customer?(m(),g("div",Oe,I(a.customer.company_name||a.customer.name),1)):(m(),g("div",Fe,"Sin cliente"))]),s("div",{class:H(["text-xs",de(a.priority)])},I(a.priority||"Normal"),3)],8,Be),a.date?(m(),g("div",{key:0,class:"mt-2 text-xs text-gray-600 dark:text-slate-300 cursor-pointer",onClick:d=>P(a)},I(ne(a.date)),9,Se)):te("",!0),r.is_done?(m(),g("div",Pe,[s("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:_(a),onMousedown:t[4]||(t[4]=b(()=>{},["stop"])),onClick:b(d=>P(a),["stop","prevent"])}," Editar ",40,Ue),s("button",{type:"button",class:"inline-flex items-center rounded-lg border border-red-200 bg-red-50 px-3 py-1.5 text-xs font-medium text-red-700 shadow-sm hover:bg-red-100 disabled:opacity-60 dark:border-red-700 dark:bg-red-900/20 dark:text-red-400 dark:hover:bg-red-900/30",disabled:_(a),onMousedown:t[5]||(t[5]=b(()=>{},["stop"])),onClick:b(d=>Q(a),["stop","prevent"])}," Eliminar ",40,Ve),s("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:S.value.has(a.id),onClick:b(d=>me(a,r),["stop","prevent"])},I(S.value.has(a.id)?"Archivando…":"Archivar"),9,ze)])):(m(),g("div",qe,[s("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:_(a),onMousedown:t[6]||(t[6]=b(()=>{},["stop"])),onClick:b(d=>P(a),["stop","prevent"])}," Editar ",40,He),s("button",{type:"button",class:"inline-flex items-center rounded-lg border border-red-200 bg-red-50 px-3 py-1.5 text-xs font-medium text-red-700 shadow-sm hover:bg-red-100 disabled:opacity-60 dark:border-red-700 dark:bg-red-900/20 dark:text-red-400 dark:hover:bg-red-900/30",disabled:_(a),onMousedown:t[7]||(t[7]=b(()=>{},["stop"])),onClick:b(d=>Q(a),["stop","prevent"])}," Eliminar ",40,Re)]))],42,$e)],8,je))),128))])],40,Ce)}),128))],2))]))}};export{Ze as default};
