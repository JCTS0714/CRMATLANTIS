import{r as c,e as ge,o as ve,f as be,x as me,g as d,i,j as a,k as C,w as B,z as ye,A as xe,t as o,G as he,u as k,n as K,C as M,F as R,m as F,s as Q,v as ke}from"./vendor-vue-Diyp6CFE.js";import{a as $}from"./vendor-utils-Czy7fllw.js";import{u as fe,a as we,_ as _e,b as j,t as P,c as W}from"./App-DAC6HJ3v.js";import"./app-BDRZbfW-.js";import"./vendor-ui-BsDgRXDF.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const Ce={class:"mb-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between"},Se={class:"flex-1"},Ie={class:"flex items-center gap-2"},Te=["disabled"],Ee={class:"mb-4 overflow-x-auto"},Ae={class:"inline-flex rounded-lg border border-gray-200 bg-white p-1 shadow-sm dark:border-slate-800 dark:bg-slate-900"},Ne={class:"ml-2 rounded bg-black/5 px-2 py-0.5 text-xs font-semibold text-gray-700 dark:bg-white/10 dark:text-slate-200"},$e=["onClick"],De={class:"ml-2 rounded bg-black/5 px-2 py-0.5 text-xs font-semibold text-gray-700 dark:bg-white/10 dark:text-slate-200"},Le={key:0,class:"mb-4 rounded-lg border border-red-200 bg-red-50 p-3 text-sm text-red-700 dark:border-red-900/40 dark:bg-red-950/30 dark:text-red-200"},Ve={class:"bg-white border border-gray-200 rounded-lg shadow-sm dark:bg-slate-900 dark:border-slate-800"},ze={class:"p-4 border-b border-gray-200 dark:border-slate-800 flex items-center justify-between"},Be={class:"mt-1 text-xs text-gray-600 dark:text-slate-300"},Me={key:0},Re={key:0,class:"text-xs text-gray-600 dark:text-slate-300"},Fe={class:"px-4 py-3 font-medium text-gray-900 dark:text-slate-100"},je={class:"px-4 py-3"},Pe={class:"px-4 py-3"},Ue={class:"flex items-center gap-2"},qe=["disabled","onClick"],He=["disabled","onClick"],Oe=["disabled","onClick"],Ge={key:0,class:"w-3 h-3 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},Ke={key:1,class:"w-3 h-3 mr-1 animate-spin",fill:"none",viewBox:"0 0 24 24"},Qe={class:"px-4 py-3"},We={class:"px-4 py-3"},Xe={key:0},Je={key:1,class:"text-gray-500 dark:text-slate-400"},Ye={class:"px-4 py-3"},Ze={class:"px-4 py-3"},et={class:"px-4 py-3"},tt={class:"px-4 py-3"},at={key:0},st={class:"p-4 flex items-center justify-between gap-3"},rt=["disabled"],lt={class:"text-xs text-gray-600 dark:text-slate-300"},ot=["disabled"],vt={__name:"IncidenciasTable",setup(nt){const D=c([]),g=c([]),S=c(0),b=c(!1),u=c(""),I=c(new Set),f=c(new Set),T=c(null),E=c(!1),A=c(""),L=c("");let w=null;const V=c(15),m=c(null),l=c({current_page:1,last_page:1,per_page:15,total:0,from:0,to:0}),z=[{key:"id",label:"ID"},{key:"correlative",label:"Correlativo"},{key:"actions",label:"Acciones"},{key:"title",label:"Título"},{key:"customer",label:"Cliente"},{key:"priority",label:"Prioridad"},{key:"date",label:"Fecha"},{key:"archived_at",label:"Archivado"},{key:"updated_at",label:"Actualizado"}],{tableRef:U,visibleKeys:X,isColumnVisible:J,toggleColumn:Y,resetColumns:Z}=fe({tableId:"incidencias-table",columns:z}),{tableScrollRef:ee,stickyScrollRef:te,stickyScrollWidth:ae,showStickyXScroll:se}=we({tableRef:U}),re=()=>{const t=new URL(window.location.href).searchParams.get("q");t&&(A.value=t,L.value=t)},_=({stageId:e=m.value,page:t=l.value.current_page}={})=>{m.value=e===void 0?m.value:e,l.value.current_page=t,y()},y=async()=>{var e,t,s;b.value=!0,u.value="";try{const r=await $.get("/incidencias/data",{params:{stage_id:m.value,q:L.value||"",page:l.value.current_page,per_page:V.value}}),n=((e=r==null?void 0:r.data)==null?void 0:e.data)??{};D.value=n.stages??[],S.value=n.total_count??0,g.value=n.incidences??[],l.value={...l.value,...n.pagination||{}}}catch(r){const n=((s=(t=r==null?void 0:r.response)==null?void 0:t.data)==null?void 0:s.message)??"No se pudo cargar incidencias.";u.value=n}finally{b.value=!1}},le=()=>{var e,t;(t=(e=T.value)==null?void 0:e.click)==null||t.call(e)},oe=async e=>{var s,r,n,p,v;const t=(r=(s=e==null?void 0:e.target)==null?void 0:s.files)==null?void 0:r[0];if(t){E.value=!0,u.value="";try{const x=new FormData;x.append("csv",t);const{data:h}=await $.post("/incidencias/import",x,{headers:{"Content-Type":"multipart/form-data"}});j(((n=h==null?void 0:h.output)!=null&&n.trim(),"Importación finalizada")),l.value.current_page=1,await y()}catch(x){const h=((v=(p=x==null?void 0:x.response)==null?void 0:p.data)==null?void 0:v.message)??"No se pudo importar el CSV.";u.value=h,P(h)}finally{E.value=!1,T.value&&(T.value.value="")}}},ne=ge(()=>{const e=new Map;for(const t of D.value)e.set(t.id,t);return e}),q=e=>!!(e!=null&&e.archived_at),de=e=>{e!=null&&e.id&&window.dispatchEvent(new CustomEvent("incidencias:edit",{detail:{incidence:e}}))},H=e=>{if(!e||q(e))return!1;const t=ne.value.get(e.stage_id);return!!(t!=null&&t.is_done)},ie=async e=>{var s,r,n;if(!(!(e!=null&&e.id)||!H(e)||!await W({title:"Archivar incidencia",text:"Se ocultará del backlog, pero seguirá visible en la tabla (historial).",confirmText:"Archivar",cancelText:"Cancelar",icon:"warning"}))){I.value.add(e.id),u.value="";try{const p=await $.patch(`/incidencias/${e.id}/archive`),v=(s=p==null?void 0:p.data)==null?void 0:s.data;v&&typeof v=="object"?Object.assign(e,v):e.archived_at=new Date().toISOString(),j("Incidencia archivada"),window.dispatchEvent(new CustomEvent("incidencias:archived"))}catch(p){const v=((n=(r=p==null?void 0:p.response)==null?void 0:r.data)==null?void 0:n.message)??"No se pudo archivar la incidencia.";u.value=v,P(v)}finally{I.value.delete(e.id)}}},ce=async e=>{await W({title:"¿Eliminar incidencia?",text:`Se eliminará permanentemente "${e.title||`#${e.correlative}`}"`,confirmText:"Sí, eliminar",cancelText:"Cancelar",icon:"warning"})&&await ue(e)},ue=async e=>{var t,s;f.value.add(e.id),u.value="";try{await $.delete(`/incidencias/${e.id}`);const r=g.value.findIndex(n=>n.id===e.id);if(r!==-1&&(g.value.splice(r,1),S.value=Math.max(0,S.value-1),g.value.length===0&&l.value.current_page>1)){l.value.current_page--,y();return}j("Incidencia eliminada exitosamente"),window.dispatchEvent(new CustomEvent("incidencias:deleted"))}catch(r){const n=((s=(t=r==null?void 0:r.response)==null?void 0:t.data)==null?void 0:s.message)??"No se pudo eliminar la incidencia.";u.value=n,P(n)}finally{f.value.delete(e.id)}},pe=e=>{if(!e)return"";try{const t=new Date(String(e));return Number.isNaN(t.getTime())?String(e):t.toLocaleDateString()}catch{return String(e)}},O=e=>{if(!e)return"";try{const t=new Date(String(e));return Number.isNaN(t.getTime())?String(e):t.toLocaleString()}catch{return String(e)}},N=()=>{l.value.current_page=1,y()},G=e=>{var r;const t=(r=e==null?void 0:e.detail)==null?void 0:r.incidence;if(!(t!=null&&t.id))return;const s=g.value.findIndex(n=>n.id===t.id);s!==-1&&g.value.splice(s,1,{...g.value[s],...t})};return ve(async()=>{re(),window.addEventListener("incidencias:created",N),window.addEventListener("incidencias:archived",N),window.addEventListener("incidencias:updated",G),await y()}),be(()=>{window.removeEventListener("incidencias:created",N),window.removeEventListener("incidencias:archived",N),window.removeEventListener("incidencias:updated",G),w&&window.clearTimeout(w)}),me(A,e=>{w&&window.clearTimeout(w),w=window.setTimeout(()=>{L.value=e,l.value.current_page=1,y()},350)},{flush:"post"}),(e,t)=>(i(),d("section",null,[a("div",Ce,[a("div",Se,[t[6]||(t[6]=a("label",{class:"sr-only",for:"inc-search"},"Buscar",-1)),B(a("input",{id:"inc-search","onUpdate:modelValue":t[0]||(t[0]=s=>A.value=s),type:"search",placeholder:"Buscar por título, correlativo, cliente…",class:"w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900 placeholder:text-gray-400 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:placeholder:text-slate-500"},null,512),[[ye,A.value]])]),a("div",Ie,[a("input",{ref_key:"importInput",ref:T,type:"file",accept:".csv,text/csv",class:"hidden",onChange:oe},null,544),a("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:E.value,onClick:le},o(E.value?"Importando…":"Importar CSV"),9,Te),B(a("select",{"onUpdate:modelValue":t[1]||(t[1]=s=>V.value=s),class:"rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100",onChange:t[2]||(t[2]=s=>_({page:1}))},[...t[7]||(t[7]=[a("option",{value:10},"10",-1),a("option",{value:15},"15",-1),a("option",{value:25},"25",-1),a("option",{value:50},"50",-1)])],544),[[he,V.value,void 0,{number:!0}]]),xe(_e,{columns:z,"visible-keys":k(X),onToggle:k(Y),onReset:k(Z)},null,8,["visible-keys","onToggle","onReset"])])]),a("div",Ee,[a("div",Ae,[a("button",{type:"button",class:K(["px-3 py-2 text-sm font-medium rounded-md transition",m.value===null?"bg-blue-600 text-white":"text-gray-700 hover:bg-gray-50 dark:text-slate-200 dark:hover:bg-slate-800"]),onClick:t[3]||(t[3]=s=>_({stageId:null,page:1}))},[t[8]||(t[8]=M(" Todos ",-1)),a("span",Ne,o(S.value),1)],2),(i(!0),d(R,null,F(D.value,s=>(i(),d("button",{key:s.id,type:"button",class:K(["px-3 py-2 text-sm font-medium rounded-md transition",m.value===s.id?"bg-blue-600 text-white":"text-gray-700 hover:bg-gray-50 dark:text-slate-200 dark:hover:bg-slate-800"]),onClick:r=>_({stageId:s.id,page:1})},[M(o(s.name)+" ",1),a("span",De,o(s.count??0),1)],10,$e))),128))])]),u.value?(i(),d("div",Le,o(u.value),1)):C("",!0),a("div",Ve,[a("div",ze,[a("div",null,[t[9]||(t[9]=a("div",{class:"text-sm font-semibold text-gray-900 dark:text-slate-100"},"Incidencias",-1)),a("div",Be,[l.value.total!==null?(i(),d("span",Me," Mostrando "+o(l.value.from??0)+"–"+o(l.value.to??0)+" de "+o(l.value.total??0),1)):C("",!0)])]),b.value?(i(),d("div",Re,"Cargando…")):C("",!0)]),a("div",{ref_key:"tableScrollRef",ref:ee,class:"overflow-x-auto"},[a("table",{ref_key:"tableRef",ref:U,class:"min-w-[1300px] w-full text-sm text-left text-gray-700 dark:text-slate-200"},[a("colgroup",null,[(i(),d(R,null,F(z,s=>a("col",{key:s.key,style:Q({display:k(J)(s.key)?"":"none"})},null,4)),64))]),t[13]||(t[13]=a("thead",{class:"text-xs uppercase bg-gray-50 text-gray-700 dark:bg-slate-800 dark:text-slate-200"},[a("tr",null,[a("th",{class:"px-4 py-3"},"ID"),a("th",{class:"px-4 py-3"},"Correlativo"),a("th",{class:"px-4 py-3"},"Acciones"),a("th",{class:"px-4 py-3"},"Título"),a("th",{class:"px-4 py-3"},"Cliente"),a("th",{class:"px-4 py-3"},"Prioridad"),a("th",{class:"px-4 py-3"},"Fecha"),a("th",{class:"px-4 py-3"},"Archivado"),a("th",{class:"px-4 py-3"},"Actualizado")])],-1)),a("tbody",null,[(i(!0),d(R,null,F(g.value,s=>(i(),d("tr",{key:s.id,class:"border-b border-gray-100 bg-white hover:bg-blue-50/40 transition-colors dark:border-slate-800 dark:bg-slate-900 dark:hover:bg-slate-800/60"},[a("td",Fe,o(s.id),1),a("td",je,o(s.correlative||"—"),1),a("td",Pe,[a("div",Ue,[a("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:q(s),onClick:r=>de(s)}," Editar ",8,qe),H(s)?(i(),d("button",{key:0,type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:I.value.has(s.id),onClick:r=>ie(s)},o(I.value.has(s.id)?"Archivando…":"Archivar"),9,He)):C("",!0),a("button",{type:"button",class:"inline-flex items-center rounded-lg border border-red-200 bg-red-50 px-3 py-1.5 text-xs font-medium text-red-700 shadow-sm hover:bg-red-100 disabled:opacity-60 dark:border-red-800 dark:bg-red-950 dark:text-red-300 dark:hover:bg-red-900",disabled:f.value.has(s.id),onClick:r=>ce(s)},[f.value.has(s.id)?(i(),d("svg",Ke,[...t[11]||(t[11]=[a("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),a("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)])])):(i(),d("svg",Ge,[...t[10]||(t[10]=[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"},null,-1)])])),M(" "+o(f.value.has(s.id)?"Eliminando…":"Eliminar"),1)],8,Oe)])]),a("td",Qe,o(s.title??""),1),a("td",We,[s.customer?(i(),d("span",Xe,o(s.customer.company_name||s.customer.name),1)):(i(),d("span",Je,"—"))]),a("td",Ye,o(s.priority??""),1),a("td",Ze,o(pe(s.date)),1),a("td",et,o(O(s.archived_at)),1),a("td",tt,o(O(s.updated_at)),1)]))),128)),!b.value&&g.value.length===0?(i(),d("tr",at,[...t[12]||(t[12]=[a("td",{colspan:"9",class:"px-4 py-10 text-center text-sm text-gray-600 dark:text-slate-300"}," Sin incidencias. ",-1)])])):C("",!0)])],512)],512),B(a("div",{ref_key:"stickyScrollRef",ref:te,class:"sticky bottom-0 z-20 mt-2 overflow-x-auto rounded-lg border border-slate-200 bg-white/95 dark:border-slate-700 dark:bg-slate-900/95"},[a("div",{style:Q({width:`${k(ae)}px`,height:"1px"})},null,4)],512),[[ke,k(se)]]),a("div",st,[a("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:b.value||l.value.current_page<=1,onClick:t[4]||(t[4]=s=>_({page:l.value.current_page-1}))}," Anterior ",8,rt),a("div",lt," Página "+o(l.value.current_page)+" / "+o(l.value.last_page),1),a("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:b.value||l.value.current_page>=l.value.last_page,onClick:t[5]||(t[5]=s=>_({page:l.value.current_page+1}))}," Siguiente ",8,ot)])])]))}};export{vt as default};
