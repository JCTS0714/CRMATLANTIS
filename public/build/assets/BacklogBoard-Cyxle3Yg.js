import{r as l,e as ge,o as ve,f as me,g as c,i as u,j as d,w as T,D as J,x as K,t as f,n as V,F as Q,m as W,l as b,k as j}from"./vendor-vue-Db-AqoDh.js";import{a as E}from"./vendor-utils-Czy7fllw.js";import{a as F,t as q,c as X}from"./App-Bly0OSko.js";import"./app-Co7Pniaw.js";import"./vendor-ui-DEm6YKEA.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const xe={class:"mb-4 flex items-center gap-3"},be={class:"flex items-center gap-2"},pe={class:"flex items-center gap-2"},fe={class:"flex items-center gap-2"},ye={class:"flex items-center gap-2"},ke={key:0,class:"text-sm text-gray-600 dark:text-slate-300"},he={key:1,class:"mb-3 text-sm text-red-600"},we=["data-stage-id","onDrop"],_e={class:"p-4 border-b border-gray-200 dark:border-slate-800"},Ce={class:"flex items-center justify-between gap-3"},Ie={class:"text-sm font-semibold text-gray-900 dark:text-slate-100"},Ee={class:"text-xs text-gray-600 dark:text-slate-300"},Ae={class:"p-3 space-y-3 min-h-[140px]"},De={key:0,class:"text-sm text-gray-500 dark:text-slate-400 px-1"},Se=["data-incidence-id"],Me={key:0,class:"h-1 bg-blue-500 rounded-full mx-3 mb-2 animate-pulse transition-all duration-300"},Le=["data-incidence-id","draggable","onDragstart","onClick"],$e=["onClick"],Be={class:"text-sm font-semibold text-gray-900 dark:text-slate-100"},Te={key:0,class:"text-xs text-gray-600 dark:text-slate-300 mt-1"},je={key:1,class:"text-xs text-gray-500 dark:text-slate-400 mt-1"},Fe=["onClick"],Pe={key:1,class:"mt-3 flex justify-end gap-2"},Ne=["disabled","onClick"],Ue=["disabled","onClick"],Ve=["disabled","onClick"],qe={key:2,class:"mt-3 flex justify-end gap-2"},Oe=["disabled","onClick"],Ye=["disabled","onClick"],ze={key:1,class:"h-1 bg-blue-500 rounded-full mx-3 mt-2 animate-pulse transition-all duration-300"},Xe={__name:"BacklogBoard",setup(He){const P=l(!0),v=l([]),y=l(""),A=l(50),D=l(""),S=l(""),M=l(""),m=l(null),Z=l(null),L=l(null),k=l(null),h=l(null),N=l(null),U=l(!1),_=l(!1),w=l(null),$=l(new Set),ee=ge(()=>{const e=v.value.length||1;return e<=1?"grid-cols-1":e===2?"grid-cols-1 md:grid-cols-2":e===3?"grid-cols-1 md:grid-cols-3":"grid-cols-1 md:grid-cols-2 xl:grid-cols-4"}),te=e=>{if(!e)return"";try{const t=new Date(String(e));return Number.isNaN(t.getTime())?String(e):t.toLocaleDateString()}catch{return String(e)}},ae=e=>{switch(e==null?void 0:e.toLowerCase()){case"alta":return"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200 px-2 py-0.5 rounded font-medium";case"media":return"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200 px-2 py-0.5 rounded font-medium";case"baja":return"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 px-2 py-0.5 rounded font-medium";default:return"text-gray-700 dark:text-slate-200"}},C=async({showLoading:e=!0}={})=>{var t,s;e&&(P.value=!0);try{const a=await E.get("/backlog/board-data",{params:{limit:A.value,date_from:D.value||null,date_to:S.value||null,priority:M.value||null}});v.value=((s=(t=a==null?void 0:a.data)==null?void 0:t.data)==null?void 0:s.stages)??[]}finally{e&&(P.value=!1)}},re=()=>{C()},se=()=>{D.value="",S.value="",M.value="",A.value=50,C()},p=e=>!!(e!=null&&e.archived_at),I=e=>{e!=null&&e.id&&window.dispatchEvent(new CustomEvent("incidencias:edit",{detail:{incidence:e}}))},O=e=>{var s,a,n;const t=(s=e==null?void 0:e.detail)==null?void 0:s.incidence;if(t!=null&&t.id)for(const r of v.value){const i=((n=(a=r==null?void 0:r.incidences)==null?void 0:a.findIndex)==null?void 0:n.call(a,o=>o.id===t.id))??-1;if(i!==-1){r.incidences.splice(i,1,{...r.incidences[i],...t});break}}},ne=(e,t,s)=>{if(p(e))return;m.value=e,L.value=(e==null?void 0:e.stage_id)??null,N.value=e.id,U.value=!1;const a=v.value.find(n=>n.id===((e==null?void 0:e.stage_id)??null));if(a&&Array.isArray(a.incidences)){const n=a.incidences.findIndex(r=>r.id===e.id);w.value={stageId:a.id,index:n}}else w.value=null;_.value=!1},de=(e=!1)=>{var s;if(!_.value)return;const t=((s=m.value)==null?void 0:s.id)??null;if(t!=null){for(const a of v.value){if(!Array.isArray(a.incidences))continue;const n=a.incidences.findIndex(r=>r.id===t);n!==-1&&a.incidences.splice(n,1)}if(e&&w.value){const a=v.value.find(n=>n.id===w.value.stageId);if(a){Array.isArray(a.incidences)||(a.incidences=[]);const n=Math.max(0,Math.min(w.value.index??a.incidences.length,a.incidences.length));a.incidences.splice(n,0,m.value)}}_.value=!1,k.value=null,h.value=null}},ie=()=>{!U.value&&_.value&&de(!0),m.value=null,L.value=null,N.value=null,_.value=!1,U.value=!1,k.value=null,h.value=null,w.value=null},oe=async(e,t)=>{var n,r,i;if(t.preventDefault(),!m.value||!e)return;const s=m.value,a=L.value;if(p(s)){y.value="Esta incidencia está bloqueada y no se puede mover.";return}y.value="";try{const o=t.clientY,g=z(e,o,s.id);if(a===e.id)await H(e.id,s.id,g),F("Incidencia reordenada");else{const x=await E.patch(`/incidencias/${s.id}/move-stage`,{stage_id:e.id});Y(a,s.id);const G=((n=x==null?void 0:x.data)==null?void 0:n.data)??s;G.stage_id=e.id,le(e.id,G,g),await H(e.id,s.id,g),F("Incidencia movida correctamente")}}catch(o){console.error("Error in onDropOnStage:",o);const g=((i=(r=o==null?void 0:o.response)==null?void 0:r.data)==null?void 0:i.message)??"No se pudo mover la incidencia.";y.value=g,q(g),await C({showLoading:!1})}finally{m.value=null,L.value=null,N.value=null,k.value=null,h.value=null}},Y=(e,t)=>{const s=v.value.find(n=>n.id===e);if(!(s!=null&&s.incidences))return null;const a=s.incidences.findIndex(n=>n.id===t);if(a!==-1){const n=s.incidences.splice(a,1)[0];return s.count=s.incidences.length,n}return null},le=(e,t,s=0)=>{const a=v.value.find(i=>i.id===e);if(!a)return;Array.isArray(a.incidences)||(a.incidences=[]);const n=a.incidences.findIndex(i=>i.id===t.id);n!==-1&&a.incidences.splice(n,1);const r=Math.min(Math.max(0,s),a.incidences.length);a.incidences.splice(r,0,t),a.count=a.incidences.length},ce=e=>{if(!m.value)return;e.preventDefault();const t=e.currentTarget.closest("section[data-stage-id]");if(!t)return;const s=parseInt(t.getAttribute("data-stage-id")),a=v.value.find(r=>r.id===s);if(!a)return;k.value=s;const n=e.clientY;h.value=z(a,n,m.value.id)},z=(e,t,s=null)=>{const a=document.querySelector(`[data-stage-id="${e.id}"] .p-3`);if(!a)return 0;const n=a.querySelectorAll("article[data-incidence-id]"),r=Array.from(n).filter(i=>{const o=parseInt(i.getAttribute("data-incidence-id"));return s?o!==s:!0});for(let i=0;i<r.length;i++){const o=r[i].getBoundingClientRect();if(t<o.top+o.height/2)return i}return r.length},H=async(e,t,s)=>{const a=v.value.find(g=>g.id===e);if(!a||!Array.isArray(a.incidences))return;const n=a.incidences.findIndex(g=>g.id===t);if(n===-1||n===s)return;const[r]=a.incidences.splice(n,1),i=Math.min(Math.max(0,s),a.incidences.length);a.incidences.splice(i,0,r),a.count=a.incidences.length;const o=a.incidences.map(g=>g.id);await E.patch("/incidencias/reorder",{stage_id:e,ordered_ids:o})},R=async e=>{var t,s;if(e!=null&&e.id)try{if(!(await X({title:"¿Seguro que quieres eliminar la incidencia?",text:"Esta acción no se puede deshacer.",icon:"warning",confirmButtonText:"Eliminar",cancelButtonText:"Cancelar"})).isConfirmed)return;await E.delete(`/incidencias/${e.id}`);for(const n of v.value){const r=((s=(t=n==null?void 0:n.incidences)==null?void 0:t.findIndex)==null?void 0:s.call(t,i=>i.id===e.id))??-1;if(r!==-1){n.incidences.splice(r,1),n.count=Math.max(0,(n.count??0)-1);break}}F("Incidencia eliminada correctamente")}catch{q("Error al eliminar la incidencia")}},ue=async(e,t)=>{var a,n;if(!(!(e!=null&&e.id)||!(t!=null&&t.is_done)||!await X({title:"Archivar incidencia",text:"Se ocultará del backlog, pero seguirá visible en la tabla (historial).",confirmText:"Archivar",cancelText:"Cancelar",icon:"warning"}))){$.value.add(e.id),y.value="";try{await E.patch(`/incidencias/${e.id}/archive`),Y(t.id,e.id),F("Incidencia archivada"),window.dispatchEvent(new CustomEvent("incidencias:archived"))}catch(r){const i=((n=(a=r==null?void 0:r.response)==null?void 0:a.data)==null?void 0:n.message)??"No se pudo archivar la incidencia.";y.value=i,q(i)}finally{$.value.delete(e.id)}}},B=()=>C({showLoading:!1});return ve(async()=>{window.addEventListener("incidencias:created",B),window.addEventListener("incidencias:archived",B),window.addEventListener("incidencias:updated",O),await C()}),me(()=>{window.removeEventListener("incidencias:created",B),window.removeEventListener("incidencias:archived",B),window.removeEventListener("incidencias:updated",O),m.value=null,Z.value=null}),(e,t)=>(u(),c("div",null,[t[14]||(t[14]=d("div",{class:"mb-4 text-sm text-gray-600 dark:text-slate-300"}," Arrastra una incidencia entre columnas para cambiar su estado, o dentro de una columna para reordenar. ",-1)),d("div",xe,[d("div",be,[t[9]||(t[9]=d("label",{class:"text-xs text-gray-600 dark:text-slate-300"},"Limite:",-1)),T(d("select",{"onUpdate:modelValue":t[0]||(t[0]=s=>A.value=s),class:"rounded-lg border border-gray-200 bg-white px-2 py-1 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:focus:ring-blue-900/30"},[...t[8]||(t[8]=[d("option",{value:20},"20",-1),d("option",{value:50},"50",-1),d("option",{value:100},"100",-1),d("option",{value:250},"250",-1)])],512),[[J,A.value,void 0,{number:!0}]])]),d("div",pe,[t[10]||(t[10]=d("label",{class:"text-xs text-gray-600 dark:text-slate-300"},"Desde:",-1)),T(d("input",{"onUpdate:modelValue":t[1]||(t[1]=s=>D.value=s),type:"date",class:"rounded-lg border border-gray-200 bg-white px-2 py-1 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 placeholder:text-gray-400 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:placeholder:text-slate-500 dark:focus:ring-blue-900/30 dark:[color-scheme:dark]"},null,512),[[K,D.value]])]),d("div",fe,[t[11]||(t[11]=d("label",{class:"text-xs text-gray-600 dark:text-slate-300"},"Hasta:",-1)),T(d("input",{"onUpdate:modelValue":t[2]||(t[2]=s=>S.value=s),type:"date",class:"rounded-lg border border-gray-200 bg-white px-2 py-1 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 placeholder:text-gray-400 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:placeholder:text-slate-500 dark:focus:ring-blue-900/30 dark:[color-scheme:dark]"},null,512),[[K,S.value]])]),d("div",ye,[t[13]||(t[13]=d("label",{class:"text-xs text-gray-600 dark:text-slate-300"},"Prioridad:",-1)),T(d("select",{"onUpdate:modelValue":t[3]||(t[3]=s=>M.value=s),class:"rounded-lg border border-gray-200 bg-white px-2 py-1 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:focus:ring-blue-900/30"},[...t[12]||(t[12]=[d("option",{value:""},"Todas",-1),d("option",{value:"alta"},"Alta",-1),d("option",{value:"media"},"Media",-1),d("option",{value:"baja"},"Baja",-1)])],512),[[J,M.value]])]),d("div",{class:"flex items-center gap-2 ms-auto"},[d("button",{onClick:re,class:"inline-flex items-center rounded-lg bg-blue-600 px-3 py-1 text-sm text-white hover:bg-blue-700"}," Aplicar "),d("button",{onClick:se,class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1 text-sm text-gray-700 shadow-sm hover:bg-gray-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800"}," Limpiar ")])]),P.value?(u(),c("div",ke,"Cargando...")):y.value?(u(),c("div",he,f(y.value),1)):(u(),c("div",{key:2,class:V(["grid gap-4",ee.value])},[(u(!0),c(Q,null,W(v.value,s=>{var a,n;return u(),c("section",{key:s.id,"data-stage-id":s.id,class:"bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden dark:bg-slate-900 dark:border-slate-800",onDragover:b(ce,["prevent"]),onDrop:b(r=>oe(s,r),["prevent"])},[d("div",_e,[d("div",Ce,[d("div",Ie,f(s.name),1),d("div",Ee,f(s.count),1)])]),d("div",Ae,[(((a=s.incidences)==null?void 0:a.length)??0)===0?(u(),c("div",De," Sin incidencias. ")):j("",!0),(u(!0),c(Q,null,W(s.incidences,(r,i)=>{var o,g;return u(),c("div",{key:r.id,"data-incidence-id":r.id},[k.value===s.id&&h.value===i&&((o=m.value)==null?void 0:o.id)!==r.id?(u(),c("div",Me)):j("",!0),d("article",{"data-incidence-id":r.id,class:V(["select-none bg-gray-50 border border-gray-200 rounded-lg p-3 mb-3 dark:bg-slate-800 dark:border-slate-700 transition-all duration-200",{"opacity-60 scale-95 shadow-lg":((g=m.value)==null?void 0:g.id)===r.id,"cursor-not-allowed opacity-80":p(r),"cursor-grab hover:bg-blue-50/30 dark:hover:bg-slate-800/50 hover:shadow-md":!p(r)}]),draggable:!p(r),onDragstart:x=>ne(r),onDragend:ie,onClick:x=>I(r)},[d("div",{class:"flex items-start justify-between gap-3 cursor-pointer",onClick:x=>I(r)},[d("div",null,[d("div",Be,f(r.title),1),r.customer?(u(),c("div",Te,f(r.customer.company_name||r.customer.name),1)):(u(),c("div",je,"Sin cliente"))]),d("div",{class:V(["text-xs",ae(r.priority)])},f(r.priority||"Normal"),3)],8,$e),r.date?(u(),c("div",{key:0,class:"mt-2 text-xs text-gray-600 dark:text-slate-300 cursor-pointer",onClick:x=>I(r)},f(te(r.date)),9,Fe)):j("",!0),s.is_done?(u(),c("div",Pe,[d("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:p(r),onMousedown:t[4]||(t[4]=b(()=>{},["stop"])),onClick:b(x=>I(r),["stop","prevent"])}," Editar ",40,Ne),d("button",{type:"button",class:"inline-flex items-center rounded-lg border border-red-200 bg-red-50 px-3 py-1.5 text-xs font-medium text-red-700 shadow-sm hover:bg-red-100 disabled:opacity-60 dark:border-red-700 dark:bg-red-900/20 dark:text-red-400 dark:hover:bg-red-900/30",disabled:p(r),onMousedown:t[5]||(t[5]=b(()=>{},["stop"])),onClick:b(x=>R(r),["stop","prevent"])}," Eliminar ",40,Ue),d("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:$.value.has(r.id),onClick:b(x=>ue(r,s),["stop","prevent"])},f($.value.has(r.id)?"Archivando…":"Archivar"),9,Ve)])):(u(),c("div",qe,[d("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:p(r),onMousedown:t[6]||(t[6]=b(()=>{},["stop"])),onClick:b(x=>I(r),["stop","prevent"])}," Editar ",40,Oe),d("button",{type:"button",class:"inline-flex items-center rounded-lg border border-red-200 bg-red-50 px-3 py-1.5 text-xs font-medium text-red-700 shadow-sm hover:bg-red-100 disabled:opacity-60 dark:border-red-700 dark:bg-red-900/20 dark:text-red-400 dark:hover:bg-red-900/30",disabled:p(r),onMousedown:t[7]||(t[7]=b(()=>{},["stop"])),onClick:b(x=>R(r),["stop","prevent"])}," Eliminar ",40,Ye)]))],42,Le)],8,Se)}),128)),k.value===s.id&&h.value>=(((n=s.incidences)==null?void 0:n.length)||0)?(u(),c("div",ze)):j("",!0)])],40,we)}),128))],2))]))}};export{Xe as default};
