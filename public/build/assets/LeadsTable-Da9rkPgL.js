import{a as W}from"./vendor-utils-Czy7fllw.js";import{S as O}from"./vendor-ui-DEm6YKEA.js";import{r as v,H as L,g as b,i as c,j as e,t as d,k as S,w as M,D as Z,y as ee,x as q,n as z,z as A,F as Y,m as J,G as H,e as U,o as te,B as G,u as P,q as ae}from"./vendor-vue-Db-AqoDh.js";const se={class:"mb-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between"},re={class:"flex-1"},oe=["value"],ne={class:"flex items-center gap-2"},le=["disabled"],de=["value"],ie={class:"mb-4 flex flex-wrap items-center gap-2"},ue={class:"flex items-center gap-2"},ce={key:0,class:"flex items-center gap-2"},ge={key:1,class:"flex items-center gap-2"},pe={key:2,class:"flex items-center gap-2"},me={key:3,class:"flex items-center gap-2"},be={key:4,class:"flex items-center gap-2"},xe={key:5,class:"flex items-center gap-2"},ye={class:"mb-4 overflow-x-auto"},fe={class:"inline-flex rounded-lg border border-gray-200 bg-white p-1 shadow-sm dark:border-slate-800 dark:bg-slate-900"},ve={class:"ml-2 rounded bg-black/5 px-2 py-0.5 text-xs font-semibold text-gray-700 dark:bg-white/10 dark:text-slate-200"},he=["onClick"],ke={class:"ml-2 rounded bg-black/5 px-2 py-0.5 text-xs font-semibold text-gray-700 dark:bg-white/10 dark:text-slate-200"},we={__name:"LeadsTableFilters",props:{modelValue:{type:String,required:!0},stages:{type:Array,required:!0},activeStageId:{type:[Number,null],default:null},totalCount:{type:Number,default:0},perPage:{type:Number,default:25},importing:{type:Boolean,default:!1}},emits:["update:modelValue","update:per-page","stage-filter","import-file","period-filter"],setup(a,{emit:h}){const g=h,n=v("last_week"),k=v(""),o=v(""),p=v(""),u=v(""),x=v(""),m=v(""),V=()=>{k.value="",o.value="",p.value="",u.value="",x.value="",m.value=""},C=s=>String(s).padStart(2,"0"),R=s=>{const t=s.getFullYear(),r=C(s.getMonth()+1),_=C(s.getDate());return`${t}-${r}-${_}`},F=s=>{if(!s||!/^\d{4}-\d{2}$/.test(s))return{from:null,to:null};const[t,r]=s.split("-"),_=Number(t),D=Number(r);if(Number.isNaN(_)||Number.isNaN(D)||D<1||D>12)return{from:null,to:null};const y=new Date(_,D,0).getDate();return{from:`${_}-${C(D)}-01`,to:`${_}-${C(D)}-${C(y)}`}},I=(s,t)=>s&&t&&s>t?{from:t,to:s}:{from:s,to:t},w=()=>{switch(n.value){case"last_week":{const s=new Date,t=new Date(s);return t.setDate(t.getDate()-6),{from:R(t),to:R(s)}}case"month":{const{from:s,to:t}=F(k.value);return{from:s??void 0,to:t??void 0}}case"between_months":{const s=F(o.value),t=F(p.value);return I(s.from??void 0,t.to??void 0)}case"date":return u.value?{from:u.value,to:u.value}:{from:void 0,to:void 0};case"between_dates":return I(x.value||void 0,m.value||void 0);default:return{from:void 0,to:void 0}}},T=()=>n.value==="all"||n.value==="last_week"?!0:n.value==="month"?!!k.value:n.value==="between_months"?!!o.value&&!!p.value:n.value==="date"?!!u.value:n.value==="between_dates"?!!x.value&&!!m.value:!1;L(n,(s,t)=>{if(s!==t&&V(),s==="all"||s==="last_week"){const r=w();g("period-filter",{date_from:r.from,date_to:r.to})}});const j=w();return g("period-filter",{date_from:j.from,date_to:j.to}),L([k,o,p,u,x,m],()=>{if(!T())return;const s=w();g("period-filter",{date_from:s.from,date_to:s.to})}),(s,t)=>(c(),b("section",null,[e("div",se,[e("div",re,[t[12]||(t[12]=e("label",{class:"sr-only",for:"leads-search"},"Buscar",-1)),e("input",{id:"leads-search",value:a.modelValue,type:"search",placeholder:"Buscar por nombre, empresa, contacto, email, teléfono, documento…",class:"w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900 placeholder:text-gray-400 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:placeholder:text-slate-500",onInput:t[0]||(t[0]=r=>s.$emit("update:modelValue",r.target.value))},null,40,oe)]),e("div",ne,[e("input",{ref:"importInput",type:"file",accept:".csv,text/csv",class:"hidden",onChange:t[1]||(t[1]=r=>s.$emit("import-file",r))},null,544),e("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:a.importing,onClick:t[2]||(t[2]=r=>s.$refs.importInput.click())},d(a.importing?"Importando…":"Importar CSV"),9,le),e("select",{value:a.perPage,class:"rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100",onChange:t[3]||(t[3]=r=>s.$emit("update:per-page",Number(r.target.value)))},[...t[13]||(t[13]=[e("option",{value:10},"10",-1),e("option",{value:15},"15",-1),e("option",{value:25},"25",-1),e("option",{value:50},"50",-1)])],40,de)])]),e("div",ie,[e("div",ue,[t[15]||(t[15]=e("label",{class:"text-xs text-gray-600 dark:text-slate-300"},"Periodo:",-1)),M(e("select",{"onUpdate:modelValue":t[4]||(t[4]=r=>n.value=r),class:"rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100"},[...t[14]||(t[14]=[ee('<option value="all">Todos</option><option value="last_week">Última semana</option><option value="month">Por mes</option><option value="between_months">Entre meses</option><option value="date">Por fecha</option><option value="between_dates">Entre fechas</option>',6)])],512),[[Z,n.value]])]),n.value==="month"?(c(),b("div",ce,[t[16]||(t[16]=e("label",{class:"text-xs text-gray-600 dark:text-slate-300"},"Mes:",-1)),M(e("input",{"onUpdate:modelValue":t[5]||(t[5]=r=>k.value=r),type:"month",class:"rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:scheme-dark"},null,512),[[q,k.value]])])):S("",!0),n.value==="between_months"?(c(),b("div",ge,[t[17]||(t[17]=e("label",{class:"text-xs text-gray-600 dark:text-slate-300"},"Desde mes:",-1)),M(e("input",{"onUpdate:modelValue":t[6]||(t[6]=r=>o.value=r),type:"month",class:"rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:scheme-dark"},null,512),[[q,o.value]])])):S("",!0),n.value==="between_months"?(c(),b("div",pe,[t[18]||(t[18]=e("label",{class:"text-xs text-gray-600 dark:text-slate-300"},"Hasta mes:",-1)),M(e("input",{"onUpdate:modelValue":t[7]||(t[7]=r=>p.value=r),type:"month",class:"rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:scheme-dark"},null,512),[[q,p.value]])])):S("",!0),n.value==="date"?(c(),b("div",me,[t[19]||(t[19]=e("label",{class:"text-xs text-gray-600 dark:text-slate-300"},"Fecha:",-1)),M(e("input",{"onUpdate:modelValue":t[8]||(t[8]=r=>u.value=r),type:"date",class:"rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:scheme-dark"},null,512),[[q,u.value]])])):S("",!0),n.value==="between_dates"?(c(),b("div",be,[t[20]||(t[20]=e("label",{class:"text-xs text-gray-600 dark:text-slate-300"},"Desde:",-1)),M(e("input",{"onUpdate:modelValue":t[9]||(t[9]=r=>x.value=r),type:"date",class:"rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:scheme-dark"},null,512),[[q,x.value]])])):S("",!0),n.value==="between_dates"?(c(),b("div",xe,[t[21]||(t[21]=e("label",{class:"text-xs text-gray-600 dark:text-slate-300"},"Hasta:",-1)),M(e("input",{"onUpdate:modelValue":t[10]||(t[10]=r=>m.value=r),type:"date",class:"rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:scheme-dark"},null,512),[[q,m.value]])])):S("",!0)]),e("div",ye,[e("div",fe,[e("button",{type:"button",class:z(["px-3 py-2 text-sm font-medium rounded-md transition",a.activeStageId===null?"bg-blue-600 text-white":"text-gray-700 hover:bg-gray-50 dark:text-slate-200 dark:hover:bg-slate-800"]),onClick:t[11]||(t[11]=r=>s.$emit("stage-filter",null))},[t[22]||(t[22]=A(" Todos ",-1)),e("span",ve,d(a.totalCount),1)],2),(c(!0),b(Y,null,J(a.stages,r=>(c(),b("button",{key:r.id,type:"button",class:z(["px-3 py-2 text-sm font-medium rounded-md transition",a.activeStageId===r.id?"bg-blue-600 text-white":"text-gray-700 hover:bg-gray-50 dark:text-slate-200 dark:hover:bg-slate-800"]),onClick:_=>s.$emit("stage-filter",r.id)},[A(d(r.name)+" ",1),e("span",ke,d(r.count??0),1)],10,he))),128))])])]))}},$e={class:"border-b border-gray-100 bg-white hover:bg-blue-50/40 transition-colors dark:border-slate-800 dark:bg-slate-900 dark:hover:bg-slate-800/60"},_e={class:"px-4 py-3 font-medium text-gray-900 dark:text-slate-100"},De={class:"px-4 py-3"},Pe={class:"flex flex-col gap-1"},Se={class:"px-4 py-3 text-right"},Ce={class:"px-4 py-3"},Te={class:"px-4 py-3"},Ve={class:"px-4 py-3"},Ie={class:"px-4 py-3"},Ne={class:"px-4 py-3"},Fe={class:"px-4 py-3"},Ee={class:"px-4 py-3"},Me={class:"px-4 py-3"},Ue={class:"px-4 py-3"},Re={class:"px-4 py-3"},je={class:"px-4 py-3"},qe={class:"px-4 py-3"},Be={class:"px-4 py-3"},Le={__name:"LeadsTableRow",props:{lead:{type:Object,required:!0}},setup(a){const h=a,g=(o,p="EUR")=>o?new Intl.NumberFormat("es-ES",{style:"currency",currency:p||"EUR"}).format(o):"",n=o=>o?new Date(o).toLocaleString("es-ES"):"",k=()=>{const o=h.lead||{},p=o.name?`Seguimiento lead: ${o.name}`:"Seguimiento lead",u=[o.company_name?`Empresa: ${o.company_name}`:null,o.contact_name?`Contacto: ${o.contact_name}`:null,o.contact_phone?`Teléfono: ${o.contact_phone}`:null,o.contact_email?`Email: ${o.contact_email}`:null,o.observacion?`Observación: ${o.observacion}`:null].filter(Boolean),x=new URLSearchParams({related_type:"lead",related_id:String(o.id??""),title:p});u.length>0&&x.set("description",u.join(" | ")),window.location.assign(`/calendar?${x.toString()}`)};return(o,p)=>(c(),b("tr",$e,[e("td",_e,d(a.lead.id),1),e("td",De,[e("div",Pe,[e("span",null,d(a.lead.name??""),1),e("button",{type:"button",class:"inline-flex w-fit items-center rounded-lg border border-blue-200 bg-blue-50 px-2 py-1 text-xs font-medium text-blue-700 hover:bg-blue-100 dark:border-blue-800 dark:bg-blue-950 dark:text-blue-300 dark:hover:bg-blue-900",onClick:k}," Agendar ")])]),e("td",Se,d(g(a.lead.amount,a.lead.currency)),1),e("td",Ce,d(a.lead.currency??""),1),e("td",Te,d(a.lead.contact_name??""),1),e("td",Ve,d(a.lead.contact_phone??""),1),e("td",Ie,d(a.lead.contact_email??""),1),e("td",Ne,d(a.lead.company_name??""),1),e("td",Fe,d(a.lead.company_address??""),1),e("td",Ee,d(a.lead.document_type??""),1),e("td",Me,d(a.lead.document_number??""),1),e("td",Ue,d(a.lead.customer_id??""),1),e("td",Re,d(a.lead.created_by??""),1),e("td",je,d(n(a.lead.won_at)),1),e("td",qe,d(n(a.lead.created_at)),1),e("td",Be,d(n(a.lead.updated_at)),1)]))}},Oe={class:"p-4 flex items-center justify-between gap-3"},ze=["disabled"],Ae={class:"text-xs text-gray-600 dark:text-slate-300"},He=["disabled"],Ge={__name:"LeadsTablePagination",props:{pagination:{type:Object,required:!0,default:()=>({current_page:1,last_page:1})},loading:{type:Boolean,default:!1}},emits:["page-change"],setup(a){return(h,g)=>(c(),b("div",Oe,[e("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:a.loading||a.pagination.current_page<=1,onClick:g[0]||(g[0]=n=>h.$emit("page-change",a.pagination.current_page-1))}," Anterior ",8,ze),e("div",Ae," Página "+d(a.pagination.current_page)+" / "+d(a.pagination.last_page),1),e("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:a.loading||a.pagination.current_page>=a.pagination.last_page,onClick:g[1]||(g[1]=n=>h.$emit("page-change",a.pagination.current_page+1))}," Siguiente ",8,He)]))}};function We(a={}){const{endpoint:h,defaultPerPage:g=25,defaultFilters:n={},searchDebounce:k=300}=a,o=v(!1),p=v(null),u=v([]),x=v([]),m=H({current_page:1,last_page:1,per_page:g,total:0,from:null,to:null}),V=H({q:"",page:1,per_page:g,...n}),C=U(()=>u.value.length>0),R=U(()=>!o.value&&u.value.length===0),F=U(()=>m.total||0),I=U(()=>{if(!m.total)return"";const l=m.from||0,$=m.to||0,E=m.total||0;return`${l}-${$} de ${E}`}),w=async(l={})=>{var $,E,N;if(!h){console.error("useTableData: endpoint is required");return}o.value=!0,p.value=null;try{const B={...V,...l},f=await W.get(h,{params:B}),i=(($=f.data)==null?void 0:$.data)||f.data;u.value=(i==null?void 0:i.items)||(i==null?void 0:i.leads)||[],i!=null&&i.stages&&(x.value=i.stages),i!=null&&i.pagination&&Object.assign(m,i.pagination)}catch(B){p.value=((N=(E=B.response)==null?void 0:E.data)==null?void 0:N.message)||"Error al cargar los datos",console.error("useTableData fetch error:",B)}finally{o.value=!1}},T=async(l={})=>{Object.assign(V,l),await w()},j=async l=>{await T({page:l})},s=async l=>{await T({per_page:l,page:1})},t=async l=>{await T({q:l,page:1})},r=async()=>{await w()},_=async()=>{Object.assign(V,{q:"",page:1,per_page:g,...n}),await w()};let D;return{loading:o,error:p,items:u,stagesData:x,pagination:m,filters:V,hasData:C,isEmpty:R,totalCount:F,paginationInfo:I,fetchData:w,applyFilters:T,changePage:j,changePerPage:s,search:t,debouncedSearch:l=>{clearTimeout(D),D=setTimeout(()=>{t(l)},k)},refresh:r,reset:_}}const Ye={key:0,class:"mb-4 rounded-lg border border-red-200 bg-red-50 p-3 text-sm text-red-700 dark:border-red-900/40 dark:bg-red-950/30 dark:text-red-200"},Je={class:"bg-white border border-gray-200 rounded-lg shadow-sm dark:bg-slate-900 dark:border-slate-800"},Ke={class:"p-4 border-b border-gray-200 dark:border-slate-800 flex items-center justify-between"},Qe={class:"mt-1 text-xs text-gray-600 dark:text-slate-300"},Xe={key:0},Ze={key:0,class:"text-xs text-gray-600 dark:text-slate-300"},et={class:"overflow-x-auto"},tt={class:"min-w-[1400px] w-full text-sm text-left text-gray-700 dark:text-slate-200"},at={key:0},nt={__name:"LeadsTable",setup(a){const{loading:h,error:g,items:n,stagesData:k,pagination:o,isEmpty:p,paginationInfo:u,fetchData:x,applyFilters:m,changePage:V,changePerPage:C,debouncedSearch:R}=We({endpoint:"/leads/data",defaultPerPage:25}),F=U(()=>k.value||[]),I=v(!1),w=v(""),T=v(null),j=U(()=>o.per_page),s=U(()=>o.total||0);L(w,y=>{R(y)});const t=y=>{C(y)},r=y=>{T.value=y,m({stage_id:y,page:1})},_=({date_from:y,date_to:l}={})=>{m({date_from:y||void 0,date_to:l||void 0,page:1})},D=async y=>{var $,E;const l=y.target.files[0];if(l){I.value=!0;try{const N=new FormData;N.append("file",l);const f=(await W.post("/leads/import/prospectos",N,{headers:{"Content-Type":"multipart/form-data"}})).data,i=(f==null?void 0:f.data)??{},K=(f==null?void 0:f.processed)??(i.created||0)+(i.updated||0)+(i.skipped||0)+(i.invalid||0),Q=(f==null?void 0:f.imported)??(i.created||0)+(i.updated||0),X=(f==null?void 0:f.errors)??(i.invalid||0);O.fire({title:"¡Importación completada!",html:`
        <div class="text-left">
          <p><strong>Procesados:</strong> ${K}</p>
          <p><strong>Importados:</strong> ${Q}</p>
          <p><strong>Errores:</strong> ${X}</p>
        </div>
      `,icon:"success"}),await x()}catch(N){console.error(N),O.fire({title:"Error en la importación",text:((E=($=N.response)==null?void 0:$.data)==null?void 0:E.message)||"Error desconocido",icon:"error"})}finally{I.value=!1,y.target.value=""}}};return te(async()=>{await x()}),(y,l)=>(c(),b("section",null,[G(we,{modelValue:w.value,"onUpdate:modelValue":l[0]||(l[0]=$=>w.value=$),stages:F.value,"active-stage-id":T.value,"total-count":s.value,"per-page":j.value,importing:I.value,"onUpdate:perPage":t,onStageFilter:r,onImportFile:D,onPeriodFilter:_},null,8,["modelValue","stages","active-stage-id","total-count","per-page","importing"]),P(g)?(c(),b("div",Ye,d(P(g)),1)):S("",!0),e("div",Je,[e("div",Ke,[e("div",null,[l[1]||(l[1]=e("div",{class:"text-sm font-semibold text-gray-900 dark:text-slate-100"},"Leads",-1)),e("div",Qe,[P(u)?(c(),b("span",Xe,d(P(u)),1)):S("",!0)])]),P(h)?(c(),b("div",Ze,"Cargando…")):S("",!0)]),e("div",et,[e("table",tt,[l[3]||(l[3]=e("thead",{class:"text-xs uppercase bg-gray-50 text-gray-700 dark:bg-slate-800 dark:text-slate-200"},[e("tr",null,[e("th",{class:"px-4 py-3"},"ID"),e("th",{class:"px-4 py-3"},"Nombre"),e("th",{class:"px-4 py-3 text-right"},"Monto"),e("th",{class:"px-4 py-3"},"Moneda"),e("th",{class:"px-4 py-3"},"Contacto"),e("th",{class:"px-4 py-3"},"Teléfono"),e("th",{class:"px-4 py-3"},"Email"),e("th",{class:"px-4 py-3"},"Empresa"),e("th",{class:"px-4 py-3"},"Dirección"),e("th",{class:"px-4 py-3"},"Doc. tipo"),e("th",{class:"px-4 py-3"},"Doc. nro"),e("th",{class:"px-4 py-3"},"Customer ID"),e("th",{class:"px-4 py-3"},"Creado por"),e("th",{class:"px-4 py-3"},"Won at"),e("th",{class:"px-4 py-3"},"Creado"),e("th",{class:"px-4 py-3"},"Actualizado")])],-1)),e("tbody",null,[(c(!0),b(Y,null,J(P(n),$=>(c(),ae(Le,{key:$.id,lead:$},null,8,["lead"]))),128)),P(p)?(c(),b("tr",at,[...l[2]||(l[2]=[e("td",{colspan:"16",class:"px-4 py-10 text-center text-sm text-gray-600 dark:text-slate-300"}," Sin leads. ",-1)])])):S("",!0)])])]),G(Ge,{pagination:P(o),loading:P(h),onPageChange:P(V)},null,8,["pagination","loading","onPageChange"])])]))}};export{nt as default};
