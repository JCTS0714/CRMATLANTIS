import{r as u,e as me,o as xe,f as be,g as v,i as m,j as d,w as j,D as K,x as Q,t as y,n as q,F as W,m as X,l as p,k as F}from"./vendor-vue-Db-AqoDh.js";import{a as A}from"./vendor-utils-Czy7fllw.js";import{a as N,t as O,c as Z}from"./App-CrNTFfYP.js";import"./app-O9ncPqV2.js";import"./vendor-ui-DEm6YKEA.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const pe={class:"mb-4 flex items-center gap-3"},fe={class:"flex items-center gap-2"},ye={class:"flex items-center gap-2"},ke={class:"flex items-center gap-2"},he={class:"flex items-center gap-2"},we={key:0,class:"text-sm text-gray-600 dark:text-slate-300"},_e={key:1,class:"mb-3 text-sm text-red-600"},Ce=["data-stage-id","onDrop"],Ie={class:"p-4 border-b border-gray-200 dark:border-slate-800"},Ee={class:"flex items-center justify-between gap-3"},Ae={class:"text-sm font-semibold text-gray-900 dark:text-slate-100"},De={class:"text-xs text-gray-600 dark:text-slate-300"},Se={class:"p-3 space-y-3 min-h-[140px]"},Me={key:0,class:"text-sm text-gray-500 dark:text-slate-400 px-1"},Le=["data-incidence-id"],$e={key:0,class:"h-1 bg-blue-500 rounded-full mx-3 mb-2 animate-pulse transition-all duration-300"},Be=["data-incidence-id","draggable","onDragstart","onClick"],Te=["onClick"],je={class:"text-sm font-semibold text-gray-900 dark:text-slate-100"},Fe={key:0,class:"text-xs text-gray-600 dark:text-slate-300 mt-1"},Ne={key:1,class:"text-xs text-gray-500 dark:text-slate-400 mt-1"},Pe=["onClick"],Ue={key:1,class:"mt-3 flex justify-end gap-2"},Ve=["disabled","onClick"],qe=["disabled","onClick"],Oe=["disabled","onClick"],Ye={key:2,class:"mt-3 flex justify-end gap-2"},ze=["disabled","onClick"],He=["disabled","onClick"],Re={key:1,class:"h-1 bg-blue-500 rounded-full mx-3 mt-2 animate-pulse transition-all duration-300"},et={__name:"BacklogBoard",setup(Ge){const P=u(!0),x=u([]),k=u(""),D=u(50),S=u(""),M=u(""),L=u(""),b=u(null),ee=u(null),$=u(null),h=u(null),w=u(null),U=u(null),V=u(!1),C=u(!1),_=u(null),B=u(new Set),te=me(()=>{const e=x.value.length||1;return e<=1?"grid-cols-1":e===2?"grid-cols-1 md:grid-cols-2":e===3?"grid-cols-1 md:grid-cols-3":"grid-cols-1 md:grid-cols-2 xl:grid-cols-4"}),ae=e=>{if(!e)return"";try{const t=new Date(String(e));return Number.isNaN(t.getTime())?String(e):t.toLocaleDateString()}catch{return String(e)}},re=e=>{switch(e==null?void 0:e.toLowerCase()){case"alta":return"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200 px-2 py-0.5 rounded font-medium";case"media":return"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200 px-2 py-0.5 rounded font-medium";case"baja":return"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 px-2 py-0.5 rounded font-medium";default:return"text-gray-700 dark:text-slate-200"}},I=async({showLoading:e=!0}={})=>{var t,s;e&&(P.value=!0);try{const a=await A.get("/backlog/board-data",{params:{limit:D.value,date_from:S.value||null,date_to:M.value||null,priority:L.value||null}});x.value=((s=(t=a==null?void 0:a.data)==null?void 0:t.data)==null?void 0:s.stages)??[]}finally{e&&(P.value=!1)}},se=()=>{I()},ne=()=>{S.value="",M.value="",L.value="",D.value=50,I()},f=e=>!!(e!=null&&e.archived_at),E=e=>{e!=null&&e.id&&window.dispatchEvent(new CustomEvent("incidencias:edit",{detail:{incidence:e}}))},Y=e=>{var s,a,n;const t=(s=e==null?void 0:e.detail)==null?void 0:s.incidence;if(t!=null&&t.id)for(const r of x.value){const i=((n=(a=r==null?void 0:r.incidences)==null?void 0:a.findIndex)==null?void 0:n.call(a,l=>l.id===t.id))??-1;if(i!==-1){r.incidences.splice(i,1,{...r.incidences[i],...t});break}}},de=(e,t,s)=>{if(f(e))return;b.value=e,$.value=(e==null?void 0:e.stage_id)??null,U.value=e.id,V.value=!1;const a=x.value.find(n=>n.id===((e==null?void 0:e.stage_id)??null));if(a&&Array.isArray(a.incidences)){const n=a.incidences.findIndex(r=>r.id===e.id);_.value={stageId:a.id,index:n}}else _.value=null;C.value=!1},ie=(e=!1)=>{var s;if(!C.value)return;const t=((s=b.value)==null?void 0:s.id)??null;if(t!=null){for(const a of x.value){if(!Array.isArray(a.incidences))continue;const n=a.incidences.findIndex(r=>r.id===t);n!==-1&&a.incidences.splice(n,1)}if(e&&_.value){const a=x.value.find(n=>n.id===_.value.stageId);if(a){Array.isArray(a.incidences)||(a.incidences=[]);const n=Math.max(0,Math.min(_.value.index??a.incidences.length,a.incidences.length));a.incidences.splice(n,0,b.value)}}C.value=!1,h.value=null,w.value=null}},oe=()=>{!V.value&&C.value&&ie(!0),b.value=null,$.value=null,U.value=null,C.value=!1,V.value=!1,h.value=null,w.value=null,_.value=null},le=async(e,t)=>{var n,r,i;if(t.preventDefault(),!b.value||!e)return;const s=b.value,a=$.value;if(f(s)){k.value="Esta incidencia está bloqueada y no se puede mover.";return}k.value="";try{const l=t.clientY,c=H(e,l,s.id);if(a===e.id)await R(e.id,s.id,c),N("Incidencia reordenada");else{const o=await A.patch(`/incidencias/${s.id}/move-stage`,{stage_id:e.id});z(a,s.id);const g=((n=o==null?void 0:o.data)==null?void 0:n.data)??s;g.stage_id=e.id,ce(e.id,g,c),await R(e.id,s.id,c),N("Incidencia movida correctamente")}}catch(l){console.error("Error in onDropOnStage:",l);const c=((i=(r=l==null?void 0:l.response)==null?void 0:r.data)==null?void 0:i.message)??"No se pudo mover la incidencia.";k.value=c,O(c),await I({showLoading:!1})}finally{b.value=null,$.value=null,U.value=null,h.value=null,w.value=null}},z=(e,t)=>{const s=x.value.find(n=>n.id===e);if(!(s!=null&&s.incidences))return null;const a=s.incidences.findIndex(n=>n.id===t);if(a!==-1){const n=s.incidences.splice(a,1)[0];return s.count=s.incidences.length,n}return null},ce=(e,t,s=0)=>{const a=x.value.find(i=>i.id===e);if(!a)return;Array.isArray(a.incidences)||(a.incidences=[]);const n=a.incidences.findIndex(i=>i.id===t.id);n!==-1&&a.incidences.splice(n,1);const r=Math.min(Math.max(0,s),a.incidences.length);a.incidences.splice(r,0,t),a.count=a.incidences.length},ue=e=>{if(!b.value)return;e.preventDefault();const t=e.currentTarget.closest("section[data-stage-id]");if(!t)return;const s=parseInt(t.getAttribute("data-stage-id")),a=x.value.find(r=>r.id===s);if(!a)return;h.value=s;const n=e.clientY;w.value=H(a,n,b.value.id)},H=(e,t,s=null)=>{const a=document.querySelector(`[data-stage-id="${e.id}"] .p-3`);if(!a)return 0;const n=a.querySelectorAll("article[data-incidence-id]"),r=Array.from(n).filter(i=>{const l=parseInt(i.getAttribute("data-incidence-id"));return s?l!==s:!0});for(let i=0;i<r.length;i++){const l=r[i].getBoundingClientRect();if(t<l.top+l.height/2)return i}return r.length},R=async(e,t,s)=>{const a=x.value.find(c=>c.id===e);if(!a||!Array.isArray(a.incidences))return;const n=a.incidences.findIndex(c=>c.id===t);if(n===-1||n===s)return;const[r]=a.incidences.splice(n,1),i=Math.min(Math.max(0,s),a.incidences.length);a.incidences.splice(i,0,r),a.count=a.incidences.length;const l=a.incidences.map(c=>c.id);await A.patch("/incidencias/reorder",{stage_id:e,ordered_ids:l})},G=async e=>{var t,s,a,n,r,i,l,c;if(e!=null&&e.id)try{if(!(await Z({title:"¿Seguro que quieres eliminar la incidencia?",text:"Esta acción no se puede deshacer.",icon:"warning",confirmButtonText:"Eliminar",cancelButtonText:"Cancelar"})).isConfirmed)return;await A.delete(`/incidencias/${e.id}`);for(const g of x.value){const J=((s=(t=g==null?void 0:g.incidences)==null?void 0:t.findIndex)==null?void 0:s.call(t,ve=>ve.id===e.id))??-1;if(J!==-1){g.incidences.splice(J,1),g.count=Math.max(0,(g.count??0)-1);break}}N("Incidencia eliminada correctamente")}catch(o){console.error("Error eliminando incidencia:",o);let g="Error al eliminar la incidencia";((a=o.response)==null?void 0:a.status)===403?g="No tienes permisos para eliminar incidencias":((n=o.response)==null?void 0:n.status)===404?g="La incidencia no fue encontrada":((r=o.response)==null?void 0:r.status)===422?g=((i=o.response.data)==null?void 0:i.message)||"Datos inválidos":(c=(l=o.response)==null?void 0:l.data)!=null&&c.message?g=o.response.data.message:o.message&&(g=o.message),O(g)}},ge=async(e,t)=>{var a,n;if(!(!(e!=null&&e.id)||!(t!=null&&t.is_done)||!await Z({title:"Archivar incidencia",text:"Se ocultará del backlog, pero seguirá visible en la tabla (historial).",confirmText:"Archivar",cancelText:"Cancelar",icon:"warning"}))){B.value.add(e.id),k.value="";try{await A.patch(`/incidencias/${e.id}/archive`),z(t.id,e.id),N("Incidencia archivada"),window.dispatchEvent(new CustomEvent("incidencias:archived"))}catch(r){const i=((n=(a=r==null?void 0:r.response)==null?void 0:a.data)==null?void 0:n.message)??"No se pudo archivar la incidencia.";k.value=i,O(i)}finally{B.value.delete(e.id)}}},T=()=>I({showLoading:!1});return xe(async()=>{window.addEventListener("incidencias:created",T),window.addEventListener("incidencias:archived",T),window.addEventListener("incidencias:updated",Y),await I()}),be(()=>{window.removeEventListener("incidencias:created",T),window.removeEventListener("incidencias:archived",T),window.removeEventListener("incidencias:updated",Y),b.value=null,ee.value=null}),(e,t)=>(m(),v("div",null,[t[14]||(t[14]=d("div",{class:"mb-4 text-sm text-gray-600 dark:text-slate-300"}," Arrastra una incidencia entre columnas para cambiar su estado, o dentro de una columna para reordenar. ",-1)),d("div",pe,[d("div",fe,[t[9]||(t[9]=d("label",{class:"text-xs text-gray-600 dark:text-slate-300"},"Limite:",-1)),j(d("select",{"onUpdate:modelValue":t[0]||(t[0]=s=>D.value=s),class:"rounded-lg border border-gray-200 bg-white px-2 py-1 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:focus:ring-blue-900/30"},[...t[8]||(t[8]=[d("option",{value:20},"20",-1),d("option",{value:50},"50",-1),d("option",{value:100},"100",-1),d("option",{value:250},"250",-1)])],512),[[K,D.value,void 0,{number:!0}]])]),d("div",ye,[t[10]||(t[10]=d("label",{class:"text-xs text-gray-600 dark:text-slate-300"},"Desde:",-1)),j(d("input",{"onUpdate:modelValue":t[1]||(t[1]=s=>S.value=s),type:"date",class:"rounded-lg border border-gray-200 bg-white px-2 py-1 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 placeholder:text-gray-400 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:placeholder:text-slate-500 dark:focus:ring-blue-900/30 dark:[color-scheme:dark]"},null,512),[[Q,S.value]])]),d("div",ke,[t[11]||(t[11]=d("label",{class:"text-xs text-gray-600 dark:text-slate-300"},"Hasta:",-1)),j(d("input",{"onUpdate:modelValue":t[2]||(t[2]=s=>M.value=s),type:"date",class:"rounded-lg border border-gray-200 bg-white px-2 py-1 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 placeholder:text-gray-400 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:placeholder:text-slate-500 dark:focus:ring-blue-900/30 dark:[color-scheme:dark]"},null,512),[[Q,M.value]])]),d("div",he,[t[13]||(t[13]=d("label",{class:"text-xs text-gray-600 dark:text-slate-300"},"Prioridad:",-1)),j(d("select",{"onUpdate:modelValue":t[3]||(t[3]=s=>L.value=s),class:"rounded-lg border border-gray-200 bg-white px-2 py-1 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:focus:ring-blue-900/30"},[...t[12]||(t[12]=[d("option",{value:""},"Todas",-1),d("option",{value:"alta"},"Alta",-1),d("option",{value:"media"},"Media",-1),d("option",{value:"baja"},"Baja",-1)])],512),[[K,L.value]])]),d("div",{class:"flex items-center gap-2 ms-auto"},[d("button",{onClick:se,class:"inline-flex items-center rounded-lg bg-blue-600 px-3 py-1 text-sm text-white hover:bg-blue-700"}," Aplicar "),d("button",{onClick:ne,class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1 text-sm text-gray-700 shadow-sm hover:bg-gray-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800"}," Limpiar ")])]),P.value?(m(),v("div",we,"Cargando...")):k.value?(m(),v("div",_e,y(k.value),1)):(m(),v("div",{key:2,class:q(["grid gap-4",te.value])},[(m(!0),v(W,null,X(x.value,s=>{var a,n;return m(),v("section",{key:s.id,"data-stage-id":s.id,class:"bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden dark:bg-slate-900 dark:border-slate-800",onDragover:p(ue,["prevent"]),onDrop:p(r=>le(s,r),["prevent"])},[d("div",Ie,[d("div",Ee,[d("div",Ae,y(s.name),1),d("div",De,y(s.count),1)])]),d("div",Se,[(((a=s.incidences)==null?void 0:a.length)??0)===0?(m(),v("div",Me," Sin incidencias. ")):F("",!0),(m(!0),v(W,null,X(s.incidences,(r,i)=>{var l,c;return m(),v("div",{key:r.id,"data-incidence-id":r.id},[h.value===s.id&&w.value===i&&((l=b.value)==null?void 0:l.id)!==r.id?(m(),v("div",$e)):F("",!0),d("article",{"data-incidence-id":r.id,class:q(["select-none bg-gray-50 border border-gray-200 rounded-lg p-3 mb-3 dark:bg-slate-800 dark:border-slate-700 transition-all duration-200",{"opacity-60 scale-95 shadow-lg":((c=b.value)==null?void 0:c.id)===r.id,"cursor-not-allowed opacity-80":f(r),"cursor-grab hover:bg-blue-50/30 dark:hover:bg-slate-800/50 hover:shadow-md":!f(r)}]),draggable:!f(r),onDragstart:o=>de(r),onDragend:oe,onClick:o=>E(r)},[d("div",{class:"flex items-start justify-between gap-3 cursor-pointer",onClick:o=>E(r)},[d("div",null,[d("div",je,y(r.title),1),r.customer?(m(),v("div",Fe,y(r.customer.company_name||r.customer.name),1)):(m(),v("div",Ne,"Sin cliente"))]),d("div",{class:q(["text-xs",re(r.priority)])},y(r.priority||"Normal"),3)],8,Te),r.date?(m(),v("div",{key:0,class:"mt-2 text-xs text-gray-600 dark:text-slate-300 cursor-pointer",onClick:o=>E(r)},y(ae(r.date)),9,Pe)):F("",!0),s.is_done?(m(),v("div",Ue,[d("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:f(r),onMousedown:t[4]||(t[4]=p(()=>{},["stop"])),onClick:p(o=>E(r),["stop","prevent"])}," Editar ",40,Ve),d("button",{type:"button",class:"inline-flex items-center rounded-lg border border-red-200 bg-red-50 px-3 py-1.5 text-xs font-medium text-red-700 shadow-sm hover:bg-red-100 disabled:opacity-60 dark:border-red-700 dark:bg-red-900/20 dark:text-red-400 dark:hover:bg-red-900/30",disabled:f(r),onMousedown:t[5]||(t[5]=p(()=>{},["stop"])),onClick:p(o=>G(r),["stop","prevent"])}," Eliminar ",40,qe),d("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:B.value.has(r.id),onClick:p(o=>ge(r,s),["stop","prevent"])},y(B.value.has(r.id)?"Archivando…":"Archivar"),9,Oe)])):(m(),v("div",Ye,[d("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:f(r),onMousedown:t[6]||(t[6]=p(()=>{},["stop"])),onClick:p(o=>E(r),["stop","prevent"])}," Editar ",40,ze),d("button",{type:"button",class:"inline-flex items-center rounded-lg border border-red-200 bg-red-50 px-3 py-1.5 text-xs font-medium text-red-700 shadow-sm hover:bg-red-100 disabled:opacity-60 dark:border-red-700 dark:bg-red-900/20 dark:text-red-400 dark:hover:bg-red-900/30",disabled:f(r),onMousedown:t[7]||(t[7]=p(()=>{},["stop"])),onClick:p(o=>G(r),["stop","prevent"])}," Eliminar ",40,He)]))],42,Be)],8,Le)}),128)),h.value===s.id&&w.value>=(((n=s.incidences)==null?void 0:n.length)||0)?(m(),v("div",Re)):F("",!0)])],40,Ce)}),128))],2))]))}};export{et as default};
