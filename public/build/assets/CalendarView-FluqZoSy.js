const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/vendor-ui-DEm6YKEA.js","assets/vendor-vue-Db-AqoDh.js"])))=>i.map(i=>d[i]);
import{_ as se}from"./app-CEWwc3KD.js";import{a as _}from"./vendor-utils-Czy7fllw.js";import{i as re,a as le,b as ie,F as oe}from"./vendor-ui-DEm6YKEA.js";import{a as T,t as N,c as de}from"./App-Btt0t-0g.js";import"./notifications-Dl6xZJx9.js";import"./calendar-notifications-CrOVVuzr.js";import{e as Z,r as W,o as ce,I as ue,f as me,g as pe,i as ve,j as $,B as ge,t as fe,u as ye}from"./vendor-vue-Db-AqoDh.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const we={class:"p-4"},be={class:"mb-4 flex items-center justify-between"},_e=["disabled"],xe={class:"rounded-lg border border-gray-200 bg-white p-2 shadow-sm dark:border-slate-800 dark:bg-slate-900"},he={class:"px-3 py-2 text-center text-base font-semibold text-gray-800 dark:text-slate-100"},Ie={__name:"CalendarView",setup(ke){const V=window.__AUTH_USER__??null,ee=Z(()=>{const e=(V==null?void 0:V.permissions)??[];return Array.isArray(e)&&e.includes("calendar.delete")}),p=W(!1),D=W(null),G=W(""),A=()=>{var e,t;try{(t=(e=D.value)==null?void 0:e.getApi)==null||t.call(e).refetchEvents()}catch{}},q=e=>{var s,n,r;const t=(n=(s=D.value)==null?void 0:s.getApi)==null?void 0:n.call(s);if(!t)return;const a=(r=t.view)==null?void 0:r.type;if(a==="dayGridMonth"){t.incrementDate({months:e});return}if(a==="timeGridWeek"){t.incrementDate({weeks:e});return}t.incrementDate({days:e})},z=(e=null)=>{var r,o;const t=(o=(r=D.value)==null?void 0:r.getApi)==null?void 0:o.call(r),a=e??(t==null?void 0:t.view),s=a==null?void 0:a.currentStart;if(!s)return;const n=new Date(s);n.setDate(n.getDate()+15),G.value=new Intl.DateTimeFormat("es-PE",{year:"numeric",month:"long"}).format(n)},k=e=>{if(!e)return"";const t=new Date(e);if(Number.isNaN(t.getTime()))return"";const a=s=>String(s).padStart(2,"0");return`${t.getFullYear()}-${a(t.getMonth()+1)}-${a(t.getDate())}T${a(t.getHours())}:${a(t.getMinutes())}`},M=async({title:e="",start_at:t="",end_at:a="",all_day:s=!1,reminder_minutes:n="",related_type:r="",related_id:o="",description:i="",location:d="",allowDelete:c=!1}={})=>{const v=y=>String(y??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),w="mt-1 w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-950 dark:text-slate-100",H=`
    <div class="grid gap-3 text-left">
      <div>
        <label class="block text-xs font-medium text-gray-600 dark:text-slate-300">Título</label>
        <input id="sw-ev-title" class="${w}" value="${v(e)}" />
      </div>

      <div class="grid grid-cols-1 gap-3 sm:grid-cols-2">
        <div>
          <label class="block text-xs font-medium text-gray-600 dark:text-slate-300">Inicio</label>
          <input id="sw-ev-start" type="datetime-local" class="${w}" value="${v(t)}" />
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-600 dark:text-slate-300">Fin</label>
          <input id="sw-ev-end" type="datetime-local" class="${w}" value="${v(a)}" />
        </div>
      </div>

      <div class="grid grid-cols-1 gap-3 sm:grid-cols-2">
        <div>
          <label class="block text-xs font-medium text-gray-600 dark:text-slate-300">Recordatorio (minutos antes)</label>
          <input id="sw-ev-reminder" type="number" min="1" max="10080" class="${w}" value="${v(n)}" placeholder="(opcional)" />
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-600 dark:text-slate-300">Ubicación</label>
          <input id="sw-ev-location" class="${w}" value="${v(d)}" placeholder="(opcional)" />
        </div>
      </div>

      <div>
        <label class="block text-xs font-medium text-gray-600 dark:text-slate-300">Descripción</label>
        <textarea id="sw-ev-description" rows="3" class="${w}" placeholder="(opcional)">${v(i)}</textarea>
      </div>

      <div class="grid grid-cols-1 gap-3 sm:grid-cols-2">
        <div>
          <label class="block text-xs font-medium text-gray-600 dark:text-slate-300">Relacionado a</label>
          <select id="sw-ev-related_type" class="${w}">
            <option value="" ${r?"":"selected"}>(ninguno)</option>
            <option value="lead" ${r==="lead"?"selected":""}>Lead</option>
            <option value="customer" ${r==="customer"?"selected":""}>Cliente</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-600 dark:text-slate-300">Relacionado</label>
          <input id="sw-ev-related_search" class="${w}" placeholder="Escribe para buscar…" autocomplete="off" />
          <input id="sw-ev-related_id" type="hidden" value="${v(o)}" />
          <div id="sw-ev-related_results" class="mt-2 max-h-44 overflow-auto rounded-lg border border-gray-200 bg-white p-1 text-left shadow-sm dark:border-slate-800 dark:bg-slate-950" style="display:none;"></div>
          <div id="sw-ev-related_hint" class="mt-1 text-xs text-gray-500 dark:text-slate-400">Selecciona un resultado para llenar el vínculo (opcional).</div>
        </div>
      </div>
    </div>
  `,{default:f}=await se(async()=>{const{default:y}=await import("./vendor-ui-DEm6YKEA.js").then(m=>m.s);return{default:y}},__vite__mapDeps([0,1])),S=await f.fire({title:"Evento",html:H,focusConfirm:!1,showCancelButton:!0,showDenyButton:!!c,confirmButtonText:"Guardar",cancelButtonText:"Cancelar",denyButtonText:"Eliminar",buttonsStyling:!1,didOpen:async()=>{const y=document.getElementById("sw-ev-related_type"),m=document.getElementById("sw-ev-related_search"),x=document.getElementById("sw-ev-related_id"),b=document.getElementById("sw-ev-related_results");if(!y||!m||!x||!b)return;let I=null;const E=()=>{b.innerHTML="",b.style.display="none"},P=l=>{x.value=l!=null&&l.id?String(l.id):"",m.value=l!=null&&l.label?String(l.label):"",E()},B=()=>{const l=y.value||"",u=!!l;m.disabled=!u,m.placeholder=u?`Buscar ${l==="lead"?"lead":"cliente"}…`:"Selecciona tipo primero",u||P(null)},L=l=>{if(b.innerHTML="",!(l!=null&&l.length)){E();return}b.style.display="block";for(const u of l){const g=document.createElement("button");g.type="button",g.className="flex w-full items-center justify-between rounded-md px-2 py-1.5 text-left text-sm text-gray-800 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-200 dark:text-slate-100 dark:hover:bg-slate-900 dark:focus:ring-blue-500/30",g.textContent=u.label,g.addEventListener("click",()=>P(u)),b.appendChild(g)}},O=async()=>{var g,h;const l=y.value||"",u=Number(x.value);if(!(!l||!Number.isFinite(u)||u<1))try{const C=await _.get("/related-lookup",{params:{type:l,id:u}});(h=(g=C==null?void 0:C.data)==null?void 0:g.data)!=null&&h.label?m.value=C.data.data.label:m.value=`#${u}`}catch{}},R=async()=>{var g;const l=y.value||"",u=(m.value||"").trim();if(!l||u.length<2){E();return}try{const h=await _.get("/related-lookup",{params:{type:l,q:u,limit:8}});L(((g=h==null?void 0:h.data)==null?void 0:g.data)??[])}catch{E()}};y.addEventListener("change",()=>{B(),E()}),m.addEventListener("input",()=>{x.value="",I&&window.clearTimeout(I),I=window.setTimeout(()=>{R()},250)}),m.addEventListener("blur",()=>{window.setTimeout(()=>E(),150)}),m.addEventListener("focus",()=>{R()}),B(),await O()},customClass:{popup:"rounded-xl border border-gray-200 bg-white text-gray-900 shadow-xl dark:!border-slate-800 dark:!bg-slate-900 dark:!text-slate-100",backdrop:"bg-black/60",title:"text-base font-semibold text-gray-900 dark:text-slate-100",htmlContainer:"text-sm text-gray-600 dark:text-slate-300",actions:"gap-2",confirmButton:"inline-flex items-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 disabled:opacity-60",cancelButton:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-4 focus:ring-blue-100 disabled:opacity-60 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",denyButton:"inline-flex items-center rounded-lg bg-rose-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-rose-700 focus:outline-none focus:ring-4 focus:ring-rose-300 disabled:opacity-60"},preConfirm:()=>{var O,R,l,u,g,h,C,Y,J,K,X;const y=((R=(O=document.getElementById("sw-ev-title"))==null?void 0:O.value)==null?void 0:R.trim())??"",m=((l=document.getElementById("sw-ev-start"))==null?void 0:l.value)??"",x=((u=document.getElementById("sw-ev-end"))==null?void 0:u.value)??"",b=((g=document.getElementById("sw-ev-reminder"))==null?void 0:g.value)??"",I=((C=(h=document.getElementById("sw-ev-location"))==null?void 0:h.value)==null?void 0:C.trim())??"",E=((J=(Y=document.getElementById("sw-ev-description"))==null?void 0:Y.value)==null?void 0:J.trim())??"",P=((K=document.getElementById("sw-ev-related_type"))==null?void 0:K.value)??"",B=((X=document.getElementById("sw-ev-related_id"))==null?void 0:X.value)??"";if(!y)return f.showValidationMessage("El título es requerido."),!1;if(!m)return f.showValidationMessage("La fecha/hora de inicio es requerida."),!1;if(x&&x<m)return f.showValidationMessage("La fecha/hora fin no puede ser menor que inicio."),!1;if(P&&!B)return f.showValidationMessage("Selecciona un registro relacionado (lead/cliente) de la lista."),!1;const L=b?Number(b):null;return b&&(!Number.isFinite(L)||L<1)?(f.showValidationMessage("El recordatorio debe ser un número válido."),!1):{title:y,start_at:new Date(m).toISOString(),end_at:x?new Date(x).toISOString():null,reminder_minutes:L,location:I||null,description:E||null,related_type:P||null,related_id:B?Number(B):null}}});return S.isDenied?{action:"delete"}:S.isConfirmed?{action:"save",payload:S.value}:null},te=Z(()=>({plugins:[re,le,ie],initialView:"dayGridMonth",customButtons:{prevCustom:{text:"‹",click:()=>q(-1)},nextCustom:{text:"›",click:()=>q(1)}},headerToolbar:{left:"prevCustom,nextCustom today",center:"",right:"dayGridMonth,timeGridWeek,timeGridDay"},eventDisplay:"block",eventClassNames:()=>["rounded-md","px-2","py-1","text-xs","font-semibold","bg-blue-600","text-white","shadow-sm","border","border-blue-700/30","dark:bg-blue-500/70","dark:border-blue-300/20"],selectable:!0,editable:!0,eventTimeFormat:{hour:"2-digit",minute:"2-digit",meridiem:!1},datesSet:e=>z(e.view),events:async(e,t,a)=>{var s;try{const n=await _.get("/calendar/events",{params:{start:e.startStr,end:e.endStr}});t(((s=n==null?void 0:n.data)==null?void 0:s.data)??[])}catch(n){N("No se pudo cargar el calendario"),a(n)}},dateClick:async e=>{var r,o,i;const t=new Date(e.date),a=new Date(e.date);a.setHours(a.getHours()+1);const s=await M({start_at:k(t),end_at:k(a)});if(!s||s.action!=="save")return;const n=s.payload;p.value=!0;try{const d=await _.post("/calendar/events",n),c=((r=d.data)==null?void 0:r.data)||d.data;T("Evento creado"),e.view.calendar.refetchEvents(),c&&c.id&&F({id:c.id,title:n.title,description:n.description,start_at:n.start_at,end_at:n.end_at,reminder_minutes:n.reminder_minutes})}catch(d){N(((i=(o=d==null?void 0:d.response)==null?void 0:o.data)==null?void 0:i.message)??"No se pudo crear el evento")}finally{p.value=!1}},eventClick:async e=>{var r,o,i,d;const t=e.event,a=t.extendedProps||{},s=await M({title:t.title,start_at:k(t.start),end_at:k(t.end),reminder_minutes:a.reminder_minutes??"",location:a.location??"",description:a.description??"",related_type:a.related_type?a.related_type.endsWith("Lead")?"lead":a.related_type.endsWith("Customer")?"customer":"":"",related_id:a.related_id??"",allowDelete:ee.value});if(!s)return;if(s.action==="delete"){if(!await de({title:"Eliminar evento",text:"Esta acción no se puede deshacer.",confirmText:"Eliminar"}))return;p.value=!0;try{await _.delete(`/calendar/events/${t.id}`),T("Evento eliminado"),e.view.calendar.refetchEvents(),Q(t.id)}catch(v){N(((o=(r=v==null?void 0:v.response)==null?void 0:r.data)==null?void 0:o.message)??"No se pudo eliminar el evento")}finally{p.value=!1}return}if(s.action!=="save")return;const n=s.payload;p.value=!0;try{await _.put(`/calendar/events/${t.id}`,n),T("Evento actualizado"),e.view.calendar.refetchEvents(),Q(t.id),F({id:t.id,title:n.title,description:n.description,start_at:n.start_at,end_at:n.end_at,reminder_minutes:n.reminder_minutes})}catch(c){N(((d=(i=c==null?void 0:c.response)==null?void 0:i.data)==null?void 0:d.message)??"No se pudo actualizar el evento")}finally{p.value=!1}},eventDrop:async e=>{var s,n,r,o;const t=e.event,a=t.extendedProps||{};p.value=!0;try{await _.put(`/calendar/events/${t.id}`,{title:t.title,start_at:(s=t.start)==null?void 0:s.toISOString(),end_at:((n=t.end)==null?void 0:n.toISOString())??null,reminder_minutes:a.reminder_minutes??null,location:a.location??null,description:a.description??null,related_type:a.related_type?a.related_type.endsWith("Lead")?"lead":a.related_type.endsWith("Customer")?"customer":null:null,related_id:a.related_id??null}),T("Evento movido")}catch(i){e.revert(),N(((o=(r=i==null?void 0:i.response)==null?void 0:r.data)==null?void 0:o.message)??"No se pudo mover el evento")}finally{p.value=!1}},eventResize:async e=>{var s,n,r,o;const t=e.event,a=t.extendedProps||{};p.value=!0;try{await _.put(`/calendar/events/${t.id}`,{title:t.title,start_at:(s=t.start)==null?void 0:s.toISOString(),end_at:((n=t.end)==null?void 0:n.toISOString())??null,reminder_minutes:a.reminder_minutes??null,location:a.location??null,description:a.description??null,related_type:a.related_type?a.related_type.endsWith("Lead")?"lead":a.related_type.endsWith("Customer")?"customer":null:null,related_id:a.related_id??null}),T("Evento actualizado")}catch(i){e.revert(),N(((o=(r=i==null?void 0:i.response)==null?void 0:r.data)==null?void 0:o.message)??"No se pudo actualizar el evento")}finally{p.value=!1}}})),ae=async()=>{var n,r,o;const e=new Date,t=new Date(e);t.setHours(t.getHours()+1);const a=await M({start_at:k(e),end_at:k(t)});if(!a||a.action!=="save")return;const s=a.payload;p.value=!0;try{const i=await _.post("/calendar/events",s),d=((n=i.data)==null?void 0:n.data)||i.data;T("Evento creado"),A(),d&&d.id&&F({id:d.id,title:s.title,description:s.description,start_at:s.start_at,end_at:s.end_at,reminder_minutes:s.reminder_minutes})}catch(i){N(((o=(r=i==null?void 0:i.response)==null?void 0:r.data)==null?void 0:o.message)??"No se pudo crear el evento")}finally{p.value=!1}},U=e=>{if(!e)return null;const t=new Date(e);if(!Number.isNaN(t.getTime()))return t;const a=new Date(String(e).replace(" ","T"));return Number.isNaN(a.getTime())?null:a},ne=async()=>{var v,w,H;const e=new URL(window.location.href),t=e.searchParams.get("related_type")||"",a=e.searchParams.get("related_id")||"",s=e.searchParams.get("title")||"";if(!t&&!a&&!s)return;const n=U(e.searchParams.get("start")),r=U(e.searchParams.get("end")),o=n??new Date,i=r??new Date(o.getTime()+3600*1e3),d=await M({title:s||"",start_at:k(o),end_at:k(i),related_type:t,related_id:a});if(e.searchParams.delete("related_type"),e.searchParams.delete("related_id"),e.searchParams.delete("title"),e.searchParams.delete("start"),e.searchParams.delete("end"),window.history.replaceState({},"",e.pathname+e.search),!d||d.action!=="save")return;const c=d.payload;p.value=!0;try{const f=await _.post("/calendar/events",c),S=((v=f.data)==null?void 0:v.data)||f.data;T("Evento creado"),A(),S&&S.id&&F({id:S.id,title:c.title,description:c.description,start_at:c.start_at,end_at:c.end_at,reminder_minutes:c.reminder_minutes})}catch(f){N(((H=(w=f==null?void 0:f.response)==null?void 0:w.data)==null?void 0:H.message)??"No se pudo crear el evento")}finally{p.value=!1}},j=()=>A(),F=e=>{if(!window.CalendarNotifications||!e)return;const t={id:e.id,title:e.title,description:e.description||"",start_datetime:e.start_at,end_datetime:e.end_at,start_time:new Date(e.start_at).toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"}),reminder_minutes:e.reminder_minutes};t.reminder_minutes&&t.reminder_minutes>0?window.CalendarNotifications.setReminderTimes([t.reminder_minutes]):window.CalendarNotifications.setReminderTimes([15,5]),window.CalendarNotifications.scheduleReminders(t)},Q=e=>{window.CalendarNotifications&&e&&window.CalendarNotifications.cancelReminders(e)};return ce(()=>{window.addEventListener("calendar:refetch",j),ue(()=>{var t,a;const e=(a=(t=D.value)==null?void 0:t.getApi)==null?void 0:a.call(t);e&&e.gotoDate(new Date),z(),Promise.resolve().then(()=>{window.CalendarNotifications&&window.CalendarNotifications.init()}),ne()})}),me(()=>{window.removeEventListener("calendar:refetch",j)}),(e,t)=>(ve(),pe("div",we,[$("div",be,[t[0]||(t[0]=$("div",null,[$("div",{class:"text-sm font-semibold text-gray-900 dark:text-slate-100"},"Calendario"),$("div",{class:"mt-1 text-xs text-gray-600 dark:text-slate-300"},"Tu agenda personal (solo tú la ves).")],-1)),$("button",{type:"button",class:"inline-flex items-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700 disabled:opacity-60",disabled:p.value,onClick:ae}," Nuevo evento ",8,_e)]),$("div",xe,[$("div",he,fe(G.value),1),ge(ye(oe),{ref_key:"calendarRef",ref:D,options:te.value},null,8,["options"])])]))}};export{Ie as default};
