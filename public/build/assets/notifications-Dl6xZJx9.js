class s{constructor(){this.isSupported="Notification"in window&&"serviceWorker"in navigator,this.permission=this.isSupported?Notification.permission:"denied",this.registration=null,this.soundEnabled=this.getSoundEnabled(),this.notificationSound=null,this.init()}async init(){if(!this.isSupported){console.warn("Notificaciones no soportadas en este navegador");return}try{this.registration=await navigator.serviceWorker.register("/sw.js"),this.loadNotificationSound()}catch(i){console.error("Error registrando Service Worker:",i)}}loadNotificationSound(){this.notificationSound||(this.notificationSound=new Audio("/sounds/universfield-new-notification-022-370046.mp3"),this.notificationSound.preload="auto",this.notificationSound.volume=.7,this.notificationSound.addEventListener("error",()=>{if(this.notificationSound=null,!window.NotificationSound){const i=document.createElement("script");i.src="/sounds/notification-generator.js",i.onload=()=>{console.log("Generador de sonidos cargado")},i.onerror=()=>{console.warn("No se pudo cargar el generador de sonidos")},document.head.appendChild(i)}}),this.notificationSound.addEventListener("canplaythrough",()=>{}))}async requestPermission(){if(!this.isSupported)throw new Error("Notificaciones no soportadas");if(this.permission==="granted")return"granted";try{return this.permission=await Notification.requestPermission(),this.permission==="granted"?(console.log("Permisos de notificaci√≥n otorgados"),this.showLocalNotification("¬°Notificaciones activadas!","Ahora recibir√°s notificaciones de tu calendario.",{tag:"welcome"})):console.warn("Permisos de notificaci√≥n denegados"),this.permission}catch(i){return console.error("Error pidiendo permisos:",i),"denied"}}playNotificationSound(){if(this.soundEnabled)try{this.notificationSound&&this.notificationSound.readyState>=2?(this.notificationSound.currentTime=0,this.notificationSound.play().catch(i=>{console.warn("No se pudo reproducir el sonido personalizado:",i),this.playGeneratedSound()})):this.playGeneratedSound()}catch(i){console.warn("Error reproduciendo sonido:",i)}}playGeneratedSound(){window.NotificationSound?window.NotificationSound.play():"beep"in window&&window.beep()}async showNotification(i,t,o={}){if(this.permission!=="granted")return console.warn("Sin permisos para mostrar notificaciones"),!1;try{this.playNotificationSound();const a={...{body:t,icon:"/images/LOGO.png",badge:"/images/LOGO.png",requireInteraction:!0,silent:!1,vibrate:[200,100,200,100,200],timestamp:Date.now(),renotify:!0,data:{...o.data,timestamp:Date.now()}},...o},r=new Notification(i,a);return r.addEventListener("click",()=>{window.focus(),r.close(),o.url&&(window.location.href=o.url)}),!0}catch(n){return console.error("Error mostrando notificaci√≥n:",n),!1}}async showLocalNotification(i,t,o={}){return this.showNotification(i,t,o)}async showCalendarNotification(i){const t=`üìÖ Recordatorio: ${i.title}`,o=`${i.description||"Sin descripci√≥n"}
‚è∞ ${i.start_time}`,n={tag:`calendar-${i.id}`,icon:"/images/calendar-icon.png",requireInteraction:!0,url:`/calendar?event=${i.id}`,data:{type:"calendar",eventId:i.id,url:`/calendar?event=${i.id}`},actions:[{action:"view",title:"üëÅÔ∏è Ver evento"},{action:"snooze",title:"‚è∞ Recordar en 5 min"}]};return this.showNotification(t,o,n)}scheduleNotification(i,t=15){const o=new Date(i.start_datetime),n=new Date(o.getTime()-t*60*1e3),a=new Date;if(n<=a){console.warn("El tiempo de notificaci√≥n ya pas√≥");return}const r=n.getTime()-a.getTime();console.log(`Notificaci√≥n programada para: ${n.toLocaleString()}`),setTimeout(()=>{this.showCalendarNotification(i)},r)}setSoundEnabled(i){this.soundEnabled=i,localStorage.setItem("notification-sound-enabled",i.toString())}getSoundEnabled(){const i=localStorage.getItem("notification-sound-enabled");return i?i==="true":!0}getStatus(){return{supported:this.isSupported,permission:this.permission,soundEnabled:this.soundEnabled,serviceWorkerReady:!!this.registration}}}window.NotificationManager=new s;window.showNotification=(e,i,t)=>window.NotificationManager.showNotification(e,i,t);window.requestNotificationPermission=()=>window.NotificationManager.requestPermission();document.addEventListener("DOMContentLoaded",()=>{const e=localStorage.getItem("notification-sound-enabled");e!==null?(window.NotificationManager.setSoundEnabled(e==="true"),window.NotificationManager.soundEnabled=e==="true"):window.NotificationManager.setSoundEnabled(!0)});
