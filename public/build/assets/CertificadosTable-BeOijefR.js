import{r as f,o as ae,f as se,x as oe,g as c,i as p,j as s,k as re,w as V,z as le,A as ie,t as u,n as j,C as P,u as y,F as U,m as A,s as M,v as ne}from"./vendor-vue-Diyp6CFE.js";import{a as b}from"./vendor-utils-Czy7fllw.js";import{u as de,a as ce,_ as pe,g as ue,b as x,t as v,h as me,c as fe}from"./App-BLINciIY.js";import"./app-D0PWajC2.js";import"./vendor-ui-BsDgRXDF.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const ge={class:"p-4"},be={class:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between"},he={class:"w-full sm:max-w-md"},ye={class:"flex items-center gap-2"},xe={class:"text-sm text-slate-600 dark:text-slate-300"},ve={key:0},ke={key:1},_e={key:0,class:"mt-2 text-sm text-slate-600 dark:text-slate-300"},we={class:"px-4 py-3 font-medium text-slate-900 dark:text-slate-100"},Ce={class:"px-4 py-3"},Se={class:"px-4 py-3"},Ie={class:"px-4 py-3"},Te={class:"px-4 py-3"},Ee={class:"px-4 py-3"},$e=["href"],De=["src"],Ne={key:1,class:"inline-flex items-center rounded-md border border-slate-300 px-2 py-1 text-xs text-slate-700 dark:border-slate-700 dark:text-slate-200"},Re={key:1},ze={class:"px-4 py-3"},Fe={class:"flex items-center gap-2"},Ve=["disabled","onClick"],je=["disabled","onClick"],Pe={class:"mt-4 flex items-center justify-between"},Ue=["disabled"],Ae={class:"text-sm text-slate-600 dark:text-slate-300"},Me=["disabled"],Xe={__name:"CertificadosTable",setup(Be){const N=e=>{if(!e)return"";const t=String(e);return t.startsWith("http://")||t.startsWith("https://")?t:`/storage/${t.replace(/^\/+/,"")}`},B=e=>String(e||"").toLowerCase().endsWith(".pdf"),L=e=>{if(!e)return"";const t=String(e).trim();if(t==="")return"";const a=t.match(/^(\d{4})-(\d{2})-(\d{2})/);if(a)return`${a[3]}/${a[2]}/${a[1]}`;const l=new Date(t);return Number.isNaN(l.getTime())?t:new Intl.DateTimeFormat("es-PE",{day:"2-digit",month:"2-digit",year:"numeric"}).format(l)},k=f([]),_=f(!1),C=f(new Set),S=f(new Set),w=f("");let I=null;const T=f(!1),E=f(!1),m=f(""),i=f({current_page:1,last_page:1,per_page:15,total:0,from:0,to:0}),$=[{key:"nombre",label:"Nombre"},{key:"ruc",label:"RUC"},{key:"tipo",label:"Tipo"},{key:"estado",label:"Estado"},{key:"fecha_vencimiento",label:"Vencimiento"},{key:"imagen",label:"Imagen"},{key:"actions",label:"Acciones"}],{tableRef:R,visibleKeys:W,isColumnVisible:O,toggleColumn:q,resetColumns:H}=de({tableId:"certificados-table",columns:$}),{tableScrollRef:K,stickyScrollRef:X,stickyScrollWidth:Z,showStickyXScroll:G}=ce({tableRef:R}),h=async(e=1)=>{_.value=!0;try{const{data:t}=await b.get("/postventa/certificados/data",{params:{q:w.value||"",per_page:i.value.per_page,page:e}});k.value=t.certificados||[],i.value={...i.value,...t.pagination||{}}}finally{_.value=!1}},z=e=>{const t=Math.max(1,Math.min(i.value.last_page||1,e));h(t)},J=async e=>{var a,l,n,o;const t=(l=(a=e==null?void 0:e.target)==null?void 0:a.files)==null?void 0:l[0];if(e!=null&&e.target&&(e.target.value=""),!!t){T.value=!0,m.value="Importando datos...";try{const r=new FormData;r.append("csv",t);const{data:d}=await b.post("/postventa/certificados/import-data",r,{headers:{"Content-Type":"multipart/form-data"}}),g=((d==null?void 0:d.output)??"").trim();m.value=g!==""?g:"Importación de datos finalizada.",x("Datos importados"),h(1)}catch(r){const d=((o=(n=r==null?void 0:r.response)==null?void 0:n.data)==null?void 0:o.message)??"No se pudo importar el CSV.";m.value=d,v(d)}finally{T.value=!1}}},Q=async e=>{var a,l,n;const t=Array.from(((a=e==null?void 0:e.target)==null?void 0:a.files)??[]);if(e!=null&&e.target&&(e.target.value=""),!!t.length){E.value=!0,m.value="Importando imágenes...";try{const o=new FormData;t.forEach(d=>o.append("images[]",d));const{data:r}=await b.post("/postventa/certificados/import-images",o,{headers:{"Content-Type":"multipart/form-data"}});if(typeof(r==null?void 0:r.updated)=="number")m.value=`Importación de imágenes finalizada. Actualizados: ${r.updated} · Saltados: ${r.skipped??0} · Sin match: ${r.unmatched??0}`;else{const d=((r==null?void 0:r.output)??"").trim();m.value=d!==""?d:"Importación de imágenes finalizada."}x("Imágenes importadas"),h(1)}catch(o){const r=((n=(l=o==null?void 0:o.response)==null?void 0:l.data)==null?void 0:n.message)??"No se pudo importar el ZIP.";m.value=r,v(r)}finally{E.value=!1}}},Y=async()=>{var t,a,l,n;const e=await ue();if(e)try{let o;if((e==null?void 0:e.imagen)instanceof File){const r=new FormData;Object.entries(e).forEach(([d,g])=>{g!=null&&r.append(d,g)}),o=await b.post("/postventa/certificados",r,{headers:{"Content-Type":"multipart/form-data"}})}else o=await b.post("/postventa/certificados",e);x("Certificado creado"),(t=o==null?void 0:o.data)!=null&&t.calendar_event_created&&x(((a=o==null?void 0:o.data)==null?void 0:a.calendar_event_message)||"La fecha de vencimiento del certificado fue agregada al calendario."),h(1)}catch(o){const r=((n=(l=o==null?void 0:o.response)==null?void 0:l.data)==null?void 0:n.message)??"No se pudo crear el certificado.";v(r)}},ee=async e=>{var a,l,n;if(!(e!=null&&e.id))return;const t=await me(e);if(t){C.value.add(e.id);try{let o;if((t==null?void 0:t.imagen)instanceof File){const d=new FormData;d.append("_method","PUT"),Object.entries(t).forEach(([g,D])=>{D!=null&&d.append(g,D)}),o=await b.post(`/postventa/certificados/${e.id}`,d,{headers:{"Content-Type":"multipart/form-data"}})}else o=await b.put(`/postventa/certificados/${e.id}`,t);const r=(a=o==null?void 0:o.data)==null?void 0:a.data;Object.assign(e,r&&typeof r=="object"?r:t),x("Certificado actualizado")}catch(o){const r=((n=(l=o==null?void 0:o.response)==null?void 0:l.data)==null?void 0:n.message)??"No se pudo actualizar el certificado.";v(r)}finally{C.value.delete(e.id)}}},te=async e=>{var a,l;if(!(!(e!=null&&e.id)||!await fe({title:"Eliminar certificado",text:"Se eliminará el certificado.",confirmText:"Eliminar",cancelText:"Cancelar",icon:"warning"}))){S.value.add(e.id);try{await b.delete(`/postventa/certificados/${e.id}`),k.value=k.value.filter(n=>n.id!==e.id),x("Certificado eliminado"),h(Math.min(i.value.current_page,i.value.last_page||1))}catch(n){const o=((l=(a=n==null?void 0:n.response)==null?void 0:a.data)==null?void 0:l.message)??"No se pudo eliminar el certificado.";v(o)}finally{S.value.delete(e.id)}}},F=()=>Y();return ae(()=>{window.addEventListener("certificados:create",F)}),se(()=>{window.removeEventListener("certificados:create",F)}),oe(w,()=>{I&&clearTimeout(I),I=setTimeout(()=>{h(1)},300)},{flush:"post"}),h(1),(e,t)=>(p(),c("div",ge,[s("div",be,[s("div",he,[V(s("input",{"onUpdate:modelValue":t[0]||(t[0]=a=>w.value=a),type:"text",class:"w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 focus:border-sky-500 focus:ring-sky-500 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100",placeholder:"Buscar certificado (nombre, RUC, usuario…)"},null,512),[[le,w.value]])]),s("div",ye,[s("div",xe,[i.value.total?(p(),c("span",ve,"Mostrando "+u(i.value.from)+"–"+u(i.value.to)+" de "+u(i.value.total),1)):(p(),c("span",ke,"Sin resultados"))]),s("label",{class:j(["inline-flex cursor-pointer items-center rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",T.value?"pointer-events-none opacity-50":""])},[s("input",{type:"file",class:"hidden",accept:".csv,.txt,text/csv",onChange:J},null,32),t[3]||(t[3]=P(" Importar datos (CSV) ",-1))],2),s("label",{class:j(["inline-flex cursor-pointer items-center rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",E.value?"pointer-events-none opacity-50":""])},[s("input",{type:"file",class:"hidden",multiple:"",accept:"image/*,.pdf,application/pdf",onChange:Q},null,32),t[4]||(t[4]=P(" Importar imágenes ",-1))],2),ie(pe,{columns:$,"visible-keys":y(W),onToggle:y(q),onReset:y(H)},null,8,["visible-keys","onToggle","onReset"])])]),m.value?(p(),c("div",_e,u(m.value),1)):re("",!0),s("div",{ref_key:"tableScrollRef",ref:K,class:"mt-4 overflow-x-auto rounded-lg border border-slate-200 bg-white dark:border-slate-800 dark:bg-slate-900"},[s("table",{ref_key:"tableRef",ref:R,class:"min-w-full text-left text-sm text-slate-700 dark:text-slate-200"},[s("colgroup",null,[(p(),c(U,null,A($,a=>s("col",{key:a.key,style:M({display:y(O)(a.key)?"":"none"})},null,4)),64))]),t[5]||(t[5]=s("thead",{class:"bg-slate-50 text-xs uppercase text-slate-600 dark:bg-slate-800 dark:text-slate-200"},[s("tr",null,[s("th",{class:"px-4 py-3"},"Nombre"),s("th",{class:"px-4 py-3"},"RUC"),s("th",{class:"px-4 py-3"},"Tipo"),s("th",{class:"px-4 py-3"},"Estado"),s("th",{class:"px-4 py-3"},"Vencimiento"),s("th",{class:"px-4 py-3"},"Imagen"),s("th",{class:"px-4 py-3"},"Acciones")])],-1)),s("tbody",null,[(p(!0),c(U,null,A(k.value,a=>(p(),c("tr",{key:a.id,class:"border-t border-slate-200 hover:bg-slate-50 dark:border-slate-800 dark:hover:bg-slate-800"},[s("td",we,u(a.nombre),1),s("td",Ce,u(a.ruc||"—"),1),s("td",Se,u(a.tipo||"—"),1),s("td",Ie,u(a.estado||"—"),1),s("td",Te,u(L(a.fecha_vencimiento)||"—"),1),s("td",Ee,[a.imagen?(p(),c("a",{key:0,href:N(a.imagen),target:"_blank",rel:"noreferrer"},[B(a.imagen)?(p(),c("span",Ne," PDF ")):(p(),c("img",{key:0,src:N(a.imagen),alt:"",class:"h-10 w-10 rounded object-cover"},null,8,De))],8,$e)):(p(),c("span",Re,"—"))]),s("td",ze,[s("div",Fe,[s("button",{type:"button",class:"inline-flex items-center rounded-lg border border-slate-300 bg-white px-3 py-1.5 text-xs font-medium text-slate-700 hover:bg-slate-50 disabled:opacity-60 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:C.value.has(a.id),onClick:l=>ee(a)}," Editar ",8,Ve),s("button",{type:"button",class:"inline-flex items-center rounded-lg border border-red-200 bg-white px-3 py-1.5 text-xs font-medium text-red-700 hover:bg-red-50 disabled:opacity-60 dark:border-red-900/40 dark:bg-slate-900 dark:text-red-300 dark:hover:bg-red-950/30",disabled:S.value.has(a.id),onClick:l=>te(a)}," Eliminar ",8,je)])])]))),128))])],512)],512),V(s("div",{ref_key:"stickyScrollRef",ref:X,class:"sticky bottom-0 z-20 mt-2 overflow-x-auto rounded-lg border border-slate-200 bg-white/95 dark:border-slate-700 dark:bg-slate-900/95"},[s("div",{style:M({width:`${y(Z)}px`,height:"1px"})},null,4)],512),[[ne,y(G)]]),s("div",Pe,[s("button",{class:"rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 disabled:cursor-not-allowed disabled:opacity-50 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:i.value.current_page<=1||_.value,onClick:t[1]||(t[1]=a=>z(i.value.current_page-1))}," Anterior ",8,Ue),s("div",Ae," Página "+u(i.value.current_page)+" / "+u(i.value.last_page),1),s("button",{class:"rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 disabled:cursor-not-allowed disabled:opacity-50 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:i.value.current_page>=i.value.last_page||_.value,onClick:t[2]||(t[2]=a=>z(i.value.current_page+1))}," Siguiente ",8,Me)])]))}};export{Xe as default};
