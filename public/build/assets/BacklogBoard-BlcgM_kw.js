import{r as u,e as be,o as ye,f as he,g as v,i as g,j as r,w as O,D as Z,x as ee,t as y,n as q,F as te,m as ae,l as z,k as D,s as ke}from"./vendor-vue-Db-AqoDh.js";import{a as A}from"./vendor-utils-Czy7fllw.js";import{a as H,t as R,c as we}from"./App-D_XY1sJF.js";import"./app-CglYj3fU.js";import"./vendor-ui-DEm6YKEA.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const _e={class:"mb-4 flex items-center gap-3"},Ie={class:"flex items-center gap-2"},Ce={class:"flex items-center gap-2"},Ee={class:"flex items-center gap-2"},De={class:"flex items-center gap-2"},Ae={key:0,class:"text-sm text-gray-600 dark:text-slate-300"},Le={key:1,class:"mb-3 text-sm text-red-600"},Se=["data-stage-id","onDrop"],Me={class:"p-4 border-b border-gray-200 dark:border-slate-800"},je={class:"flex items-center justify-between gap-3"},Fe={class:"text-sm font-semibold text-gray-900 dark:text-slate-100"},Ne={class:"text-xs text-gray-600 dark:text-slate-300"},Pe={class:"p-3 space-y-3 min-h-[140px]"},Be={key:0,class:"text-sm text-gray-500 dark:text-slate-400 px-1"},Te=["data-incidence-id"],$e={key:0,class:"h-1 bg-blue-500 rounded-full mx-3 mb-2 animate-pulse transition-all duration-200"},Oe=["data-incidence-id","draggable","onDragstart","onClick"],Ue=["onClick"],Ve={class:"text-sm font-semibold text-gray-900 dark:text-slate-100"},Ye={key:0,class:"text-xs text-gray-600 dark:text-slate-300 mt-1"},qe={key:1,class:"text-xs text-gray-500 dark:text-slate-400 mt-1"},ze=["onClick"],He={key:1,class:"mt-3 flex justify-end gap-2"},Re=["disabled","onClick"],Ge={key:1,class:"h-1 bg-blue-500 rounded-full mx-3 mt-2 animate-pulse transition-all duration-200"},tt={__name:"BacklogBoard",setup(Je){const U=u(!0),m=u([]),p=u(""),L=u(50),S=u(""),M=u(""),j=u(""),x=u(null),ne=u(null),F=u(null),h=u(null),k=u(null),V=u(null),N=u(!1),_=u(!1),w=u(null),P=u(new Set),se=be(()=>{const e=m.value.length||1;return e<=1?"grid-cols-1":e===2?"grid-cols-1 md:grid-cols-2":e===3?"grid-cols-1 md:grid-cols-3":"grid-cols-1 md:grid-cols-2 xl:grid-cols-4"}),ie=e=>{if(!e)return"";try{const a=new Date(String(e));return Number.isNaN(a.getTime())?String(e):a.toLocaleDateString()}catch{return String(e)}},re=e=>{switch(e==null?void 0:e.toLowerCase()){case"alta":return"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200 px-2 py-0.5 rounded font-medium";case"media":return"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200 px-2 py-0.5 rounded font-medium";case"baja":return"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 px-2 py-0.5 rounded font-medium";default:return"text-gray-700 dark:text-slate-200"}},b=async({showLoading:e=!0}={})=>{var a,n;e&&(U.value=!0);try{const t=await A.get("/backlog/board-data",{params:{limit:L.value,date_from:S.value||null,date_to:M.value||null,priority:j.value||null}});m.value=((n=(a=t==null?void 0:t.data)==null?void 0:a.data)==null?void 0:n.stages)??[]}finally{e&&(U.value=!1)}},de=()=>{b()},le=()=>{S.value="",M.value="",j.value="",L.value=50,b()},I=e=>!!(e!=null&&e.archived_at),Y=e=>{e!=null&&e.id&&window.dispatchEvent(new CustomEvent("incidencias:edit",{detail:{incidence:e}}))},G=e=>{var n,t,i;const a=(n=e==null?void 0:e.detail)==null?void 0:n.incidence;if(a!=null&&a.id)for(const s of m.value){const d=((i=(t=s==null?void 0:s.incidences)==null?void 0:t.findIndex)==null?void 0:i.call(t,o=>o.id===a.id))??-1;if(d!==-1){s.incidences.splice(d,1,{...s.incidences[d],...a});break}}},oe=(e,a,n)=>{if(I(e))return;x.value=e,F.value=(e==null?void 0:e.stage_id)??null,V.value=e.id,N.value=!1;const t=m.value.find(i=>i.id===((e==null?void 0:e.stage_id)??null));if(t&&Array.isArray(t.incidences)){const i=t.incidences.findIndex(s=>s.id===e.id);w.value={stageId:t.id,index:i}}else w.value=null;_.value=!1},ce=(e=!1)=>{var n;if(!_.value)return;const a=((n=x.value)==null?void 0:n.id)??null;if(a!=null){for(const t of m.value){if(!Array.isArray(t.incidences))continue;const i=t.incidences.findIndex(s=>s.id===a);i!==-1&&t.incidences.splice(i,1)}if(e&&w.value){const t=m.value.find(i=>i.id===w.value.stageId);if(t){Array.isArray(t.incidences)||(t.incidences=[]);const i=Math.max(0,Math.min(w.value.index??t.incidences.length,t.incidences.length));t.incidences.splice(i,0,x.value)}}_.value=!1,h.value=null,k.value=null}},ue=()=>{!N.value&&_.value&&ce(!0),x.value=null,F.value=null,V.value=null,_.value=!1,N.value=!1,h.value=null,k.value=null,w.value=null},ve=async(e,a)=>{var i,s;if(a.preventDefault(),!x.value||!e)return;N.value=!0;const n=x.value,t=F.value;if(I(n)){p.value="Esta incidencia está bloqueada y no se puede mover.";return}p.value="";try{const d=a.clientY,o=Q(e,d,n.id);if(t===e.id)xe(e.id,n.id,o),H("Incidencia reordenada");else{J(t,n.id);const l={...n,stage_id:e.id};ge(e.id,l,o),A.patch(`/incidencias/${n.id}/move-stage`,{stage_id:e.id}).then(c=>{var C,X;const f=(C=c==null?void 0:c.data)==null?void 0:C.data;if(f){const E=m.value.find($=>$.id===e.id);if(E){const $=E.incidences.findIndex(pe=>pe.id===n.id);$!==-1&&Object.assign(E.incidences[$],f)}}const T=((X=e.incidences)==null?void 0:X.map(E=>E.id))||[];return A.patch("/incidencias/reorder",{stage_id:e.id,ordered_ids:T})}).then(()=>{H("Incidencia movida correctamente")}).catch(c=>{var T,C;console.error("Error moving incidence:",c);const f=((C=(T=c==null?void 0:c.response)==null?void 0:T.data)==null?void 0:C.message)??"No se pudo mover la incidencia.";p.value=f,R(f),b({showLoading:!1})})}}catch(d){console.error("Error in onDropOnStage:",d);const o=((s=(i=d==null?void 0:d.response)==null?void 0:i.data)==null?void 0:s.message)??"No se pudo mover la incidencia.";p.value=o,R(o),await b({showLoading:!1})}x.value=null,F.value=null,V.value=null,h.value=null,k.value=null},J=(e,a)=>{const n=m.value.find(i=>i.id===e);if(!(n!=null&&n.incidences))return null;const t=n.incidences.findIndex(i=>i.id===a);if(t!==-1){const i=n.incidences.splice(t,1)[0];return n.count=n.incidences.length,i}return null},ge=(e,a,n=0)=>{const t=m.value.find(d=>d.id===e);if(!t)return;Array.isArray(t.incidences)||(t.incidences=[]);const i=t.incidences.findIndex(d=>d.id===a.id);i!==-1&&t.incidences.splice(i,1);const s=Math.min(Math.max(0,n),t.incidences.length);t.incidences.splice(s,0,a),t.count=t.incidences.length},me=e=>{if(!x.value)return;e.preventDefault();const a=e.currentTarget.closest("section[data-stage-id]");if(!a)return;const n=parseInt(a.getAttribute("data-stage-id")),t=m.value.find(s=>s.id===n);if(!t)return;h.value=n;const i=e.clientY;k.value=Q(t,i,x.value.id)},K=new Map,Q=(e,a,n=null)=>{let t=K.get(e.id);if(!t||!document.contains(t)){if(t=document.querySelector(`[data-stage-id="${e.id}"] .p-3`),!t)return 0;K.set(e.id,t)}const i=t.querySelectorAll("article[data-incidence-id]");let s=0;for(let d=0;d<i.length;d++){const o=i[d],l=parseInt(o.getAttribute("data-incidence-id"));if(n&&l===n)continue;const c=o.getBoundingClientRect();if(a<c.top+c.height/2)return s;s++}return s},xe=async(e,a,n)=>{const t=m.value.find(l=>l.id===e);if(!t||!Array.isArray(t.incidences))return;const i=t.incidences.findIndex(l=>l.id===a);if(i===-1||i===n)return;const[s]=t.incidences.splice(i,1),d=Math.min(Math.max(0,n),t.incidences.length);t.incidences.splice(d,0,s),t.count=t.incidences.length;const o=t.incidences.map(l=>l.id);A.patch("/incidencias/reorder",{stage_id:e,ordered_ids:o}).catch(l=>{console.error("Error reordering incidences:",l),b({showLoading:!1})})},fe=async(e,a)=>{var t,i;if(!(!(e!=null&&e.id)||!(a!=null&&a.is_done)||!await we({title:"Archivar incidencia",text:"Se ocultará del backlog, pero seguirá visible en la tabla (historial).",confirmText:"Archivar",cancelText:"Cancelar",icon:"warning"}))){P.value.add(e.id),p.value="";try{await A.patch(`/incidencias/${e.id}/archive`),J(a.id,e.id),H("Incidencia archivada"),window.dispatchEvent(new CustomEvent("incidencias:archived"))}catch(s){const d=((i=(t=s==null?void 0:s.response)==null?void 0:t.data)==null?void 0:i.message)??"No se pudo archivar la incidencia.";p.value=d,R(d)}finally{P.value.delete(e.id)}}},B=()=>b({showLoading:!1}),W=e=>{var n,t,i,s,d,o;const a=((n=e==null?void 0:e.detail)==null?void 0:n.id)??((i=(t=e==null?void 0:e.detail)==null?void 0:t.incidence)==null?void 0:i.id)??((s=e==null?void 0:e.detail)==null?void 0:s.incidenceId)??null;if(!a){b({showLoading:!1});return}for(const l of m.value){const c=((o=(d=l==null?void 0:l.incidences)==null?void 0:d.findIndex)==null?void 0:o.call(d,f=>f.id===a))??-1;if(c!==-1){l.incidences.splice(c,1),l.count=Math.max(0,(l.count??0)-1);break}}};return ye(async()=>{window.addEventListener("incidencias:created",B),window.addEventListener("incidencias:archived",B),window.addEventListener("incidencias:deleted",W),window.addEventListener("incidencias:updated",G),await b()}),he(()=>{window.removeEventListener("incidencias:created",B),window.removeEventListener("incidencias:archived",B),window.removeEventListener("incidencias:deleted",W),window.removeEventListener("incidencias:updated",G),x.value=null,ne.value=null}),(e,a)=>(g(),v("div",null,[a[10]||(a[10]=r("div",{class:"mb-4 text-sm text-gray-600 dark:text-slate-300"}," Arrastra una incidencia entre columnas para cambiar su estado, o dentro de una columna para reordenar. ",-1)),r("div",_e,[r("div",Ie,[a[5]||(a[5]=r("label",{class:"text-xs text-gray-600 dark:text-slate-300"},"Limite:",-1)),O(r("select",{"onUpdate:modelValue":a[0]||(a[0]=n=>L.value=n),class:"rounded-lg border border-gray-200 bg-white px-2 py-1 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:focus:ring-blue-900/30"},[...a[4]||(a[4]=[r("option",{value:20},"20",-1),r("option",{value:50},"50",-1),r("option",{value:100},"100",-1),r("option",{value:250},"250",-1)])],512),[[Z,L.value,void 0,{number:!0}]])]),r("div",Ce,[a[6]||(a[6]=r("label",{class:"text-xs text-gray-600 dark:text-slate-300"},"Desde:",-1)),O(r("input",{"onUpdate:modelValue":a[1]||(a[1]=n=>S.value=n),type:"date",class:"rounded-lg border border-gray-200 bg-white px-2 py-1 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 placeholder:text-gray-400 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:placeholder:text-slate-500 dark:focus:ring-blue-900/30 dark:[color-scheme:dark]"},null,512),[[ee,S.value]])]),r("div",Ee,[a[7]||(a[7]=r("label",{class:"text-xs text-gray-600 dark:text-slate-300"},"Hasta:",-1)),O(r("input",{"onUpdate:modelValue":a[2]||(a[2]=n=>M.value=n),type:"date",class:"rounded-lg border border-gray-200 bg-white px-2 py-1 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 placeholder:text-gray-400 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:placeholder:text-slate-500 dark:focus:ring-blue-900/30 dark:[color-scheme:dark]"},null,512),[[ee,M.value]])]),r("div",De,[a[9]||(a[9]=r("label",{class:"text-xs text-gray-600 dark:text-slate-300"},"Prioridad:",-1)),O(r("select",{"onUpdate:modelValue":a[3]||(a[3]=n=>j.value=n),class:"rounded-lg border border-gray-200 bg-white px-2 py-1 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:focus:ring-blue-900/30"},[...a[8]||(a[8]=[r("option",{value:""},"Todas",-1),r("option",{value:"alta"},"Alta",-1),r("option",{value:"media"},"Media",-1),r("option",{value:"baja"},"Baja",-1)])],512),[[Z,j.value]])]),r("div",{class:"flex items-center gap-2 ms-auto"},[r("button",{onClick:de,class:"inline-flex items-center rounded-lg bg-blue-600 px-3 py-1 text-sm text-white hover:bg-blue-700"}," Aplicar "),r("button",{onClick:le,class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1 text-sm text-gray-700 shadow-sm hover:bg-gray-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800"}," Limpiar ")])]),U.value?(g(),v("div",Ae,"Cargando...")):p.value?(g(),v("div",Le,y(p.value),1)):(g(),v("div",{key:2,class:q(["grid gap-4",se.value])},[(g(!0),v(te,null,ae(m.value,n=>{var t,i;return g(),v("section",{key:n.id,"data-stage-id":n.id,class:"bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden dark:bg-slate-900 dark:border-slate-800",onDragover:z(me,["prevent"]),onDrop:z(s=>ve(n,s),["prevent"])},[r("div",Me,[r("div",je,[r("div",Fe,y(n.name),1),r("div",Ne,y(n.count),1)])]),r("div",Pe,[(((t=n.incidences)==null?void 0:t.length)??0)===0?(g(),v("div",Be," Sin incidencias. ")):D("",!0),(g(!0),v(te,null,ae(n.incidences,(s,d)=>{var o,l,c;return g(),v("div",{key:s.id,"data-incidence-id":s.id},[h.value===n.id&&k.value===d&&((o=x.value)==null?void 0:o.id)!==s.id?(g(),v("div",$e)):D("",!0),r("article",{"data-incidence-id":s.id,class:q(["select-none bg-gray-50 border border-gray-200 rounded-lg p-3 mb-3 dark:bg-slate-800 dark:border-slate-700 will-change-transform",{"opacity-60 scale-95 shadow-lg":((l=x.value)==null?void 0:l.id)===s.id,"cursor-not-allowed opacity-80":I(s),"cursor-grab hover:bg-blue-50/30 dark:hover:bg-slate-800/50 hover:shadow-md":!I(s)}]),style:ke(((c=x.value)==null?void 0:c.id)===s.id?"transition: none !important; transform: scale(1.02);":"transition: transform 0.1s ease, opacity 0.1s ease;"),draggable:!I(s),onDragstart:f=>oe(s),onDragend:ue,onClick:f=>Y(s)},[r("div",{class:"flex items-start justify-between gap-3 cursor-pointer",onClick:f=>Y(s)},[r("div",null,[r("div",Ve,y(s.title),1),s.customer?(g(),v("div",Ye,y(s.customer.company_name||s.customer.name),1)):(g(),v("div",qe,"Sin cliente"))]),r("div",{class:q(["text-xs",re(s.priority)])},y(s.priority||"Normal"),3)],8,Ue),s.date?(g(),v("div",{key:0,class:"mt-2 text-xs text-gray-600 dark:text-slate-300 cursor-pointer",onClick:f=>Y(s)},y(ie(s.date)),9,ze)):D("",!0),n.is_done?(g(),v("div",He,[r("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:P.value.has(s.id),onClick:z(f=>fe(s,n),["stop","prevent"])},y(P.value.has(s.id)?"Archivando…":"Archivar"),9,Re)])):D("",!0)],46,Oe)],8,Te)}),128)),h.value===n.id&&k.value>=(((i=n.incidences)==null?void 0:i.length)||0)?(g(),v("div",Ge)):D("",!0)])],40,Se)}),128))],2))]))}};export{tt as default};
