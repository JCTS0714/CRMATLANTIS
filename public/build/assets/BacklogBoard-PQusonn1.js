import{r as o,e as ge,o as fe,f as me,g as u,i as v,j as n,w as U,D as K,x as Q,t as w,n as q,F as W,m as X,l as p,k as Z}from"./vendor-vue-Db-AqoDh.js";import{a as N}from"./vendor-utils-Czy7fllw.js";import{a as H,t as ee,c as xe}from"./App-ClL66G7-.js";import"./app-l-wloUcb.js";import"./vendor-ui-DEm6YKEA.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const be={class:"mb-4 flex items-center gap-3"},pe={class:"flex items-center gap-2"},ye={class:"flex items-center gap-2"},ke={class:"flex items-center gap-2"},he={class:"flex items-center gap-2"},we={key:0,class:"text-sm text-gray-600 dark:text-slate-300"},_e={key:1,class:"mb-3 text-sm text-red-600"},Ie=["data-stage-id","onDrop"],Ae={class:"p-4 border-b border-gray-200 dark:border-slate-800"},De={class:"flex items-center justify-between gap-3"},Ce={class:"text-sm font-semibold text-gray-900 dark:text-slate-100"},Ee={class:"text-xs text-gray-600 dark:text-slate-300"},Le={class:"p-3 space-y-3 min-h-[140px]"},Me={key:0,class:"text-sm text-gray-500 dark:text-slate-400 px-1"},Te=["data-incidence-id"],je=["data-incidence-id","draggable","onDragstart","onDragover","onDrop","onClick"],Ne={class:"flex items-start justify-between gap-3"},Oe={class:"text-sm font-semibold text-gray-900 dark:text-slate-100"},$e={key:0,class:"text-xs text-gray-600 dark:text-slate-300 mt-1"},Be={key:1,class:"text-xs text-gray-500 dark:text-slate-400 mt-1"},Fe={key:0,class:"mt-2 text-xs text-gray-600 dark:text-slate-300"},Pe={key:1,class:"mt-3 flex justify-end gap-2"},Se=["disabled","onClick"],Ue=["disabled","onClick"],Ve={key:2,class:"mt-3 flex justify-end"},ze=["disabled","onClick"],Qe={__name:"BacklogBoard",setup(qe){const V=o(!0),g=o([]),y=o(""),O=o(50),$=o(""),B=o(""),F=o(""),k=o(null),f=o(null),I=o(null),h=o(!1),E=o(!1),L=o({incidenceId:null,position:"after",stageId:null}),_=o(null),P=o(new Set),te=ge(()=>{const e=g.value.length||1;return e<=1?"grid-cols-1":e===2?"grid-cols-1 md:grid-cols-2":e===3?"grid-cols-1 md:grid-cols-3":"grid-cols-1 md:grid-cols-2 xl:grid-cols-4"}),ae=e=>{if(!e)return"";try{const t=new Date(String(e));return Number.isNaN(t.getTime())?String(e):t.toLocaleDateString()}catch{return String(e)}},re=e=>{switch(e==null?void 0:e.toLowerCase()){case"alta":return"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200 px-2 py-0.5 rounded font-medium";case"media":return"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200 px-2 py-0.5 rounded font-medium";case"baja":return"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 px-2 py-0.5 rounded font-medium";default:return"text-gray-700 dark:text-slate-200"}},A=async({showLoading:e=!0}={})=>{var t,s;e&&(V.value=!0);try{const a=await N.get("/backlog/board-data",{params:{limit:O.value,date_from:$.value||null,date_to:B.value||null,priority:F.value||null}});g.value=((s=(t=a==null?void 0:a.data)==null?void 0:t.data)==null?void 0:s.stages)??[]}finally{e&&(V.value=!1)}},se=()=>{A()},ne=()=>{$.value="",B.value="",F.value="",O.value=50,A()},R=(e,t)=>{const s=g.value.find(i=>i.id===e);if(!(s!=null&&s.incidences))return null;const a=s.incidences.findIndex(i=>i.id===t);if(a===-1)return null;const[r]=s.incidences.splice(a,1);return s.count=Math.max(0,(s.count??s.incidences.length)-1),r},ie=(e,t,s=0)=>{const a=g.value.find(i=>i.id===e);if(!a)return;Array.isArray(a.incidences)||(a.incidences=[]);const r=Math.max(0,Math.min(s,a.incidences.length));a.incidences.splice(r,0,t),a.count=(a.count??0)+1},D=e=>!!(e!=null&&e.archived_at),z=e=>{e!=null&&e.id&&window.dispatchEvent(new CustomEvent("incidencias:edit",{detail:{incidence:e}}))},Y=e=>{var s,a,r;const t=(s=e==null?void 0:e.detail)==null?void 0:s.incidence;if(t!=null&&t.id)for(const i of g.value){const d=((r=(a=i==null?void 0:i.incidences)==null?void 0:a.findIndex)==null?void 0:r.call(a,c=>c.id===t.id))??-1;if(d!==-1){i.incidences.splice(d,1,{...i.incidences[d],...t});break}}},de=(e,t)=>{if(D(e))return;f.value=e,I.value=(e==null?void 0:e.stage_id)??null,k.value=e.id,E.value=!1;const s=g.value.find(a=>a.id===((e==null?void 0:e.stage_id)??null));if(s&&Array.isArray(s.incidences)){const a=s.incidences.findIndex(r=>r.id===e.id);_.value={stageId:s.id,index:a}}else _.value=null;h.value=!1},le=(e=!1)=>{var s;if(!h.value)return;const t=((s=f.value)==null?void 0:s.id)??null;if(t!=null){for(const a of g.value){if(!Array.isArray(a.incidences))continue;const r=a.incidences.findIndex(i=>i.id===t);r!==-1&&a.incidences.splice(r,1)}if(e&&_.value){const a=g.value.find(r=>r.id===_.value.stageId);if(a){Array.isArray(a.incidences)||(a.incidences=[]);const r=Math.max(0,Math.min(_.value.index??a.incidences.length,a.incidences.length));a.incidences.splice(r,0,f.value)}}h.value=!1,L.value={incidenceId:null,position:"after",stageId:null}}},oe=()=>{!E.value&&h.value&&le(!0),f.value=null,I.value=null,k.value=null,h.value=!1,E.value=!1,L.value={incidenceId:null,position:"after",stageId:null},_.value=null};let M=null;const ce=(e,t,s)=>{f.value&&(M&&clearTimeout(M),M=setTimeout(()=>{ue(e,t,s)},16))},ue=(e,t,s)=>{var T;if(!f.value)return;const a=s.currentTarget.closest("section[data-stage-id]");if(!a)return;const r=a.querySelector(".p-3");if(!r)return;const i=r.querySelectorAll("article[data-incidence-id]"),d=Array.from(i).filter(l=>Number(l.getAttribute("data-incidence-id"))!==f.value.id);if(d.length===0){G(t.id,0),L.value={incidenceId:null,position:"top",stageId:t.id};return}const c=s.clientY;let x=d.length;for(let l=0;l<d.length;l++){const m=d[l].getBoundingClientRect(),b=m.top+m.height/2;if(c<b){x=l;break}}G(t.id,x);const C=x>0?Number((T=d[x-1])==null?void 0:T.getAttribute("data-incidence-id")):null;L.value={incidenceId:C,position:x===0?"before":"after",stageId:t.id}},G=(e,t)=>{var d;if(!f.value)return;const s=f.value,a=g.value.find(c=>c.id===e);if(!a||(((d=a.incidences)==null?void 0:d.findIndex(c=>c.id===s.id))??-1)===t)return;g.value.forEach(c=>{if(!Array.isArray(c.incidences))return;const x=c.incidences.findIndex(C=>C.id===s.id);x!==-1&&c.incidences.splice(x,1)}),Array.isArray(a.incidences)||(a.incidences=[]);const i=Math.max(0,Math.min(t,a.incidences.length));a.incidences.splice(i,0,s),h.value=!0},J=async(e,t=null,s=null)=>{var d,c,x,C,T;const a=f.value,r=I.value;if(!(a!=null&&a.id)||!r||!(e!=null&&e.id)){f.value=null,I.value=null,k.value=null;return}if(h.value){E.value=!0;const l=a.id,m=g.value.find(b=>b.id===e.id);if(!m)return;try{r!==e.id&&await N.patch(`/incidencias/${l}/move-stage`,{stage_id:e.id});const b=m.incidences.map(j=>j.id);await N.patch("/incidencias/reorder",{stage_id:e.id,ordered_ids:b}),h.value=!1,L.value={incidenceId:null,position:"after",stageId:null},f.value=null,I.value=null,k.value=null,_.value=null,E.value=!1,y.value="",H("Incidencia actualizada")}catch{y.value="Error al mover la incidencia",await A({showLoading:!1})}return}if(r===e.id)return;y.value="";const i=R(r,a.id);i&&(i.stage_id=e.id,ie(e.id,i,0));try{const l=await N.patch(`/incidencias/${a.id}/move-stage`,{stage_id:e.id}),m=(d=l==null?void 0:l.data)==null?void 0:d.data;if(m&&typeof m=="object"){const b=(x=(c=g.value.find(j=>j.id===e.id))==null?void 0:c.incidences)==null?void 0:x.find(j=>j.id===a.id);b&&Object.assign(b,m)}H("Incidencia actualizada")}catch(l){const m=((T=(C=l==null?void 0:l.response)==null?void 0:C.data)==null?void 0:T.message)??"No se pudo mover la incidencia.";y.value=m,ee(m),await A({showLoading:!1})}finally{f.value=null,I.value=null,k.value=null}},ve=async(e,t)=>{var a,r;if(!(!(e!=null&&e.id)||!(t!=null&&t.is_done)||!await xe({title:"Archivar incidencia",text:"Se ocultará del backlog, pero seguirá visible en la tabla (historial).",confirmText:"Archivar",cancelText:"Cancelar",icon:"warning"}))){P.value.add(e.id),y.value="";try{await N.patch(`/incidencias/${e.id}/archive`),R(t.id,e.id),H("Incidencia archivada"),window.dispatchEvent(new CustomEvent("incidencias:archived"))}catch(i){const d=((r=(a=i==null?void 0:i.response)==null?void 0:a.data)==null?void 0:r.message)??"No se pudo archivar la incidencia.";y.value=d,ee(d)}finally{P.value.delete(e.id)}}},S=()=>A({showLoading:!1});return fe(async()=>{window.addEventListener("incidencias:created",S),window.addEventListener("incidencias:archived",S),window.addEventListener("incidencias:updated",Y),await A()}),me(()=>{window.removeEventListener("incidencias:created",S),window.removeEventListener("incidencias:archived",S),window.removeEventListener("incidencias:updated",Y),M&&clearTimeout(M)}),(e,t)=>(v(),u("div",null,[t[13]||(t[13]=n("div",{class:"mb-4 text-sm text-gray-600 dark:text-slate-300"}," Arrastra una incidencia entre columnas para cambiar su estado, o dentro de una columna para reordenar. ",-1)),n("div",be,[n("div",pe,[t[8]||(t[8]=n("label",{class:"text-xs text-gray-600 dark:text-slate-300"},"Limite:",-1)),U(n("select",{"onUpdate:modelValue":t[0]||(t[0]=s=>O.value=s),class:"rounded-lg border border-gray-200 bg-white px-2 py-1 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:focus:ring-blue-900/30"},[...t[7]||(t[7]=[n("option",{value:20},"20",-1),n("option",{value:50},"50",-1),n("option",{value:100},"100",-1),n("option",{value:250},"250",-1)])],512),[[K,O.value,void 0,{number:!0}]])]),n("div",ye,[t[9]||(t[9]=n("label",{class:"text-xs text-gray-600 dark:text-slate-300"},"Desde:",-1)),U(n("input",{"onUpdate:modelValue":t[1]||(t[1]=s=>$.value=s),type:"date",class:"rounded-lg border border-gray-200 bg-white px-2 py-1 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 placeholder:text-gray-400 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:placeholder:text-slate-500 dark:focus:ring-blue-900/30 dark:[color-scheme:dark]"},null,512),[[Q,$.value]])]),n("div",ke,[t[10]||(t[10]=n("label",{class:"text-xs text-gray-600 dark:text-slate-300"},"Hasta:",-1)),U(n("input",{"onUpdate:modelValue":t[2]||(t[2]=s=>B.value=s),type:"date",class:"rounded-lg border border-gray-200 bg-white px-2 py-1 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 placeholder:text-gray-400 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:placeholder:text-slate-500 dark:focus:ring-blue-900/30 dark:[color-scheme:dark]"},null,512),[[Q,B.value]])]),n("div",he,[t[12]||(t[12]=n("label",{class:"text-xs text-gray-600 dark:text-slate-300"},"Prioridad:",-1)),U(n("select",{"onUpdate:modelValue":t[3]||(t[3]=s=>F.value=s),class:"rounded-lg border border-gray-200 bg-white px-2 py-1 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:focus:ring-blue-900/30"},[...t[11]||(t[11]=[n("option",{value:""},"Todas",-1),n("option",{value:"alta"},"Alta",-1),n("option",{value:"media"},"Media",-1),n("option",{value:"baja"},"Baja",-1)])],512),[[K,F.value]])]),n("div",{class:"flex items-center gap-2 ms-auto"},[n("button",{onClick:se,class:"inline-flex items-center rounded-lg bg-blue-600 px-3 py-1 text-sm text-white hover:bg-blue-700"}," Aplicar "),n("button",{onClick:ne,class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1 text-sm text-gray-700 shadow-sm hover:bg-gray-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800"}," Limpiar ")])]),V.value?(v(),u("div",we,"Cargando...")):y.value?(v(),u("div",_e,w(y.value),1)):(v(),u("div",{key:2,class:q(["grid gap-4",te.value])},[(v(!0),u(W,null,X(g.value,s=>{var a;return v(),u("section",{key:s.id,"data-stage-id":s.id,class:"bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden dark:bg-slate-900 dark:border-slate-800",onDragover:t[6]||(t[6]=p(()=>{},["prevent"])),onDrop:p(r=>J(s),["prevent"])},[n("div",Ae,[n("div",De,[n("div",Ce,w(s.name),1),n("div",Ee,w(s.count),1)])]),n("div",Le,[(((a=s.incidences)==null?void 0:a.length)??0)===0?(v(),u("div",Me," Sin incidencias. ")):Z("",!0),(v(!0),u(W,null,X(s.incidences,r=>(v(),u("div",{key:r.id,"data-incidence-id":r.id},[n("article",{"data-incidence-id":r.id,class:q(["select-none bg-gray-50 border border-gray-200 rounded-lg p-3 dark:bg-slate-800 dark:border-slate-700",{"scale-105 shadow-lg opacity-90 z-50 transform":k.value===r.id,"opacity-50":k.value&&k.value!==r.id,"cursor-not-allowed opacity-80":D(r),"cursor-grab active:cursor-grabbing hover:bg-blue-50/30 dark:hover:bg-slate-800/50":!D(r)}]),draggable:!D(r),onDragstart:i=>de(r),onDragend:oe,onDragover:p(i=>ce(r,s,i),["prevent"]),onDrop:p(i=>J(s,r,i),["prevent"]),onClick:i=>z(r)},[n("div",Ne,[n("div",null,[n("div",Oe,w(r.title),1),r.customer?(v(),u("div",$e,w(r.customer.company_name||r.customer.name),1)):(v(),u("div",Be,"Sin cliente"))]),n("div",{class:q(["text-xs",re(r.priority)])},w(r.priority||"Normal"),3)]),r.date?(v(),u("div",Fe,w(ae(r.date)),1)):Z("",!0),s.is_done?(v(),u("div",Pe,[n("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:D(r),onMousedown:t[4]||(t[4]=p(()=>{},["stop"])),onClick:p(i=>z(r),["stop","prevent"])}," Editar ",40,Se),n("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:P.value.has(r.id),onClick:p(i=>ve(r,s),["stop","prevent"])},w(P.value.has(r.id)?"Archivando…":"Archivar"),9,Ue)])):(v(),u("div",Ve,[n("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:D(r),onMousedown:t[5]||(t[5]=p(()=>{},["stop"])),onClick:p(i=>z(r),["stop","prevent"])}," Editar ",40,ze)]))],42,je)],8,Te))),128))])],40,Ie)}),128))],2))]))}};export{Qe as default};
