import{r as g,e as te,o as ae,g as o,i as l,j as t,k as x,n as M,w as S,x as z,z as m,D as se,F as D,m as L,t as r,J as re}from"./vendor-vue-Db-AqoDh.js";import{a as A}from"./vendor-utils-Czy7fllw.js";const oe={class:"grid gap-4 lg:grid-cols-2"},le={class:"bg-white border border-gray-200 rounded-lg shadow-sm dark:bg-slate-900 dark:border-slate-800"},ne={class:"p-4 space-y-4"},de={class:"inline-flex rounded-lg border border-gray-200 bg-white p-1 shadow-sm dark:border-slate-800 dark:bg-slate-900"},ie={class:"flex items-center justify-between gap-3"},ue={class:"flex flex-wrap gap-2"},ge={class:"grid gap-3 sm:grid-cols-3"},ce={key:0},pe=["value"],me={class:"flex items-center gap-2"},be={class:"ml-2 inline-flex items-center gap-2 text-xs text-gray-700 dark:text-slate-200"},xe=["disabled"],ve=["disabled"],ye={key:0,class:"rounded-lg border border-red-200 bg-red-50 p-3 text-sm text-red-700 dark:border-red-900/40 dark:bg-red-950/30 dark:text-red-200"},he={key:1,class:"text-xs text-gray-600 dark:text-slate-300"},ke={class:"font-semibold"},fe={class:"font-semibold"},_e={class:"font-semibold"},we={key:0},Ce={class:"rounded-lg border border-gray-200 dark:border-slate-800 overflow-hidden"},Se={class:"flex items-center gap-3 bg-gray-50 px-3 py-2 text-xs text-gray-600 dark:bg-slate-800 dark:text-slate-200"},$e={class:"inline-flex items-center gap-2"},Ae=["checked"],Ee={class:"ml-auto"},je={class:"max-h-[360px] overflow-y-auto bg-white dark:bg-slate-900"},Ne=["checked","onChange"],Ve={class:"min-w-0 flex-1"},We={class:"truncate text-gray-900 dark:text-slate-100"},ze={key:0,class:"text-gray-500 dark:text-slate-400"},De={class:"mt-0.5 flex items-center gap-2 text-xs text-gray-600 dark:text-slate-300"},Le={key:0},Ue={key:0,class:"p-3 text-sm text-gray-600 dark:text-slate-300"},qe={class:"flex items-center gap-2"},Me=["disabled"],Ie={key:0,class:"text-xs text-gray-600 dark:text-slate-300"},Re={class:"font-semibold"},Be={key:2,class:"rounded-lg border border-red-200 bg-red-50 p-3 text-sm text-red-700 dark:border-red-900/40 dark:bg-red-950/30 dark:text-red-200"},He={class:"bg-white border border-gray-200 rounded-lg shadow-sm dark:bg-slate-900 dark:border-slate-800"},Te={class:"p-4 border-b border-gray-200 dark:border-slate-800 flex items-center justify-between"},Oe=["disabled"],Fe={class:"p-4 space-y-4"},Pe={key:0,class:"space-y-3"},Je={class:"text-sm font-semibold text-gray-900 dark:text-slate-100"},Ge={key:0,class:"text-gray-500 dark:text-slate-400"},Ke={class:"rounded-lg border border-gray-200 dark:border-slate-800 overflow-hidden"},Qe={class:"max-h-[520px] overflow-y-auto"},Xe={class:"flex items-start justify-between gap-3"},Ye={class:"min-w-0"},Ze={class:"truncate text-gray-900 dark:text-slate-100"},et={class:"text-gray-500 dark:text-slate-400"},tt={class:"mt-1 whitespace-pre-wrap rounded-md bg-gray-50 p-2 text-xs text-gray-700 dark:bg-slate-800 dark:text-slate-200"},at={class:"flex flex-col gap-2"},st=["href","onClick"],rt=["onClick"],ot={class:"text-[11px] text-gray-500 dark:text-slate-400"},lt={class:"font-semibold"},nt={key:0,class:"p-3 text-sm text-gray-600 dark:text-slate-300"},dt={key:1,class:"text-sm text-gray-600 dark:text-slate-300"},it={key:2,class:"rounded-lg border border-red-200 bg-red-50 p-3 text-sm text-red-700 dark:border-red-900/40 dark:bg-red-950/30 dark:text-red-200"},ut={key:3,class:"space-y-2"},gt={class:"grid gap-2"},ct=["onClick"],pt={key:0,class:"text-gray-500 dark:text-slate-400"},mt={class:"text-xs text-gray-500 dark:text-slate-400"},yt={__name:"LeadsWhatsAppCampaign",setup(bt){const I=g([]),h=g([]),k=g("leads"),f=g({total:0,without_phone:0}),E=g(!1),j=g(""),N=g(!1),$=g(""),w=g(null),V=g(!1),C=g(""),U=g([]),v=g(null),y=g(new Set),b=g({name:"",message_template:"Hola {{first_name}}, te escribo para…"}),u=g({stage_id:null,q:"",limit:200,only_with_phone:!1}),R=te(()=>h.value.length>0&&y.value.size===h.value.length),F=()=>{if(R.value){y.value=new Set;return}y.value=new Set(h.value.map(s=>s.id))},P=s=>{const e=new Set(y.value);e.has(s)?e.delete(s):e.add(s),y.value=e},B=s=>{b.value.message_template=`${b.value.message_template}${b.value.message_template.endsWith(" ")?"":" "}${s}`},q=async()=>{var s,e,a,n,c,d,i,_;E.value=!0,j.value="";try{const p={source:k.value,q:u.value.q,limit:u.value.limit,only_with_phone:u.value.only_with_phone?1:0};k.value==="leads"&&u.value.stage_id!==null&&(p.stage_id=u.value.stage_id),console.log("Loading recipients with params:",p);const W=await A.get("/leads/whatsapp/recipients",{params:p});console.log("Recipients response:",W.data),I.value=((e=(s=W.data)==null?void 0:s.data)==null?void 0:e.stages)??[],h.value=((n=(a=W.data)==null?void 0:a.data)==null?void 0:n.contacts)??[],f.value=((d=(c=W.data)==null?void 0:c.data)==null?void 0:d.counts)??{total:0,without_phone:0},(f.value.total??0)>0&&(f.value.with_phone??0)===0&&(u.value.only_with_phone=!1),y.value=new Set(h.value.map(ee=>ee.id))}catch(p){console.error("Error loading recipients:",p),j.value=((_=(i=p==null?void 0:p.response)==null?void 0:i.data)==null?void 0:_.message)||(p==null?void 0:p.message)||"No se pudieron cargar destinatarios."}finally{E.value=!1}},H=s=>{k.value=s,u.value.stage_id=null,q()},J=async()=>{var s,e,a,n,c,d;N.value=!0,$.value="",w.value=null;try{const i=Array.from(y.value);console.log("Creating campaign with:",{name:b.value.name||null,message_template:b.value.message_template,source:k.value,ids:i});const _=await A.post("/leads/whatsapp-campaigns",{name:b.value.name||null,message_template:b.value.message_template,source:k.value,ids:i});console.log("Campaign created:",_.data),w.value=((e=(s=_.data)==null?void 0:s.data)==null?void 0:e.campaign_id)??null,w.value&&await T(w.value);const p=((n=(a=_.data)==null?void 0:a.data)==null?void 0:n.skipped_missing_phone_ids)??[];Array.isArray(p)&&p.length>0&&($.value=`Se omitieron ${p.length} registros sin teléfono.`)}catch(i){console.error("Error creating campaign:",i),$.value=((d=(c=i==null?void 0:i.response)==null?void 0:c.data)==null?void 0:d.message)||(i==null?void 0:i.message)||"No se pudo crear la campaña."}finally{N.value=!1}},G=async()=>{var s,e,a,n;V.value=!0,C.value="";try{const c=await A.get("/leads/whatsapp-campaigns");U.value=((e=(s=c.data)==null?void 0:s.data)==null?void 0:e.campaigns)??[]}catch(c){C.value=((n=(a=c==null?void 0:c.response)==null?void 0:a.data)==null?void 0:n.message)||"No se pudo cargar el historial."}finally{V.value=!1}},T=async s=>{var e,a,n,c;C.value="";try{console.log("Opening campaign:",s);const d=await A.get(`/leads/whatsapp-campaigns/${s}`);console.log("Campaign data:",d.data),v.value=((a=(e=d.data)==null?void 0:e.data)==null?void 0:a.campaign)??null}catch(d){console.error("Error opening campaign:",d),C.value=((c=(n=d==null?void 0:d.response)==null?void 0:n.data)==null?void 0:c.message)||(d==null?void 0:d.message)||"No se pudo abrir la campaña."}},K=s=>{if(!s)return"";const e=String(s).replace(/\D+/g,"");return!e||e.length<8?"":e.length===9&&e.startsWith("9")?`51${e}`:e.startsWith("51")&&e.length>=11||e.length>=10?e:""},Q=(s,e)=>{const a=K(s);if(!a)return console.warn("Invalid phone number for WhatsApp link:",s),"#";const n=encodeURIComponent(e||"");return`https://wa.me/${a}?text=${n}`},O=async(s,e)=>{var a,n;try{const d=(n=(a=(await A.patch(`/leads/whatsapp-campaign-recipients/${s}`,e)).data)==null?void 0:a.data)==null?void 0:n.recipient;if(!v.value||!d)return;const i=v.value.recipients.findIndex(_=>_.id===s);if(i===-1)return;v.value.recipients[i]={...v.value.recipients[i],...d}}catch{}},X=s=>{s!=null&&s.id&&s.status==="pending"&&(O(s.id,{status:"opened"}),s.status="opened")},Y=s=>{s!=null&&s.id&&(O(s.id,{status:"sent"}),s.status="sent")},Z=s=>{if(!s)return"";try{return new Date(s).toLocaleString()}catch{return String(s)}};return ae(()=>{q()}),(s,e)=>(l(),o("section",null,[t("div",oe,[t("div",le,[e[24]||(e[24]=t("div",{class:"p-4 border-b border-gray-200 dark:border-slate-800"},[t("div",{class:"text-sm font-semibold text-gray-900 dark:text-slate-100"},"Nueva campaña WhatsApp (manual asistido)"),t("div",{class:"mt-1 text-xs text-gray-600 dark:text-slate-300"}," El sistema genera mensajes personalizados y abre WhatsApp. No envía automáticamente (sin API). ")],-1)),t("div",ne,[t("div",de,[t("button",{type:"button",class:M(["px-3 py-2 text-sm font-medium rounded-md transition",k.value==="leads"?"bg-blue-600 text-white":"text-gray-700 hover:bg-gray-50 dark:text-slate-200 dark:hover:bg-slate-800"]),onClick:e[0]||(e[0]=a=>H("leads"))}," Leads ",2),t("button",{type:"button",class:M(["px-3 py-2 text-sm font-medium rounded-md transition",k.value==="customers"?"bg-blue-600 text-white":"text-gray-700 hover:bg-gray-50 dark:text-slate-200 dark:hover:bg-slate-800"]),onClick:e[1]||(e[1]=a=>H("customers"))}," Clientes ",2)]),t("div",null,[e[10]||(e[10]=t("label",{class:"block text-xs font-medium text-gray-700 dark:text-slate-200"},"Nombre (opcional)",-1)),S(t("input",{"onUpdate:modelValue":e[2]||(e[2]=a=>b.value.name=a),type:"text",class:"mt-1 w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:focus:ring-blue-900/30",placeholder:"Ej: Aviso de promoción Enero"},null,512),[[z,b.value.name]])]),t("div",null,[t("div",ie,[e[11]||(e[11]=t("label",{class:"block text-xs font-medium text-gray-700 dark:text-slate-200"},"Mensaje",-1)),t("div",ue,[t("button",{type:"button",class:"rounded-md border border-gray-200 bg-white px-2 py-1 text-xs text-gray-700 shadow-sm hover:bg-gray-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",onClick:e[3]||(e[3]=a=>B("{{first_name}}"))}," + first_name "),t("button",{type:"button",class:"rounded-md border border-gray-200 bg-white px-2 py-1 text-xs text-gray-700 shadow-sm hover:bg-gray-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",onClick:e[4]||(e[4]=a=>B("{{company_name}}"))}," + company_name ")])]),S(t("textarea",{"onUpdate:modelValue":e[5]||(e[5]=a=>b.value.message_template=a),rows:"6",class:"mt-1 w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 placeholder:text-gray-400 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:placeholder:text-slate-500 dark:focus:ring-blue-900/30",placeholder:"Hola {{first_name}}, te escribo por..."},null,512),[[z,b.value.message_template]]),e[12]||(e[12]=t("div",{class:"mt-1 text-xs text-gray-500 dark:text-slate-400"},[m(" Variables: "),t("span",{class:"font-mono"},"{{first_name}}"),m(", "),t("span",{class:"font-mono"},"{{company_name}}")],-1))]),t("div",ge,[k.value==="leads"?(l(),o("div",ce,[e[14]||(e[14]=t("label",{class:"block text-xs font-medium text-gray-700 dark:text-slate-200"},"Etapa",-1)),S(t("select",{"onUpdate:modelValue":e[6]||(e[6]=a=>u.value.stage_id=a),class:"mt-1 w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:focus:ring-blue-900/30"},[e[13]||(e[13]=t("option",{value:null},"Todas",-1)),(l(!0),o(D,null,L(I.value,a=>(l(),o("option",{key:a.id,value:a.id},r(a.name),9,pe))),128))],512),[[se,u.value.stage_id,void 0,{number:!0}]])])):x("",!0),t("div",{class:M(k.value==="leads"?"sm:col-span-2":"sm:col-span-3")},[e[15]||(e[15]=t("label",{class:"block text-xs font-medium text-gray-700 dark:text-slate-200"},"Buscar",-1)),S(t("input",{"onUpdate:modelValue":e[7]||(e[7]=a=>u.value.q=a),type:"search",class:"mt-1 w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 placeholder:text-gray-400 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:placeholder:text-slate-500 dark:focus:ring-blue-900/30",placeholder:"Nombre, empresa, teléfono…"},null,512),[[z,u.value.q]])],2)]),t("div",me,[e[17]||(e[17]=t("label",{class:"text-xs font-medium text-gray-700 dark:text-slate-200"},"Límite",-1)),S(t("input",{"onUpdate:modelValue":e[8]||(e[8]=a=>u.value.limit=a),type:"number",min:"1",max:"500",class:"w-28 rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:focus:ring-blue-900/30"},null,512),[[z,u.value.limit,void 0,{number:!0}]]),t("label",be,[S(t("input",{type:"checkbox","onUpdate:modelValue":e[9]||(e[9]=a=>u.value.only_with_phone=a),disabled:(f.value.total??0)>0&&(f.value.with_phone??0)===0},null,8,xe),[[re,u.value.only_with_phone]]),e[16]||(e[16]=m(" Solo con teléfono ",-1))]),t("button",{type:"button",class:"ml-auto inline-flex items-center rounded-lg bg-blue-600 px-3 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:ring-4 focus:ring-blue-200",disabled:E.value,onClick:q},r(E.value?"Cargando…":"Cargar destinatarios"),9,ve)]),j.value?(l(),o("div",ye,r(j.value),1)):(l(),o("div",he,[e[19]||(e[19]=m(" Total: ",-1)),t("span",ke,r(f.value.total),1),e[20]||(e[20]=m(" · Con teléfono: ",-1)),t("span",fe,r(f.value.with_phone??0),1),e[21]||(e[21]=m(" · Sin teléfono: ",-1)),t("span",_e,r(f.value.without_phone??0),1),u.value.only_with_phone&&h.value.length===0&&(f.value.without_phone??0)>0?(l(),o("span",we,[...e[18]||(e[18]=[m(" · Desmarca ",-1),t("span",{class:"font-semibold"},"Solo con teléfono",-1),m(" para verlos. ",-1)])])):x("",!0)])),t("div",Ce,[t("div",Se,[t("label",$e,[t("input",{type:"checkbox",checked:R.value,onChange:F},null,40,Ae),e[22]||(e[22]=m(" Seleccionar todos ",-1))]),t("div",Ee,"Seleccionados: "+r(y.value.size)+" / "+r(h.value.length),1)]),t("div",je,[(l(!0),o(D,null,L(h.value,a=>(l(),o("div",{key:a.id,class:"flex items-center gap-3 border-t border-gray-100 px-3 py-2 text-sm dark:border-slate-800"},[t("input",{type:"checkbox",checked:y.value.has(a.id),onChange:n=>P(a.id)},null,40,Ne),t("div",Ve,[t("div",We,[m(r(a.display_name||"Sin nombre")+" ",1),a.secondary?(l(),o("span",ze,"· "+r(a.secondary),1)):x("",!0)]),t("div",De,[t("span",null,r(a.phone||"Sin teléfono"),1),a.stage_name?(l(),o("span",Le,"· "+r(a.stage_name),1)):x("",!0)])])]))),128)),h.value.length===0?(l(),o("div",Ue," No hay resultados con esos filtros. ")):x("",!0)])]),t("div",qe,[t("button",{type:"button",class:"inline-flex items-center rounded-lg bg-emerald-600 px-3 py-2 text-sm font-medium text-white shadow-sm hover:bg-emerald-700 focus:ring-4 focus:ring-emerald-200 disabled:opacity-50",disabled:N.value||y.value.size===0||!b.value.message_template.trim(),onClick:J},r(N.value?"Creando…":"Crear campaña"),9,Me),w.value?(l(),o("div",Ie,[e[23]||(e[23]=m(" Campaña creada: ",-1)),t("span",Re,"#"+r(w.value),1)])):x("",!0)]),$.value?(l(),o("div",Be,r($.value),1)):x("",!0)])]),t("div",He,[t("div",Te,[e[25]||(e[25]=t("div",null,[t("div",{class:"text-sm font-semibold text-gray-900 dark:text-slate-100"},"Ejecución"),t("div",{class:"mt-1 text-xs text-gray-600 dark:text-slate-300"}," Abre WhatsApp con mensaje prellenado y marca el estado. ")],-1)),t("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:V.value,onClick:G},r(V.value?"Cargando…":"Ver últimas campañas"),9,Oe)]),t("div",Fe,[v.value?(l(),o("div",Pe,[t("div",Je,[m(" Campaña #"+r(v.value.id)+" ",1),v.value.name?(l(),o("span",Ge,"· "+r(v.value.name),1)):x("",!0)]),t("div",Ke,[t("div",Qe,[(l(!0),o(D,null,L(v.value.recipients,a=>(l(),o("div",{key:a.id,class:"border-t border-gray-100 p-3 text-sm dark:border-slate-800"},[t("div",Xe,[t("div",Ye,[t("div",Ze,[m(r(a.display_name||"Sin nombre")+" ",1),t("span",et,"· "+r(a.phone),1)]),t("div",tt,r(a.rendered_message),1)]),t("div",at,[t("a",{class:"inline-flex items-center justify-center rounded-lg bg-blue-600 px-3 py-2 text-xs font-medium text-white shadow-sm hover:bg-blue-700",href:Q(a.phone,a.rendered_message),target:"_blank",rel:"noopener",onClick:n=>X(a)}," Abrir WhatsApp ",8,st),t("button",{type:"button",class:"inline-flex items-center justify-center rounded-lg border border-gray-200 bg-white px-3 py-2 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",onClick:n=>Y(a)}," Marcar enviado ",8,rt),t("div",ot,[e[26]||(e[26]=m(" Estado: ",-1)),t("span",lt,r(a.status),1)])])])]))),128)),v.value.recipients.length===0?(l(),o("div",nt," Sin destinatarios. ")):x("",!0)])])])):(l(),o("div",dt," Crea una campaña a la izquierda o carga una campaña reciente. ")),C.value?(l(),o("div",it,r(C.value),1)):x("",!0),U.value.length>0?(l(),o("div",ut,[e[27]||(e[27]=t("div",{class:"text-xs font-semibold text-gray-700 dark:text-slate-200"},"Últimas campañas",-1)),t("div",gt,[(l(!0),o(D,null,L(U.value,a=>(l(),o("button",{key:a.id,type:"button",class:"flex items-center justify-between rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-700 shadow-sm hover:bg-gray-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",onClick:n=>T(a.id)},[t("span",null,[m(" #"+r(a.id)+" ",1),a.name?(l(),o("span",pt,"· "+r(a.name),1)):x("",!0)]),t("span",mt,r(Z(a.created_at)),1)],8,ct))),128))])])):x("",!0)])])])]))}};export{yt as default};
