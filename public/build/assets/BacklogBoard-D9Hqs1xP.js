import{r as g,e as ye,o as ke,f as he,g as v,i as m,j as d,w as U,D as Z,x as ee,t as k,n as R,F as te,m as ae,l as b,k as V,s as we}from"./vendor-vue-Db-AqoDh.js";import{a as D}from"./vendor-utils-Czy7fllw.js";import{a as q,t as Y,c as se}from"./App-qLal-Xme.js";import"./app-Wix60hZj.js";import"./vendor-ui-DEm6YKEA.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const _e={class:"mb-4 flex items-center gap-3"},Ie={class:"flex items-center gap-2"},Ce={class:"flex items-center gap-2"},Ee={class:"flex items-center gap-2"},De={class:"flex items-center gap-2"},Ae={key:0,class:"text-sm text-gray-600 dark:text-slate-300"},Me={key:1,class:"mb-3 text-sm text-red-600"},Se=["data-stage-id","onDrop"],Le={class:"p-4 border-b border-gray-200 dark:border-slate-800"},$e={class:"flex items-center justify-between gap-3"},je={class:"text-sm font-semibold text-gray-900 dark:text-slate-100"},Ne={class:"text-xs text-gray-600 dark:text-slate-300"},Te={class:"p-3 space-y-3 min-h-[140px]"},Fe={key:0,class:"text-sm text-gray-500 dark:text-slate-400 px-1"},Pe=["data-incidence-id"],Be={key:0,class:"h-1 bg-blue-500 rounded-full mx-3 mb-2 animate-pulse transition-all duration-200"},Oe=["data-incidence-id","draggable","onDragstart","onClick"],Ue=["onClick"],Ve={class:"text-sm font-semibold text-gray-900 dark:text-slate-100"},qe={key:0,class:"text-xs text-gray-600 dark:text-slate-300 mt-1"},Ye={key:1,class:"text-xs text-gray-500 dark:text-slate-400 mt-1"},ze=["onClick"],He={key:1,class:"mt-3 flex justify-end gap-2"},Re=["disabled","onClick"],Ge=["disabled","onClick"],Je=["disabled","onClick"],Ke={key:2,class:"mt-3 flex justify-end gap-2"},Qe=["disabled","onClick"],We=["disabled","onClick"],Xe={key:1,class:"h-1 bg-blue-500 rounded-full mx-3 mt-2 animate-pulse transition-all duration-200"},dt={__name:"BacklogBoard",setup(Ze){const z=g(!0),x=g([]),y=g(""),L=g(50),$=g(""),j=g(""),N=g(""),p=g(null),re=g(null),T=g(null),I=g(null),C=g(null),H=g(null),F=g(!1),A=g(!1),E=g(null),P=g(new Set),ne=ye(()=>{const e=x.value.length||1;return e<=1?"grid-cols-1":e===2?"grid-cols-1 md:grid-cols-2":e===3?"grid-cols-1 md:grid-cols-3":"grid-cols-1 md:grid-cols-2 xl:grid-cols-4"}),de=e=>{if(!e)return"";try{const t=new Date(String(e));return Number.isNaN(t.getTime())?String(e):t.toLocaleDateString()}catch{return String(e)}},ie=e=>{switch(e==null?void 0:e.toLowerCase()){case"alta":return"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200 px-2 py-0.5 rounded font-medium";case"media":return"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200 px-2 py-0.5 rounded font-medium";case"baja":return"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 px-2 py-0.5 rounded font-medium";default:return"text-gray-700 dark:text-slate-200"}},h=async({showLoading:e=!0}={})=>{var t,r;e&&(z.value=!0);try{const a=await D.get("/backlog/board-data",{params:{limit:L.value,date_from:$.value||null,date_to:j.value||null,priority:N.value||null}});x.value=((r=(t=a==null?void 0:a.data)==null?void 0:t.data)==null?void 0:r.stages)??[]}finally{e&&(z.value=!1)}},oe=()=>{h()},le=()=>{$.value="",j.value="",N.value="",L.value=50,h()},f=e=>!!(e!=null&&e.archived_at),M=e=>{e!=null&&e.id&&window.dispatchEvent(new CustomEvent("incidencias:edit",{detail:{incidence:e}}))},G=e=>{var r,a,n;const t=(r=e==null?void 0:e.detail)==null?void 0:r.incidence;if(t!=null&&t.id)for(const s of x.value){const i=((n=(a=s==null?void 0:s.incidences)==null?void 0:a.findIndex)==null?void 0:n.call(a,c=>c.id===t.id))??-1;if(i!==-1){s.incidences.splice(i,1,{...s.incidences[i],...t});break}}},ce=(e,t,r)=>{if(f(e))return;p.value=e,T.value=(e==null?void 0:e.stage_id)??null,H.value=e.id,F.value=!1;const a=x.value.find(n=>n.id===((e==null?void 0:e.stage_id)??null));if(a&&Array.isArray(a.incidences)){const n=a.incidences.findIndex(s=>s.id===e.id);E.value={stageId:a.id,index:n}}else E.value=null;A.value=!1},ue=(e=!1)=>{var r;if(!A.value)return;const t=((r=p.value)==null?void 0:r.id)??null;if(t!=null){for(const a of x.value){if(!Array.isArray(a.incidences))continue;const n=a.incidences.findIndex(s=>s.id===t);n!==-1&&a.incidences.splice(n,1)}if(e&&E.value){const a=x.value.find(n=>n.id===E.value.stageId);if(a){Array.isArray(a.incidences)||(a.incidences=[]);const n=Math.max(0,Math.min(E.value.index??a.incidences.length,a.incidences.length));a.incidences.splice(n,0,p.value)}}A.value=!1,I.value=null,C.value=null}},ge=()=>{!F.value&&A.value&&ue(!0),p.value=null,T.value=null,H.value=null,A.value=!1,F.value=!1,I.value=null,C.value=null,E.value=null},ve=async(e,t)=>{var n,s;if(t.preventDefault(),!p.value||!e)return;F.value=!0;const r=p.value,a=T.value;if(f(r)){y.value="Esta incidencia está bloqueada y no se puede mover.";return}y.value="";try{const i=t.clientY,c=Q(e,i,r.id);if(a===e.id)pe(e.id,r.id,c),q("Incidencia reordenada");else{J(a,r.id);const u={...r,stage_id:e.id};me(e.id,u,c),D.patch(`/incidencias/${r.id}/move-stage`,{stage_id:e.id}).then(l=>{var _,X;const o=(_=l==null?void 0:l.data)==null?void 0:_.data;if(o){const S=x.value.find(O=>O.id===e.id);if(S){const O=S.incidences.findIndex(fe=>fe.id===r.id);O!==-1&&Object.assign(S.incidences[O],o)}}const w=((X=e.incidences)==null?void 0:X.map(S=>S.id))||[];return D.patch("/incidencias/reorder",{stage_id:e.id,ordered_ids:w})}).then(()=>{q("Incidencia movida correctamente")}).catch(l=>{var w,_;console.error("Error moving incidence:",l);const o=((_=(w=l==null?void 0:l.response)==null?void 0:w.data)==null?void 0:_.message)??"No se pudo mover la incidencia.";y.value=o,Y(o),h({showLoading:!1})})}}catch(i){console.error("Error in onDropOnStage:",i);const c=((s=(n=i==null?void 0:i.response)==null?void 0:n.data)==null?void 0:s.message)??"No se pudo mover la incidencia.";y.value=c,Y(c),await h({showLoading:!1})}p.value=null,T.value=null,H.value=null,I.value=null,C.value=null},J=(e,t)=>{const r=x.value.find(n=>n.id===e);if(!(r!=null&&r.incidences))return null;const a=r.incidences.findIndex(n=>n.id===t);if(a!==-1){const n=r.incidences.splice(a,1)[0];return r.count=r.incidences.length,n}return null},me=(e,t,r=0)=>{const a=x.value.find(i=>i.id===e);if(!a)return;Array.isArray(a.incidences)||(a.incidences=[]);const n=a.incidences.findIndex(i=>i.id===t.id);n!==-1&&a.incidences.splice(n,1);const s=Math.min(Math.max(0,r),a.incidences.length);a.incidences.splice(s,0,t),a.count=a.incidences.length},xe=e=>{if(!p.value)return;e.preventDefault();const t=e.currentTarget.closest("section[data-stage-id]");if(!t)return;const r=parseInt(t.getAttribute("data-stage-id")),a=x.value.find(s=>s.id===r);if(!a)return;I.value=r;const n=e.clientY;C.value=Q(a,n,p.value.id)},K=new Map,Q=(e,t,r=null)=>{let a=K.get(e.id);if(!a||!document.contains(a)){if(a=document.querySelector(`[data-stage-id="${e.id}"] .p-3`),!a)return 0;K.set(e.id,a)}const n=a.querySelectorAll("article[data-incidence-id]");let s=0;for(let i=0;i<n.length;i++){const c=n[i],u=parseInt(c.getAttribute("data-incidence-id"));if(r&&u===r)continue;const l=c.getBoundingClientRect();if(t<l.top+l.height/2)return s;s++}return s},pe=async(e,t,r)=>{const a=x.value.find(u=>u.id===e);if(!a||!Array.isArray(a.incidences))return;const n=a.incidences.findIndex(u=>u.id===t);if(n===-1||n===r)return;const[s]=a.incidences.splice(n,1),i=Math.min(Math.max(0,r),a.incidences.length);a.incidences.splice(i,0,s),a.count=a.incidences.length;const c=a.incidences.map(u=>u.id);D.patch("/incidencias/reorder",{stage_id:e,ordered_ids:c}).catch(u=>{console.error("Error reordering incidences:",u),h({showLoading:!1})})},W=async e=>{var t,r,a,n,s,i,c,u;if(e!=null&&e.id)try{if(!await se({title:"¿Seguro que quieres eliminar la incidencia?",text:"Esta acción no se puede deshacer.",icon:"warning",confirmText:"Eliminar",cancelText:"Cancelar"}))return;await D.delete(`/incidencias/${e.id}`);for(const o of x.value){const w=((r=(t=o==null?void 0:o.incidences)==null?void 0:t.findIndex)==null?void 0:r.call(t,_=>_.id===e.id))??-1;if(w!==-1){o.incidences.splice(w,1),o.count=Math.max(0,(o.count??0)-1);break}}q("Incidencia eliminada correctamente")}catch(l){console.error("Error eliminando incidencia:",l);let o="Error al eliminar la incidencia";((a=l.response)==null?void 0:a.status)===403?o="No tienes permisos para eliminar incidencias":((n=l.response)==null?void 0:n.status)===404?o="La incidencia no fue encontrada":((s=l.response)==null?void 0:s.status)===422?o=((i=l.response.data)==null?void 0:i.message)||"Datos inválidos":(u=(c=l.response)==null?void 0:c.data)!=null&&u.message?o=l.response.data.message:l.message&&(o=l.message),Y(o)}},be=async(e,t)=>{var a,n;if(!(!(e!=null&&e.id)||!(t!=null&&t.is_done)||!await se({title:"Archivar incidencia",text:"Se ocultará del backlog, pero seguirá visible en la tabla (historial).",confirmText:"Archivar",cancelText:"Cancelar",icon:"warning"}))){P.value.add(e.id),y.value="";try{await D.patch(`/incidencias/${e.id}/archive`),J(t.id,e.id),q("Incidencia archivada"),window.dispatchEvent(new CustomEvent("incidencias:archived"))}catch(s){const i=((n=(a=s==null?void 0:s.response)==null?void 0:a.data)==null?void 0:n.message)??"No se pudo archivar la incidencia.";y.value=i,Y(i)}finally{P.value.delete(e.id)}}},B=()=>h({showLoading:!1});return ke(async()=>{window.addEventListener("incidencias:created",B),window.addEventListener("incidencias:archived",B),window.addEventListener("incidencias:updated",G),await h()}),he(()=>{window.removeEventListener("incidencias:created",B),window.removeEventListener("incidencias:archived",B),window.removeEventListener("incidencias:updated",G),p.value=null,re.value=null}),(e,t)=>(m(),v("div",null,[t[14]||(t[14]=d("div",{class:"mb-4 text-sm text-gray-600 dark:text-slate-300"}," Arrastra una incidencia entre columnas para cambiar su estado, o dentro de una columna para reordenar. ",-1)),d("div",_e,[d("div",Ie,[t[9]||(t[9]=d("label",{class:"text-xs text-gray-600 dark:text-slate-300"},"Limite:",-1)),U(d("select",{"onUpdate:modelValue":t[0]||(t[0]=r=>L.value=r),class:"rounded-lg border border-gray-200 bg-white px-2 py-1 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:focus:ring-blue-900/30"},[...t[8]||(t[8]=[d("option",{value:20},"20",-1),d("option",{value:50},"50",-1),d("option",{value:100},"100",-1),d("option",{value:250},"250",-1)])],512),[[Z,L.value,void 0,{number:!0}]])]),d("div",Ce,[t[10]||(t[10]=d("label",{class:"text-xs text-gray-600 dark:text-slate-300"},"Desde:",-1)),U(d("input",{"onUpdate:modelValue":t[1]||(t[1]=r=>$.value=r),type:"date",class:"rounded-lg border border-gray-200 bg-white px-2 py-1 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 placeholder:text-gray-400 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:placeholder:text-slate-500 dark:focus:ring-blue-900/30 dark:[color-scheme:dark]"},null,512),[[ee,$.value]])]),d("div",Ee,[t[11]||(t[11]=d("label",{class:"text-xs text-gray-600 dark:text-slate-300"},"Hasta:",-1)),U(d("input",{"onUpdate:modelValue":t[2]||(t[2]=r=>j.value=r),type:"date",class:"rounded-lg border border-gray-200 bg-white px-2 py-1 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 placeholder:text-gray-400 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:placeholder:text-slate-500 dark:focus:ring-blue-900/30 dark:[color-scheme:dark]"},null,512),[[ee,j.value]])]),d("div",De,[t[13]||(t[13]=d("label",{class:"text-xs text-gray-600 dark:text-slate-300"},"Prioridad:",-1)),U(d("select",{"onUpdate:modelValue":t[3]||(t[3]=r=>N.value=r),class:"rounded-lg border border-gray-200 bg-white px-2 py-1 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:focus:ring-blue-900/30"},[...t[12]||(t[12]=[d("option",{value:""},"Todas",-1),d("option",{value:"alta"},"Alta",-1),d("option",{value:"media"},"Media",-1),d("option",{value:"baja"},"Baja",-1)])],512),[[Z,N.value]])]),d("div",{class:"flex items-center gap-2 ms-auto"},[d("button",{onClick:oe,class:"inline-flex items-center rounded-lg bg-blue-600 px-3 py-1 text-sm text-white hover:bg-blue-700"}," Aplicar "),d("button",{onClick:le,class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1 text-sm text-gray-700 shadow-sm hover:bg-gray-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800"}," Limpiar ")])]),z.value?(m(),v("div",Ae,"Cargando...")):y.value?(m(),v("div",Me,k(y.value),1)):(m(),v("div",{key:2,class:R(["grid gap-4",ne.value])},[(m(!0),v(te,null,ae(x.value,r=>{var a,n;return m(),v("section",{key:r.id,"data-stage-id":r.id,class:"bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden dark:bg-slate-900 dark:border-slate-800",onDragover:b(xe,["prevent"]),onDrop:b(s=>ve(r,s),["prevent"])},[d("div",Le,[d("div",$e,[d("div",je,k(r.name),1),d("div",Ne,k(r.count),1)])]),d("div",Te,[(((a=r.incidences)==null?void 0:a.length)??0)===0?(m(),v("div",Fe," Sin incidencias. ")):V("",!0),(m(!0),v(te,null,ae(r.incidences,(s,i)=>{var c,u,l;return m(),v("div",{key:s.id,"data-incidence-id":s.id},[I.value===r.id&&C.value===i&&((c=p.value)==null?void 0:c.id)!==s.id?(m(),v("div",Be)):V("",!0),d("article",{"data-incidence-id":s.id,class:R(["select-none bg-gray-50 border border-gray-200 rounded-lg p-3 mb-3 dark:bg-slate-800 dark:border-slate-700 will-change-transform",{"opacity-60 scale-95 shadow-lg":((u=p.value)==null?void 0:u.id)===s.id,"cursor-not-allowed opacity-80":f(s),"cursor-grab hover:bg-blue-50/30 dark:hover:bg-slate-800/50 hover:shadow-md":!f(s)}]),style:we(((l=p.value)==null?void 0:l.id)===s.id?"transition: none !important; transform: scale(1.02);":"transition: transform 0.1s ease, opacity 0.1s ease;"),draggable:!f(s),onDragstart:o=>ce(s),onDragend:ge,onClick:o=>M(s)},[d("div",{class:"flex items-start justify-between gap-3 cursor-pointer",onClick:o=>M(s)},[d("div",null,[d("div",Ve,k(s.title),1),s.customer?(m(),v("div",qe,k(s.customer.company_name||s.customer.name),1)):(m(),v("div",Ye,"Sin cliente"))]),d("div",{class:R(["text-xs",ie(s.priority)])},k(s.priority||"Normal"),3)],8,Ue),s.date?(m(),v("div",{key:0,class:"mt-2 text-xs text-gray-600 dark:text-slate-300 cursor-pointer",onClick:o=>M(s)},k(de(s.date)),9,ze)):V("",!0),r.is_done?(m(),v("div",He,[d("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:f(s),onMousedown:t[4]||(t[4]=b(()=>{},["stop"])),onClick:b(o=>M(s),["stop","prevent"])}," Editar ",40,Re),d("button",{type:"button",class:"inline-flex items-center rounded-lg border border-red-200 bg-red-50 px-3 py-1.5 text-xs font-medium text-red-700 shadow-sm hover:bg-red-100 disabled:opacity-60 dark:border-red-700 dark:bg-red-900/20 dark:text-red-400 dark:hover:bg-red-900/30",disabled:f(s),onMousedown:t[5]||(t[5]=b(()=>{},["stop"])),onClick:b(o=>W(s),["stop","prevent"])}," Eliminar ",40,Ge),d("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:P.value.has(s.id),onClick:b(o=>be(s,r),["stop","prevent"])},k(P.value.has(s.id)?"Archivando…":"Archivar"),9,Je)])):(m(),v("div",Ke,[d("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:f(s),onMousedown:t[6]||(t[6]=b(()=>{},["stop"])),onClick:b(o=>M(s),["stop","prevent"])}," Editar ",40,Qe),d("button",{type:"button",class:"inline-flex items-center rounded-lg border border-red-200 bg-red-50 px-3 py-1.5 text-xs font-medium text-red-700 shadow-sm hover:bg-red-100 disabled:opacity-60 dark:border-red-700 dark:bg-red-900/20 dark:text-red-400 dark:hover:bg-red-900/30",disabled:f(s),onMousedown:t[7]||(t[7]=b(()=>{},["stop"])),onClick:b(o=>W(s),["stop","prevent"])}," Eliminar ",40,We)]))],46,Oe)],8,Pe)}),128)),I.value===r.id&&C.value>=(((n=r.incidences)==null?void 0:n.length)||0)?(m(),v("div",Xe)):V("",!0)])],40,Se)}),128))],2))]))}};export{dt as default};
