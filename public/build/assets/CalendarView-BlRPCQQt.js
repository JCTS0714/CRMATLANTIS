const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/vendor-ui-BsDgRXDF.js","assets/vendor-vue-Diyp6CFE.js"])))=>i.map(i=>d[i]);
import{_ as fe}from"./app-BDRZbfW-.js";import{a as S}from"./vendor-utils-Czy7fllw.js";import{i as Se,a as Ne,b as Ce,F as Te}from"./vendor-ui-BsDgRXDF.js";import{b as M,t as I,c as $e}from"./App-DAC6HJ3v.js";import"./notifications-Dl6xZJx9.js";import"./calendar-notifications-CrOVVuzr.js";import{e as be,r as ne,o as Be,y as Ie,f as Le,g as De,i as Pe,j as H,A as Ae,t as Me,u as Fe}from"./vendor-vue-Diyp6CFE.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const Re={class:"p-4"},Ve={class:"mb-4 flex items-center justify-between"},Oe=["disabled"],He={class:"rounded-lg border border-gray-200 bg-white p-2 shadow-sm dark:border-slate-800 dark:bg-slate-900"},Ge={class:"px-3 py-2 text-center text-base font-semibold text-gray-800 dark:text-slate-100"},Xe={__name:"CalendarView",setup(ze){const re=window.__AUTH_USER__??null,ye=be(()=>{const e=(re==null?void 0:re.permissions)??[];return Array.isArray(e)&&e.includes("calendar.delete")}),f=ne(!1),z=ne(null),de=ne(""),L=ne([]),ce=(()=>{if(typeof window>"u")return!1;const e=window.location.hostname;return e==="localhost"||e==="127.0.0.1"||e==="::1"})();let le=null;const we=async()=>ce?(le||(le=fe(()=>import("./customerModalAutofill.local-CpHl0RE-.js"),[]).catch(()=>null)),le):null,se=()=>{var e,t;try{(t=(e=z.value)==null?void 0:e.getApi)==null||t.call(e).refetchEvents()}catch{}},ue=e=>{var l,r,d;const t=(r=(l=z.value)==null?void 0:l.getApi)==null?void 0:r.call(l);if(!t)return;const a=(d=t.view)==null?void 0:d.type;if(a==="dayGridMonth"){t.incrementDate({months:e});return}if(a==="timeGridWeek"){t.incrementDate({weeks:e});return}t.incrementDate({days:e})},me=(e=null)=>{var d,u;const t=(u=(d=z.value)==null?void 0:d.getApi)==null?void 0:u.call(d),a=e??(t==null?void 0:t.view),l=a==null?void 0:a.currentStart;if(!l)return;const r=new Date(l);r.setDate(r.getDate()+15),de.value=new Intl.DateTimeFormat("es-PE",{year:"numeric",month:"long"}).format(r)},D=e=>{if(!e)return"";const t=new Date(e);if(Number.isNaN(t.getTime()))return"";const a=l=>String(l).padStart(2,"0");return`${t.getFullYear()}-${a(t.getMonth()+1)}-${a(t.getDate())}T${a(t.getHours())}:${a(t.getMinutes())}`},U=async({event_type:e="general",is_existing:t=!1,title:a="",start_at:l="",end_at:r="",all_day:d=!1,reminder_minutes:u="",related_type:i="",related_id:m="",lead_stage_id:h="",meta:g=null,description:P="",location:J="",allowDelete:K=!1}={})=>{const _=N=>String(N??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),x="mt-1 w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-950 dark:text-slate-100",ke=`
    <div class="grid gap-3 text-left">
      ${!t&&ce?'<div class="rounded-lg border border-amber-200 bg-amber-50 px-3 py-2 text-xs text-amber-800 dark:border-amber-800/40 dark:bg-amber-950/20 dark:text-amber-300">Solo local: autollenado para pruebas.<button id="sw-ev-autofill-create-local" type="button" class="ml-2 inline-flex items-center rounded-md border border-amber-300 bg-white px-2 py-1 text-xs font-medium text-amber-800 hover:bg-amber-100 dark:border-amber-700 dark:bg-slate-900 dark:text-amber-300 dark:hover:bg-amber-900/30">Rellenar test</button></div>':""}
      <div>
        <label class="block text-xs font-medium text-gray-600 dark:text-slate-300">Tipo de evento</label>
        <select id="sw-ev-event_type" class="${x}">
          <option value="general" ${e==="general"?"selected":""}>General</option>
          <option value="meeting" ${e==="meeting"?"selected":""}>Reunión</option>
          <option value="lead_followup" ${e==="lead_followup"?"selected":""}>Seguimiento de lead</option>
          <option value="customer_payment" ${e==="customer_payment"?"selected":""}>Fecha de pago</option>
          <option value="certificate_expiry" ${e==="certificate_expiry"?"selected":""}>Vencimiento de certificado</option>
        </select>
      </div>

      <div id="sw-ev-lead_stage_wrap" style="display:none;">
        <label class="block text-xs font-medium text-gray-600 dark:text-slate-300">Cambiar estado del lead</label>
        <select id="sw-ev-lead_stage_id" class="${x}">
        </select>
        <div class="mt-1 text-xs text-gray-500 dark:text-slate-400">Solo aplica para tipo "Seguimiento de lead".</div>
      </div>

      <div>
        <label class="block text-xs font-medium text-gray-600 dark:text-slate-300">Título</label>
        <input id="sw-ev-title" class="${x}" value="${_(a)}" />
      </div>

      <div class="grid grid-cols-1 gap-3 sm:grid-cols-2">
        <div>
          <label class="block text-xs font-medium text-gray-600 dark:text-slate-300">Inicio</label>
          <input id="sw-ev-start" type="datetime-local" class="${x}" value="${_(l)}" />
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-600 dark:text-slate-300">Fin</label>
          <input id="sw-ev-end" type="datetime-local" class="${x}" value="${_(r)}" />
        </div>
      </div>

      <div class="grid grid-cols-1 gap-3 sm:grid-cols-2">
        <div>
          <label class="block text-xs font-medium text-gray-600 dark:text-slate-300">Recordatorio (minutos antes)</label>
          <input id="sw-ev-reminder" type="number" min="1" max="10080" class="${x}" value="${_(u)}" placeholder="(opcional)" />
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-600 dark:text-slate-300">Ubicación</label>
          <input id="sw-ev-location" class="${x}" value="${_(J)}" placeholder="(opcional)" />
        </div>
      </div>

      <div>
        <label class="block text-xs font-medium text-gray-600 dark:text-slate-300">Descripción</label>
        <textarea id="sw-ev-description" rows="3" class="${x}" placeholder="(opcional)">${_(P)}</textarea>
      </div>

      <div class="grid grid-cols-1 gap-3 sm:grid-cols-2">
        <div>
          <label class="block text-xs font-medium text-gray-600 dark:text-slate-300">Relacionado a</label>
          <select id="sw-ev-related_type" class="${x}">
            <option value="" ${i?"":"selected"}>(ninguno)</option>
            <option value="lead" ${i==="lead"?"selected":""}>Lead</option>
            <option value="customer" ${i==="customer"?"selected":""}>Cliente</option>
            <option value="certificate" ${i==="certificate"?"selected":""}>Certificado</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-600 dark:text-slate-300">Relacionado</label>
          <input id="sw-ev-related_search" class="${x}" placeholder="Escribe para buscar…" autocomplete="off" />
          <input id="sw-ev-related_id" type="hidden" value="${_(m)}" />
          <div id="sw-ev-related_results" class="mt-2 max-h-44 overflow-auto rounded-lg border border-gray-200 bg-white p-1 text-left shadow-sm dark:border-slate-800 dark:bg-slate-950" style="display:none;"></div>
          <div id="sw-ev-related_hint" class="mt-1 text-xs text-gray-500 dark:text-slate-400">Selecciona un resultado para llenar el vínculo (opcional).</div>
        </div>
      </div>

    </div>
  `,{default:T}=await fe(async()=>{const{default:N}=await import("./vendor-ui-BsDgRXDF.js").then(c=>c.s);return{default:N}},__vite__mapDeps([0,1])),oe=await T.fire({title:"Evento",html:ke,focusConfirm:!1,showCancelButton:!0,showDenyButton:!!K,confirmButtonText:"Guardar",cancelButtonText:"Cancelar",denyButtonText:"Eliminar",buttonsStyling:!1,didOpen:async()=>{const N=document.getElementById("sw-ev-event_type"),c=document.getElementById("sw-ev-start"),B=document.getElementById("sw-ev-end"),A=document.getElementById("sw-ev-reminder"),b=document.getElementById("sw-ev-related_type"),y=document.getElementById("sw-ev-related_search"),G=document.getElementById("sw-ev-related_id"),w=document.getElementById("sw-ev-related_results"),F=document.getElementById("sw-ev-lead_stage_wrap"),E=document.getElementById("sw-ev-lead_stage_id"),R=document.getElementById("sw-ev-autofill-create-local");if(!b||!y||!G||!w||!N||!c||!B||!A||!F||!E)return;if(R){const n=await we();n!=null&&n.autofillCalendarEventCreateModalForm&&R.addEventListener("click",()=>{n.autofillCalendarEventCreateModalForm()})}let V=null;const C=()=>{w.innerHTML="",w.style.display="none"},X=n=>{if(!n||(b.value||"")!=="lead")return;const s=Number(n.stage_id??0);if(!Number.isFinite(s)||s<1)return;const o=String(s);Array.from(E.options).some(v=>v.value===o)&&(E.value=o)},O=n=>{G.value=n!=null&&n.id?String(n.id):"",y.value=n!=null&&n.label?String(n.label):"",X(n),C()},W=()=>{const n=b.value||"",s=!!n;y.disabled=!s;const o=n==="lead"?"lead":n==="customer"?"cliente":"certificado";y.placeholder=s?`Buscar ${o}…`:"Selecciona tipo primero",s||O(null)},Z=async()=>{var n,s,o,p;if(Array.isArray(L.value)&&L.value.length>0)return L.value;try{const v=await S.get("/leads/board-data",{params:{limit:0}}),$=((s=(n=v==null?void 0:v.data)==null?void 0:n.data)==null?void 0:s.stages)??[];if(Array.isArray($)&&$.length>0)return L.value=$.map(k=>({id:Number(k.id),name:String(k.name||"").trim()})).filter(k=>Number.isFinite(k.id)&&k.id>0&&k.name!==""),L.value}catch{}try{const v=await S.get("/leads/data",{params:{per_page:1}}),$=((p=(o=v==null?void 0:v.data)==null?void 0:o.data)==null?void 0:p.stages)??[];Array.isArray($)&&$.length>0&&(L.value=$.map(k=>({id:Number(k.id),name:String(k.name||"").trim()})).filter(k=>Number.isFinite(k.id)&&k.id>0&&k.name!==""))}catch{L.value=[]}return L.value},ee=async()=>{const n=await Z();E.innerHTML="";for(const s of n){const o=document.createElement("option");o.value=String(s.id),o.textContent=s.name,E.appendChild(o)}if(!n.length){const s=document.createElement("option");s.value="",s.textContent="No hay etapas disponibles",E.appendChild(s)}E.disabled=!n.length,h?E.value=String(h):n.length>0&&(E.value=String(n[0].id))},j=()=>{const n=N.value||"general",s=n==="customer_payment"||n==="certificate_expiry",o=t&&s,p=n==="lead_followup";F.style.display=p?"block":"none",p||(E.value=""),p&&!b.value&&(b.value="lead"),n==="customer_payment"&&(b.value="customer"),n==="certificate_expiry"&&(b.value="certificate"),s?(c.type!=="date"&&(c.type="date"),c.value&&c.value.length>10&&(c.value=c.value.slice(0,10)),B.value="",B.disabled=!0,String(A.value||"").trim()||(A.value="1440")):(c.type!=="datetime-local"&&(c.type="datetime-local",c.value&&c.value.length===10&&(c.value=`${c.value}T09:00`)),B.disabled=!1),N.disabled=o,b.disabled=o,y.disabled=o?!0:y.disabled,W(),o&&(y.disabled=!0)},te=n=>{if(w.innerHTML="",!(n!=null&&n.length)){C();return}w.style.display="block";for(const s of n){const o=document.createElement("button");o.type="button",o.className="flex w-full items-center justify-between rounded-md px-2 py-1.5 text-left text-sm text-gray-800 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-200 dark:text-slate-100 dark:hover:bg-slate-900 dark:focus:ring-blue-500/30",o.textContent=s.label,o.addEventListener("click",()=>O(s)),w.appendChild(o)}},ae=async()=>{var o;const n=b.value||"",s=Number(G.value);if(!(!n||!Number.isFinite(s)||s<1))try{const p=await S.get("/related-lookup",{params:{type:n,id:s}}),v=((o=p==null?void 0:p.data)==null?void 0:o.data)??null;v!=null&&v.label?(y.value=v.label,X(v)):y.value=`#${s}`}catch{}},q=async()=>{var o;const n=b.value||"",s=(y.value||"").trim();if(!n||s.length<2){C();return}try{const p=await S.get("/related-lookup",{params:{type:n,q:s,limit:8}});te(((o=p==null?void 0:p.data)==null?void 0:o.data)??[])}catch{C()}};b.addEventListener("change",()=>{W(),C()}),N.addEventListener("change",()=>{j(),C()}),y.addEventListener("input",()=>{G.value="",V&&window.clearTimeout(V),V=window.setTimeout(()=>{q()},250)}),y.addEventListener("blur",()=>{window.setTimeout(()=>C(),150)}),y.addEventListener("focus",()=>{q()}),await ee(),j(),await ae()},customClass:{popup:"rounded-xl border border-gray-200 bg-white text-gray-900 shadow-xl dark:!border-slate-800 dark:!bg-slate-900 dark:!text-slate-100",backdrop:"bg-black/60",title:"text-base font-semibold text-gray-900 dark:text-slate-100",htmlContainer:"text-sm text-gray-600 dark:text-slate-300",actions:"gap-2",confirmButton:"inline-flex items-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 disabled:opacity-60",cancelButton:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-4 focus:ring-blue-100 disabled:opacity-60 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",denyButton:"inline-flex items-center rounded-lg bg-rose-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-rose-700 focus:outline-none focus:ring-4 focus:ring-rose-300 disabled:opacity-60"},preConfirm:()=>{var W,Z,ee,j,te,ae,q,n,s,o,p,v,$;const N=((Z=(W=document.getElementById("sw-ev-title"))==null?void 0:W.value)==null?void 0:Z.trim())??"",c=((ee=document.getElementById("sw-ev-event_type"))==null?void 0:ee.value)??"general",B=((j=document.getElementById("sw-ev-start"))==null?void 0:j.value)??"",A=((te=document.getElementById("sw-ev-end"))==null?void 0:te.value)??"",b=((ae=document.getElementById("sw-ev-reminder"))==null?void 0:ae.value)??"",y=((n=(q=document.getElementById("sw-ev-location"))==null?void 0:q.value)==null?void 0:n.trim())??"",G=((o=(s=document.getElementById("sw-ev-description"))==null?void 0:s.value)==null?void 0:o.trim())??"";let w=((p=document.getElementById("sw-ev-related_type"))==null?void 0:p.value)??"";const F=((v=document.getElementById("sw-ev-related_id"))==null?void 0:v.value)??"",E=(($=document.getElementById("sw-ev-lead_stage_id"))==null?void 0:$.value)??"",R=c==="customer_payment"||c==="certificate_expiry";if(c==="customer_payment"&&!w&&(w="customer"),c==="certificate_expiry"&&!w&&(w="certificate"),!N)return T.showValidationMessage("El título es requerido."),!1;if(!B)return T.showValidationMessage("La fecha/hora de inicio es requerida."),!1;if(A&&A<B)return T.showValidationMessage("La fecha/hora fin no puede ser menor que inicio."),!1;if(w&&!F)return T.showValidationMessage("Selecciona un registro relacionado de la lista."),!1;if(c==="customer_payment"&&w!=="customer")return T.showValidationMessage("Los pagos deben vincularse a un cliente."),!1;const V=Number(E);if(!Number.isFinite(V)||V<1)return T.showValidationMessage("Selecciona un estado de lead válido."),!1;if(c==="lead_followup"&&(w!=="lead"||!F))return T.showValidationMessage("Para cambiar estado, debes vincular el evento a un lead."),!1;if(c==="lead_followup"&&!E)return T.showValidationMessage("Selecciona una etapa para el lead."),!1;const C=b?Number(b):R?1440:null;if(b&&(!Number.isFinite(C)||C<1))return T.showValidationMessage("El recordatorio debe ser un número válido."),!1;const X=R?`${B}T00:00`:B,O=g&&typeof g=="object"&&!Array.isArray(g)?{...g}:{};return c==="lead_followup"?O.lead_stage_id=V:delete O.lead_stage_id,{event_type:c,title:N,all_day:R,start_at:new Date(X).toISOString(),end_at:R?null:A?new Date(A).toISOString():null,reminder_minutes:C,location:y||null,description:G||null,related_type:w||null,related_id:F?Number(F):null,meta:Object.keys(O).length>0?O:null}}});return oe.isDenied?{action:"delete"}:oe.isConfirmed?{action:"save",payload:oe.value}:null},Q=async e=>{var d,u,i;if(((e==null?void 0:e.event_type)??"")!=="lead_followup")return;const a=(e==null?void 0:e.related_type)??"",l=Number((e==null?void 0:e.related_id)??0),r=Number(((d=e==null?void 0:e.meta)==null?void 0:d.lead_stage_id)??0);if(!(a!=="lead"||!Number.isFinite(l)||l<1)&&!(!Number.isFinite(r)||r<1))try{await S.patch(`/leads/${l}/move-stage`,{stage_id:r}),window.dispatchEvent(new CustomEvent("leads:stage-changed-from-calendar",{detail:{leadId:l,stageId:r}})),M("Estado del lead actualizado")}catch(m){I(((i=(u=m==null?void 0:m.response)==null?void 0:u.data)==null?void 0:i.message)??"Evento guardado, pero no se pudo cambiar el estado del lead.")}},ie=e=>{const t=String(e||"").toLowerCase();return t?t.endsWith("lead")||t==="lead"?"lead":t.endsWith("customer")||t==="customer"?"customer":t.endsWith("certificado")||t==="certificate"?"certificate":null:null},_e=e=>e==="customer_payment"?["bg-emerald-600","border-emerald-700/30","dark:bg-emerald-500/70","dark:border-emerald-300/20"]:e==="certificate_expiry"?["bg-amber-600","border-amber-700/30","dark:bg-amber-500/70","dark:border-amber-300/20"]:e==="lead_followup"?["bg-indigo-600","border-indigo-700/30","dark:bg-indigo-500/70","dark:border-indigo-300/20"]:e==="meeting"?["bg-violet-600","border-violet-700/30","dark:bg-violet-500/70","dark:border-violet-300/20"]:["bg-blue-600","border-blue-700/30","dark:bg-blue-500/70","dark:border-blue-300/20"],xe=be(()=>({plugins:[Se,Ne,Ce],initialView:"dayGridMonth",customButtons:{prevCustom:{text:"‹",click:()=>ue(-1)},nextCustom:{text:"›",click:()=>ue(1)}},headerToolbar:{left:"prevCustom,nextCustom today",center:"",right:"dayGridMonth,timeGridWeek,timeGridDay"},eventDisplay:"block",eventClassNames:e=>{var t,a;return["rounded-md","px-2","py-1","text-xs","font-semibold","text-white","shadow-sm","border",..._e(((a=(t=e==null?void 0:e.event)==null?void 0:t.extendedProps)==null?void 0:a.event_type)||"general")]},selectable:!0,editable:!0,eventTimeFormat:{hour:"2-digit",minute:"2-digit",meridiem:!1},datesSet:e=>me(e.view),events:async(e,t,a)=>{var l;try{const r=await S.get("/calendar/events",{params:{start:e.startStr,end:e.endStr}});t(((l=r==null?void 0:r.data)==null?void 0:l.data)??[])}catch(r){I("No se pudo cargar el calendario"),a(r)}},dateClick:async e=>{var d,u,i;const t=new Date(e.date),a=new Date(e.date);a.setHours(a.getHours()+1);const l=await U({start_at:D(t),end_at:D(a)});if(!l||l.action!=="save")return;const r=l.payload;f.value=!0;try{const m=await S.post("/calendar/events",r),h=((d=m.data)==null?void 0:d.data)||m.data;await Q(r),M("Evento creado"),e.view.calendar.refetchEvents(),h&&h.id&&Y({id:h.id,title:r.title,description:r.description,start_at:r.start_at,end_at:r.end_at,reminder_minutes:r.reminder_minutes})}catch(m){I(((i=(u=m==null?void 0:m.response)==null?void 0:u.data)==null?void 0:i.message)??"No se pudo crear el evento")}finally{f.value=!1}},eventClick:async e=>{var d,u,i,m,h;const t=e.event,a=t.extendedProps||{},l=await U({event_type:a.event_type??"general",is_existing:!0,title:t.title,start_at:D(t.start),end_at:D(t.end),reminder_minutes:a.reminder_minutes??"",location:a.location??"",description:a.description??"",related_type:ie(a.related_type)||"",related_id:a.related_id??"",lead_stage_id:((d=a==null?void 0:a.meta)==null?void 0:d.lead_stage_id)??"",meta:(a==null?void 0:a.meta)??null,allowDelete:ye.value});if(!l)return;if(l.action==="delete"){if(!await $e({title:"Eliminar evento",text:"Esta acción no se puede deshacer.",confirmText:"Eliminar"}))return;f.value=!0;try{await S.delete(`/calendar/events/${t.id}`),M("Evento eliminado"),e.view.calendar.refetchEvents(),ge(t.id)}catch(P){I(((i=(u=P==null?void 0:P.response)==null?void 0:u.data)==null?void 0:i.message)??"No se pudo eliminar el evento")}finally{f.value=!1}return}if(l.action!=="save")return;const r=l.payload;f.value=!0;try{await S.put(`/calendar/events/${t.id}`,r),await Q(r),M("Evento actualizado"),e.view.calendar.refetchEvents(),ge(t.id),Y({id:t.id,title:r.title,description:r.description,start_at:r.start_at,end_at:r.end_at,reminder_minutes:r.reminder_minutes})}catch(g){I(((h=(m=g==null?void 0:g.response)==null?void 0:m.data)==null?void 0:h.message)??"No se pudo actualizar el evento")}finally{f.value=!1}},eventDrop:async e=>{var l,r,d,u;const t=e.event,a=t.extendedProps||{};f.value=!0;try{await S.put(`/calendar/events/${t.id}`,{title:t.title,start_at:(l=t.start)==null?void 0:l.toISOString(),end_at:((r=t.end)==null?void 0:r.toISOString())??null,reminder_minutes:a.reminder_minutes??null,location:a.location??null,description:a.description??null,event_type:a.event_type??"general",related_type:ie(a.related_type),related_id:a.related_id??null}),M("Evento movido")}catch(i){e.revert(),I(((u=(d=i==null?void 0:i.response)==null?void 0:d.data)==null?void 0:u.message)??"No se pudo mover el evento")}finally{f.value=!1}},eventResize:async e=>{var l,r,d,u;const t=e.event,a=t.extendedProps||{};f.value=!0;try{await S.put(`/calendar/events/${t.id}`,{title:t.title,start_at:(l=t.start)==null?void 0:l.toISOString(),end_at:((r=t.end)==null?void 0:r.toISOString())??null,reminder_minutes:a.reminder_minutes??null,location:a.location??null,description:a.description??null,event_type:a.event_type??"general",related_type:ie(a.related_type),related_id:a.related_id??null}),M("Evento actualizado")}catch(i){e.revert(),I(((u=(d=i==null?void 0:i.response)==null?void 0:d.data)==null?void 0:u.message)??"No se pudo actualizar el evento")}finally{f.value=!1}}})),he=async()=>{var r,d,u;const e=new Date,t=new Date(e);t.setHours(t.getHours()+1);const a=await U({start_at:D(e),end_at:D(t)});if(!a||a.action!=="save")return;const l=a.payload;f.value=!0;try{const i=await S.post("/calendar/events",l),m=((r=i.data)==null?void 0:r.data)||i.data;await Q(l),M("Evento creado"),se(),m&&m.id&&Y({id:m.id,title:l.title,description:l.description,start_at:l.start_at,end_at:l.end_at,reminder_minutes:l.reminder_minutes})}catch(i){I(((u=(d=i==null?void 0:i.response)==null?void 0:d.data)==null?void 0:u.message)??"No se pudo crear el evento")}finally{f.value=!1}},pe=e=>{if(!e)return null;const t=new Date(e);if(!Number.isNaN(t.getTime()))return t;const a=new Date(String(e).replace(" ","T"));return Number.isNaN(a.getTime())?null:a},Ee=async()=>{var P,J,K;const e=new URL(window.location.href),t=e.searchParams.get("related_type")||"",a=e.searchParams.get("related_id")||"",l=e.searchParams.get("title")||"",r=e.searchParams.get("description")||"";if(!t&&!a&&!l&&!r)return;const d=pe(e.searchParams.get("start")),u=pe(e.searchParams.get("end")),i=d??new Date,m=u??new Date(i.getTime()+3600*1e3),h=await U({event_type:t==="lead"?"lead_followup":"general",title:l||"",start_at:D(i),end_at:D(m),related_type:t,related_id:a,description:r});if(e.searchParams.delete("related_type"),e.searchParams.delete("related_id"),e.searchParams.delete("title"),e.searchParams.delete("description"),e.searchParams.delete("start"),e.searchParams.delete("end"),window.history.replaceState({},"",e.pathname+e.search),!h||h.action!=="save")return;const g=h.payload;f.value=!0;try{const _=await S.post("/calendar/events",g),x=((P=_.data)==null?void 0:P.data)||_.data;await Q(g),M("Evento creado"),se(),x&&x.id&&Y({id:x.id,title:g.title,description:g.description,start_at:g.start_at,end_at:g.end_at,reminder_minutes:g.reminder_minutes})}catch(_){I(((K=(J=_==null?void 0:_.response)==null?void 0:J.data)==null?void 0:K.message)??"No se pudo crear el evento")}finally{f.value=!1}},ve=()=>se(),Y=e=>{if(!window.CalendarNotifications||!e)return;const t={id:e.id,title:e.title,description:e.description||"",start_datetime:e.start_at,end_datetime:e.end_at,start_time:new Date(e.start_at).toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"}),reminder_minutes:e.reminder_minutes};t.reminder_minutes&&t.reminder_minutes>0?window.CalendarNotifications.setReminderTimes([t.reminder_minutes]):window.CalendarNotifications.setReminderTimes([15,5]),window.CalendarNotifications.scheduleReminders(t)},ge=e=>{window.CalendarNotifications&&e&&window.CalendarNotifications.cancelReminders(e)};return Be(()=>{window.addEventListener("calendar:refetch",ve),Ie(()=>{var t,a;const e=(a=(t=z.value)==null?void 0:t.getApi)==null?void 0:a.call(t);e&&e.gotoDate(new Date),me(),Promise.resolve().then(()=>{window.CalendarNotifications&&window.CalendarNotifications.init()}),Ee()})}),Le(()=>{window.removeEventListener("calendar:refetch",ve)}),(e,t)=>(Pe(),De("div",Re,[H("div",Ve,[t[0]||(t[0]=H("div",null,[H("div",{class:"text-sm font-semibold text-gray-900 dark:text-slate-100"},"Calendario"),H("div",{class:"mt-1 text-xs text-gray-600 dark:text-slate-300"},"Tu agenda personal (solo tú la ves).")],-1)),H("button",{type:"button",class:"inline-flex items-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700 disabled:opacity-60",disabled:f.value,onClick:he}," Nuevo evento ",8,Oe)]),H("div",He,[H("div",Ge,Me(de.value),1),Ae(Fe(Te),{ref_key:"calendarRef",ref:z,options:xe.value},null,8,["options"])])]))}};export{Xe as default};
