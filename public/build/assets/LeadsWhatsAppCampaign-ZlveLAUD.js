import{r as i,e as te,o as ae,g as l,i as o,j as t,k as m,n as M,w as S,x as z,z as c,D as se,F as D,m as W,t as r,K as re}from"./vendor-vue-DWiPAFcI.js";import{a as A}from"./vendor-utils-Czy7fllw.js";const le={class:"grid gap-4 lg:grid-cols-2"},oe={class:"bg-white border border-gray-200 rounded-lg shadow-sm dark:bg-slate-900 dark:border-slate-800"},de={class:"p-4 space-y-4"},ne={class:"inline-flex rounded-lg border border-gray-200 bg-white p-1 shadow-sm dark:border-slate-800 dark:bg-slate-900"},ie={class:"flex items-center justify-between gap-3"},ue={class:"flex flex-wrap gap-2"},ce={class:"grid gap-3 sm:grid-cols-3"},ge={key:0},pe=["value"],me={class:"flex items-center gap-2"},be={class:"ml-2 inline-flex items-center gap-2 text-xs text-gray-700 dark:text-slate-200"},xe=["disabled"],ve=["disabled"],ye={key:0,class:"rounded-lg border border-red-200 bg-red-50 p-3 text-sm text-red-700 dark:border-red-900/40 dark:bg-red-950/30 dark:text-red-200"},he={key:1,class:"text-xs text-gray-600 dark:text-slate-300"},ke={class:"font-semibold"},fe={class:"font-semibold"},_e={class:"font-semibold"},we={key:0},Ce={class:"rounded-lg border border-gray-200 dark:border-slate-800 overflow-hidden"},Se={class:"flex items-center gap-3 bg-gray-50 px-3 py-2 text-xs text-gray-600 dark:bg-slate-800 dark:text-slate-200"},$e={class:"inline-flex items-center gap-2"},Ae=["checked"],je={class:"ml-auto"},Ne={class:"max-h-[360px] overflow-y-auto bg-white dark:bg-slate-900"},Ve=["checked","onChange"],Ee={class:"min-w-0 flex-1"},ze={class:"truncate text-gray-900 dark:text-slate-100"},De={key:0,class:"text-gray-500 dark:text-slate-400"},We={class:"mt-0.5 flex items-center gap-2 text-xs text-gray-600 dark:text-slate-300"},Ue={key:0},qe={key:0,class:"p-3 text-sm text-gray-600 dark:text-slate-300"},Le={class:"flex items-center gap-2"},Me=["disabled"],Be={key:0,class:"text-xs text-gray-600 dark:text-slate-300"},He={class:"font-semibold"},Ie={key:2,class:"rounded-lg border border-red-200 bg-red-50 p-3 text-sm text-red-700 dark:border-red-900/40 dark:bg-red-950/30 dark:text-red-200"},Re={class:"bg-white border border-gray-200 rounded-lg shadow-sm dark:bg-slate-900 dark:border-slate-800"},Te={class:"p-4 border-b border-gray-200 dark:border-slate-800 flex items-center justify-between"},Fe=["disabled"],Oe={class:"p-4 space-y-4"},Pe={key:0,class:"space-y-3"},Ke={class:"text-sm font-semibold text-gray-900 dark:text-slate-100"},Ge={key:0,class:"text-gray-500 dark:text-slate-400"},Je={class:"rounded-lg border border-gray-200 dark:border-slate-800 overflow-hidden"},Qe={class:"max-h-[520px] overflow-y-auto"},Xe={class:"flex items-start justify-between gap-3"},Ye={class:"min-w-0"},Ze={class:"truncate text-gray-900 dark:text-slate-100"},et={class:"text-gray-500 dark:text-slate-400"},tt={class:"mt-1 whitespace-pre-wrap rounded-md bg-gray-50 p-2 text-xs text-gray-700 dark:bg-slate-800 dark:text-slate-200"},at={class:"flex flex-col gap-2"},st=["href","onClick"],rt=["onClick"],lt={class:"text-[11px] text-gray-500 dark:text-slate-400"},ot={class:"font-semibold"},dt={key:0,class:"p-3 text-sm text-gray-600 dark:text-slate-300"},nt={key:1,class:"text-sm text-gray-600 dark:text-slate-300"},it={key:2,class:"rounded-lg border border-red-200 bg-red-50 p-3 text-sm text-red-700 dark:border-red-900/40 dark:bg-red-950/30 dark:text-red-200"},ut={key:3,class:"space-y-2"},ct={class:"grid gap-2"},gt=["onClick"],pt={key:0,class:"text-gray-500 dark:text-slate-400"},mt={class:"text-xs text-gray-500 dark:text-slate-400"},yt={__name:"LeadsWhatsAppCampaign",setup(bt){const B=i([]),h=i([]),f=i("leads"),k=i({total:0,without_phone:0}),j=i(!1),N=i(""),V=i(!1),$=i(""),w=i(null),E=i(!1),C=i(""),U=i([]),b=i(null),x=i(new Set),v=i({name:"",message_template:"Hola {{first_name}}, te escribo para…"}),n=i({stage_id:null,q:"",limit:200,only_with_phone:!1}),H=te(()=>h.value.length>0&&x.value.size===h.value.length),O=()=>{if(H.value){x.value=new Set;return}x.value=new Set(h.value.map(s=>s.id))},P=s=>{const e=new Set(x.value);e.has(s)?e.delete(s):e.add(s),x.value=e},I=s=>{v.value.message_template=`${v.value.message_template}${v.value.message_template.endsWith(" ")?"":" "}${s}`},q=async()=>{var s,e,a,d,u,g,p,_;j.value=!0,N.value="";try{const y={source:f.value,q:n.value.q,limit:n.value.limit,only_with_phone:n.value.only_with_phone?1:0};f.value==="leads"&&n.value.stage_id!==null&&(y.stage_id=n.value.stage_id);const L=await A.get("/leads/whatsapp/recipients",{params:y});B.value=((e=(s=L.data)==null?void 0:s.data)==null?void 0:e.stages)??[],h.value=((d=(a=L.data)==null?void 0:a.data)==null?void 0:d.contacts)??[],k.value=((g=(u=L.data)==null?void 0:u.data)==null?void 0:g.counts)??{total:0,without_phone:0},(k.value.total??0)>0&&(k.value.with_phone??0)===0&&(n.value.only_with_phone=!1),x.value=new Set(h.value.map(ee=>ee.id))}catch(y){N.value=((_=(p=y==null?void 0:y.response)==null?void 0:p.data)==null?void 0:_.message)||"No se pudieron cargar destinatarios."}finally{j.value=!1}},R=s=>{f.value=s,n.value.stage_id=null,q()},K=async()=>{var s,e,a,d,u,g;V.value=!0,$.value="",w.value=null;try{const p=Array.from(x.value),_=await A.post("/leads/whatsapp-campaigns",{name:v.value.name||null,message_template:v.value.message_template,source:f.value,ids:p});w.value=((e=(s=_.data)==null?void 0:s.data)==null?void 0:e.campaign_id)??null,w.value&&await T(w.value);const y=((d=(a=_.data)==null?void 0:a.data)==null?void 0:d.skipped_missing_phone_ids)??[];Array.isArray(y)&&y.length>0&&($.value=`Se omitieron ${y.length} registros sin teléfono.`)}catch(p){$.value=((g=(u=p==null?void 0:p.response)==null?void 0:u.data)==null?void 0:g.message)||"No se pudo crear la campaña."}finally{V.value=!1}},G=async()=>{var s,e,a,d;E.value=!0,C.value="";try{const u=await A.get("/leads/whatsapp-campaigns");U.value=((e=(s=u.data)==null?void 0:s.data)==null?void 0:e.campaigns)??[]}catch(u){C.value=((d=(a=u==null?void 0:u.response)==null?void 0:a.data)==null?void 0:d.message)||"No se pudo cargar el historial."}finally{E.value=!1}},T=async s=>{var e,a,d,u;C.value="";try{const g=await A.get(`/leads/whatsapp-campaigns/${s}`);b.value=((a=(e=g.data)==null?void 0:e.data)==null?void 0:a.campaign)??null}catch(g){C.value=((u=(d=g==null?void 0:g.response)==null?void 0:d.data)==null?void 0:u.message)||"No se pudo abrir la campaña."}},J=s=>{if(!s)return"";const e=String(s).replace(/\D+/g,"");return e?e.length===9&&e.startsWith("9")?`51${e}`:(e.startsWith("51"),e):""},Q=(s,e)=>{const a=J(s);if(!a)return"#";const d=encodeURIComponent(e||"");return`https://wa.me/${a}?text=${d}`},F=async(s,e)=>{var a,d;try{const g=(d=(a=(await A.patch(`/leads/whatsapp-campaign-recipients/${s}`,e)).data)==null?void 0:a.data)==null?void 0:d.recipient;if(!b.value||!g)return;const p=b.value.recipients.findIndex(_=>_.id===s);if(p===-1)return;b.value.recipients[p]={...b.value.recipients[p],...g}}catch{}},X=s=>{s!=null&&s.id&&s.status==="pending"&&(F(s.id,{status:"opened"}),s.status="opened")},Y=s=>{s!=null&&s.id&&(F(s.id,{status:"sent"}),s.status="sent")},Z=s=>{if(!s)return"";try{return new Date(s).toLocaleString()}catch{return String(s)}};return ae(()=>{q()}),(s,e)=>(o(),l("section",null,[t("div",le,[t("div",oe,[e[24]||(e[24]=t("div",{class:"p-4 border-b border-gray-200 dark:border-slate-800"},[t("div",{class:"text-sm font-semibold text-gray-900 dark:text-slate-100"},"Nueva campaña WhatsApp (manual asistido)"),t("div",{class:"mt-1 text-xs text-gray-600 dark:text-slate-300"}," El sistema genera mensajes personalizados y abre WhatsApp. No envía automáticamente (sin API). ")],-1)),t("div",de,[t("div",ne,[t("button",{type:"button",class:M(["px-3 py-2 text-sm font-medium rounded-md transition",f.value==="leads"?"bg-blue-600 text-white":"text-gray-700 hover:bg-gray-50 dark:text-slate-200 dark:hover:bg-slate-800"]),onClick:e[0]||(e[0]=a=>R("leads"))}," Leads ",2),t("button",{type:"button",class:M(["px-3 py-2 text-sm font-medium rounded-md transition",f.value==="customers"?"bg-blue-600 text-white":"text-gray-700 hover:bg-gray-50 dark:text-slate-200 dark:hover:bg-slate-800"]),onClick:e[1]||(e[1]=a=>R("customers"))}," Clientes ",2)]),t("div",null,[e[10]||(e[10]=t("label",{class:"block text-xs font-medium text-gray-700 dark:text-slate-200"},"Nombre (opcional)",-1)),S(t("input",{"onUpdate:modelValue":e[2]||(e[2]=a=>v.value.name=a),type:"text",class:"mt-1 w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:focus:ring-blue-900/30",placeholder:"Ej: Aviso de promoción Enero"},null,512),[[z,v.value.name]])]),t("div",null,[t("div",ie,[e[11]||(e[11]=t("label",{class:"block text-xs font-medium text-gray-700 dark:text-slate-200"},"Mensaje",-1)),t("div",ue,[t("button",{type:"button",class:"rounded-md border border-gray-200 bg-white px-2 py-1 text-xs text-gray-700 shadow-sm hover:bg-gray-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",onClick:e[3]||(e[3]=a=>I("{{first_name}}"))}," + first_name "),t("button",{type:"button",class:"rounded-md border border-gray-200 bg-white px-2 py-1 text-xs text-gray-700 shadow-sm hover:bg-gray-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",onClick:e[4]||(e[4]=a=>I("{{company_name}}"))}," + company_name ")])]),S(t("textarea",{"onUpdate:modelValue":e[5]||(e[5]=a=>v.value.message_template=a),rows:"6",class:"mt-1 w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 placeholder:text-gray-400 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:placeholder:text-slate-500 dark:focus:ring-blue-900/30",placeholder:"Hola {{first_name}}, te escribo por..."},null,512),[[z,v.value.message_template]]),e[12]||(e[12]=t("div",{class:"mt-1 text-xs text-gray-500 dark:text-slate-400"},[c(" Variables: "),t("span",{class:"font-mono"},"{{first_name}}"),c(", "),t("span",{class:"font-mono"},"{{company_name}}")],-1))]),t("div",ce,[f.value==="leads"?(o(),l("div",ge,[e[14]||(e[14]=t("label",{class:"block text-xs font-medium text-gray-700 dark:text-slate-200"},"Etapa",-1)),S(t("select",{"onUpdate:modelValue":e[6]||(e[6]=a=>n.value.stage_id=a),class:"mt-1 w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:focus:ring-blue-900/30"},[e[13]||(e[13]=t("option",{value:null},"Todas",-1)),(o(!0),l(D,null,W(B.value,a=>(o(),l("option",{key:a.id,value:a.id},r(a.name),9,pe))),128))],512),[[se,n.value.stage_id,void 0,{number:!0}]])])):m("",!0),t("div",{class:M(f.value==="leads"?"sm:col-span-2":"sm:col-span-3")},[e[15]||(e[15]=t("label",{class:"block text-xs font-medium text-gray-700 dark:text-slate-200"},"Buscar",-1)),S(t("input",{"onUpdate:modelValue":e[7]||(e[7]=a=>n.value.q=a),type:"search",class:"mt-1 w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 placeholder:text-gray-400 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:placeholder:text-slate-500 dark:focus:ring-blue-900/30",placeholder:"Nombre, empresa, teléfono…"},null,512),[[z,n.value.q]])],2)]),t("div",me,[e[17]||(e[17]=t("label",{class:"text-xs font-medium text-gray-700 dark:text-slate-200"},"Límite",-1)),S(t("input",{"onUpdate:modelValue":e[8]||(e[8]=a=>n.value.limit=a),type:"number",min:"1",max:"500",class:"w-28 rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-100 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100 dark:focus:ring-blue-900/30"},null,512),[[z,n.value.limit,void 0,{number:!0}]]),t("label",be,[S(t("input",{type:"checkbox","onUpdate:modelValue":e[9]||(e[9]=a=>n.value.only_with_phone=a),disabled:(k.value.total??0)>0&&(k.value.with_phone??0)===0},null,8,xe),[[re,n.value.only_with_phone]]),e[16]||(e[16]=c(" Solo con teléfono ",-1))]),t("button",{type:"button",class:"ml-auto inline-flex items-center rounded-lg bg-blue-600 px-3 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:ring-4 focus:ring-blue-200",disabled:j.value,onClick:q},r(j.value?"Cargando…":"Cargar destinatarios"),9,ve)]),N.value?(o(),l("div",ye,r(N.value),1)):(o(),l("div",he,[e[19]||(e[19]=c(" Total: ",-1)),t("span",ke,r(k.value.total),1),e[20]||(e[20]=c(" · Con teléfono: ",-1)),t("span",fe,r(k.value.with_phone??0),1),e[21]||(e[21]=c(" · Sin teléfono: ",-1)),t("span",_e,r(k.value.without_phone??0),1),n.value.only_with_phone&&h.value.length===0&&(k.value.without_phone??0)>0?(o(),l("span",we,[...e[18]||(e[18]=[c(" · Desmarca ",-1),t("span",{class:"font-semibold"},"Solo con teléfono",-1),c(" para verlos. ",-1)])])):m("",!0)])),t("div",Ce,[t("div",Se,[t("label",$e,[t("input",{type:"checkbox",checked:H.value,onChange:O},null,40,Ae),e[22]||(e[22]=c(" Seleccionar todos ",-1))]),t("div",je,"Seleccionados: "+r(x.value.size)+" / "+r(h.value.length),1)]),t("div",Ne,[(o(!0),l(D,null,W(h.value,a=>(o(),l("div",{key:a.id,class:"flex items-center gap-3 border-t border-gray-100 px-3 py-2 text-sm dark:border-slate-800"},[t("input",{type:"checkbox",checked:x.value.has(a.id),onChange:d=>P(a.id)},null,40,Ve),t("div",Ee,[t("div",ze,[c(r(a.display_name||"Sin nombre")+" ",1),a.secondary?(o(),l("span",De,"· "+r(a.secondary),1)):m("",!0)]),t("div",We,[t("span",null,r(a.phone||"Sin teléfono"),1),a.stage_name?(o(),l("span",Ue,"· "+r(a.stage_name),1)):m("",!0)])])]))),128)),h.value.length===0?(o(),l("div",qe," No hay resultados con esos filtros. ")):m("",!0)])]),t("div",Le,[t("button",{type:"button",class:"inline-flex items-center rounded-lg bg-emerald-600 px-3 py-2 text-sm font-medium text-white shadow-sm hover:bg-emerald-700 focus:ring-4 focus:ring-emerald-200 disabled:opacity-50",disabled:V.value||x.value.size===0||!v.value.message_template.trim(),onClick:K},r(V.value?"Creando…":"Crear campaña"),9,Me),w.value?(o(),l("div",Be,[e[23]||(e[23]=c(" Campaña creada: ",-1)),t("span",He,"#"+r(w.value),1)])):m("",!0)]),$.value?(o(),l("div",Ie,r($.value),1)):m("",!0)])]),t("div",Re,[t("div",Te,[e[25]||(e[25]=t("div",null,[t("div",{class:"text-sm font-semibold text-gray-900 dark:text-slate-100"},"Ejecución"),t("div",{class:"mt-1 text-xs text-gray-600 dark:text-slate-300"}," Abre WhatsApp con mensaje prellenado y marca el estado. ")],-1)),t("button",{type:"button",class:"inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",disabled:E.value,onClick:G},r(E.value?"Cargando…":"Ver últimas campañas"),9,Fe)]),t("div",Oe,[b.value?(o(),l("div",Pe,[t("div",Ke,[c(" Campaña #"+r(b.value.id)+" ",1),b.value.name?(o(),l("span",Ge,"· "+r(b.value.name),1)):m("",!0)]),t("div",Je,[t("div",Qe,[(o(!0),l(D,null,W(b.value.recipients,a=>(o(),l("div",{key:a.id,class:"border-t border-gray-100 p-3 text-sm dark:border-slate-800"},[t("div",Xe,[t("div",Ye,[t("div",Ze,[c(r(a.display_name||"Sin nombre")+" ",1),t("span",et,"· "+r(a.phone),1)]),t("div",tt,r(a.rendered_message),1)]),t("div",at,[t("a",{class:"inline-flex items-center justify-center rounded-lg bg-blue-600 px-3 py-2 text-xs font-medium text-white shadow-sm hover:bg-blue-700",href:Q(a.phone,a.rendered_message),target:"_blank",rel:"noopener",onClick:d=>X(a)}," Abrir WhatsApp ",8,st),t("button",{type:"button",class:"inline-flex items-center justify-center rounded-lg border border-gray-200 bg-white px-3 py-2 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",onClick:d=>Y(a)}," Marcar enviado ",8,rt),t("div",lt,[e[26]||(e[26]=c(" Estado: ",-1)),t("span",ot,r(a.status),1)])])])]))),128)),b.value.recipients.length===0?(o(),l("div",dt," Sin destinatarios. ")):m("",!0)])])])):(o(),l("div",nt," Crea una campaña a la izquierda o carga una campaña reciente. ")),C.value?(o(),l("div",it,r(C.value),1)):m("",!0),U.value.length>0?(o(),l("div",ut,[e[27]||(e[27]=t("div",{class:"text-xs font-semibold text-gray-700 dark:text-slate-200"},"Últimas campañas",-1)),t("div",ct,[(o(!0),l(D,null,W(U.value,a=>(o(),l("button",{key:a.id,type:"button",class:"flex items-center justify-between rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-700 shadow-sm hover:bg-gray-50 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800",onClick:d=>T(a.id)},[t("span",null,[c(" #"+r(a.id)+" ",1),a.name?(o(),l("span",pt,"· "+r(a.name),1)):m("",!0)]),t("span",mt,r(Z(a.created_at)),1)],8,gt))),128))])])):m("",!0)])])])]))}};export{yt as default};
