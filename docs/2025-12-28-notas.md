# 2025-12-28 — CRM Atlantis (resumen de avances)

Fecha: 2025-12-28

## Objetivo general
- Consolidar el CRM (Leads/Clientes) con UX consistente (modo oscuro + SweetAlert2).
- Implementar módulo de Calendario (Opción A: agenda por usuario, privada) y recordatorios con notificaciones in-app (DB).

---

## 1) Modo oscuro (UI)
**Qué se hizo**
- Se ajustaron vistas Blade del perfil y navegación/header para que soporten `dark:` de Tailwind.

**Archivos clave**
- `resources/views/profile/*`
- `resources/views/layouts/navigation.blade.php`
- `resources/views/components/*` relacionados con navegación/dropdowns

---

## 2) Leads (CRM): pipeline + lista, bloqueo “Ganado” y archivado
**Qué se hizo**
- Se implementaron 2 vistas para Leads:
  - Pipeline/Kanban
  - Lista/tabla (con tabs por etapa + select por fila para cambiar etapa)
- Se agregó confirmación (SweetAlert2) antes de pasar a la etapa ganadora (`is_won`).
- Una vez Ganado:
  - Se bloquean movimientos (drag/select) para evitar cambios.
  - Se habilita solo “Archivar” para ocultar del Kanban sin perder historial.
- Se agregó `archived_at` para marcar leads archivados.

**Backend**
- `app/Http/Controllers/LeadController.php`
  - Endpoints para data de tabla y board.
  - Movimiento de etapa.
  - Archivado (`archived_at`).
- Migración:
  - `database/migrations/2025_12_27_000200_add_archived_at_to_leads_table.php`
- Modelo:
  - `app/Models/Lead.php` con casts/fillable para `archived_at`.

**Frontend**
- `resources/js/components/LeadsBoard.vue`
  - Confirmación antes de “Ganado”.
  - Bloqueo de drag para Ganados/Archivados.
  - Botón “Archivar” (visible en columna ganadora).
- `resources/js/components/LeadsTable.vue`
  - Select deshabilitado para Ganados/Archivados.
  - Acción “Archivar” desde tabla.
  - Columna “Archivado” mostrando `archived_at`.

**Rutas**
- `routes/web.php`
  - `GET /leads` (pipeline)
  - `GET /leads/list` (tabla)
  - `GET /leads/data` (data tabla)
  - `GET /leads/board-data` (data kanban)
  - `PATCH /leads/{lead}/move-stage`
  - `PATCH /leads/{lead}/archive`

---

## 3) SweetAlert2 (confirmaciones/toasts) + compatibilidad dark
**Qué se hizo**
- Se reemplazaron `window.confirm` por modales SweetAlert2.
- Se creó helper para confirmaciones y toasts.
- Se ajustó el estilo del modal para que en dark mode no quede blanco.

**Archivos clave**
- `resources/js/ui/alerts.js`
- (Usos) `LeadsBoard.vue`, `LeadsTable.vue`, `CustomersTable.vue`, `Header.vue`, `CalendarView.vue`

---

## 4) Clientes (módulo + acciones)
**Qué se hizo**
- Se agregó módulo Clientes (vista, rutas, controlador).
- Se corrigieron campos consultados (ej. `contact_email`, `contact_phone`, `company_name`).
- Se agregaron acciones Editar/Eliminar desde la UI (con SweetAlert2).

**Backend**
- `app/Http/Controllers/CustomerController.php`
  - `data()` listado
  - `update()` editar
  - `destroy()` eliminar

**Frontend**
- `resources/js/components/CustomersTable.vue`
  - Buscar/paginación
  - “Ver leads” (link por documento o nombre)
  - Editar/Eliminar

**Rutas**
- `routes/web.php`
  - `GET /customers`
  - `GET /customers/data`
  - `PUT /customers/{customer}`
  - `DELETE /customers/{customer}`

---

## 5) Branding/layout
**Qué se hizo**
- Branding integrado al sidebar:
  - Sidebar colapsado: isotipo
  - Sidebar expandido: logotipo
- Header alineado/pegado a la derecha del sidebar.

**Archivos clave**
- `resources/js/components/Sidebar.vue`
- `resources/js/components/Header.vue`
- `resources/images/LOGO.png`
- `resources/images/LOGO_TEXTO.png`

---

## 6) Calendario (Opción A: agenda por usuario)
**Decisión**
- Opción A: cada usuario ve su propio calendario (scoping por `assigned_to = auth()->id()`).

### 6.1 Base de datos
**Migraciones**
- `database/migrations/2025_12_28_000100_create_notifications_table.php`
- `database/migrations/2025_12_28_000101_create_calendar_events_table.php`

**Tabla calendar_events** (resumen)
- `title`, `description`, `location`
- `start_at`, `end_at`, `all_day`
- recordatorios: `reminder_minutes`, `reminder_at`, `reminded_at`
- relación polimórfica opcional: `related_type`, `related_id`
- control de acceso: `created_by`, `assigned_to`

### 6.2 Modelo
- `app/Models/CalendarEvent.php`
  - casts de fechas
  - relaciones `creator()`, `assignee()` y `related()` (morph)

### 6.3 API
- `app/Http/Controllers/CalendarEventController.php`
  - `GET /calendar/events` por rango (`start`, `end`) y filtrado por `assigned_to`
  - `POST /calendar/events` crea evento (assigned_to=usuario actual)
  - `PUT /calendar/events/{event}` actualiza solo si el evento es del usuario
  - `DELETE /calendar/events/{event}` elimina solo si el evento es del usuario

### 6.4 UI (FullCalendar)
- `resources/js/components/CalendarView.vue`
  - FullCalendar month/week/day
  - Crear evento (click fecha)
  - Editar evento (click evento)
  - Drag & drop / resize
  - Formulario de evento con SweetAlert2
  - Soporte para “prefill” vía querystring:
    - `/calendar?related_type=lead&related_id=123&title=Seguimiento...`
  - Refetch correcto mediante `calendarRef.getApi().refetchEvents()`

**Dependencias**
- `@fullcalendar/core`
- `@fullcalendar/vue3`
- `@fullcalendar/daygrid`
- `@fullcalendar/timegrid`
- `@fullcalendar/interaction`

### 6.5 Rutas (vista)
- `routes/web.php`
  - `GET /calendar` (renderiza dashboard SPA)

---

## 7) Notificaciones in-app (fase 1)
**Qué se hizo**
- Notificaciones persistidas en DB (channel `database`).
- Scheduler cada minuto revisa eventos vencidos para recordatorio y genera notificación.

**Backend**
- `app/Notifications/CalendarEventReminderNotification.php`
- `app/Http/Controllers/NotificationController.php`
  - `GET /notifications` (últimas no leídas + count)
  - `POST /notifications/{id}/read` (marcar leída)
- `bootstrap/app.php`
  - `withSchedule`: cada minuto
    - busca eventos con `reminder_at <= now` y `reminded_at IS NULL`
    - marca `reminded_at`
    - envía notificación al usuario `assigned_to`

**Frontend**
- `resources/js/components/Header.vue`
  - Campana con badge y dropdown
  - Polling cada 30s a `/notifications`
  - Toast al detectar nuevas (máximo 2 por ciclo)
  - Click: marca como leída y redirige a `notification.data.url` si existe

---

## 8) Permisos (Spatie) y visibilidad del menú
**Seeder**
- `database/seeders/RolesAndPermissionsSeeder.php`
  - permisos `calendar.*` y `menu.calendar`
  - rol `admin` y `dev` con permisos completos

**Sidebar**
- `resources/js/components/Sidebar.vue`
  - Se muestra Calendario si el usuario tiene `menu.calendar` o `calendar.view`.

**Nota**
- Si no aparece el menú: el usuario debe tener el permiso en BD.
- Comandos útiles:
  - `php artisan db:seed --class=RolesAndPermissionsSeeder`
  - `php artisan permission:cache-reset`

---

## 9) Cómo probar mañana (checklist)
### Calendario
1) Ver menú: ingresar a `/dashboard` y confirmar que aparece “Calendario” en sidebar.
2) Abrir `/calendar`.
3) Crear evento:
   - click en una fecha
   - título requerido, inicio requerido
4) Editar evento: click en evento.
5) Mover evento: drag & drop.
6) Resize evento: estirar fin.
7) Probar recordatorio:
   - crear evento con inicio cercano
   - `reminder_minutes` pequeño (ej. 1)
   - esperar el scheduler (cada minuto)
   - ver campana (badge) y dropdown.

### Notificaciones
- Confirmar que `/notifications` retorna datos.
- Confirmar que al click se marca leída (`/notifications/{id}/read`) y baja el contador.

---

## 10) Pendientes/Recomendaciones (para decidir)
### Relación Lead/Cliente con calendario (recomendación funcional)
- Leads:
  - **Seguimiento** (llamada, reunión, demo, cotización)
  - **Recordatorio de propuesta** (cuando está en etapa de negociación)
  - **Fecha tentativa de cierre**
- Clientes:
  - **Reunión de onboarding** (post-venta)
  - **Visita periódica / check-in mensual**
  - **Renovación / vencimientos** (si luego se agrega contratos)

### Mejora UX recomendada (cuando quieras)
- Evitar “related_id manual” en el formulario del calendario:
  - Opción 1: desde Lead/Cliente agregar botón “Agendar” que prellena `related_type`/`related_id` (ya soportado por querystring)
  - Opción 2: autocompletar (buscador) para seleccionar Lead/Cliente.

---

## Notas de implementación
- SPA sigue siendo “por path” (sin vue-router): `resources/js/components/App.vue` decide qué componente renderizar según `window.location.pathname`.
- Datos de usuario/permisos se inyectan en `resources/views/dashboard.blade.php` via `window.__AUTH_USER__`.

---

## 11) Cambios de las últimas horas (post-resumen)

### 11.1 Login: colores + fondo con imagen
**Qué se hizo**
- Se corrigieron estilos (dark/light) del formulario de login y se agregó un fondo con imagen desde `resources/images`.
- Se ajustaron clases de Tailwind v4 para el gradiente (cambio de utilidades).

**Archivos clave**
- `resources/views/layouts/guest.blade.php`
  - Fondo con `Vite::asset('resources/images/fondo_login.jpg')`.
  - Overlay para legibilidad del formulario.
  - Ajustes dark/light del card.
- `resources/views/auth/login.blade.php`
  - Ajustes de clases en checkbox/link en modo oscuro.

### 11.2 Calendario: “Relacionado” con buscador (sin escribir IDs)
**Problema**
- El campo `related_id` obligaba a escribir IDs manualmente.

**Qué se hizo**
- Se reemplazó el input por un buscador/autocomplete que cambia según el tipo:
  - Si `related_type = lead` busca leads.
  - Si `related_type = customer` busca clientes.
- Se soporta precarga del label cuando se edita un evento ya existente.

**Reglas aplicadas**
- En búsqueda de leads:
  - No aparecen leads archivados.
  - No aparecen leads ganados.

**Backend**
- `app/Http/Controllers/RelatedLookupController.php`
  - Endpoint `GET /related-lookup` con `type=lead|customer`, `q`, `limit`.
  - Búsqueda y validaciones por permisos (`leads.view` / `customers.view`).
- `routes/web.php`
  - Registro de ruta `GET /related-lookup` dentro del scope autenticado/permisos.

**Frontend**
- `resources/js/components/CalendarView.vue`
  - Select `related_type` + input de búsqueda + lista de resultados.
  - Setea `related_id` al seleccionar.

### 11.3 Calendario: mejor visibilidad de eventos + eliminar eventos
**Qué se hizo**
- Se mejoró la visibilidad de los eventos en el calendario (píldora/bloque más notorio).
- Se agregó la opción de eliminar eventos desde el modal de edición.

**Detalles**
- `resources/js/components/CalendarView.vue`
  - Estilos/clases para “event pill” (mejor contraste y truncado).
  - Acción “Eliminar” visible solo si el usuario tiene permiso `calendar.delete`.
  - Llama `DELETE /calendar/events/{id}` y refresca con `refetchEvents()`.

### 11.4 Notificaciones/recordatorios: por qué no aparecían en local
**Causa**
- Los recordatorios dependen del Scheduler. Si el Scheduler no está corriendo, no se generan notificaciones.

**Qué se hizo**
- Se ajustó el flujo de desarrollo para que el Scheduler esté activo durante `composer run dev`.

**Archivos clave**
- `composer.json`
  - Se agregó `php artisan schedule:work` al script de desarrollo.

**Nota Windows**
- En `storage/logs/laravel.log` apareció el error: `The [pcntl] extension is required to run Pail.`
  - Esto es esperado en Windows; no bloquea el CRM, pero evita usar Pail.

### 11.5 Diagnóstico: pantalla en blanco (SPA)
**Causa típica detectada**
- Desajuste entre Vite dev server y el archivo `public/hot` (URL/host/puerto). Si el JS no carga, la SPA queda en blanco.

**Señal**
- `public/hot` apuntando a un host/puerto no accesible (ej. IPv6 `http://[::1]:5174`).

### 11.6 Leads → Clientes: “no aparecen clientes al pasar a Ganado”
**Hallazgo (importante)**
- La conversión a cliente sí se ejecutaba, pero varios leads estaban usando el mismo documento (ej. DNI `12345678`).
- Como `customers` tiene `unique(document_type, document_number)`, esos leads terminaban vinculándose al mismo cliente (en vez de crear uno nuevo).

**Mejora mínima solicitada**
- Mostrar un aviso y bloquear la creación de un lead si el documento ya existe.

**Qué se implementó**
- Validación adicional en `LeadController@store`:
  - Si ya existe un `Customer` con el mismo `document_type + document_number`, se rechaza con mensaje claro.
  - También se rechaza si ya existe un `Lead` activo (no archivado) con ese documento.

**Archivo clave**
- `app/Http/Controllers/LeadController.php`

### 11.7 Nota de consola (PowerShell): comandos PHP y variables
**Problema encontrado**
- En PowerShell, usar `php -r "... $var ..."` con comillas dobles expande `$var` y rompe el snippet de PHP.

**Solución práctica**
- Usar comillas simples para el snippet: `php -r '... $var ...'`.
