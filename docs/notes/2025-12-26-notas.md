# CRM ATLANTIS — Notas de trabajo (2025-12-26)

## Resumen de lo implementado

Hoy se consolidó el CRM con RBAC completo, módulos reales (Usuarios, Roles y Leads/Kanban), y mejoras de UX para que el dashboard sea usable como SPA dentro de Blade.

## Stack actual
- Backend: Laravel 12 + PHP 8.2
- DB: MySQL (XAMPP)
- Auth: Laravel Breeze (registro deshabilitado)
- Frontend: Vue 3 + Vite 7
- UI: Tailwind v4 + Flowbite
- RBAC: spatie/laravel-permission

## Arquitectura
- Blade actúa como shell: `resources/views/dashboard.blade.php`.
- Vue se monta en `#app` (`resources/js/app.js`) y cambia de módulo por `window.location.pathname` (`resources/js/components/App.vue`).
- Endpoints JSON internos protegidos por `auth` + permisos (no hay API separada).

## RBAC / Seguridad

### Middleware Spatie en Laravel 12
- Se registraron aliases en `bootstrap/app.php`:
  - `permission`, `role`, `role_or_permission`

### Permisos base creados por seeder
- `users.view|create|update|delete`
- `roles.view|create|update|delete`
- `leads.view|create|update|delete`
- `menu.users|menu.roles|menu.leads` (control de visibilidad del sidebar)

### Roles base
- `admin`: acceso total.
- `dev`: acceso total.
- `employee`: rol base sin permisos (para asignar granularmente).

> Importante: para ver un módulo debes dar permisos de ruta (`*.view`) y también el permiso de menú `menu.*` para que aparezca el link en el sidebar.

## Módulo Usuarios

### Backend
- `GET /users/data`: paginación + búsqueda server-side.
- Se añadió `GET /users/role-options`: retorna roles existentes para que el select sea dinámico.
- Crear/editar usuario asigna roles usando Spatie (`syncRoles`).

### Frontend
- Tabla con buscador (debounce), paginación server-side, modales animados.
- Select de rol cargado dinámicamente desde `/users/role-options`.

## Módulo Roles

### Backend
- CRUD de roles vía JSON y catálogo de permisos:
  - `GET /roles/data`
  - `GET /roles/permissions`
  - `POST /roles`, `PUT /roles/{role}`, `DELETE /roles/{role}`

### Frontend
- CRUD de roles.
- Asignación de permisos por checkbox.
- Sección “Módulos del menú” para togglear `menu.users`, `menu.roles`, `menu.leads`.

## Módulo Leads (Kanban)

### Modelo de datos
- `lead_stages`: columnas del kanban. Seeder crea: follow_up, qualified, proposed, won.
- `leads`: oportunidad.
- `customers`: entidad separada.

Reglas:
- `document_type` + `document_number` son opcionales en lead.
- Validación condicional: si envías `document_type`, el `document_number` debe tener 8 dígitos (dni) o 11 (ruc).
- Al mover a etapa `won` se crea/relaciona un `customer` automáticamente.

### Backend
- `GET /leads/board-data`: stages + leads agrupados.
- `POST /leads`: crea lead (usa primera etapa por defecto si no se envía `stage_id`).
- `PATCH /leads/{lead}/move-stage`: mueve lead y convierte a customer si la etapa es ganada.

### Frontend
- Kanban con drag & drop.
- Movimiento “optimista” para evitar parpadeo: se actualiza UI sin recargar todo el tablero.
- Modal “Lead rápido” tipo Kommo, adaptado a los campos actuales.

## Seeders y credenciales
- `DatabaseSeeder` ejecuta:
  - `RolesAndPermissionsSeeder`
  - `LeadStagesSeeder`
  - `InternalUserSeeder`

Usuario admin interno (dev/local):
- Email: `admin@crmatlantis.local`
- Password: `Atlantis2025!`

## Validaciones
- `php artisan test`: 24/24 OK
- `npm run build`: OK
