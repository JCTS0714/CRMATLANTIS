# 2026-01-12 — Notas (WhatsApp masivo + UX + fixes)

## Objetivo del día

- Mejorar UX/UI en modo oscuro (filtros de Leads).
- Diseñar e implementar un MVP de **campañas de WhatsApp “manual asistido”** dentro del CRM (sin API de WhatsApp).
- Resolver issues de navegación y UX.
- Separar claramente **Leads** vs **Clientes** en la selección de destinatarios.

> "Manual asistido" = el sistema **no envía** mensajes; solo **genera texto personalizado**, abre WhatsApp (`wa.me`) y el usuario marca el estado (enviado/abierto).

---

## 1) UI: filtros de Leads (modo oscuro)

**Archivo:** `resources/js/components/LeadsBoard.vue`

- Ajustes de estilos para inputs de filtros (select / date / botones) en dark mode:
  - colores de texto / placeholder
  - bordes y focus rings
  - `color-scheme` para date inputs para icono/datepicker consistente en dark mode

Se reconstruyeron assets con Vite.

---

## 2) MVP: Campañas WhatsApp “manual asistido”

### 2.1 Migración y tablas

**Migración:** `database/migrations/2026_01_12_120000_create_whatsapp_campaigns_tables.php`

- Tabla `whatsapp_campaigns`
- Tabla `whatsapp_campaign_recipients`
  - Recipients con relación polimórfica (`contactable_type`, `contactable_id`) para soportar Lead/Customer.

> Se ejecutó `php artisan migrate` con éxito.

### 2.2 Modelos

- `app/Models/WhatsAppCampaign.php`
- `app/Models/WhatsAppCampaignRecipient.php`

### 2.3 Controller / API

**Controlador:** `app/Http/Controllers/WhatsAppCampaignController.php`

Endpoints:

- `GET /leads/whatsapp/recipients`
  - Devuelve candidatos unificados en `contacts[]`.
  - Soporta:
    - `source`: `leads|customers`
    - `stage_id` (solo para leads)
    - `q` (búsqueda)
    - `limit`
    - `only_with_phone` (filtro de teléfono)
  - Devuelve `counts` para UX:
    - `total`
    - `with_phone`
    - `without_phone`
    - `returned`

- `POST /leads/whatsapp-campaigns`
  - Crea campaña con:
    - `source` + `ids[]` (genérico: leads o customers)
    - `message_template`

- `GET /leads/whatsapp-campaigns`
  - Lista últimas campañas.

- `GET /leads/whatsapp-campaigns/{campaign}`
  - Detalle de campaña con recipients.

- `PATCH /leads/whatsapp-campaign-recipients/{recipient}`
  - Actualiza estado por destinatario (ej: `opened`, `sent`).

Permisos:

- Para `source=customers`, se valida `customers.view`.

### 2.4 Rutas

**Archivo:** `routes/web.php`

- Ruta UI shell:
  - `GET /leads/whatsapp` (renderiza el dashboard SPA)
- Rutas API (ver endpoints arriba).

---

## 3) Frontend: pantalla de campañas

**Componente:** `resources/js/components/LeadsWhatsAppCampaign.vue`

Funcionalidad:

- Crear campaña:
  - nombre opcional
  - plantilla de mensaje con variables:
    - `{{first_name}}`
    - `{{company_name}}`
- Cargar destinatarios con filtros:
  - Tabs: **Leads / Clientes** (`source`)
  - Etapa (solo en Leads)
  - Búsqueda `q`
  - Límite
  - Checkbox `Solo con teléfono`
- Selección:
  - seleccionar todos
  - selección individual
- Ejecución:
  - abrir WhatsApp con `https://wa.me/<phone>?text=<message>`
  - marcar estado (abierto/enviado)
- Historial:
  - lista de últimas campañas

Mejoras UX agregadas hoy:

- Conteos de destinatarios (total/con teléfono/sin teléfono) para entender por qué queda vacío.
- Ajuste de envío de `only_with_phone` a `1/0` (evita validación fallida en backend).
- Auto-ajuste del checkbox cuando no existen registros con teléfono (evita “0 resultados” confuso).

---

## 4) Integración SPA + navegación

**SPA:** `resources/js/components/App.vue`

- Se agregó la vista `/leads/whatsapp` al switch de pantallas.

**Sidebar:** `resources/js/components/Sidebar.vue`

- Se añadió el item de menú “WhatsApp masivo” dentro de Pipeline.
- Fix: el sidebar en modo colapsado usa un menú “flyout” distinto; se agregó el link también ahí.
- Fix de active state para que `/leads` no quede resaltado cuando estás en `/leads/whatsapp`.

---

## 5) Fixes importantes de hoy

### 5.1 Error de validación (rojo en inglés) `only_with_phone`

Problema:

- Laravel valida querystring boolean como `0/1`.
- El frontend enviaba `true/false` (string), lo que disparaba el error.

Solución:

- Frontend manda `only_with_phone: 1|0`.
- Backend acepta `0/1/true/false` y castea con `$request->boolean(...)`.

### 5.2 “Todos” en Leads no debe incluir Ganado

Requisito:

- La etapa “Ganado” (is_won) corresponde a leads convertidos, que deben tratarse como Customers.

Solución:

- En `recipients()` para leads:
  - `LeadStage` filtrado por `is_won = false`.
  - “Todas” trae solo etapas no ganadas.
  - Si se intenta pedir una etapa no válida (Ganado), responde 422 con mensaje.

### 5.3 Por qué no salían Leads

Hallazgo en la BD (al momento del ajuste):

- Existen leads no-ganados, pero no hay ninguno con `contact_phone`.
- Si “Solo con teléfono” estaba activado, el resultado era 0.

Mitigación UX:

- Mostrar conteos y sugerir desmarcar.
- Auto-desactivar el filtro cuando `with_phone = 0`.

---

## 6) Comandos usados (resumen)

- `php artisan migrate`
- `npm run build`

---

## 7) Pendientes sugeridos (para mañana)

- No permitir seleccionar destinatarios “Sin teléfono” (o marcarlos como no-elegibles).
- Acciones masivas en ejecución (marcar enviados/omitidos en batch).
- Vista previa del mensaje para un destinatario antes de crear campaña.
- Opcional: registro de actividad por Lead/Customer (timeline) cuando se abre/envía.
